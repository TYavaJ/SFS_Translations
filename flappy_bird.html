http://%2A%20%20playcanvas%20engine%20v0.181.12%20revision%20dde15ec%20%20http//playcanvas.com%20%20Copyright%202011-2016%20PlayCanvas%20Ltd.%20All%20rights%20reserved.%20%20Do%20not%20distribute.%20%20Contains:%20https://github.com/tildeio/rsvp.js%20-%20see%20page%20for%20license%20information%20*/%20var%20pc=%7Bversion:%220.181.12%22,revision:%22dde15ec%22,config:%7B%7D,common:%7B%7D,apps:%7B%7D,data:%7B%7D,unpack:function()%7Bconsole.warn(%22pc.unpack%20has%20been%20deprecated%20and%20will%20be%20removed%20shortly.%20Please%20update%20your%20code.%22)%7D,makeArray:function(f)%7Bvar%20a,b=[],d=f.length;for(a=0;a%3Cd;++a)b.push(f[a]);return%20b%7D,type:function(f)%7Bif(null===f)return%22null%22;var%20a=typeof%20f;return%22undefined%22==a%7C%7C%22number%22==a%7C%7C%22string%22==a%7C%7C%22boolean%22==a?a:_typeLookup[Object.prototype.toString.call(f)]},extend:function(f,a){var%20b,d;%20for(b%20in%20a)d=a[b],f[b]=%22object%22==pc.type(d)?pc.extend({},d):%22array%22==pc.type(d)?pc.extend([],d):d;return%20f},isDefined:function(f){return%20void%200!==f}},_typeLookup=function(){var%20f={},a,b=%22Array%20Object%20Function%20Date%20RegExp%20Float32Array%22.split(%22%20%22);for(a=0;a%3Cb.length;++a)f[%22[object%20%22+b[a]+%22]%22]=b[a].toLowerCase();return%20f}();%22undefined%22!==typeof%20exports&&(exports.pc=pc);(function(){for(var%20f=0,a=[%22ms%22,%22moz%22,%22webkit%22,%22o%22],b=0;b%3Ca.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[a[b]+%22RequestAnimationFrame%22],window.cancelAnimationFrame=window[a[b]+%22CancelAnimationFrame%22]||window[a[b]+%22CancelRequestAnimationFrame%22];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var%20b=(new%20Date).getTime(),g=Math.max(0,16-(b-f)),h=window.setTimeout(function(){a(b+g)},g);f=b+g;return%20h});window.cancelAnimationFrame||(window.cancelAnimationFrame=%20function(a){clearTimeout(a)})})();String.prototype.startsWith||Object.defineProperty(String.prototype,%22startsWith%22,{enumerable:!1,configurable:!0,writable:!0,value:function(f){for(var%20a=0,b=f.length;a%3Cb;a++)if(this[a]!==f[a])return!1;return!0}});String.prototype.endsWith||Object.defineProperty(String.prototype,%22endsWith%22,{enumerable:!1,configurable:!0,writable:!0,value:function(f){for(var%20a=0,b=f.length;a%3Cb;a++)if(this[a+this.length-b]!==f[a])return!1;return!0}});(function(){if(%22undefined%22!==typeof%20document){var%20f=function(){var%20a=document.createEvent(%22CustomEvent%22);a.initCustomEvent(%22fullscreenchange%22,!0,!1,null);document.dispatchEvent(a)},a=function(){var%20a=document.createEvent(%22CustomEvent%22);a.initCustomEvent(%22fullscreenerror%22,!0,!1,null);document.dispatchEvent(a)};document.addEventListener(%22webkitfullscreenchange%22,f,!1);document.addEventListener(%22mozfullscreenchange%22,f,!1);document.addEventListener(%22MSFullscreenChange%22,f,!1);document.addEventListener(%22webkitfullscreenerror%22,%20a,!1);document.addEventListener(%22mozfullscreenerror%22,a,!1);document.addEventListener(%22MSFullscreenError%22,a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.hasOwnProperty(%22fullscreenElement%22)||%20Object.defineProperty(document,%22fullscreenElement%22,{enumerable:!0,configurable:!1,get:function(){return%20document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.hasOwnProperty(%22fullscreenEnabled%22)||Object.defineProperty(document,%22fullscreenEnabled%22,{enumerable:!0,configurable:!1,get:function(){return%20document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(4);3%3C=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4%3C=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};f.prototype={clone:function(){return%20new%20pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var%20b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return%20this},set:function(a,b,d,e){var%20g=this.data;g[0]=a;%20g[1]=b;g[2]=d;g[3]=void%200===e?1:e;return%20this},fromString:function(a){var%20b=parseInt(a.replace(%22#%22,%220x%22));7%3Ca.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return%20this},toString:function(a){var%20b=%22#%22+(16777216+(parseInt(255*this.r)%3C%3C16)+(parseInt(255*this.g)%3C%3C8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a%3C16/255?b+(%220%22+a):b+a);return%20b}};Object.defineProperty(f.prototype,%22r%22,%20{get:function(){return%20this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,%22g%22,{get:function(){return%20this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,%22b%22,{get:function(){return%20this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f.prototype,%22a%22,{get:function(){return%20this.data[3]},set:function(a){this.data[3]=a}});return{Color:f}}());pc.guid=function(){return{create:function(){return%22xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx%22.replace(/[xy]/g,function(f){var%20a=16*Math.random()|0;return(%22x%22==f?a:a&3|8).toString(16)})}}}();pc.extend(pc,function(){var%20f=function(){this._isRunning=!1;this._b=this._a=0};f.prototype={start:function(){this._isRunning=!0;this._a=(new%20Date).getTime()},stop:function(){this._isRunning=!1;this._b=(new%20Date).getTime()},getMilliseconds:function(){return%20this._b-this._a}};return{Timer:f,now:!window.performance||!performance.now||!performance.timing?Date.now:function(){return%20performance.now()}}}());pc.extend(pc,function(){return{createURI:function(f){var%20a=%22%22;if((f.authority||f.scheme)&&(f.host||f.hostpath))throw%20Error(%22Can't%20have%20'scheme'%20or%20'authority'%20and%20'host'%20or%20'hostpath'%20option%22);if(f.host&&f.hostpath)throw%20Error(%22Can't%20have%20'host'%20and%20'hostpath'%20option%22);if(f.path&&f.hostpath)throw%20Error(%22Can't%20have%20'path'%20and%20'hostpath'%20option%22);f.scheme&&(a+=f.scheme+%22:%22);f.authority&&(a+=%22//%22+f.authority);f.host&&(a+=f.host);f.path&&(a+=f.path);f.hostpath&&(a+=f.hostpath);f.query&&(a+=%22?%22+f.query);%20f.fragment&&(a+=%22#%22+f.fragment);return%20a},URI:function(f){f=f.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=f[2];this.authority=f[4];this.path=f[5];this.query=f[7];this.fragment=f[9];this.toString=function(){var%20a=%22%22;this.scheme&&(a+=this.scheme+%22:%22);this.authority&&(a+=%22//%22+this.authority);a+=this.path;this.query&&(a+=%22?%22+this.query);this.fragment&&(a+=%22#%22+this.fragment);return%20a};this.getQuery=function(){var%20a,b,d={};this.query&&(a=decodeURIComponent(this.query).split(%22&%22),%20a.forEach(function(a){b=a.split(%22=%22);d[b[0]]=b[1]},this));return%20d};this.setQuery=function(a){q=%22%22;for(var%20b%20in%20a)a.hasOwnProperty(b)&&(%22%22!==q&&(q+=%22&%22),q+=encodeURIComponent(b)+%22=%22+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(f){console.log(f)},open:function(){pc.log.write(%22Powered%20by%20PlayCanvas%20%22+pc.version+%22%20%22+pc.revision)},info:function(f){console.info(%22INFO:%20%20%20%20%22+f)},debug:function(f){console.debug(%22DEBUG:%20%20%20%22+f)},error:function(f){console.error(%22ERROR:%20%20%20%22+f)},warning:function(f){console.warn(%22WARNING:%20%22+f)},alert:function(f){pc.log.write(%22ALERT:%20%20%20%22+f);alert(f)},assert:function(f,a){!1===f&&(pc.log.write(%22ASSERT:%20%20%22+a),alert(%22ASSERT%20failed:%20%22+a))}}}}());%20var%20logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(f){var%20a,b,d=function(){};a=this;b=function(){f.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=f.prototype;d.prototype=f.prototype;b.prototype=new%20d;return%20b};pc.extend(pc,function(){return{inherits:function(f,a){var%20b=function(){},d=function(){a.apply(this,arguments);f.apply(this,arguments)};d._super=a.prototype;b.prototype=a.prototype;d.prototype=new%20b;return%20d}}}());Function.prototype.bind||(Function.prototype.bind=function(f){if(%22function%22!==typeof%20this)throw%20new%20TypeError(%22Function.prototype.bind%20-%20what%20is%20trying%20to%20be%20fBound%20is%20not%20callable%22);var%20a=Array.prototype.slice.call(arguments,1),b=this,d=function(){},e=function(){return%20b.apply(this%20instanceof%20d?this:f||window,a.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;e.prototype=new%20d;return%20e});pc.path=function(){return{delimiter:%22/%22,join:function(){var%20f,a=arguments.length,b=arguments[0];for(f=0;f%3Ca-1;++f){var%20d=arguments[f],e=arguments[f+1];if(!pc.isDefined(d)||!pc.isDefined(e))throw%20Error(%22undefined%20argument%20to%20pc.path.join%22);b=e[0]===pc.path.delimiter?e:d&&e&&d[d.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?b+(pc.path.delimiter+e):b+e}return%20b},split:function(f){var%20f=f.split(pc.path.delimiter),a=f.slice(f.length-1)[0];return[f.slice(0,f.length-1).join(pc.path.delimiter),%20a]},getBasename:function(f){return%20pc.path.split(f)[1]},getDirectory:function(f){f=f.split(pc.path.delimiter);return%20f.slice(0,f.length-1).join(pc.path.delimiter)},getExtension:function(f){var%20a=f.split(%22?%22)[0].split(%22.%22).pop();return%20a!==f?%22.%22+a:%22%22},isRelativePath:function(f){return%22/%22!==f.charAt(0)&&null===f.match(/:\/\//)},extractPath:function(f){var%20a=%22.%22,b=f.split(%22/%22),d=0;if(1%3Cb.length){!1===pc.path.isRelativePath(f)&&(a=%22%22);for(d=0;d%3Cb.length-1;++d)a+=%22/%22+b[d]}return%20a}}}();pc.string=function(){return{ASCII_LOWERCASE:%22abcdefghijklmnopqrstuvwxyz%22,ASCII_UPPERCASE:%22ABCDEFGHIJKLMNOPQRSTUVWXYZ%22,ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(f){var%20a=0,b,d=pc.makeArray(arguments);d.shift();for(a=0;a%3Cd.length;a++)b=RegExp(%22\\{%22+a+%22\\}%22,%22gi%22),f=f.replace(b,d[a]);return%20f},startsWith:function(f,a){console.warn(%22WARNING:%20startsWith:%20Function%20is%20deprecated.%20Use%20String.startsWith%20instead.%22);return%20f.startsWith(a)},endsWith:function(f,a){console.warn(%22WARNING:%20endsWith:%20Function%20is%20deprecated.%20Use%20String.endsWith%20instead.%22);%20return%20f.endsWith(a)},toBool:function(f,a){if(%22true%22===f)return!0;if(a){if(%22false%22===f)return!1;throw%20Error(%22Not%20a%20boolean%20string%22);}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(f,a){return%20JSON.parse(f,a)},stringify:function(f,a,b){return%20JSON.stringify(f,function(b,e){this[b]instanceof%20Float32Array&&(e=pc.makeArray(this[b]));return%20a?a(b,e):e},b)}}}}());pc.cookie=function(){return{set:function(f,a,b){b=b||{};f=f+%22=%22+a;b.path&&(f+=%22;path=%22+b.path);b.domain&&(f+=%22;domain=%22+b.domain);b.path&&(f+=%22;path=%22+b.path);b.secure&&(f+=%22;secure%22);f=b.lifetime?f+(%22;max-age=%22+86400*b.lifetime):f+%22;max-age=86400%22;document.cookie=f},get:function(f){var%20a,b=document.cookie.split(%22;%22),d,e=b.length;for(d=0;d%3Ce;d++)if(a=b[d].trim(),a.startsWith(f))return%20a.split(%22=%22)[1]},remove:function(f,a){a.lifetime=0;pc.cookie.set(f,%22%22,a)}}}();pc.debug=function(){var%20f=null,a=null,b=null,d=null;return{display:function(e){f||(f=document.createElement(%22table%22),a=document.createElement(%22tr%22),b=document.createElement(%22td%22),d=document.createElement(%22td%22),f.style.cssText=%22position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc%22,f.style.top=%220px%22,f.style.left=%220px%22,f.style.border=%22thin%20solid%20#cccccc%22,document.body.appendChild(f));f.innerHTML=%22%22;for(var%20g%20in%20e){var%20h=a.cloneNode(),k=b.cloneNode(),n=d.cloneNode();k.textContent=g;n.textContent=%20e[g];h.appendChild(k);h.appendChild(n);f.appendChild(h)}}}}();pc.events=function(){var%20f={attach:function(a){var%20b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.once=b.once;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return%20a},on:function(a,b,d){if(%22string%22!=pc.type(a))throw%20new%20TypeError(%22Event%20name%20must%20be%20a%20string%22);var%20e=this._callbacks||(this._callbacks={});(e[a]||(e[a]=[])).push({callback:b,scope:d||this});return%20this},off:function(a,b,d){var%20e=this._callbacks;if(e){if(b){a=e[a];if(!a)return%20this;for(e=0;e%3Ca.length;e++)if(a[e].callback===b&&(!d||%20d===a[e].scope))a.splice(e,1),e--}else%20e[a]=[];return%20this}},fire:function(a){var%20b,d,e,g;if(this._callbacks&&this._callbacks[a]&&(d=this._callbacks[a].length)){if(1%3Carguments.length){e=Array(arguments.length-1);for(b=1;b%3Carguments.length;b++)e[b-1]=arguments[b]}g=this._callbacks[a].slice();var%20h=0;for(b=0;b%3Cd;++b)g[b].callback.apply(g[b].scope,e),g[b].callback.once?this._callbacks[a].splice(h,1):h++}return%20this},once:function(a,b,d){b.once=!0;this.on(a,b,d)},hasEvent:function(a){return%20void%200!==%20this._callbacks&&void%200!==this._callbacks[a]&&0%3Cthis._callbacks[a].length}};f.bind=f.on;f.unbind=f.off;return%20f}();pc.extend(pc,function(){var%20f=function(a){this._index={};this._key=a||null};f.prototype={addItem:function(a){for(var%20d=a.tags._list,e=0;e%3Cd.length;e++)this.add(d[e],a)},removeItem:function(a){for(var%20d=a.tags._list,e=0;e%3Cd.length;e++)this.remove(d[e],a)},add:function(a,d){this._index[a]&&-1!==this._index[a].list.indexOf(d)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(d),this._key&&(this._index[a].keys[d[this._key]]=d))},remove:function(a,%20d){if(this._index[a]&&(!this._key||this._index[a].keys[d[this._key]])){var%20e=this._index[a].indexOf(d);-1!==e&&(this._index[a].list.splice(e,1),this._key&&delete%20this._index[a].keys[d[this._key]],0===this._index[a].list.length&&delete%20this._index[a])}},find:function(a){var%20d=this,e={},g=[],h,f,n,r,u,l=function(a,b){return%20d._index[a].list.length-d._index[b].list.length};for(h=0;h%3Ca.length;h++){r=a[h];if(r%20instanceof%20Array){if(0===r.length)continue;if(1===r.length)r=r[0];else{n=!1;for(f=0;f%3Cr.length;f++)if(!this._index[r[f]]){n=%20!0;break}if(n)continue;r=r.slice(0).sort(l);u=r.slice(1);1===u.length&&(u=u[0]);for(f=0;f%3Cthis._index[r[0]].list.length;f++)if(n=this._index[r[0]].list[f],(this._key?!e[n[this._key]]:-1===g.indexOf(n))&&n.tags.has(u))this._key&&(e[n[this._key]]=!0),g.push(n);continue}}if(r&&%22string%22===typeof%20r&&this._index[r])for(f=0;f%3Cthis._index[r].list.length;f++)n=this._index[r].list[f],this._key?e[n[this._key]]||(e[n[this._key]]=!0,g.push(n)):-1===g.indexOf(n)&&g.push(n)}return%20g}};var%20a=function(a){this._index=%20{};this._list=[];this._parent=a;pc.events.attach(this)};a.prototype={add:function(){var%20a=!1,d=this._processArguments(arguments,!0);if(!d.length)return%20a;for(var%20e=0;e%3Cd.length;e++)this._index[d[e]]||(a=!0,this._index[d[e]]=!0,this._list.push(d[e]),this.fire(%22add%22,d[e],this._parent));a&&this.fire(%22change%22,this._parent);return%20a},remove:function(){var%20a=!1;if(!this._list.length)return%20a;var%20d=this._processArguments(arguments,!0);if(!d.length)return%20a;for(var%20e=0;e%3Cd.length;e++)this._index[d[e]]&&(a=%20!0,delete%20this._index[d[e]],this._list.splice(this._list.indexOf(d[e]),1),this.fire(%22remove%22,d[e],this._parent));a&&this.fire(%22change%22,this._parent);return%20a},clear:function(){if(this._list.length){var%20a=this._list.slice(0);this._list=[];this._index={};for(var%20d=0;d%3Ca.length;d++)this.fire(%22remove%22,a[d],this._parent);this.fire(%22change%22,this._parent)}},has:function(){if(!this._list.length)return!1;var%20a=this._processArguments(arguments);if(!a.length)return!1;for(var%20d=0;d%3Ca.length;d++)if(1===a[d].length){if(this._index[a[d][0]])return!0}else{for(var%20e=%20!0,g=0;g%3Ca[d].length;g++)if(!this._index[a[d][g]]){e=!1;break}if(e)return!0}return!1},list:function(){return%20this._list.slice(0)},_processArguments:function(a,d){var%20e=[],g=[];if(!a||!a.length)return%20e;for(var%20h=0;h%3Ca.length;h++)if(a[h]instanceof%20Array){d||(g=[]);for(var%20f=0;f%3Ca[h].length;f++)%22string%22===typeof%20a[h][f]&&(d?e.push(a[h][f]):g.push(a[h][f]));!d&&g.length&&e.push(g)}else%22string%22===typeof%20a[h]&&(d?e.push(a[h]):e.push([a[h]]));return%20e}};Object.defineProperty(a.prototype,%22size%22,{get:function(){return%20this._list.length}});%20return{TagsCache:f,Tags:a}}());pc.dom=function(){return{getWidth:function(f){return%20f.offsetWidth},getHeight:function(f){return%20f.offsetHeight},setText:function(f,a){f.textContent?f.textContent=a:f.innerText&&(f.innerText=a)},getText:function(f){return%20f.textContent||f.innerText}}}();pc.extend(pc,function(){var%20f=function(a,d){this.objects=[];this.ctor=a;this.name=d.name;this.useNew=void%200===d.useNew||d.useNew;if(this.metrics=d.metrics)this.used=this.total=0};f.prototype={_construct:function(a,d){function%20e(){return%20a.apply(this,d)}e.prototype=a.prototype;return%20new%20e},allocate:function(){var%20a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),this.metrics&&%20(this.total++,this.used++));return%20a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return%20pc.string.format(%22{0}%20-%20total:%20{1},%20used:%20{2}%22,this.name,this.total,this.used)}};var%20a=function(a,d){this._constructor=a;this._pool=[];this._count=0;this._resize(d)};a.prototype={_resize:function(a){if(a%3Ethis._pool.length)for(var%20d=this._pool.length;d%3Ca;d++)this._pool[d]=new%20this._constructor},allocate:function(){this._count%3E=this._pool.length&&this._resize(2*%20this._pool.length);return%20this._pool[this._count++]},freeAll:function(){this._count=0}};return{AllocatePool:a,ObjectPool:f}}());pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,INV_LOG2:1/Math.log(2),clamp:function(f,a,b){return%20f%3E=b?b:f%3C=a?a:f},intToBytes24:function(f){return[f%3E%3E16&255,f%3E%3E8&255,f&255]},intToBytes32:function(f){return[f%3E%3E24&255,f%3E%3E16&255,f%3E%3E8&255,f&255]},bytesToInt24:function(f,a,b){f.length&&(b=f[2],a=f[1],f=f[0]);return%20f%3C%3C16|a%3C%3C8|b},bytesToInt32:function(f,a,b,d){f.length&&(d=f[3],b=f[2],a=f[1],f=f[0]);return(f%3C%3C24|a%3C%3C16|b%3C%3C8|d)%3E%3E%3E32},lerp:function(f,a,b){return%20f+(a-f)*pc.math.clamp(b,0,1)},lerpAngle:function(f,%20a,b){180%3Ca-f&&(a-=360);-180%3Ea-f&&(a+=360);return%20pc.math.lerp(f,a,pc.math.clamp(b,0,1))},powerOfTwo:function(f){return%200!==f&&!(f&f-1)},nextPowerOfTwo:function(f){f--;f|=f%3E%3E1;f|=f%3E%3E2;f|=f%3E%3E4;f|=f%3E%3E8;f|=f%3E%3E16;f++;return%20f},random:function(f,a){return%20Math.random()*(a-f)+f},smoothstep:function(f,a,b){if(b%3C=f)return%200;if(b%3E=a)return%201;b=(b-f)/(a-f);return%20b*b*(3-2*b)},smootherstep:function(f,a,b){if(b%3C=f)return%200;if(b%3E=a)return%201;b=(b-f)/(a-f);return%20b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;%20pc.math.bytesToInt=pc.math.bytesToInt32;Math.log2||(Math.log2=function(f){return%20Math.log(f)*pc.math.INV_LOG2});pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};f.prototype={add:function(a){var%20b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return%20this},add2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];return%20this},clone:function(){return(new%20f).copy(this)},copy:function(a){var%20b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return%20this},dot:function(a){var%20b=this.data,a=a.data;return%20b[0]*%20a[0]+b[1]*a[1]},equals:function(a){var%20b=this.data,a=a.data;return%20b[0]===a[0]&&b[1]===a[1]},length:function(){var%20a=this.data;return%20Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var%20a=this.data;return%20a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,d){var%20a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);return%20this},mul:function(a){var%20b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return%20this},mul2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];%20return%20this},normalize:function(){return%20this.scale(1/this.length())},scale:function(a){var%20b=this.data;b[0]*=a;b[1]*=a;return%20this},set:function(a,b){var%20d=this.data;d[0]=a;d[1]=b;return%20this},sub:function(a){var%20b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return%20this},sub2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];return%20this},toString:function(){return%22[%22+this.data[0]+%22,%20%22+this.data[1]+%22]%22}};Object.defineProperty(f.prototype,%22x%22,{get:function(){return%20this.data[0]},%20set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,%22y%22,{get:function(){return%20this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f,%22ONE%22,{get:function(){var%20a=new%20f(1,1);return%20function(){return%20a}}()});Object.defineProperty(f,%22RIGHT%22,{get:function(){var%20a=new%20f(1,0);return%20function(){return%20a}}()});Object.defineProperty(f,%22UP%22,{get:function(){var%20a=new%20f(0,1);return%20function(){return%20a}}()});Object.defineProperty(f,%22ZERO%22,{get:function(){var%20a=new%20f(0,0);return%20function(){return%20a}}()});%20return{Vec2:f}}());pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};f.prototype={add:function(a){var%20b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return%20this},add2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];return%20this},clone:function(){return(new%20f).copy(this)},copy:function(a){var%20b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return%20this},%20cross:function(a,b){var%20d,e,g,h,f,n,r;d=a.data;e=b.data;g=this.data;h=d[0];f=d[1];d=d[2];n=e[0];r=e[1];e=e[2];g[0]=f*e-r*d;g[1]=d*n-e*h;g[2]=h*r-n*f;return%20this},dot:function(a){var%20b=this.data,a=a.data;return%20b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var%20b=this.data,a=a.data;return%20b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var%20a=this.data;return%20Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var%20a=this.data;return%20a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,%20b,d){var%20a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);e[2]=a[2]+d*(b[2]-a[2]);return%20this},mul:function(a){var%20b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return%20this},mul2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];g[2]=d[2]*e[2];return%20this},normalize:function(){return%20this.scale(1/this.length())},project:function(a){var%20b=this.data,a=a.data,d=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*d;%20b[1]=a[1]*d;b[2]=a[2]*d;return%20this},scale:function(a){var%20b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return%20this},set:function(a,b,d){var%20e=this.data;e[0]=a;e[1]=b;e[2]=d;return%20this},sub:function(a){var%20b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return%20this},sub2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];g[2]=d[2]-e[2];return%20this},toString:function(){return%22[%22+this.data[0]+%22,%20%22+this.data[1]+%22,%20%22+this.data[2]+%22]%22}};Object.defineProperty(f.prototype,%22x%22,{get:function(){return%20this.data[0]},%20set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,%22y%22,{get:function(){return%20this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,%22z%22,{get:function(){return%20this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f,%22BACK%22,{get:function(){var%20a=new%20f(0,0,1);return%20function(){return%20a}}()});Object.defineProperty(f,%22DOWN%22,{get:function(){var%20a=new%20f(0,-1,0);return%20function(){return%20a}}()});Object.defineProperty(f,%22FORWARD%22,{get:function(){var%20a=%20new%20f(0,0,-1);return%20function(){return%20a}}()});Object.defineProperty(f,%22LEFT%22,{get:function(){var%20a=new%20f(-1,0,0);return%20function(){return%20a}}()});Object.defineProperty(f,%22ONE%22,{get:function(){var%20a=new%20f(1,1,1);return%20function(){return%20a}}()});Object.defineProperty(f,%22RIGHT%22,{get:function(){var%20a=new%20f(1,0,0);return%20function(){return%20a}}()});Object.defineProperty(f,%22UP%22,{get:function(){var%20a=new%20f(0,1,0);return%20function(){return%20a}}()});Object.defineProperty(f,%22ZERO%22,{get:function(){var%20a=new%20f(0,%200,0);return%20function(){return%20a}}()});return{Vec3:f}}());pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};f.prototype={add:function(a){var%20b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return%20this},add2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];g[3]=d[3]+e[3];return%20this},clone:function(){return(new%20f).copy(this)},copy:function(a){var%20b=this.data,a=a.data;%20b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return%20this},dot:function(a){var%20b=this.data,a=a.data;return%20b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var%20b=this.data,a=a.data;return%20b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var%20a=this.data;return%20Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var%20a=this.data;return%20a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,d){var%20a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);%20e[1]=a[1]+d*(b[1]-a[1]);e[2]=a[2]+d*(b[2]-a[2]);e[3]=a[3]+d*(b[3]-a[3]);return%20this},mul:function(a){var%20b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return%20this},mul2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];g[2]=d[2]*e[2];g[3]=d[3]*e[3];return%20this},normalize:function(){return%20this.scale(1/this.length())},scale:function(a){var%20b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return%20this},set:function(a,b,d,e){var%20g=this.data;g[0]=a;g[1]=b;g[2]=%20d;g[3]=e;return%20this},sub:function(a){var%20b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return%20this},sub2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];g[2]=d[2]-e[2];g[3]=d[3]-e[3];return%20this},toString:function(){return%22[%22+this.data[0]+%22,%20%22+this.data[1]+%22,%20%22+this.data[2]+%22,%20%22+this.data[3]+%22]%22}};Object.defineProperty(f.prototype,%22x%22,{get:function(){return%20this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,%22y%22,{get:function(){return%20this.data[1]},%20set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,%22z%22,{get:function(){return%20this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f.prototype,%22w%22,{get:function(){return%20this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(f,%22ONE%22,{get:function(){var%20a=new%20f(1,1,1,1);return%20function(){return%20a}}()});Object.defineProperty(f,%22ZERO%22,{get:function(){var%20a=new%20f(0,0,0,0);return%20function(){return%20a}}()});return{Vec4:f}}());pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};f.prototype={clone:function(){return(new%20pc.Mat3).copy(this)},copy:function(a){var%20a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return%20this},equals:function(a){var%20b=this.data,a=a.data;return%20b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===%20a[8]},isIdentity:function(){var%20a=this.data;return%201===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var%20a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return%20this},toString:function(){for(var%20a=%22[%22,b=0;9%3Eb;b++)a+=this.data[b],a+=9!==b?%22,%20%22:%22%22;return%20a+%22]%22},transpose:function(){var%20a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return%20this}};Object.defineProperty(f,%22IDENTITY%22,%20{get:function(){var%20a=new%20f;return%20function(){return%20a}}()});Object.defineProperty(f,%22ZERO%22,{get:function(){var%20a=new%20f(0,0,0,0,0,0,0,0,0);return%20function(){return%20a}}()});return{Mat3:f}}());pc.extend(pc,function(){var%20f=function(){this.data=new%20Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,d;a=new%20pc.Vec3;b=new%20pc.Vec3;d=new%20pc.Vec3;var%20e,g,h;e=new%20pc.Vec3;g=new%20pc.Vec3;h=new%20pc.Vec3;var%20k=new%20pc.Vec3;f.prototype={add2:function(a,b){var%20d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];g[3]=d[3]+e[3];g[4]=d[4]+e[4];g[5]=d[5]+e[5];g[6]=d[6]+e[6];g[7]=d[7]+e[7];g[8]=d[8]+e[8];g[9]=d[9]+e[9];g[10]=d[10]+e[10];g[11]=d[11]+%20e[11];g[12]=d[12]+e[12];g[13]=d[13]+e[13];g[14]=d[14]+e[14];g[15]=d[15]+e[15];return%20this},add:function(a){return%20this.add2(this,a)},clone:function(){return(new%20pc.Mat4).copy(this)},copy:function(a){var%20a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return%20this},equals:function(a){var%20b=this.data,a=a.data;return%20b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===%20a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var%20a=this.data;return%201===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var%20d,e,g,h,f,k,y,x,A,C,B,z,E,G,R,I,P,Q,M,J;I=a.data;var%20N=b.data,U=this.data;d=I[0];e=I[1];g=I[2];%20h=I[3];f=I[4];k=I[5];y=I[6];x=I[7];A=I[8];C=I[9];B=I[10];z=I[11];E=I[12];G=I[13];R=I[14];I=I[15];P=N[0];Q=N[1];M=N[2];J=N[3];U[0]=d*P+f*Q+A*M+E*J;U[1]=e*P+k*Q+C*M+G*J;U[2]=g*P+y*Q+B*M+R*J;U[3]=h*P+x*Q+z*M+I*J;P=N[4];Q=N[5];M=N[6];J=N[7];U[4]=d*P+f*Q+A*M+E*J;U[5]=e*P+k*Q+C*M+G*J;U[6]=g*P+y*Q+B*M+R*J;U[7]=h*P+x*Q+z*M+I*J;P=N[8];Q=N[9];M=N[10];J=N[11];U[8]=d*P+f*Q+A*M+E*J;U[9]=e*P+k*Q+C*M+G*J;U[10]=g*P+y*Q+B*M+R*J;U[11]=h*P+x*Q+z*M+I*J;P=N[12];Q=N[13];M=N[14];J=N[15];U[12]=d*P+f*Q+A*M+E*J;U[13]=e*P+%20k*Q+C*M+G*J;U[14]=g*P+y*Q+B*M+R*J;U[15]=h*P+x*Q+z*M+I*J;return%20this},mul:function(a){return%20this.mul2(this,a)},transformPoint:function(a,b){var%20d=this.data,e=a.data,b=void%200===b?new%20pc.Vec3:b;return%20b.set(e[0]*d[0]+e[1]*d[4]+e[2]*d[8]+d[12],e[0]*d[1]+e[1]*d[5]+e[2]*d[9]+d[13],e[0]*d[2]+e[1]*d[6]+e[2]*d[10]+d[14])},transformVector:function(a,b){var%20d=this.data,e=a.data,b=void%200===b?new%20pc.Vec3:b;return%20b.set(e[0]*d[0]+e[1]*d[4]+e[2]*d[8],e[0]*d[1]+e[1]*d[5]+e[2]*d[9],e[0]*d[2]+e[1]*d[6]+e[2]*d[10])},%20setLookAt:function(e,g,h){d.sub2(e,g).normalize();b.copy(h).normalize();a.cross(b,d).normalize();b.cross(d,a);g=this.data;g[0]=a.x;g[1]=a.y;g[2]=a.z;g[3]=0;g[4]=b.x;g[5]=b.y;g[6]=b.z;g[7]=0;g[8]=d.x;g[9]=d.y;g[10]=d.z;g[11]=0;g[12]=e.x;g[13]=e.y;g[14]=e.z;g[15]=1;return%20this},setFrustum:function(a,b,d,e,g,h){var%20f,k,y,x,A;f=2*g;k=b-a;y=e-d;x=h-g;A=this.data;A[0]=f/k;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=f/y;A[6]=0;A[7]=0;A[8]=(b+a)/k;A[9]=(e+d)/y;A[10]=(-h-g)/x;A[11]=-1;A[12]=0;A[13]=0;A[14]=-f*h/x;A[15]=%200;return%20this},setPerspective:function(a,b,d,e,g){g?(a=d*Math.tan(a*Math.PI/360),g=a/b):(g=d*Math.tan(a*Math.PI/360),a=g*b);return%20this.setFrustum(-a,a,-g,g,d,e)},setOrtho:function(a,b,d,e,g,h){var%20f=this.data;f[0]=2/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/(e-d);f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/(h-g);f[11]=0;f[12]=-(b+a)/(b-a);f[13]=-(e+d)/(e-d);f[14]=-(h+g)/(h-g);f[15]=1;return%20this},setFromAxisAngle:function(a,b){var%20d,e,g,h,f,k,y,x,A,b=b*pc.math.DEG_TO_RAD;d=a.x;e=a.y;g=a.z;h=Math.cos(b);%20f=Math.sin(b);k=1-h;y=k*d;x=k*e;A=this.data;A[0]=y*d+h;A[1]=y*e+f*g;A[2]=y*g-f*e;A[3]=0;A[4]=y*e-f*g;A[5]=x*e+h;A[6]=x*g+f*d;A[7]=0;A[8]=y*g+f*e;A[9]=x*g-d*f;A[10]=k*g*g+h;A[11]=0;A[12]=0;A[13]=0;A[14]=0;A[15]=1;return%20this},setTranslate:function(a,b,d){var%20e=this.data;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a;e[13]=b;e[14]=d;e[15]=1;return%20this},setScale:function(a,b,d){var%20e=this.data;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=%200;e[9]=0;e[10]=d;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return%20this},invert:function(){var%20a,b,d,e,g,h,f,k,y,x,A,C,B,z,E,G,R,I,P,Q,M,J,N,U,ba,F,O,da,H,T;T=this.data;a=T[0];b=T[1];d=T[2];e=T[3];g=T[4];h=T[5];f=T[6];k=T[7];y=T[8];x=T[9];A=T[10];C=T[11];B=T[12];z=T[13];E=T[14];G=T[15];R=a*h-b*g;I=a*f-d*g;P=a*k-e*g;Q=b*f-d*h;M=b*k-e*h;J=d*k-e*f;N=y*z-x*B;U=y*E-A*B;ba=y*G-C*B;F=x*E-A*z;O=x*G-C*z;da=A*G-C*E;H=1/(R*da-I*O+P*F+Q*ba-M*U+J*N);T[0]=(h*da-f*O+k*F)*H;T[1]=(-b*da+d*O-e*F)*H;T[2]=(z*J-E*M+G*Q)*%20H;T[3]=(-x*J+A*M-C*Q)*H;T[4]=(-g*da+f*ba-k*U)*H;T[5]=(a*da-d*ba+e*U)*H;T[6]=(-B*J+E*P-G*I)*H;T[7]=(y*J-A*P+C*I)*H;T[8]=(g*O-h*ba+k*N)*H;T[9]=(-a*O+b*ba-e*N)*H;T[10]=(B*M-z*P+G*R)*H;T[11]=(-y*M+x*P-C*R)*H;T[12]=(-g*F+h*U-f*N)*H;T[13]=(a*F-b*U+d*N)*H;T[14]=(-B*Q+z*I-E*R)*H;T[15]=(y*Q-x*I+A*R)*H;return%20this},setIdentity:function(){var%20a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return%20this},setTRS:function(a,b,d){var%20e,%20g,h,f,k,y,x,A,C,B,z,E,G;e=a.x;g=a.y;a=a.z;h=b.x;f=b.y;k=b.z;y=b.w;b=d.x;x=d.y;d=d.z;A=h+h;C=f+f;B=k+k;z=h*A;E=h*C;h*=B;G=f*C;f*=B;k*=B;A*=y;C*=y;y*=B;B=this.data;B[0]=(1-(G+k))*b;B[1]=(E+y)*b;B[2]=(h-C)*b;B[3]=0;B[4]=(E-y)*x;B[5]=(1-(z+k))*x;B[6]=(f+A)*x;B[7]=0;B[8]=(h+C)*d;B[9]=(f-A)*d;B[10]=(1-(z+G))*d;B[11]=0;B[12]=e;B[13]=g;B[14]=a;B[15]=1;return%20this},transpose:function(){var%20a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];%20b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return%20this},invertTo3x3:function(a){var%20b,d,e,g,h,f,k,y,x,A;x=this.data;A=a.data;a=x[10]*x[5]-x[6]*x[9];b=-x[10]*x[1]+x[2]*x[9];d=x[6]*x[1]-x[2]*x[5];e=-x[10]*x[4]+x[6]*x[8];g=x[10]*x[0]-x[2]*x[8];h=-x[6]*x[0]+x[2]*x[4];f=x[9]*x[4]-x[5]*x[8];k=-x[9]*x[0]+x[1]*x[8];y=x[5]*x[0]-x[1]*x[4];x=x[0]*a+x[1]*e+x[2]*f;if(0===x)return%20console.warn(%22pc.Mat4#invertTo3x3:%20Matrix%20not%20invertible%22),this;x=1/x;A[0]=x*a;A[1]=x*b;A[2]=x*d;A[3]=x*e;A[4]=x*g;A[5]=x*h;A[6]=%20x*f;A[7]=x*k;A[8]=x*y;return%20this},getTranslation:function(a){a=void%200===a?new%20pc.Vec3:a;return%20a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void%200===a?new%20pc.Vec3:a;return%20a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void%200===a?new%20pc.Vec3:a;return%20a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void%200===a?new%20pc.Vec3:a;return%20a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void%200===a?new%20pc.Vec3:a;this.getX(e);%20this.getY(g);this.getZ(h);a.set(e.length(),g.length(),h.length());return%20a},setFromEulerAngles:function(a,b,d){var%20e,g,h,f,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,d=d*pc.math.DEG_TO_RAD;e=Math.sin(-a);a=Math.cos(-a);g=Math.sin(-b);b=Math.cos(-b);h=Math.sin(-d);d=Math.cos(-d);f=this.data;f[0]=b*d;f[1]=-b*h;f[2]=g;f[3]=0;f[4]=a*h+d*e*g;f[5]=a*d-e*g*h;f[6]=-b*e;f[7]=0;f[8]=e*h-a*d*g;f[9]=d*e+a*g*h;f[10]=a*b;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return%20this},getEulerAngles:function(a){var%20b,d,%20e,g,h,f,a=void%200===a?new%20pc.Vec3:a;this.getScale(k);e=k.x;b=k.y;g=k.z;h=this.data;d=Math.asin(-h[2]/e);f=0.5*Math.PI;d%3Cf?d%3E-f?(b=Math.atan2(h[6]/b,h[10]/g),e=Math.atan2(h[1]/e,h[0]/e)):(e=0,b=-Math.atan2(h[4]/b,h[5]/b)):(e=0,b=Math.atan2(h[4]/b,h[5]/b));return%20a.set(b,d,e).scale(pc.math.RAD_TO_DEG)},toString:function(){var%20a,b;b=%22[%22;for(a=0;16%3Ea;a+=1)b+=this.data[a],b+=15!==a?%22,%20%22:%22%22;return%20b+%22]%22}};Object.defineProperty(f,%22IDENTITY%22,{get:function(){var%20a=new%20f;return%20function(){return%20a}}()});Object.defineProperty(f,%20%22ZERO%22,{get:function(){var%20a=new%20f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return%20function(){return%20a}}()});return{Mat4:f}}());pc.extend(pc,function(){var%20f=function(a,b,d,e){this.x=void%200===a?0:a;this.y=void%200===b?0:b;this.z=void%200===d?0:d;this.w=void%200===e?1:e};f.prototype={clone:function(){return%20new%20pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return%20this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return%20this},equals:function(a){return%20this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var%20b,d,e,g,h,f,a=void%200===a?new%20pc.Vec3:%20a;e=this.x;g=this.y;h=this.z;f=this.w;d=2*(f*g-e*h);-0.99999%3E=d?(b=2*Math.atan2(e,f),d=-Math.PI/2,e=0):0.99999%3C=d?(b=2*Math.atan2(e,f),d=Math.PI/2,e=0):(b=Math.atan2(2*(f*e+g*h),1-2*(e*e+g*g)),d=Math.asin(d),e=Math.atan2(2*(f*h+e*g),1-2*(g*g+h*h)));return%20a.set(b,d,e).scale(pc.math.RAD_TO_DEG)},invert:function(){return%20this.conjugate().normalize()},length:function(){var%20a,b,d,e;a=this.x;b=this.y;d=this.z;e=this.w;return%20Math.sqrt(a*a+b*b+d*d+e*e)},lengthSq:function(){var%20a=this.data;return%20a[0]*a[0]+%20a[1]*a[1]+a[2]*a[2]},mul:function(a){var%20b,d,e,g,h,f,n;b=this.x;d=this.y;e=this.z;g=this.w;h=a.x;f=a.y;n=a.z;a=a.w;this.x=g*h+b*a+d*n-e*f;this.y=g*f+d*a+e*h-b*n;this.z=g*n+e*a+b*f-d*h;this.w=g*a-b*h-d*f-e*n;return%20this},mul2:function(a,b){var%20d,e,g,h,f,n,r,u;d=a.x;e=a.y;g=a.z;h=a.w;f=b.x;n=b.y;r=b.z;u=b.w;this.x=h*f+d*u+e*r-g*n;this.y=h*n+e*u+g*f-d*r;this.z=h*r+g*u+d*n-e*f;this.w=h*u-d*f-e*n-g*r;return%20this},normalize:function(){var%20a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=%20a,this.y*=a,this.z*=a,this.w*=a);return%20this},set:function(a,b,d,e){this.x=a;this.y=b;this.z=d;this.w=e;return%20this},setFromAxisAngle:function(a,b){var%20d,e,b=b*0.5*pc.math.DEG_TO_RAD;d=Math.sin(b);e=Math.cos(b);this.x=d*a.x;this.y=d*a.y;this.z=d*a.z;this.w=e;return%20this},setFromEulerAngles:function(a,b,d){var%20e,g,h;e=0.5*pc.math.DEG_TO_RAD;a*=e;b*=e;d*=e;e=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);h=Math.sin(d);d=Math.cos(d);this.x=e*b*d-a*g*h;this.y=a*g*d+e*b*h;this.z=a*b*h-e*g*d;this.w=%20a*b*d+e*g*h;return%20this},setFromMat4:function(a){var%20b,d,e,g,h,f,n,r,u,l,m,a=a.data;b=a[0];d=a[1];e=a[2];g=a[4];h=a[5];f=a[6];n=a[8];r=a[9];a=a[10];u=1/Math.sqrt(b*b+d*d+e*e);l=1/Math.sqrt(g*g+h*h+f*f);m=1/Math.sqrt(n*n+r*r+a*a);b*=u;d*=u;e*=u;g*=l;h*=l;f*=l;n*=m;r*=m;a*=m;u=b+h+a;0%3C=u?(b=Math.sqrt(u+1),this.w=0.5*b,b=0.5/b,this.x=(f-r)*b,this.y=(n-e)*b,this.z=(d-g)*b):b%3Eh?b%3Ea?(b=Math.sqrt(b-(h+a)+1),this.x=0.5*b,b=0.5/b,this.w=(f-r)*b,this.y=(d+g)*b,this.z=(e+n)*b):(b=Math.sqrt(a-(b+h)+1),this.z=%200.5*b,b=0.5/b,this.w=(d-g)*b,this.x=(n+e)*b,this.y=(r+f)*b):h%3Ea?(b=Math.sqrt(h-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(n-e)*b,this.z=(f+r)*b,this.x=(g+d)*b):(b=Math.sqrt(a-(b+h)+1),this.z=0.5*b,b=0.5/b,this.w=(d-g)*b,this.x=(n+e)*b,this.y=(r+f)*b);return%20this},slerp:function(a,b,d){var%20e,g,h,f,n,r;e=a.x;g=a.y;h=a.z;a=a.w;f=b.x;n=b.y;r=b.z;var%20b=b.w,u=a*b+e*f+g*n+h*r;0%3Eu&&(b=-b,f=-f,n=-n,r=-r,u=-u);if(1%3C=Math.abs(u))return%20this.w=a,this.x=e,this.y=g,this.z=h,this;var%20l=Math.acos(u),m=Math.sqrt(1-u*u);%20if(0.001%3EMath.abs(m))return%20this.w=0.5*a+0.5*b,this.x=0.5*e+0.5*f,this.y=0.5*g+0.5*n,this.z=0.5*h+0.5*r,this;u=Math.sin((1-d)*l)/m;d=Math.sin(d*l)/m;this.w=a*u+b*d;this.x=e*u+f*d;this.y=g*u+n*d;this.z=h*u+r*d;return%20this},transformVector:function(a,b){void%200===b&&(b=new%20pc.Vec3);var%20d=a.x,e=a.y,g=a.z,h=this.x,f=this.y,n=this.z,r=this.w,u=r*d+f*g-n*e,l=r*e+n*d-h*g,m=r*g+h*e-f*d,d=-h*d-f*e-n*g;b.x=u*r+d*-h+l*-n-m*-f;b.y=l*r+d*-f+m*-h-u*-n;b.z=m*r+d*-n+u*-f-l*-h;return%20b},toString:function(){return%22[%22+%20this.x+%22,%20%22+this.y+%22,%20%22+this.z+%22,%20%22+this.w+%22]%22}};Object.defineProperty(f,%22IDENTITY%22,{get:function(){var%20a=new%20f;return%20function(){return%20a}}()});Object.defineProperty(f,%22ZERO%22,{get:function(){var%20a=new%20f(0,0,0,0);return%20function(){return%20a}}()});return{Quat:f}}());pc.extend(pc,function(){var%20f=function(a){this.keys=[];this.type=1;this.tension=0.5;if(a)for(var%20b=0;b%3Ca.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};f.prototype={add:function(a,b){for(var%20d=this.keys,e=d.length,g=0;g%3Ce&&!(d[g][0]%3Ea);g++);d=[a,b];this.keys.splice(g,0,d);return%20d},get:function(a){return%20this.keys[a]},sort:function(){this.keys.sort(function(a,b){return%20a[0]-b[0]})},value:function(a){var%20b=this.keys;if(!b.length)return%200;if(a%3Cb[0][0])return%20b[0][1];if(a%3Eb[b.length-1][0])return%20b[b.length-%201][1];for(var%20d=0,e=b.length?b[0][1]:0,g=1,h=0,f=0,n=b.length;f%3Cn;f++){if(b[f][0]===a)return%20b[f][1];h=b[f][1];if(a%3Cb[f][0]){g=b[f][0];break}d=b[f][0];e=b[f][1]}n=g-d;a=0===n?0:(a-d)/n;if(1===this.type)a*=a*(3-2*a);else%20if(2===this.type||3===this.type){var%20n=e+(e-h),r=h+(h-e),u=g=d=g-d;0%3Cf&&(f-=1);0%3Cf&&(n=b[f-1][1],g=b[f][0]-b[f-1][0]);b.length%3Ef+1&&(d=b[f+1][0]-b[f][0]);b.length%3Ef+2&&(u=b[f+2][0]-b[f+1][0],r=b[f+2][1]);n=e+(n-e)*d/g;r=h+(r-h)*d/u;return%202===this.type?this._interpolateCatmullRom(n,%20e,h,r,a):this._interpolateCardinal(n,e,h,r,a,this.tension)}return%20pc.math.lerp(e,h,a)},_interpolateHermite:function(a,b,d,e,g){var%20f=g*g,k=g*g*g;return%20a*(2*k-3*f+1)+b*(-2*k+3*f)+d*(k-2*f+g)+e*(k-f)},_interpolateCardinal:function(a,b,d,e,g,f){return%20this._interpolateHermite(b,d,f*(d-a),f*(e-b),g)},_interpolateCatmullRom:function(a,b,d,e,g){return%20this._interpolateCardinal(a,b,d,e,g,0.5)},closest:function(a){for(var%20b=this.keys,d=b.length,e=2,g=null,f=0;f%3Cd;f++){var%20k=Math.abs(a-b[f][0]);if(e%3E=k)e=%20k,g=b[f];else%20break}return%20g},clone:function(){var%20a=new%20pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return%20a},quantize:function(a){for(var%20a=Math.max(a,2),b=new%20Float32Array(a),d=1/(a-1),e=0;e%3Ca;e++){var%20g=this.value(d*e);b[e]=g}return%20b}};Object.defineProperty(f.prototype,%22length%22,{get:function(){return%20this.keys.length}});return{Curve:f,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var%20f=function(){var%20a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1%3Carguments.length)for(a=0;a%3Carguments.length;a++)this.curves.push(new%20pc.Curve(arguments[a]));else%20if(0===arguments.length)this.curves.push(new%20pc.Curve);else{var%20b=arguments[0];if(%22number%22===pc.type(b))for(a=0;a%3Cb;a++)this.curves.push(new%20pc.Curve);else%20for(a=0;a%3Cb.length;a++)this.curves.push(new%20pc.Curve(b[a]))}};f.prototype={get:function(a){return%20this.curves[a]},value:function(a,b){var%20d=this.curves.length,%20b=b||[];b.length=d;for(var%20e=0;e%3Cd;e++)b[e]=this.curves[e].value(a);return%20b},clone:function(){var%20a=new%20pc.CurveSet;a.curves=[];for(var%20b=0;b%3Cthis.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return%20a},quantize:function(a){for(var%20a=Math.max(a,2),b=this.curves.length,d=new%20Float32Array(a*b),e=1/(a-1),g=[],f=0;f%3Ca;f++){var%20k=this.value(e*f,g);if(1==b)d[f]=k[0];else%20for(var%20n=0;n%3Cb;n++)d[f*b+n]=k[n]}return%20d}};Object.defineProperty(f.prototype,%22length%22,{get:function(){return%20this.curves.length}});%20Object.defineProperty(f.prototype,%22type%22,{get:function(){return%20this._type},set:function(a){this._type=a;for(var%20b=0;b%3Cthis.curves.length;b++)this.curves[b].type=a}});return{CurveSet:f}}());pc.extend(pc,function(){var%20f=new%20pc.Vec3,a=new%20pc.Vec3,b=new%20pc.Vec3,d=new%20pc.Vec3,e=new%20pc.Vec3,g=new%20pc.Vec3,h=function(a,b){this.center=a||new%20pc.Vec3(0,0,0);this.halfExtents=b||new%20pc.Vec3(0.5,0.5,0.5);this._min=new%20pc.Vec3;this._max=new%20pc.Vec3};h.prototype={add:function(a){var%20b=this.center,d=this.halfExtents,e=b.x-d.x,g=b.x+d.x,f=b.y-d.y,h=b.y+d.y,s=b.z-d.z,D=b.z+d.z,y=a.center,x=a.halfExtents,a=y.x-x.x,A=y.x+x.x,C=y.y-x.y,B=y.y+x.y,z=y.z-x.z,y=y.z+x.z;a%3Ce&&(e=a);A%3Eg&&(g=A);C%3Cf&&(f=C);B%3Eh&&%20(h=B);z%3Cs&&(s=z);y%3ED&&(D=y);b.set(e+g,f+h,s+D).scale(0.5);d.set(g-e,h-f,D-s).scale(0.5)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},intersects:function(a){var%20b=this.getMax(),d=this.getMin(),e=a.getMax(),a=a.getMin();return%20d.x%3C=e.x&&b.x%3E=a.x&&d.y%3C=e.y&&b.y%3E=a.y&&d.z%3C=e.z&&b.z%3E=a.z},intersectsRay:function(h){var%20n=g.copy(h.direction).normalize();f.sub2(h.origin,aabb.center);d.set(Math.abs(f.x),Math.abs(f.y),Math.abs(f.z));b.mul2(f,n);if(d.x%3E%20aabb.halfExtents.x&&0%3C=b.x||d.y%3Eaabb.halfExtents.y&&0%3C=b.y||d.z%3Eaabb.halfExtents.z&&0%3C=b.z)return!1;e.set(Math.abs(n.x),Math.abs(n.y),Math.abs(n.z));a.cross(n,f);a.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));return%20a.x%3Eaabb.halfExtents.y*e.z+aabb.halfExtents.z*e.y||a.y%3Eaabb.halfExtents.x*e.z+aabb.halfExtents.z*e.x||a.z%3Eaabb.halfExtents.x*e.y+aabb.halfExtents.y*e.x?!1:!0},setMinMax:function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)},getMin:function(){return%20this._min.copy(this.center).sub(this.halfExtents)},%20getMax:function(){return%20this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(a){var%20b=this.getMin(),d=this.getMax(),e;for(e=0;3%3Ee;++e)if(a.data[e]%3Cb.data[e]||a.data[e]%3Ed.data[e])return!1;return!0},setFromTransformedAabb:function(a,b){var%20d=this.center,e=this.halfExtents,g=a.center.data,f=a.halfExtents.data,b=b.data,h=b[0],s=b[4],D=b[8],y=b[1],x=b[5],A=b[9],C=b[2],B=b[6],z=b[10],E=Math.abs(h),G=Math.abs(s),R=Math.abs(D),I=Math.abs(y),P=Math.abs(x),Q=Math.abs(A),M=Math.abs(C),%20J=Math.abs(B),N=Math.abs(z);d.set(b[12]+h*g[0]+s*g[1]+D*g[2],b[13]+y*g[0]+x*g[1]+A*g[2],b[14]+C*g[0]+B*g[1]+z*g[2]);e.set(E*f[0]+G*f[1]+R*f[2],I*f[0]+P*f[1]+Q*f[2],M*f[0]+J*f[1]+N*f[2])},compute:function(b){for(var%20d=f.set(b[0],b[1],b[2]),e=a.set(b[0],b[1],b[2]),g=b.length/3,h=1;h%3Cg;h++){var%20m=b[3*h+0],w=b[3*h+1],s=b[3*h+2];m%3Cd.x&&(d.x=m);w%3Cd.y&&(d.y=w);s%3Cd.z&&(d.z=s);m%3Ee.x&&(e.x=m);w%3Ee.y&&(e.y=w);s%3Ee.z&&(e.z=s)}this.setMinMax(d,e)}};return{BoundingBox:h}}());pc.extend(pc,function(){function%20f(a,b){this.center=a||new%20pc.Vec3(0,0,0);this.radius=void%200===b?0.5:b}var%20a=new%20pc.Vec3,b=new%20pc.Vec3,d=new%20pc.Vec3,e=new%20pc.Vec3;f.prototype={containsPoint:function(b){var%20b=a.sub2(b,this.center).lengthSq(),d=this.radius;return%20b%3Cd*d},compute:function(g){var%20f,k=g.length/3;for(f=0;f%3Ck;f++)a.set(g[3*f],g[3*f+1],g[3*f+2]),d.addSelf(a),0===f%100&&(d.scale(1/k),b.add(d),d.set(0,0,0));d.scale(1/k);b.add(d);this.center.copy(b);var%20n=0;for(f=0;f%3Ck;f++)a.set(g[3*f],g[3*f+%201],g[3*f+2]),e.sub2(a,this.center),n=Math.max(e.lengthSq(),n);this.radius=Math.sqrt(n)},intersectRay:function(d){var%20e=a.copy(d.origin).sub(this.center),f=e.dot(b.copy(d.direction).normalize()),e=e.dot(e)-this.radius*this.radius;if(0%3Ce&&0%3Cf)return%20null;e=f*f-e;if(0%3Ee)return%20null;t=Math.abs(-f-Math.sqrt(e));return%20d.direction.clone().scale(t).add(d.origin)}};return{BoundingSphere:f}}());pc.extend(pc,function(){var%20f=new%20pc.Mat4,a=function(a,d){a=a||(new%20pc.Mat4).setPerspective(90,16/9,0.1,1E3);d=d||new%20pc.Mat4;this.planes=[];for(var%20e=0;6%3Ee;e++)this.planes[e]=[];this.update(a,d)};a.prototype={update:function(a,d){f.mul2(a,d);var%20e=f.data;this.planes[0][0]=e[3]-e[0];this.planes[0][1]=e[7]-e[4];this.planes[0][2]=e[11]-e[8];this.planes[0][3]=e[15]-e[12];t=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=%20t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=e[3]+e[0];this.planes[1][1]=e[7]+e[4];this.planes[1][2]=e[11]+e[8];this.planes[1][3]=e[15]+e[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=e[3]+e[1];this.planes[2][1]=e[7]+e[5];this.planes[2][2]=e[11]+e[9];this.planes[2][3]=e[15]+e[13];t=%20Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=e[3]-e[1];this.planes[3][1]=e[7]-e[5];this.planes[3][2]=e[11]-e[9];this.planes[3][3]=e[15]-e[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;%20this.planes[3][3]/=t;this.planes[4][0]=e[3]-e[2];this.planes[4][1]=e[7]-e[6];this.planes[4][2]=e[11]-e[10];this.planes[4][3]=e[15]-e[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=e[3]+e[2];this.planes[5][1]=e[7]+e[6];this.planes[5][2]=e[11]+e[10];this.planes[5][3]=e[15]+e[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+%20this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t},containsPoint:function(a){for(var%20d=0;6%3Ed;d++)if(0%3E=this.planes[d][0]*a.x+this.planes[d][1]*a.y+this.planes[d][2]*a.z+this.planes[d][3])return!1;return!0},containsSphere:function(a){var%20d=0,e;for(p=0;6%3Ep;p++){e=this.planes[p][0]*a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(e%3C=-a.radius)return%200;e%3E%20a.radius&&d++}return%206===d?2:1}};return{Frustum:a}}());pc.extend(pc,function(){var%20f=function(a,b){this.normal=b||new%20pc.Vec3(0,0,1);this.point=a||new%20pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point)};f.prototype={distance:function(a){return%20this.normal.dot(a)+this.d},intersect:function(a,b){var%20d=this.distance(a),e=this.distance(b);return%20d/(d-e)},intersectPosition:function(a,b){var%20d=this.intersect(a,b),e=new%20pc.Vec3;e.lerp(a,b,d);return%20e}};return{Plane:f}}());pc.extend(pc,function(){return{Ray:function(f,a){this.origin=f||new%20pc.Vec3(0,0,0);this.direction=a||new%20pc.Vec3(0,0,-1)}}}());(function(){var%20f={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,%20CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,%20INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PIXELFORMAT_ETC1:15,PIXELFORMAT_PVRTC_2BPP_RGB_1:16,PIXELFORMAT_PVRTC_2BPP_RGBA_1:17,PIXELFORMAT_PVRTC_4BPP_RGB_1:18,%20PIXELFORMAT_PVRTC_4BPP_RGBA_1:19,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:%22POSITION%22,SEMANTIC_NORMAL:%22NORMAL%22,SEMANTIC_TANGENT:%22TANGENT%22,SEMANTIC_BLENDWEIGHT:%22BLENDWEIGHT%22,SEMANTIC_BLENDINDICES:%22BLENDINDICES%22,SEMANTIC_COLOR:%22COLOR%22,SEMANTIC_TEXCOORD0:%22TEXCOORD0%22,SEMANTIC_TEXCOORD1:%22TEXCOORD1%22,SEMANTIC_TEXCOORD2:%22TEXCOORD2%22,SEMANTIC_TEXCOORD3:%22TEXCOORD3%22,SEMANTIC_TEXCOORD4:%22TEXCOORD4%22,%20SEMANTIC_TEXCOORD5:%22TEXCOORD5%22,SEMANTIC_TEXCOORD6:%22TEXCOORD6%22,SEMANTIC_TEXCOORD7:%22TEXCOORD7%22,SEMANTIC_ATTR0:%22ATTR0%22,SEMANTIC_ATTR1:%22ATTR1%22,SEMANTIC_ATTR2:%22ATTR2%22,SEMANTIC_ATTR3:%22ATTR3%22,SEMANTIC_ATTR4:%22ATTR4%22,SEMANTIC_ATTR5:%22ATTR5%22,SEMANTIC_ATTR6:%22ATTR6%22,SEMANTIC_ATTR7:%22ATTR7%22,SEMANTIC_ATTR8:%22ATTR8%22,SEMANTIC_ATTR9:%22ATTR9%22,SEMANTIC_ATTR10:%22ATTR10%22,SEMANTIC_ATTR11:%22ATTR11%22,SEMANTIC_ATTR12:%22ATTR12%22,SEMANTIC_ATTR13:%22ATTR13%22,SEMANTIC_ATTR14:%22ATTR14%22,SEMANTIC_ATTR15:%22ATTR15%22,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,%20UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,SHADERTAG_MATERIAL:1};pc.extend(pc,f);pc.gfx={};pc.extend(pc.gfx,f)})();pc.extend(pc,function(){var%20f=function(a){this.name=a;this.value=null;this.versionObject=new%20pc.VersionedObject};f.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return%20this.value}};return{ScopeId:f}}());pc.extend(pc,function(){var%20f=function(a){this.name=a;this.variables={};this.namespaces={}};f.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new%20pc.ScopeId(a));return%20this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new%20pc.ScopeSpace(a),logDEBUG(%22Added%20ScopeSpace:%20%22+a));return%20this.namespaces[a]}};return{ScopeSpace:f}}());pc.extend(pc,function(){var%20f=function(){this.revision=this.globalId=0};f.prototype={equals:function(a){return%20this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return%20this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:f}}());pc.extend(pc,function(){var%20f=0,a=function(){f++;this.version=new%20pc.Version;this.version.globalId=f};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());pc.extend(pc,function(){function%20f(g,f){this.index=0;switch(f.dataType){case%20pc.ELEMENTTYPE_INT8:this.array=new%20Int8Array(g,f.offset);break;case%20pc.ELEMENTTYPE_UINT8:this.array=new%20Uint8Array(g,f.offset);break;case%20pc.ELEMENTTYPE_INT16:this.array=new%20Int16Array(g,f.offset);break;case%20pc.ELEMENTTYPE_UINT16:this.array=new%20Uint16Array(g,f.offset);break;case%20pc.ELEMENTTYPE_INT32:this.array=new%20Int32Array(g,f.offset);break;case%20pc.ELEMENTTYPE_UINT32:this.array=new%20Uint32Array(g,f.offset);break;case%20pc.ELEMENTTYPE_FLOAT32:this.array=%20new%20Float32Array(g,f.offset)}switch(f.numComponents){case%201:this.set=a;break;case%202:this.set=b;break;case%203:this.set=d;break;case%204:this.set=e}}function%20a(a){this.array[this.index]=a}function%20b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function%20d(a,b,d){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=d}function%20e(a,b,d,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=d;this.array[this.index+3]=e}function%20g(a){this.vertexBuffer=%20a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var%20a=this.vertexBuffer.getFormat(),b=0;b%3Ca.elements.length;b++){var%20d=a.elements[b];this.setters[b]=new%20f(this.buffer,d);this.element[d.name]=this.setters[b]}}g.prototype={next:function(){for(var%20a=0,b=this.setters,d=this.setters.length,e=this.vertexBuffer.getFormat();a%3Cd;){var%20g=b[a++];g.index+=e.size/g.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};return{VertexIterator:g}}());pc.extend(pc,function(){var%20f=[];f[pc.ELEMENTTYPE_INT8]=1;f[pc.ELEMENTTYPE_UINT8]=1;f[pc.ELEMENTTYPE_INT16]=2;f[pc.ELEMENTTYPE_UINT16]=2;f[pc.ELEMENTTYPE_INT32]=4;f[pc.ELEMENTTYPE_UINT32]=4;f[pc.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var%20d,e,g;this.elements=[];this.hasColor=this.hasUv1=this.hasUv0=!1;d=this.size=0;for(e=b.length;d%3Ce;d++){var%20h=b[d];g={name:h.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(h.semantic),dataType:h.type,numComponents:h.components,normalize:void%200===%20h.normalize?!1:h.normalize,size:h.components*f[h.type]};this.elements.push(g);this.size+=g.size;h.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:h.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:h.semantic===pc.SEMANTIC_COLOR&&(this.hasColor=!0)}d=h=0;for(e=this.elements.length;d%3Ce;d++)g=this.elements[d],g.offset=h,g.stride=this.size,h+=g.size}}}());pc.extend(pc,function(){var%20f=function(a,b,d,e,g){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numVertices=d;this.numBytes=b.size*d;a._vram.vb+=this.numBytes;this.device=a;this.bufferId=this.device.gl.createBuffer();if(!g||!this.setData(g))this.storage=new%20ArrayBuffer(this.numBytes)};f.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId);this.device._vram.vb-=this.storage.byteLength},getFormat:function(){return%20this.format},getUsage:function(){return%20this.usage},getNumVertices:function(){return%20this.numVertices},%20lock:function(){return%20this.storage},unlock:function(){var%20a=this.device.gl,b;switch(this.usage){case%20pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case%20pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case%20pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return%20console.error(%22VertexBuffer:%20wrong%20initial%20data%20size:%20expected%20%22+this.numBytes+%22,%20got%20%22+a.byteLength),!1;this.storage=a;this.unlock();%20return!0}};return{VertexBuffer:f}}());pc.extend(pc,function(){var%20f=function(a,b,d,e){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numIndices=d;this.device=a;d=this.device.gl;this.bufferId=d.createBuffer();var%20g;b===pc.INDEXFORMAT_UINT8?(g=1,this.glFormat=d.UNSIGNED_BYTE):b===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=d.UNSIGNED_SHORT):b===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=d.UNSIGNED_INT);this.bytesPerIndex=g;b=this.numIndices*g;this.storage=new%20ArrayBuffer(b);a._vram.ib+=b};f.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId);%20this.device._vram.ib-=this.storage.byteLength},getFormat:function(){return%20this.format},getNumIndices:function(){return%20this.numIndices},lock:function(){return%20this.storage},unlock:function(){var%20a=this.device.gl,b;switch(this.usage){case%20pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case%20pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case%20pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:f}}());pc.extend(pc,function(){var%20f=function(a,b){this.device=a;var%20d=4,e=4,g=pc.PIXELFORMAT_R8_G8_B8_A8,f=!1,k=!0,n=!1,r=!1;void%200!==b&&(d=void%200!==b.width?b.width:d,e=void%200!==b.height?b.height:e,g=void%200!==b.format?b.format:g,f=void%200!==b.cubemap?b.cubemap:f,k=void%200!==b.autoMipmap?b.autoMipmap:k,n=void%200!==b.rgbm?b.rgbm:n,r=void%200!==b.fixCubemapSeams?b.fixCubemapSeams:r);this.name=null;this.autoMipmap=k;this.rgbm=n;this.fixCubemapSeams=r;this._cubemap=f;this._format=g;this._compressed=g===pc.PIXELFORMAT_DXT1||%20g===pc.PIXELFORMAT_DXT3||g===pc.PIXELFORMAT_DXT5||g%3E=pc.PIXELFORMAT_ETC1;this._width=d||4;this._height=e||4;this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._minFilter=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._invalid=!1;this._levels=f?[[null,null,null,null,null,null]]:[null];this._levelsUpdated=f?[[!0,!0,!0,!0,!0,!0]]:[!0];this._lockedLevel=-1;this._anisotropyDirty=%20this._addressVDirty=this._addressUDirty=this._magFilterDirty=this._minFilterDirty=this._needsUpload=!0;this._gpuSize=0};Object.defineProperty(f.prototype,%22minFilter%22,{get:function(){return%20this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||(logWARNING(%22Invalid%20minification%20filter%20mode%20set%20on%20non%20power%20of%20two%20texture.%20Forcing%20linear%20addressing.%22),a=pc.FILTER_LINEAR);a!==this._minFilter&&(this._minFilter=%20a,this._minFilterDirty=!0)}});Object.defineProperty(f.prototype,%22magFilter%22,{get:function(){return%20this._magFilter},set:function(a){a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||logWARNING(%22Invalid%20magnification%20filter%20mode.%20Must%20be%20set%20to%20FILTER_NEAREST%20or%20FILTER_LINEAR.%22);a!==this._magFilter&&(this._magFilter=a,this._magFilterDirty=!0)}});Object.defineProperty(f.prototype,%22addressU%22,{get:function(){return%20this._addressU},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&%20a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING(%22Invalid%20address%20mode%20in%20U%20set%20on%20non%20power%20of%20two%20texture.%20Forcing%20clamp%20to%20edge%20addressing.%22),a=pc.ADDRESS_CLAMP_TO_EDGE;a!==this._addressU&&(this._addressU=a,this._addressUDirty=!0)}});Object.defineProperty(f.prototype,%22addressV%22,{get:function(){return%20this._addressV},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING(%22Invalid%20address%20mode%20in%20V%20set%20on%20non%20power%20of%20two%20texture.%20Forcing%20clamp%20to%20edge%20addressing.%22),%20a=pc.ADDRESS_CLAMP_TO_EDGE;a!==this._addressV&&(this._addressV=a,this._addressVDirty=!0)}});Object.defineProperty(f.prototype,%22anisotropy%22,{get:function(){return%20this._anisotropy},set:function(a){a=pc.math.clamp(a,1,this.device.maxAnisotropy);a!==this._anisotropy&&(this._anisotropy=a,this._anisotropyDirty=!0)}});Object.defineProperty(f.prototype,%22width%22,{get:function(){return%20this._width}});Object.defineProperty(f.prototype,%22height%22,{get:function(){return%20this._height}});Object.defineProperty(f.prototype,%20%22format%22,{get:function(){return%20this._format}});Object.defineProperty(f.prototype,%22cubemap%22,{get:function(){return%20this._cubemap}});pc.extend(f.prototype,{bind:function(){},destroy:function(){this._glTextureId&&(this.device.gl.deleteTexture(this._glTextureId),this.device._vram.tex-=this._gpuSize)},lock:function(a){a=a||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE};void%200===a.level&&(a.level=0);void%200===a.face&&(a.face=0);void%200===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===%20this._levels[a.level])switch(this._format){case%20pc.PIXELFORMAT_A8:case%20pc.PIXELFORMAT_L8:this._levels[a.level]=new%20Uint8Array(this._width*this._height);break;case%20pc.PIXELFORMAT_L8_A8:this._levels[a.level]=new%20Uint8Array(2*this._width*this._height);break;case%20pc.PIXELFORMAT_R5_G6_B5:case%20pc.PIXELFORMAT_R5_G5_B5_A1:case%20pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new%20Uint16Array(this._width*this._height);break;case%20pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new%20Uint8Array(3*this._width*this._height);%20break;case%20pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new%20Uint8Array(4*this._width*this._height);break;case%20pc.PIXELFORMAT_DXT1:this._levels[a.level]=new%20Uint8Array(8*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case%20pc.PIXELFORMAT_DXT3:case%20pc.PIXELFORMAT_DXT5:this._levels[a.level]=new%20Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case%20pc.PIXELFORMAT_RGB16F:case%20pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new%20Float32Array(3*this._width*%20this._height);break;case%20pc.PIXELFORMAT_RGBA16F:case%20pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=new%20Float32Array(4*this._width*this._height)}return%20this._levels[a.level]},recover:function(){},setSource:function(a){var%20b,d=!1,e,g;if(this._cubemap){e=a[0]&&a[0].width||0;g=a[0]&&a[0].height||0;if(a[0])for(b=0;6%3Eb;b++){if(!a[b]||a[b].width!==e||a[b].height!==g||!(a[b]instanceof%20HTMLImageElement)&&!(a[b]instanceof%20HTMLCanvasElement)&&!(a[b]instanceof%20HTMLVideoElement))d=!0}else%20d=!0;for(b=0;6%3Eb;b++)if(d||%20this._levels[0][b]!==a[b])this._levelsUpdated[0][b]=!0}else{!(a%20instanceof%20HTMLImageElement)&&(!(a%20instanceof%20HTMLCanvasElement)&&!(a%20instanceof%20HTMLVideoElement))&&(d=!0);if(d||a!==this._levels[0])this._levelsUpdated[0]=!0;e=a.width;g=a.height}if(d)if(this._height=this._width=4,this._cubemap)for(b=0;6%3Eb;b++)this._levels[0][b]=null,this._levelsUpdated[0][b]=!0;else%20this._levels[0]=null,this._levelsUpdated[0]=!0;else%20this._width=e,this._height=g,this._levels[0]=a;if(this._invalid!==d||!d)this._invalid=%20d,this.upload(),this.minFilter=this._minFilter,this.magFilter=this._magFilter,this.addressU=this._addressU,this.addressV=this._addressV},getSource:function(){return%20this._levels[0]},unlock:function(){logASSERT(-1!==this._lockedLevel,%22Attempting%20to%20unlock%20a%20texture%20that%20is%20not%20locked%22);this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error(%22This%20format%20is%20not%20implemented%20yet%22);for(var%20a=128,b=0,d,e;this._levels[b];){if(this.cubemap)for(e=%200;6%3Ee;e++){if(!this._levels[b][e]){console.error(%22No%20level%20data%20for%20mip%20%22+b+%22,%20face%20%22+e);return}d=this._levels[b][e].length;if(!d){console.error(%22No%20byte%20array%20for%20mip%20%22+b+%22,%20face%20%22+e);return}a+=d}else{d=this._levels[b].length;if(!d){console.error(%22No%20byte%20array%20for%20mip%20%22+b);return}a+=d}a+=this._levels[b].length;b++}a=new%20ArrayBuffer(a);e=new%20Uint32Array(a,0,32);b=528391;1%3Cthis._levels.length&&(b|=131072);d=4096;1%3Cthis._levels.length&&(d|=4194304);if(1%3Cthis._levels.length||this.cubemap)d|=8;var%20g=%20this.cubemap?65024:0;e[0]=542327876;e[1]=124;e[2]=b;e[3]=this.height;e[4]=this.width;e[5]=4*this.width*this.height;e[6]=0;e[7]=this._levels.length;for(b=0;11%3Eb;b++)e[8+b]=0;e[19]=32;e[20]=65;e[21]=0;e[22]=32;e[23]=16711680;e[24]=65280;e[25]=255;e[26]=4278190080;e[27]=d;e[28]=g;e[29]=0;e[30]=0;e[31]=0;var%20g=128,f,k;if(this.cubemap)for(e=0;6%3Ee;e++)for(b=0;b%3Cthis._levels.length;b++){f=this._levels[b][e];k=new%20Uint8Array(a,g,f.length);for(d=0;d%3Cf.length;d++)k[d]=f[d];g+=f.length}else%20for(b=0;b%3Cthis._levels.length;b++){f=%20this._levels[b];k=new%20Uint8Array(a,g,f.length);for(d=0;d%3Cf.length;d++)k[d]=f[d];g+=f.length}return%20a}});return{Texture:f}}());pc.extend(pc,function(){var%20f={depth:!0,face:0},a=function(a,d,e){this._device=a;this._colorBuffer=d;e=void%200!==e?e:f;this._face=void%200!==e.face?e.face:0;this._depth=void%200!==e.depth?e.depth:!0};a.prototype={destroy:function(){var%20a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)}};Object.defineProperty(a.prototype,%22colorBuffer%22,{get:function(){return%20this._colorBuffer}});Object.defineProperty(a.prototype,%22face%22,{get:function(){return%20this._face}});%20Object.defineProperty(a.prototype,%22width%22,{get:function(){return%20this._colorBuffer.width}});Object.defineProperty(a.prototype,%22height%22,{get:function(){return%20this._colorBuffer.height}});return{RenderTarget:a}}());pc.extend(pc,function(){return{ShaderInput:function(f,a,b,d){this.locationId=d;this.scopeId=f.scope.resolve(a);this.version=new%20pc.Version;this.dataType=b;this.array=[]}}}());pc.extend(pc,function(){function%20f(a){for(var%20a=a.split(%22\n%22),b=0,g=a.length;b%3Cg;b++)a[b]=b+1+%22:\t%22+a[b];return%20a.join(%22\n%22)}function%20a(a,b,g){b=a.createShader(b);a.shaderSource(b,g);a.compileShader(b);return%20b}var%20b=function(b,e){this.device=b;this.definition=e;this.ready=!1;this.device.fire(%22shader:compile:start%22,{timestamp:pc.now(),target:this});var%20g=this.device.gl;this.vshader=a(g,g.VERTEX_SHADER,e.vshader);this.fshader=a(g,g.FRAGMENT_SHADER,e.fshader);var%20f=this.vshader,k=this.fshader,n=g.createProgram();%20g.attachShader(n,f);g.attachShader(n,k);this.program=n;b._shaderStats.vsCompiled++;b._shaderStats.fsCompiled++;b._shaderStats.linked++;e.tag===pc.SHADERTAG_MATERIAL&&b._shaderStats.materialShaders++;this.device.fire(%22shader:compile:end%22,{timestamp:pc.now(),target:this})};b.prototype={link:function(){var%20a=this.device.gl;this.device.fire(%22shader:link:start%22,{timestamp:pc.now(),target:this});a.linkProgram(this.program);a.getShaderParameter(this.vshader,a.COMPILE_STATUS)||logERROR(%22Failed%20to%20compile%20vertex%20shader:\n\n%22+%20f(this.definition.vshader)+%22\n\n%22+a.getShaderInfoLog(this.vshader));a.getShaderParameter(this.fshader,a.COMPILE_STATUS)||logERROR(%22Failed%20to%20compile%20fragment%20shader:\n\n%22+f(this.definition.fshader)+%22\n\n%22+a.getShaderInfoLog(this.fshader));a.getProgramParameter(this.program,a.LINK_STATUS)||logERROR(%22Failed%20to%20link%20shader%20program.%20Error:%20%22+a.getProgramInfoLog(this.program));a.deleteShader(this.vshader);a.deleteShader(this.fshader);this.attributes=[];this.uniforms=[];this.samplers=[];var%20b=0,g,h,k={};%20k[a.BOOL]=pc.UNIFORMTYPE_BOOL;k[a.INT]=pc.UNIFORMTYPE_INT;k[a.FLOAT]=pc.UNIFORMTYPE_FLOAT;k[a.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;k[a.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;k[a.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4;k[a.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;k[a.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;k[a.INT_VEC4]=pc.UNIFORMTYPE_IVEC4;k[a.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;k[a.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;k[a.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;k[a.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;k[a.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;k[a.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;%20k[a.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;k[a.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;for(var%20n=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);b%3Cn;)g=a.getActiveAttrib(this.program,b++),h=a.getAttribLocation(this.program,g.name),void%200===this.definition.attributes[g.name]&&console.error('Vertex%20shader%20attribute%20%22'+g.name+'%22%20is%20not%20mapped%20to%20a%20semantic%20in%20shader%20definition.'),g=new%20pc.ShaderInput(this.device,this.definition.attributes[g.name],k[g.type],h),this.attributes.push(g);b=0;for(n=%20a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS);b%3Cn;)g=a.getActiveUniform(this.program,b++),h=a.getUniformLocation(this.program,g.name),g.type===a.SAMPLER_2D||g.type===a.SAMPLER_CUBE?this.samplers.push(new%20pc.ShaderInput(this.device,g.name,k[g.type],h)):this.uniforms.push(new%20pc.ShaderInput(this.device,g.name,k[g.type],h));this.ready=!0;this.device.fire(%22shader:link:end%22,{timestamp:pc.now(),target:this})},destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:b}}());pc.extend(pc,function(){var%20f=function(a){this._device=a;this._cache={};this._generators={}};f.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};f.prototype.unregister=function(a){this.isRegistered(a)&&delete%20this._generators[a]};f.prototype.isRegistered=function(a){return%20void%200!==this._generators[a]};f.prototype.getProgram=function(a,b){var%20d=this._generators[a];if(void%200===d)return%20logERROR(%22No%20program%20library%20functions%20registered%20for:%20%22+a),null;var%20e=d.generateKey(g,%20b),g=this._cache[e];if(!g)var%20g=this._device,d=d.createShaderDefinition(g,b),g=this._cache[e]=new%20pc.Shader(g,d);return%20g};return{ProgramLibrary:f}}());pc.extend(pc,function(){function%20f(a){this.name=%22UnsupportedBrowserError%22;this.message=a||%22%22}function%20a(a){this.name=%22ContextCreationError%22;this.message=a||%22%22}function%20b(a,b,d){b=a.createTexture();a.bindTexture(a.TEXTURE_2D,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,%200,a.RGBA,2,2,0,a.RGBA,d,null);d=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,d);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,b,0);a.bindTexture(a.TEXTURE_2D,null);if(a.checkFramebufferStatus(a.FRAMEBUFFER)!=a.FRAMEBUFFER_COMPLETE)return%20a.deleteTexture(b),!1;a.deleteTexture(b);return!0}f.prototype=Error.prototype;a.prototype=Error.prototype;var%20d=function(){logWARNING(%22Context%20lost.%22)},e=function(){logINFO(%22Context%20restored.%22)},g=function(a,b){var%20d=a.width,e=a.height;%20if(d%3Eb||e%3Eb){var%20g=b/Math.max(d,e),f=Math.floor(d*g),g=Math.floor(e*g);console.warn(%22Image%20dimensions%20larger%20than%20max%20supported%20texture%20size%20of%20%22+b+%22.%20Resizing%20from%20%22+d+%22,%20%22+e+%22%20to%20%22+f+%22,%20%22+g+%22.%22);var%20h=document.createElement(%22canvas%22);h.width=f;h.height=g;h.getContext(%222d%22).drawImage(a,0,0,d,e,0,0,f,g);return%20h}return%20a},h=null,k=function(a,g){this.gl=void%200;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision=%22highp%22;this.enableAutoInstancing=!1;this.autoInstancingMaxObjects=%2016384;this.attributesInvalidated=!0;this.boundBuffer=null;this.instancedAttribs={};this.enabledAttributes={};this.textureUnits=[];this.commitFunction={};this._maxPixelRatio=1;this._height=this._width=0;this.updateClientRect();if(!window.WebGLRenderingContext)throw%20new%20pc.UnsupportedBrowserError;if(a){for(var%20f=[%22webgl%22,%22experimental-webgl%22],h=null,k=0;k%3Cf.length;k++){try{h=a.getContext(f[k],g)}catch(w){}if(h)break}this.gl=h}if(!this.gl)throw%20new%20pc.ContextCreationError;var%20s=this.gl;a.addEventListener(%22webglcontextlost%22,%20d,!1);a.addEventListener(%22webglcontextrestored%22,e,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision=%22highp%22;this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE);this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE);if(s.getShaderPrecisionFormat){f=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_FLOAT);k=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_FLOAT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,%20s.LOW_FLOAT);var%20h=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_FLOAT),D=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_FLOAT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.LOW_FLOAT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_INT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_INT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.LOW_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,%20s.LOW_INT);k=0%3Ck.precision&&0%3CD.precision;0%3Cf.precision&&0%3Ch.precision||(k?(this.precision=%22mediump%22,console.warn(%22WARNING:%20highp%20not%20supported,%20using%20mediump%22)):(this.precision=%22lowp%22,console.warn(%22WARNING:%20highp%20and%20mediump%20not%20supported,%20using%20lowp%22)))}this.maxPrecision=this.precision;this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[s.REPEAT,s.CLAMP_TO_EDGE,s.MIRRORED_REPEAT];this.glBlendEquation=[s.FUNC_ADD,s.FUNC_SUBTRACT,s.FUNC_REVERSE_SUBTRACT];%20this.glBlendFunction=[s.ZERO,s.ONE,s.SRC_COLOR,s.ONE_MINUS_SRC_COLOR,s.DST_COLOR,s.ONE_MINUS_DST_COLOR,s.SRC_ALPHA,s.SRC_ALPHA_SATURATE,s.ONE_MINUS_SRC_ALPHA,s.DST_ALPHA,s.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,s.COLOR_BUFFER_BIT,s.DEPTH_BUFFER_BIT,s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT,s.STENCIL_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.COLOR_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.DEPTH_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT];this.glFilter=[s.NEAREST,s.LINEAR,s.NEAREST_MIPMAP_NEAREST,%20s.NEAREST_MIPMAP_LINEAR,s.LINEAR_MIPMAP_NEAREST,s.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[s.POINTS,s.LINES,s.LINE_LOOP,s.LINE_STRIP,s.TRIANGLES,s.TRIANGLE_STRIP,s.TRIANGLE_FAN];this.glType=[s.BYTE,s.UNSIGNED_BYTE,s.SHORT,s.UNSIGNED_SHORT,s.INT,s.UNSIGNED_INT,s.FLOAT];this.extTextureFloat=s.getExtension(%22OES_texture_float%22);this.extTextureFloatLinear=s.getExtension(%22OES_texture_float_linear%22);this.extTextureFloat&&(this.extTextureFloatRenderable=b(s,this.extTextureFloat,s.FLOAT));if(this.extTextureHalfFloat=%20s.getExtension(%22OES_texture_half_float%22))this.extTextureHalfFloatRenderable=b(s,this.extTextureHalfFloat,this.extTextureHalfFloat.HALF_FLOAT_OES);this.extUintElement=s.getExtension(%22OES_element_index_uint%22);this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.supportsBoneTextures=this.extTextureFloat&&0%3Cthis.maxVertexTextures;this.extTextureLod=s.getExtension(%22EXT_shader_texture_lod%22);this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS);this.samplerCount=%20s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);this.useTexCubeLod=this.extTextureLod&&16%3Ethis.samplerCount;this.extDepthTexture=null;(this.extStandardDerivatives=s.getExtension(%22OES_standard_derivatives%22))&&s.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,s.NICEST);this.extTextureFilterAnisotropic=s.getExtension(%22EXT_texture_filter_anisotropic%22);this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=s.getExtension(%22WEBKIT_EXT_texture_filter_anisotropic%22));this.extCompressedTextureS3TC=%20s.getExtension(%22WEBGL_compressed_texture_s3tc%22);this.extCompressedTextureS3TC||(this.extCompressedTextureS3TC=s.getExtension(%22WEBKIT_WEBGL_compressed_texture_s3tc%22));if(f=this.extCompressedTextureS3TC)f=window.navigator.userAgent.indexOf(%22MSIE%20%22),h=navigator.userAgent.match(/Trident.*rv\:11\./),f=0%3Cf||!!h;f&&(this.extCompressedTextureS3TC=!1);if(this.extCompressedTextureS3TC){h=s.getParameter(s.COMPRESSED_TEXTURE_FORMATS);for(f=0;f%3Ch.length;f++);}this.extInstancing=s.getExtension(%22ANGLE_instanced_arrays%22);%20this.extCompressedTextureETC1=s.getExtension(%22WEBGL_compressed_texture_etc1%22);this.extCompressedTexturePVRTC=s.getExtension(%22WEBGL_compressed_texture_pvrtc%22)||s.getExtension(%22WEBKIT_WEBGL_compressed_texture_pvrtc%22);this.maxDrawBuffers=(this.extDrawBuffers=s.getExtension(%22EXT_draw_buffers%22))?s.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT):1;this.maxColorAttachments=this.extDrawBuffers?s.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT):1;this.renderTarget=null;this.scope=new%20pc.ScopeSpace(%22Device%22);%20this.commitFunction={};this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){s.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_INT]=function(a,b){s.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(a,b){%22number%22==typeof%20b?s.uniform1f(a,b):s.uniform1fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(a,b){s.uniform2fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(a,b){s.uniform3fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(a,b){s.uniform4fv(a,b)};%20this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(a,b){s.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=function(a,b){s.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(a,b){s.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=function(a,b){s.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(a,b){s.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=function(a,b){s.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,%20b){s.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(a,b){s.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(a,b){s.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.BLENDMODE_ONE,pc.BLENDMODE_ZERO);this.setBlendEquation(pc.BLENDEQUATION_ADD);this.setColorWrite(!0,!0,!0,!0);this.setCullMode(pc.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);this.setClearDepth(1);this.setClearColor(0,0,0,0);s.enable(s.SCISSOR_TEST);%20this.programLib=new%20pc.ProgramLibrary(this);for(var%20y%20in%20pc.programlib)this.programLib.register(y,pc.programlib[y]);y=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS);y=y-16-8;y-=1;y-=16;this.boneLimit=Math.floor(y/4);110%3Cthis.boneLimit&&(this.boneLimit=110);pc.events.attach(this);this.boundBuffer=null;this.instancedAttribs={};this.activeTexture=0;this.textureUnits=[];this.attributesInvalidated=!0;this.enabledAttributes={};this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0;this._primsPerFrame=[];%20for(f=pc.PRIMITIVE_POINTS;f%3C=pc.PRIMITIVE_TRIFAN;f++)this._primsPerFrame[f]=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0};y=s.createBuffer();f=new%20ArrayBuffer(16);s.bindBuffer(s.ARRAY_BUFFER,y);s.bufferData(s.ARRAY_BUFFER,f,s.STATIC_DRAW);s.getError();s.vertexAttribPointer(0,4,s.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===s.getError();s.deleteBuffer(y)};k.prototype={updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},%20setViewport:function(a,b,d,e){this.gl.viewport(a,b,d,e)},setScissor:function(a,b,d,e){this.gl.scissor(a,b,d,e)},getProgramLibrary:function(){return%20this.programLib},setProgramLibrary:function(a){this.programLib=a},updateBegin:function(){var%20a=this.gl;this.indexBuffer=this.boundBuffer=null;var%20b=this.renderTarget;if(b)if(b._glFrameBuffer)a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);else{b._glFrameBuffer=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);var%20d=b._colorBuffer;%20d._glTextureId||(d._width=Math.min(d.width,this.maxRenderBufferSize),d._height=Math.min(d.height,this.maxRenderBufferSize),this.setTexture(d,0));a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,d._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:a.TEXTURE_2D,d._glTextureId,0);b._depth&&(b._glDepthBuffer||(b._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glDepthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),a.bindRenderbuffer(a.RENDERBUFFER,%20null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glDepthBuffer));switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case%20a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error(%22ERROR:%20FRAMEBUFFER_INCOMPLETE_ATTACHMENT%22);break;case%20a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error(%22ERROR:%20FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT%22);break;case%20a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error(%22ERROR:%20FRAMEBUFFER_INCOMPLETE_DIMENSIONS%22);break;case%20a.FRAMEBUFFER_UNSUPPORTED:console.error(%22ERROR:%20FRAMEBUFFER_UNSUPPORTED%22)}}else%20a.bindFramebuffer(a.FRAMEBUFFER,%20null);for(a=0;16%3Ea;a++)this.textureUnits[a]=null},updateEnd:function(){var%20a=this.gl,b=this.renderTarget;b&&(a.bindFramebuffer(a.FRAMEBUFFER,null),b=b._colorBuffer,b._glTextureId&&(b.autoMipmap&&pc.math.powerOfTwo(b._width)&&pc.math.powerOfTwo(b._height))&&(a.bindTexture(b._glTarget,b._glTextureId),a.generateMipmap(b._glTarget)))},initializeTexture:function(a){var%20b=this.gl;a._glTextureId=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;switch(a._format){case%20pc.PIXELFORMAT_A8:a._glFormat=%20b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case%20pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case%20pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case%20pc.PIXELFORMAT_R5_G6_B5:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case%20pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=b.RGBA;a._glInternalFormat=%20b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case%20pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case%20pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case%20pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case%20pc.PIXELFORMAT_DXT1:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_S3TC_DXT1_EXT;%20break;case%20pc.PIXELFORMAT_DXT3:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case%20pc.PIXELFORMAT_DXT5:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case%20pc.PIXELFORMAT_ETC1:ext=this.extCompressedTextureETC1;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_ETC1_WEBGL;break;case%20pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;%20a._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case%20pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case%20pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case%20pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;%20break;case%20pc.PIXELFORMAT_RGB16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=ext.HALF_FLOAT_OES;break;case%20pc.PIXELFORMAT_RGBA16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=ext.HALF_FLOAT_OES;break;case%20pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.FLOAT;break;case%20pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA,a._glInternalFormat=b.RGBA,a._glPixelType=b.FLOAT}},uploadTexture:function(a){for(var%20b=%20this.gl,d=0,e,f;a._levels[d]||0===d;){e=a._levels[d];1==d&&!a._compressed&&b.generateMipmap(a._glTarget);if(a._cubemap){var%20k;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(e[0]instanceof%20HTMLCanvasElement||e[0]instanceof%20HTMLImageElement||e[0]instanceof%20HTMLVideoElement)for(k=0;6%3Ek;k++){if(a._levelsUpdated[0][k]){f=e[k];if(f%20instanceof%20HTMLImageElement&&(f.width%3Ethis.maxCubeMapSize||f.height%3Ethis.maxCubeMapSize))f=g(f,this.maxCubeMapSize),0===d&&(a.width=%20f.width,a.height=f.height);b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,a._glFormat,a._glPixelType,f)}}else{f=1/Math.pow(2,d);for(k=0;6%3Ek;k++)if(a._levelsUpdated[0][k]){var%20s=e[k];a._compressed?b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,s):b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,a._glFormat,a._glPixelType,s)}}}else%20if(e%20instanceof%20HTMLCanvasElement||e%20instanceof%20HTMLImageElement||e%20instanceof%20HTMLVideoElement){if(e%20instanceof%20HTMLImageElement&&(e.width%3Ethis.maxTextureSize||e.height%3Ethis.maxTextureSize))e=g(e,this.maxTextureSize),0===d&&(a.width=e.width,a.height=e.height);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.texImage2D(b.TEXTURE_2D,d,a._glInternalFormat,a._glFormat,a._glPixelType,e)}else%20b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),f=1/Math.pow(2,d),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,%20d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,e):b.texImage2D(b.TEXTURE_2D,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,a._glFormat,a._glPixelType,e);d++}if(a._cubemap)for(d=0;6%3Ed;d++)a._levelsUpdated[0][d]=!1;else%20a._levelsUpdated[0]=!1;a.autoMipmap&&(pc.math.powerOfTwo(a._width)&&pc.math.powerOfTwo(a._height)&&1===a._levels.length&&!a._compressed)&&b.generateMipmap(a._glTarget);a._gpuSize&&(this._vram.tex-=a._gpuSize);h||(h={},h[pc.PIXELFORMAT_A8]=%201,h[pc.PIXELFORMAT_L8]=1,h[pc.PIXELFORMAT_L8_A8]=1,h[pc.PIXELFORMAT_R5_G6_B5]=2,h[pc.PIXELFORMAT_R5_G5_B5_A1]=2,h[pc.PIXELFORMAT_R4_G4_B4_A4]=2,h[pc.PIXELFORMAT_R8_G8_B8]=4,h[pc.PIXELFORMAT_R8_G8_B8_A8]=4,h[pc.PIXELFORMAT_RGB16F]=8,h[pc.PIXELFORMAT_RGBA16F]=8,h[pc.PIXELFORMAT_RGB32F]=16,h[pc.PIXELFORMAT_RGBA32F]=16);d=1;if(a.autoMipmap||a._minFilter===b.NEAREST_MIPMAP_NEAREST||a._minFilter===b.NEAREST_MIPMAP_LINEAR||a._minFilter===b.LINEAR_MIPMAP_NEAREST||a._minFilter===b.LINEAR_MIPMAP_LINEAR)d=Math.round(Math.log2(Math.max(a._width,%20a._height))+1);b=a._width;e=a._height;for(f=k=0;f%3Cd;f++)k=a._compressed?a._format===pc.PIXELFORMAT_ETC1?k+8*Math.floor((b+3)/4)*Math.floor((e+3)/4):a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1?k+Math.max(b,16)*Math.max(e,8)/4:a._format===pc.PIXELFORMAT_PVRTC_4BPP_RGB_1||a._format===pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1?k+Math.max(b,8)*Math.max(e,8)/2:k+Math.floor((b+4-1)/4)*Math.floor((e+4-1)/4)*(a._format===pc.PIXELFORMAT_DXT1?8:16):k+b*e*h[a._format],b=Math.max(0.5*%20b,1),e=Math.max(0.5*e,1);a._cubemap&&(k*=6);a._gpuSize=k;this._vram.tex+=a._gpuSize},setTexture:function(a,b){var%20d=this.gl;a._glTextureId||this.initializeTexture(a);this.activeTexture!==b&&(d.activeTexture(d.TEXTURE0+b),this.activeTexture=b);var%20e=a._glTarget;this.textureUnits[b]!==a&&(d.bindTexture(e,a._glTextureId),this.textureUnits[b]=a);a._minFilterDirty&&(d.texParameteri(e,d.TEXTURE_MIN_FILTER,this.glFilter[a._minFilter]),a._minFilterDirty=!1);a._magFilterDirty&&(d.texParameteri(e,d.TEXTURE_MAG_FILTER,%20this.glFilter[a._magFilter]),a._magFilterDirty=!1);a._addressUDirty&&(d.texParameteri(e,d.TEXTURE_WRAP_S,this.glAddress[a._addressU]),a._addressUDirty=!1);a._addressVDirty&&(d.texParameteri(e,d.TEXTURE_WRAP_T,this.glAddress[a._addressV]),a._addressVDirty=!1);if(a._anisotropyDirty){var%20g=this.extTextureFilterAnisotropic;if(g){var%20f=a.anisotropy,f=Math.min(f,this.maxAnisotropy);d.texParameterf(e,g.TEXTURE_MAX_ANISOTROPY_EXT,f)}a._anisotropyDirty=!1}a._needsUpload&&(this.uploadTexture(a),a._needsUpload=%20!1)},draw:function(a,b){var%20d=this.gl,e,g,f,h,k,y,x;e=this.shader;x=e.samplers;var%20A=e.uniforms;1%3Cb&&(this.boundBuffer=null,this.attributesInvalidated=!0);if(this.attributesInvalidated){y=e.attributes;e=0;for(f=y.length;e%3Cf;e++)g=y[e],h=g.scopeId.value,null!==h&&(k=this.vertexBuffers[h.stream],this.boundBuffer!==k.bufferId&&(d.bindBuffer(d.ARRAY_BUFFER,k.bufferId),this.boundBuffer=k.bufferId),this.enabledAttributes[g.locationId]||(d.enableVertexAttribArray(g.locationId),this.enabledAttributes[g.locationId]=%20!0),d.vertexAttribPointer(g.locationId,h.numComponents,this.glType[h.dataType],h.normalize,h.stride,h.offset),1===h.stream&&1%3Cb?this.instancedAttribs[g.locationId]||(this.extInstancing.vertexAttribDivisorANGLE(g.locationId,1),this.instancedAttribs[g.locationId]=!0):this.instancedAttribs[g.locationId]&&(this.extInstancing.vertexAttribDivisorANGLE(g.locationId,0),this.instancedAttribs[g.locationId]=!1));this.attributesInvalidated=!1}var%20C=0;e=0;for(f=x.length;e%3Cf;e++)if(h=x[e],k=h.scopeId.value)if(k%20instanceof%20pc.Texture)y=k,this.setTexture(y,C),h.slot!==C&&(d.uniform1i(h.locationId,C),h.slot=C),C++;else{h.array.length=0;numTexures=k.length;for(g=0;g%3CnumTexures;g++)y=k[g],this.setTexture(y,C),h.array[g]=C,C++;d.uniform1iv(h.locationId,h.array)}e=0;for(f=A.length;e%3Cf;e++)if(x=A[e],g=x.scopeId,h=x.version,k=g.versionObject.version,h.globalId!==k.globalId||h.revision!==k.revision)if(h.globalId=k.globalId,h.revision=k.revision,null!==g.value)this.commitFunction[x.dataType](x.locationId,g.value);this._drawCallsPerFrame++;%20this._primsPerFrame[a.type]+=a.count*(1%3Cb?b:1);a.indexed?1%3Cb?(this.extInstancing.drawElementsInstancedANGLE(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base,b),this.boundBuffer=null,this.attributesInvalidated=!0):d.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,a.base*this.indexBuffer.bytesPerIndex):1%3Cb?(this.extInstancing.drawArraysInstancedANGLE(this.glPrimitive[a.type],a.base,a.count,b),this.boundBuffer=null,this.attributesInvalidated=!0):d.drawArrays(this.glPrimitive[a.type],%20a.base,a.count)},clear:function(a){var%20b=this.defaultClearOptions,a=a||b,d=void%200===a.flags?b.flags:a.flags;if(0!==d){var%20e=this.gl;if(d&pc.CLEARFLAG_COLOR){var%20g=void%200===a.color?b.color:a.color;this.setClearColor(g[0],g[1],g[2],g[3])}d&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void%200===a.depth?b.depth:a.depth),this.depthWrite||e.depthMask(!0));e.clear(this.glClearFlag[d]);d&pc.CLEARFLAG_DEPTH&&(this.depthWrite||e.depthMask(!1))}},readPixels:function(a,b,d,e,g){var%20f=this.gl;f.readPixels(a,b,d,e,f.RGBA,%20f.UNSIGNED_BYTE,g)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,d,e){if(a!==this.clearRed||b!==this.clearGreen||d!==this.clearBlue||e!==this.clearAlpha)this.gl.clearColor(a,b,d,e),this.clearRed=a,this.clearGreen=b,this.clearBlue=d,this.clearAlpha=e},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return%20this.renderTarget},getDepthTest:function(){return%20this.depthTest},setDepthTest:function(a){if(this.depthTest!==%20a){var%20b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},getDepthWrite:function(){return%20this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,d,e){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==d||this.writeAlpha!==e)this.gl.colorMask(a,b,d,e),this.writeRed=a,this.writeGreen=b,this.writeBlue=d,this.writeAlpha=e},getBlending:function(){return%20this.blending},setBlending:function(a){if(this.blending!==%20a){var%20b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==a&&(this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var%20b=this.gl;switch(a){case%20pc.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case%20pc.CULLFACE_FRONT:b.enable(b.CULL_FACE);%20b.cullFace(b.FRONT);break;case%20pc.CULLFACE_BACK:b.enable(b.CULL_FACE);b.cullFace(b.BACK);break;case%20pc.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},getCullMode:function(){return%20this.cullMode},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var%20b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var%20d=0,e=a.getFormat().elements,%20g=e.length;d%3Cg;){var%20f=e[d++];f.stream=b;f.scopeId.setValue(f)}this.attributesInvalidated=!0}},setShader:function(a){a!==this.shader&&(this.shader=a,a.ready||a.link(),this._shaderSwitchesPerFrame++,this.gl.useProgram(a.program),this.attributesInvalidated=!0)},getHdrFormat:function(){return%20this.extTextureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.extTextureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return%20this.boneLimit},setBoneLimit:function(a){this.boneLimit=%20a},enableValidation:function(){console.warn(%22enableValidation:%20This%20function%20is%20deprecated%20and%20will%20be%20removed%20shortly.%22)},validate:function(){console.warn(%22validate:%20This%20function%20is%20deprecated%20and%20will%20be%20removed%20shortly.%22)},resizeCanvas:function(a,b){this._width=a;this._height=b;var%20d=Math.min(this._maxPixelRatio,window.devicePixelRatio),a=a*d,b=b*d;this.canvas.width=a;this.canvas.height=b;this.fire(%22resizecanvas%22,a,b)}};Object.defineProperty(k.prototype,%22width%22,{get:function(){return%20this.gl.drawingBufferWidth||%20this.canvas.width}});Object.defineProperty(k.prototype,%22height%22,{get:function(){return%20this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(k.prototype,%22fullscreen%22,{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(k.prototype,%22maxAnisotropy%22,{get:function(){var%20a;return%20function(){if(void%200===a){a=1;var%20b=this.gl,d=this.extTextureFilterAnisotropic;d&&(a=b.getParameter(d.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}return%20a}}()});%20Object.defineProperty(k.prototype,%22maxPixelRatio%22,{get:function(){return%20this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});return{UnsupportedBrowserError:f,ContextCreationError:a,GraphicsDevice:k,precalculatedTangents:!0}}());pc.extend(pc,function(){var%20f={},a={};f.collectAttribs=function(a){for(var%20d={},e=0,g=a.indexOf(%22attribute%22);0%3C=g;){var%20f=a.indexOf(%22;%22,g),k=a.lastIndexOf(%22%20%22,f),f=a.substr(k+1,f-(k+1));%22aPosition%22==f?d.aPosition=pc.SEMANTIC_POSITION:(d[f]=%22ATTR%22+e,e++);g=a.indexOf(%22attribute%22,g+1)}return%20d};f.createShader=function(a,d,e){d=f[d];e=pc.programlib.getSnippet(a,%22fs_precision%22)+%22\n%22+f[e];attribs=this.collectAttribs(d);return%20new%20pc.Shader(a,{attributes:attribs,vshader:d,fshader:e})};f.createShaderFromCode=%20function(b,d,e,g){var%20f=a[g];if(void%200!==f)return%20f;e=pc.programlib.getSnippet(b,%22fs_precision%22)+%22\n%22+e;attribs=this.collectAttribs(d);a[g]=new%20pc.Shader(b,{attributes:attribs,vshader:d,fshader:e});return%20a[g]};return{shaderChunks:f}}());pc.extend(pc,function(){var%20f=null;return{drawQuadWithShader:function(a,b,d,e){if(null===f){var%20g=new%20pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]);f=new%20pc.VertexBuffer(a,g,4);g=new%20pc.VertexIterator(f);g.element[pc.SEMANTIC_POSITION].set(-1,-1);g.next();g.element[pc.SEMANTIC_POSITION].set(1,-1);g.next();g.element[pc.SEMANTIC_POSITION].set(-1,1);g.next();g.element[pc.SEMANTIC_POSITION].set(1,1);g.end()}a.setRenderTarget(b);a.updateBegin();var%20h;e?(b=%20e.x,h=e.y,g=e.z,e=e.w):(g=null!==b?b.width:a.width,e=null!==b?b.height:a.height,h=b=0);a.setViewport(b,h,g,e);a.setScissor(b,h,g,e);e=a.getDepthTest();g=a.getDepthWrite();a.setDepthTest(!1);a.setDepthWrite(!1);a.setBlending(!1);a.setVertexBuffer(f,0);a.setShader(d);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setDepthTest(e);a.setDepthWrite(g);a.updateEnd()}}}());pc.extend(pc,function(){function%20f(){for(var%20a=Date.now()+10;Date.now()%3Ca;);}function%20a(a,b,g){var%20f=b._colorBuffer;if(f.format==pc.PIXELFORMAT_R8_G8_B8_A8){var%20k=new%20Uint8Array(4*f.width*f.height),a=a.gl;a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);a.readPixels(0,0,f.width,f.height,a.RGBA,a.UNSIGNED_BYTE,k);f._levels||(f._levels=[]);f._levels[0]||(f._levels[0]=[]);f._levels[0][g]=k}}function%20b(a,b){return%20Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}return{prefilterCubemap:function(b){var%20e=b.device,%20g=b.sourceCubemap,h=b.method,k=b.samples,n=b.cpuSync,r=b.chromeFix;if(n&&!g._levels[0])console.error(%22ERROR:%20prefilter:%20cubemap%20must%20have%20_levels%22);else{var%20u=pc.shaderChunks,l=g.rgbm,k=u.createShaderFromCode(e,u.fullscreenQuadVS,u.rgbmPS+u.prefilterCubemapPS.replace(/\$METHOD/g,0===h?%22cos%22:%22phong%22).replace(/\$NUMSAMPLES/g,k).replace(/\$textureCube/g,l?%22textureCubeRGBM%22:%22textureCube%22),%22prefilter%22+h+%22%22+k+%22%22+l),m=u.createShaderFromCode(e,u.fullscreenQuadVS,u.outputCubemapPS,%22outputCubemap%22),w=e.scope.resolve(%22source%22),%20s=e.scope.resolve(%22params%22),D=new%20pc.Vec4,y=g.width,u=g.format,x=[[],b.filteredFixed,b.filteredRgbm,b.filteredFixedRgbm],A=0===h?[0.9,0.85,0.7,0.4,0.25]:[512,128,32,8,2],C=[64,32,16,8,4],B,z,E;z=u===pc.PIXELFORMAT_R8_G8_B8;B=!1;var%20G;n&&(B=g._levels[0][0]instanceof%20HTMLImageElement);if((z||B)&&n){u=pc.PIXELFORMAT_R8_G8_B8_A8;G=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:l,format:u,width:y,height:y,autoMipmap:!1});G.minFilter=pc.FILTER_LINEAR;G.magFilter=pc.FILTER_LINEAR;G.addressU=pc.ADDRESS_CLAMP_TO_EDGE;%20G.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6%3EE;E++)B=new%20pc.RenderTarget(e,G,{face:E,depth:!1}),D.x=E,D.y=0,w.setValue(g),s.setValue(D.data),r&&f(),pc.drawQuadWithShader(e,B,m),a(e,B,E);g=G}if(128%3Cy){z=Math.round(Math.log2(128));var%20R=Math.round(Math.log2(y))-z;for(z=0;z%3CR;z++){var%20y=0.5*g.width,I=0===h?1:Math.pow(2,Math.round(Math.log2(A[0])+2*(R-z)));G=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:l,format:u,width:y,height:y,autoMipmap:!1});G.minFilter=pc.FILTER_LINEAR;G.magFilter=pc.FILTER_LINEAR;G.addressU=%20pc.ADDRESS_CLAMP_TO_EDGE;G.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6%3EE;E++)B=new%20pc.RenderTarget(e,G,{face:E,depth:!1}),D.x=E,D.y=I,D.z=y,D.w=l?3:0,w.setValue(g),s.setValue(D.data),r&&f(),pc.drawQuadWithShader(e,B,m),z===R-1&&n&&a(e,B,E);g=G}}b.sourceCubemap=g;G=null;if(!l&&b.filteredFixedRgbm){G=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:y,height:y,autoMipmap:!1});G.minFilter=pc.FILTER_LINEAR;G.magFilter=pc.FILTER_LINEAR;G.addressU=pc.ADDRESS_CLAMP_TO_EDGE;%20G.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6%3EE;E++)B=new%20pc.RenderTarget(e,G,{face:E,depth:!1}),D.x=E,D.w=2,w.setValue(g),s.setValue(D.data),r&&f(),pc.drawQuadWithShader(e,B,m),a(e,B,E)}y=0===h?1:2048;B=0===h?0:-1;x[B]=[];for(z=0;5%3Ez;z++)for(m=B;m%3Cx.length;m++)null!=x[m]&&(x[m][z]=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:2%3Em?l:!0,format:2%3Em?u:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===m||3===m,width:C[z],height:C[z],autoMipmap:!1}),x[m][z].minFilter=pc.FILTER_LINEAR,x[m][z].magFilter=pc.FILTER_LINEAR,%20x[m][z].addressU=pc.ADDRESS_CLAMP_TO_EDGE,x[m][z].addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(m=B;m%3Cx.length;m++)if(null!=x[m])if(1%3Cm&&l)x[m]=x[m-2];else%20for(z=0;5%3Ez;z++)for(E=0;6%3EE;E++)B=new%20pc.RenderTarget(e,x[m][z],{face:E,depth:!1}),D.x=E,D.y=0%3Em?y:A[z],D.z=C[z],D.w=l?3:m,w.setValue(0===z?g:0===h?x[0][z-1]:x[-1][z-1]),s.setValue(D.data),r&&f(),pc.drawQuadWithShader(e,B,k),n&&a(e,B,E);b.filtered=x[0];if(n&&b.singleFilteredFixed){g=[g,b.filteredFixed[0],b.filteredFixed[1],b.filteredFixed[2],b.filteredFixed[3],%20b.filteredFixed[4],b.filteredFixed[5]];l=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:l,fixCubemapSeams:!0,format:u,width:128,height:128,autoMipmap:!1});for(z=0;6%3Ez;z++)l._levels[z]=g[z]._levels[0];l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;l.upload();l.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;l.magFilter=pc.FILTER_LINEAR;l._prefilteredMips=!0;b.singleFilteredFixed=l}if(n&&b.singleFilteredFixedRgbm&&b.filteredFixedRgbm){g=[G,b.filteredFixedRgbm[0],b.filteredFixedRgbm[1],b.filteredFixedRgbm[2],%20b.filteredFixedRgbm[3],b.filteredFixedRgbm[4],b.filteredFixedRgbm[5]];l=new%20pc.gfx.Texture(e,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,autoMipmap:!1});for(z=0;6%3Ez;z++)l._levels[z]=g[z]._levels[0];l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;l.upload();l.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;l.magFilter=pc.FILTER_LINEAR;l._prefilteredMips=!0;b.singleFilteredFixedRgbm=l}}},shFromCubemap:function(a,e){var%20g,f=a.width;if(a.format!=%20pc.PIXELFORMAT_R8_G8_B8_A8)console.error(%22ERROR:%20SH:%20cubemap%20must%20be%20RGBA8%22);else{if(a._levels[0]){if(!a._levels[0][0].length)if(a._levels[0][0]instanceof%20HTMLImageElement){var%20k=pc.Application.getApplication().graphicsDevice,n=k.gl;g=pc.shaderChunks;var%20r=g.createShaderFromCode(k,g.fullscreenQuadVS,g.fullscreenQuadPS,%22fsQuadSimple%22),u=k.scope.resolve(%22source%22);for(g=0;6%3Eg;g++){var%20l=a._levels[0][g],m=new%20pc.gfx.Texture(k,{cubemap:!1,rgbm:!1,format:a.format,width:f,height:f,autoMipmap:!1});m.minFilter=%20pc.FILTER_NEAREST;m.magFilter=pc.FILTER_NEAREST;m.addressU=pc.ADDRESS_CLAMP_TO_EDGE;m.addressV=pc.ADDRESS_CLAMP_TO_EDGE;m._levels[0]=l;m.upload();l=new%20pc.gfx.Texture(k,{cubemap:!1,rgbm:!1,format:a.format,width:f,height:f,autoMipmap:!1});l.minFilter=pc.FILTER_NEAREST;l.magFilter=pc.FILTER_NEAREST;l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;targ=new%20pc.RenderTarget(k,l,{depth:!1});u.setValue(m);pc.drawQuadWithShader(k,targ,r);l=new%20Uint8Array(4*f*f);n.bindFramebuffer(n.FRAMEBUFFER,%20targ._glFrameBuffer);n.readPixels(0,0,m.width,m.height,n.RGBA,n.UNSIGNED_BYTE,l);a._levels[0][g]=l}}else{console.error(%22ERROR:%20SH:%20cubemap%20must%20be%20composed%20of%20arrays%20or%20images%22);return}k=[];for(u=0;u%3Cf;u++)for(r=0;r%3Cf;r++)k[u*f+r]=(new%20pc.Vec3(2*(r/(f-1))-1,2*(u/(f-1))-1,1)).normalize();var%20n=new%20Float32Array(27),w,s,D,y,x,A,C;for(g=l=0;6%3Eg;g++)for(u=0;u%3Cf;u++)for(r=0;r%3Cf;r++){m=u*f+r;y=r;w=u;s=f;var%20B=2*(y+0.5)/s-1,z=2*(w+0.5)/s-1,B=B*(1-1/s),z=z*(1-1/s),E=1/s;D=B-E;var%20G=z-E,B=B+E,z=z+E;D=b(D,G)-%20b(D,z)-b(B,G)+b(B,z);if(0===y&&0===w||y===s-1&&0===w||0===y&&w===s-1||y===s-1&&w===s-1)D/=3;else%20if(0===y||0===w||y===s-1||w===s-1)D*=0.5;y=D;weight1=4*y/17;weight2=8*y/17;weight3=15*y/17;weight4=5*y/68;weight5=15*y/68;w=k[m];0==g?(x=w.z,A=-w.y,C=-w.x):1==g?(x=-w.z,A=-w.y,C=w.x):2==g?(x=w.x,A=w.z,C=w.y):3==g?(x=w.x,A=-w.z,C=-w.y):4==g?(x=w.x,A=-w.y,C=w.z):5==g&&(x=-w.x,A=-w.y,C=-w.z);e||(x=-x);s=a._levels[0][g][4*m+3]/255;for(w=0;3%3Ew;w++)D=a._levels[0][g][4*m+w]/255,a.rgbm&&(D*=8*s,D*=D),n[0+w]+=%20D*weight1,n[3+w]+=D*weight2*x,n[6+w]+=D*weight2*A,n[9+w]+=D*weight2*C,n[12+w]+=D*weight3*x*C,n[15+w]+=D*weight3*C*A,n[18+w]+=D*weight3*A*x,n[21+w]+=D*weight4*(3*C*C-1),n[24+w]+=D*weight5*(x*x-A*A),l+=y}for(w=0;w%3Cn.length;w++)n[w]*=4*Math.PI/l;return%20n}console.error(%22ERROR:%20SH:%20cubemap%20must%20be%20synced%20to%20CPU%22)}}}}());pc.extend(pc,function(){return{paraboloidFromCubemap:function(f,a,b,d){var%20e=pc.shaderChunks,e=e.createShaderFromCode(f,e.fullscreenQuadVS,(a.fixCubemapSeams?e.fixCubemapSeamsStretchPS:e.fixCubemapSeamsNonePS)+e.genParaboloidPS,%22genParaboloid%22),g=f.scope.resolve(%22source%22),h=f.scope.resolve(%22params%22),k=new%20pc.Vec4,n=a.width,r=a.rgbm,u=a.format,n=2*Math.max(n,8),n=new%20pc.gfx.Texture(f,{rgbm:r,format:u,width:2*n,height:n,autoMipmap:!1});n.minFilter=pc.FILTER_LINEAR;n.magFilter=pc.FILTER_LINEAR;n.addressU=%20pc.ADDRESS_CLAMP_TO_EDGE;n.addressV=pc.ADDRESS_CLAMP_TO_EDGE;r=new%20pc.RenderTarget(f,n,{depth:!1});k.x=b;k.y=d?-1:1;g.setValue(a);h.setValue(k.data);pc.drawQuadWithShader(f,r,e);return%20n},generateDpAtlas:function(f,a,b){var%20d,e;e=new%20pc.Vec4;var%20g=new%20pc.Vec4,h=4*a[0].width,k=pc.shaderChunks,k=k.createShaderFromCode(f,k.fullscreenQuadVS,k.dpAtlasQuadPS,%22dpAtlasQuad%22),n=f.scope.resolve(%22source%22),r=f.scope.resolve(%22params%22),u=new%20pc.gfx.Texture(f,{rgbm:a[0].rgbm,format:a[0].format,width:h,height:h,%20autoMipmap:!1});u.minFilter=pc.FILTER_LINEAR;u.magFilter=pc.FILTER_LINEAR;u.addressU=pc.ADDRESS_CLAMP_TO_EDGE;u.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var%20l=new%20pc.RenderTarget(f,u,{depth:!1}),m=(h+2)/h-1,w=0;6%3Ew;w++){d=pc.paraboloidFromCubemap(f,a[w],w,b);n.setValue(d);d=e;var%20s=w;d.x=0.5*pc.math.clamp(s-2,0,1);var%20s=s-6*d.x,D=1-d.x;d.y=Math.min(0.5*s,0.75)*D+d.x;d.z=(1-0.5*pc.math.clamp(s,0,1))*D;d.w=0.5*d.z;d=1/d.z;g.x=d*m;g.y=2*g.x;g.x+=1;g.y+=1;r.setValue(g.data);e.x*=h;e.y*=h;e.z*=h;e.w*=h;pc.drawQuadWithShader(f,%20l,k,e)}return%20u}}}());pc.shaderChunks.ambientPrefilteredCubeLodPS=%22void%20addAmbient(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20fixedReflDir%20=%20fixSeamsStatic(data.normalW,%201.0%20-%201.0%20/%204.0);\n%20%20%20%20fixedReflDir.x%20*=%20-1.0;\n%20%20%20%20data.diffuseLight%20+=%20processEnvironment($DECODE(%20textureCubeLodEXT(texture_prefilteredCubeMap128,%20fixedReflDir,%205.0)%20).rgb);\n}\n\n%22;pc.shaderChunks.reflectionPrefilteredCubePS=%22uniform%20samplerCube%20texture_prefilteredCubeMap128;\nuniform%20samplerCube%20texture_prefilteredCubeMap64;\nuniform%20samplerCube%20texture_prefilteredCubeMap32;\nuniform%20samplerCube%20texture_prefilteredCubeMap16;\nuniform%20samplerCube%20texture_prefilteredCubeMap8;\nuniform%20samplerCube%20texture_prefilteredCubeMap4;\nuniform%20float%20material_reflectivity;\n\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n\n%20%20%20%20//%20Unfortunately,%20WebGL%20doesn't%20allow%20us%20using%20textureCubeLod.%20Therefore%20bunch%20of%20nasty%20workarounds%20is%20required.\n%20%20%20%20//%20We%20fix%20mip0%20to%20128x128,%20so%20code%20is%20rather%20static.\n%20%20%20%20//%20Mips%20smaller%20than%204x4%20aren't%20great%20even%20for%20diffuse.%20Don't%20forget%20that%20we%20don't%20have%20bilinear%20filtering%20between%20different%20faces.\n\n%20%20%20%20float%20bias%20=%20saturate(1.0%20-%20data.glossiness)%20*%205.0;%20//%20multiply%20by%20max%20mip%20level\n%20%20%20%20int%20index1%20=%20int(bias);\n%20%20%20%20int%20index2%20=%20int(min(bias%20+%201.0,%207.0));\n\n%20%20%20%20vec3%20fixedReflDir%20=%20fixSeams(cubeMapProject(data.reflDirW),%20bias);\n%20%20%20%20fixedReflDir.x%20*=%20-1.0;\n\n%20%20%20%20vec4%20cubes[6];\n%20%20%20%20cubes[0]%20=%20textureCube(texture_prefilteredCubeMap128,%20fixedReflDir);\n%20%20%20%20cubes[1]%20=%20textureCube(texture_prefilteredCubeMap64,%20fixedReflDir);\n%20%20%20%20cubes[2]%20=%20textureCube(texture_prefilteredCubeMap32,%20fixedReflDir);\n%20%20%20%20cubes[3]%20=%20textureCube(texture_prefilteredCubeMap16,%20fixedReflDir);\n%20%20%20%20cubes[4]%20=%20textureCube(texture_prefilteredCubeMap8,%20fixedReflDir);\n%20%20%20%20cubes[5]%20=%20textureCube(texture_prefilteredCubeMap4,%20fixedReflDir);\n\n%20%20%20%20//%20Also%20we%20don't%20have%20dynamic%20indexing%20in%20PS,%20so...\n%20%20%20%20vec4%20cube[2];\n%20%20%20%20for(int%20i%20=%200;%20i%20%3C%206;%20i++)%20{\n%20%20%20%20%20%20%20%20if%20(i%20==%20index1)%20{\n%20%20%20%20%20%20%20%20%20%20%20%20cube[0]%20=%20cubes[i];\n%20%20%20%20%20%20%20%20}\n%20%20%20%20%20%20%20%20if%20(i%20==%20index2)%20{\n%20%20%20%20%20%20%20%20%20%20%20%20cube[1]%20=%20cubes[i];\n%20%20%20%20%20%20%20%20}\n%20%20%20%20}\n\n%20%20%20%20//%20another%20variant\n%20%20%20%20/*if%20(index1==0){%20cube[0]=cubes[0];\n%20%20%20%20}else%20if%20(index1==1){%20cube[0]=cubes[1];\n%20%20%20%20}else%20if%20(index1==2){%20cube[0]=cubes[2];\n%20%20%20%20}else%20if%20(index1==3){%20cube[0]=cubes[3];\n%20%20%20%20}else%20if%20(index1==4){%20cube[0]=cubes[4];\n%20%20%20%20}else%20if%20(index1==5){%20cube[0]=cubes[5];}\n\n%20%20%20%20if%20(index2==0){%20cube[1]=cubes[0];\n%20%20%20%20}else%20if%20(index2==1){%20cube[1]=cubes[1];\n%20%20%20%20}else%20if%20(index2==2){%20cube[1]=cubes[2];\n%20%20%20%20}else%20if%20(index2==3){%20cube[1]=cubes[3];\n%20%20%20%20}else%20if%20(index2==4){%20cube[1]=cubes[4];\n%20%20%20%20}else%20if%20(index2==5){%20cube[1]=cubes[5];}*/\n\n%20%20%20%20vec4%20cubeFinal%20=%20mix(cube[0],%20cube[1],%20fract(bias));\n%20%20%20%20vec3%20refl%20=%20processEnvironment($DECODE(cubeFinal).rgb);\n\n%20%20%20%20data.reflection%20+=%20vec4(refl,%20material_reflectivity);\n}\n\n%22;%20pc.shaderChunks.ambientSHPS=%22uniform%20vec3%20ambientSH[9];\nvoid%20addAmbient(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20n%20=%20data.normalW;\n\n%20%20%20%20vec3%20color%20=\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[0]%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[1]%20*%20n.x%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[2]%20*%20n.y%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[3]%20*%20n.z%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[4]%20*%20n.x%20*%20n.z%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[5]%20*%20n.z%20*%20n.y%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[6]%20*%20n.y%20*%20n.x%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[7]%20*%20(3.0%20*%20n.z%20*%20n.z%20-%201.0)%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ambientSH[8]%20*%20(n.x%20*%20n.x%20-%20n.y%20*%20n.y);\n\n%20%20%20%20data.diffuseLight%20+=%20processEnvironment(max(color,%20vec3(0.0)));\n}\n\n%22;%20pc.shaderChunks.normalMapPS=%22uniform%20sampler2D%20texture_normalMap;\nuniform%20float%20material_bumpiness;\nvoid%20getNormal(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20normalMap%20=%20unpackNormal(texture2D(texture_normalMap,%20$UV));\n%20%20%20%20data.normalMap%20=%20normalMap;\n%20%20%20%20data.normalW%20=%20data.TBN%20*%20normalMap;\n}\n\n%22;pc.shaderChunks.gamma2_2FastPS=%22vec3%20gammaCorrectInput(vec3%20color)%20{\n%20%20%20%20return%20color%20*%20(color%20*%20(color%20*%200.305306011%20+%200.682171111)%20+%200.012522878);\n}\n\nfloat%20gammaCorrectInput(float%20color)%20{\n%20%20%20%20return%20color%20*%20(color%20*%20(color%20*%200.305306011%20+%200.682171111)%20+%200.012522878);\n}\n\nvec4%20gammaCorrectInput(vec4%20color)%20{\n%20%20%20%20return%20vec4(gammaCorrectInput(color.rgb),%20color.a);\n}\n\nvec4%20texture2DSRGB(sampler2D%20tex,%20vec2%20uv)%20{\n%20%20%20%20vec4%20rgba%20=%20texture2D(tex,%20uv);\n%20%20%20%20rgba.rgb%20=%20gammaCorrectInput(rgba.rgb);\n%20%20%20%20return%20rgba;\n}\n\nvec4%20textureCubeSRGB(samplerCube%20tex,%20vec3%20uvw)%20{\n%20%20%20%20vec4%20rgba%20=%20textureCube(tex,%20uvw);\n%20%20%20%20rgba.rgb%20=%20gammaCorrectInput(rgba.rgb);\n%20%20%20%20return%20rgba;\n}\n\nvec3%20gammaCorrectOutput(vec3%20color)%20{\n%20%20%20%20color%20+=%20vec3(0.0000001);\n%20%20%20%20return%20pow(color,%20vec3(0.45));\n}\n\n%22;%20pc.shaderChunks.particle_pointAlongVS=%22%20%20%20%20angle%20=%20atan(velocityV.x,%20velocityV.y);%20//%20not%20the%20fastest%20way,%20but%20easier%20to%20plug%20in;%20TODO:%20create%20rot%20matrix%20right%20from%20vectors\n\n%22;pc.shaderChunks.glossConstPS=%22uniform%20float%20material_shininess;\nvoid%20getGlossiness(inout%20psInternalData%20data)%20{\n%20%20%20%20data.glossiness%20=%20material_shininess%20+%200.0000001;\n}\n\n%22;pc.shaderChunks.tonemappingFilmicPS=%22const%20float%20A%20=%20%200.15;\nconst%20float%20B%20=%20%200.50;\nconst%20float%20C%20=%20%200.10;\nconst%20float%20D%20=%20%200.20;\nconst%20float%20E%20=%20%200.02;\nconst%20float%20F%20=%20%200.30;\nconst%20float%20W%20=%20%2011.2;\n\nuniform%20float%20exposure;\n\nvec3%20uncharted2Tonemap(vec3%20x)%20{\n%20%20%20return%20((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3%20toneMap(vec3%20color)%20{\n%20%20%20%20color%20=%20uncharted2Tonemap(color%20*%20exposure);\n%20%20%20%20vec3%20whiteScale%20=%201.0%20/%20uncharted2Tonemap(vec3(W,W,W));\n%20%20%20%20color%20=%20color%20*%20whiteScale;\n\n%20%20%20%20return%20color;\n}\n\n%22;%20pc.shaderChunks.skyboxPS=%22varying%20vec3%20vViewDir;\nuniform%20samplerCube%20texture_cubeMap;\n\nvoid%20main(void)%20{\n%20%20%20%20gl_FragColor%20=%20textureCube(texture_cubeMap,%20fixSeams(vViewDir));\n}\n\n%22;pc.shaderChunks.particleUpdaterAABBPS=%22uniform%20mat3%20spawnBounds;\nvec3%20calcSpawnPosition(vec3%20inBounds,%20float%20rndFactor)%20{\n%20%20%20%20return%20emitterPos%20+%20spawnBounds%20*%20(inBounds%20-%20vec3(0.5));\n}\n\nvoid%20addInitialVelocity(inout%20vec3%20localVelocity,%20vec3%20inBounds)%20{\n%20%20%20%20localVelocity%20-=%20vec3(0,%200,%20initialVelocity);\n}\n\n%22;%20pc.shaderChunks.uv1VS=%22\nvec2%20getUv1(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20vertex_texCoord1;\n}\n%22;pc.shaderChunks.emissiveVertPS=%22vec3%20getEmission(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n\n%22;pc.shaderChunks.particle_cpu_endVS=%22\n%20%20%20%20localPos%20*=%20particle_vertexData2.y%20*%20emitterScale;\n%20%20%20%20localPos%20+=%20particlePos;\n\n%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20vec4(localPos,%201.0);\n}\n\n%22;pc.shaderChunks.normalVertexPS=%22void%20getNormal(inout%20psInternalData%20data)%20{\n%20%20%20%20data.normalW%20=%20normalize(vNormalW);\n}\n\n%22;%20pc.shaderChunks.lightSpecularPhongPS=%22float%20getLightSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20float%20specPow%20=%20data.glossiness;\n\n%20%20%20%20specPow%20=%20antiAliasGlossiness(data,%20specPow);\n\n%20%20%20%20//%20Hack:%20On%20Mac%20OS%20X,%20calling%20pow%20with%20zero%20for%20the%20exponent%20generates%20hideous%20artifacts%20so%20bias%20up%20a%20little\n%20%20%20%20return%20pow(max(dot(data.reflDirW,%20-data.lightDirNormW),%200.0),%20specPow%20+%200.0001);\n}\n\n%22;pc.shaderChunks.reflectionDpAtlasPS=%22uniform%20sampler2D%20texture_sphereMap;\nuniform%20float%20material_reflectivity;\n\nvec2%20getDpAtlasUv(vec2%20uv,%20float%20mip)%20{\n\n%20%20%20%20vec4%20rect;\n%20%20%20%20float%20sx%20=%20saturate(mip%20-%202.0);\n%20%20%20%20rect.x%20=%20sx%20*%200.5;\n\n%20%20%20%20float%20t%20=%20mip%20-%20rect.x%20*%206.0;\n%20%20%20%20float%20i%20=%201.0%20-%20rect.x;\n%20%20%20%20rect.y%20=%20min(t%20*%200.5,%200.75)%20*%20i%20+%20rect.x;\n\n%20%20%20%20float%20st%20=%20saturate(t);\n%20%20%20%20rect.z%20=%20(1.0%20-%20st%20*%200.5)%20*%20i;\n%20%20%20%20rect.w%20=%20rect.z%20*%200.5;\n\n%20%20%20%20float%20rcRectZ%20=%201.0%20/%20rect.z;\n%20%20%20%20float%20scaleFactor%20=%200.00390625%20*%20rcRectZ;%20//%200.0078125%20=%20(256%20+%202)%20/%20256%20-%201,%200.00390625%20same%20for%20512\n%20%20%20%20vec2%20scale%20=%20vec2(scaleFactor,%20scaleFactor%20*%202.0);\n%20%20%20%20uv%20=%20uv%20*%20(vec2(1.0)%20-%20scale)%20+%20scale%20*%200.5;\n\n%20%20%20%20uv%20=%20uv%20*%20rect.zw%20+%20rect.xy;\n\n%20%20%20%20return%20uv;\n}\n\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n\n%20%20%20%20vec3%20reflDir%20=%20normalize(cubeMapProject(data.reflDirW));\n\n%20%20%20%20//%20Convert%20vector%20to%20DP%20coords\n%20%20%20%20bool%20up%20=%20reflDir.y%20%3E%200.0;\n%20%20%20%20float%20scale%20=%200.90909090909090909090909090909091;//%201.0%20/%201.1;\n%20%20%20%20vec3%20reflDirWarp%20=%20reflDir.xzx%20*%20vec3(-0.25,%200.5,%200.25);\n%20%20%20%20float%20reflDirVer%20=%20abs(reflDir.y)%20+%201.0;\n%20%20%20%20reflDirWarp%20/=%20reflDirVer;\n%20%20%20%20reflDirWarp%20*=%20scale;\n%20%20%20%20reflDirWarp%20=%20vec3(0.75,%200.5,%200.25)%20-%20reflDirWarp;\n%20%20%20%20vec2%20tc%20=%20up?%20reflDirWarp.xy%20:%20reflDirWarp.zy;\n\n%20%20%20%20float%20bias%20=%20saturate(1.0%20-%20data.glossiness)%20*%205.0;%20//%20multiply%20by%20max%20mip%20level\n\n%20%20%20%20float%20mip%20=%20floor(bias);\n%20%20%20%20vec3%20tex1%20=%20$texture2DSAMPLE(texture_sphereMap,%20getDpAtlasUv(tc,%20mip)).rgb;\n\n%20%20%20%20mip%20=%20min(mip%20+%201.0,%205.0);\n%20%20%20%20vec3%20tex2%20=%20$texture2DSAMPLE(texture_sphereMap,%20getDpAtlasUv(tc,%20mip)).rgb;\n\n%20%20%20%20tex1%20=%20mix(tex1,%20tex2,%20fract(bias));\n%20%20%20%20tex1%20=%20processEnvironment(tex1);\n\n%20%20%20%20data.reflection%20+=%20vec4(tex1,%20material_reflectivity);\n}\n\n\n%22;%20pc.shaderChunks.refractionPS=%22uniform%20float%20material_refraction,%20material_refractionIndex;\n\nvec3%20refract2(vec3%20viewVec,%20vec3%20Normal,%20float%20IOR)%20{\n%20%20%20%20float%20vn%20=%20dot(viewVec,%20Normal);\n%20%20%20%20float%20k%20=%201.0%20-%20IOR%20*%20IOR%20*%20(1.0%20-%20vn%20*%20vn);\n%20%20%20%20vec3%20refrVec%20=%20IOR%20*%20viewVec%20-%20(IOR%20*%20vn%20+%20sqrt(k))%20*%20Normal;\n%20%20%20%20return%20refrVec;\n}\n\nvoid%20addRefraction(inout%20psInternalData%20data)%20{\n\n%20%20%20%20//%20use%20same%20reflection%20code%20with%20refraction%20vector\n%20%20%20%20vec3%20tmp%20=%20data.reflDirW;\n%20%20%20%20vec4%20tmp2%20=%20data.reflection;\n%20%20%20%20data.reflection%20=%20vec4(0.0);\n%20%20%20%20data.reflDirW%20=%20refract2(-data.viewDirW,%20data.normalW,%20material_refractionIndex);\n\n%20%20%20%20addReflection(data);\n\n%20%20%20%20data.diffuseLight%20=%20mix(data.diffuseLight,%20data.reflection.rgb%20*%20data.albedo,%20material_refraction);\n%20%20%20%20data.reflDirW%20=%20tmp;\n%20%20%20%20data.reflection%20=%20tmp2;\n}\n\n%22;%20pc.shaderChunks.metalnessTexConstPS=%22uniform%20sampler2D%20texture_metalnessMap;\nuniform%20float%20material_metalness;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20processMetalness(data,%20texture2D(texture_metalnessMap,%20$UV).$CH%20*%20material_metalness);\n}\n\n%22;pc.shaderChunks.diffuseVertPS=%22void%20getAlbedo(inout%20psInternalData%20data)%20{\n%20%20%20%20data.albedo%20=%20gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n\n%22;pc.shaderChunks.particleAnimFrameLoopVS=%22\n%20%20%20%20float%20animFrame%20=%20floor(texCoordsAlphaLife.w%20*%20animTexParams.z);\n\n%22;%20pc.shaderChunks.transformInstancedVS=%22mat4%20getModelMatrix(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20mat4(instance_line1,%20instance_line2,%20instance_line3,%20instance_line4);\n}\n\nvec4%20getPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.modelMatrix%20=%20getModelMatrix(data);\n%20%20%20%20vec4%20posW%20=%20data.modelMatrix%20*%20vec4(vertex_position,%201.0);\n%20%20%20%20data.positionW%20=%20posW.xyz;\n%20%20%20%20return%20matrix_viewProjection%20*%20posW;\n}\n\nvec3%20getWorldPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20data.positionW;\n}\n\n%22;%20pc.shaderChunks.normalMapFloatPS=%22uniform%20sampler2D%20texture_normalMap;\nuniform%20float%20material_bumpiness;\nvoid%20getNormal(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20normalMap%20=%20unpackNormal(texture2D(texture_normalMap,%20$UV));\n%20%20%20%20data.normalMap%20=%20normalMap;\n%20%20%20%20normalMap%20=%20normalize(mix(vec3(0.0,%200.0,%201.0),%20normalMap,%20material_bumpiness));\n%20%20%20%20data.normalW%20=%20data.TBN%20*%20normalMap;\n}\n\n%22;pc.shaderChunks.combineDiffuseSpecularOldPS=%22vec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20mix(data.albedo%20*%20data.diffuseLight%20+%20data.specularLight%20*%20data.specularity,%20data.reflection.rgb,%20data.reflection.a);\n}\n\n%22;%20pc.shaderChunks.particleUpdaterStartPS=%22float%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nvec3%20unpack3NFloats(float%20src)%20{\n%20%20%20%20float%20r%20=%20fract(src);\n%20%20%20%20float%20g%20=%20fract(src%20*%20256.0);\n%20%20%20%20float%20b%20=%20fract(src%20*%2065536.0);\n%20%20%20%20return%20vec3(r,%20g,%20b);\n}\n\nvec3%20tex1Dlod_lerp(sampler2D%20tex,%20vec2%20tc,%20out%20vec3%20w)%20{\n%20%20%20%20vec4%20a%20=%20texture2D(tex,%20tc);\n%20%20%20%20vec4%20b%20=%20texture2D(tex,%20tc%20+%20graphSampleSize);\n%20%20%20%20float%20c%20=%20fract(tc.x%20*%20graphNumSamples);\n\n%20%20%20%20vec3%20unpackedA%20=%20unpack3NFloats(a.w);\n%20%20%20%20vec3%20unpackedB%20=%20unpack3NFloats(b.w);\n%20%20%20%20w%20=%20mix(unpackedA,%20unpackedB,%20c);\n\n%20%20%20%20return%20mix(a.xyz,%20b.xyz,%20c);\n}\n\nvoid%20main(void)\n{\n%20%20%20%20if%20(gl_FragCoord.x%20%3E%20numParticles)%20discard;\n%20%20%20%20float%20outMask0%20=%20gl_FragCoord.y%20%3C%201.0?%201.0%20:%200.0;\n%20%20%20%20float%20outMask1%20=%20(gl_FragCoord.y%20%3C%202.0%20&&%20gl_FragCoord.y%20%3E=%201.0)?%201.0%20:%200.0;\n%20%20%20%20float%20outMask2%20=%20(gl_FragCoord.y%20%3C%203.0%20&&%20gl_FragCoord.y%20%3E=%202.0)?%201.0%20:%200.0;\n\n%20%20%20%20vec4%20tex%20=%20texture2D(particleTexIN,%20vec2(vUv0.x,%200.125));\n%20%20%20%20vec4%20tex2%20=%20texture2D(particleTexIN,%20vec2(vUv0.x,%200.375));\n%20%20%20%20vec4%20texR%20=%20texture2D(particleTexIN,%20vec2(vUv0.x,%200.625));\n\n%20%20%20%20vec4%20rndFactor%20=%20fract(texR%20+%20vec4(seed));\n%20%20%20%20float%20particleLifetime%20=%20lifetime;\n%20%20%20%20float%20life%20=%20tex2.w%20+%20delta;\n%20%20%20%20float%20particleRate%20=%20rate%20+%20rateDiv%20*%20rndFactor.x;\n\n%20%20%20%20%20%20%20%20float%20nlife%20=%20clamp(life%20/%20particleLifetime,%200.0,%201.0);\n%20%20%20%20%20%20%20%20vec3%20localVelocityDiv;\n%20%20%20%20%20%20%20%20vec3%20velocityDiv;\n%20%20%20%20%20%20%20%20vec3%20paramDiv;\n%20%20%20%20%20%20%20%20vec3%20localVelocity%20=%20tex1Dlod_lerp(internalTex0,%20vec2(nlife,%200),%20localVelocityDiv);\n%20%20%20%20%20%20%20%20vec3%20velocity%20=%20%20%20%20%20%20tex1Dlod_lerp(internalTex1,%20vec2(nlife,%200),%20velocityDiv);\n%20%20%20%20%20%20%20%20vec3%20params%20=%20%20%20%20%20%20%20%20tex1Dlod_lerp(internalTex2,%20vec2(nlife,%200),%20paramDiv);\n%20%20%20%20%20%20%20%20float%20rotSpeed%20=%20params.x;\n%20%20%20%20%20%20%20%20float%20rotSpeedDiv%20=%20paramDiv.y;\n%20%20%20%20%20%20%20%20float%20angle%20=%20(tex.w%20%3C%200.0?%20-tex.w%20:%20tex.w)%20-%201000.0;\n%20%20%20%20%20%20%20%20float%20visMode%20=%20tex.w%20%3C%200.0?%20-1.0%20:%201.0;\n\n%20%20%20%20%20%20%20%20localVelocity%20+=%20%20%20%20(localVelocityDiv%20*%20vec3(2.0)%20-%20vec3(1.0))%20*%20localVelocityDivMult%20*%20rndFactor.xyz;\n%20%20%20%20%20%20%20%20velocity%20+=%20%20%20%20%20%20%20%20%20(velocityDiv%20*%20vec3(2.0)%20-%20vec3(1.0))%20*%20velocityDivMult%20*%20rndFactor.xyz;\n%20%20%20%20%20%20%20%20rotSpeed%20+=%20%20%20%20%20%20%20%20%20(rotSpeedDiv%20*%202.0%20-%201.0)%20*%20rotSpeedDivMult%20*%20rndFactor.y;\n\n%20%20%20%20%20%20%20%20addInitialVelocity(localVelocity,%20rndFactor.xyz);\n\n%20%20%20%20%20%20%20%20vec3%20outVelocity%20=%20emitterMatrix%20*%20localVelocity.xyz%20+%20velocity.xyz%20*%20emitterScale;\n%20%20%20%20%20%20%20%20vec3%20outPosition%20=%20tex.xyz%20+%20outVelocity%20*%20delta;\n%20%20%20%20%20%20%20%20float%20outRotation%20=%20angle%20+%20rotSpeed%20*%20delta;\n\n%20%20%20%20%20%20%20%20bool%20respawn%20=%20life%20%3C=%200.0%20||%20life%20%3E=%20particleLifetime;\n%20%20%20%20%20%20%20%20outPosition%20=%20respawn?%20calcSpawnPosition(rndFactor.xyz,%20rndFactor.x)%20:%20outPosition;\n%20%20%20%20%20%20%20%20outRotation%20=%20respawn?%20mix(startAngle,%20startAngle2,%20rndFactor.x)%20:%20outRotation;\n%20%20%20%20%20%20%20%20outVelocity%20=%20respawn?%20vec3(0.0)%20:%20outVelocity;\n%22;%20pc.shaderChunks.opacityTexPS=%22uniform%20sampler2D%20texture_opacityMap;\nvoid%20getOpacity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.alpha%20=%20texture2D(texture_opacityMap,%20$UV).$CH;\n}\n\n%22;pc.shaderChunks.emissiveTexConstPS=%22uniform%20sampler2D%20texture_emissiveMap;\nuniform%20vec3%20material_emissive;\nvec3%20getEmission(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20$texture2DSAMPLE(texture_emissiveMap,%20$UV).$CH%20*%20material_emissive;\n}\n\n%22;pc.shaderChunks.normalVS=%22vec3%20getNormal(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.normalMatrix%20=%20matrix_normal;\n%20%20%20%20return%20normalize(data.normalMatrix%20*%20vertex_normal);\n}\n\n%22;%20pc.shaderChunks.particle_stretchVS=%22%20%20%20%20vec3%20moveDir%20=%20particleVelocity%20*%20stretch;\n%20%20%20%20vec3%20posPrev%20=%20pos%20-%20moveDir;\n%20%20%20%20posPrev%20+=%20particlePosMoved;\n\n%20%20%20%20vec2%20centerToVertexV%20=%20normalize((mat3(matrix_view)%20*%20localPos).xy);\n\n%20%20%20%20float%20interpolation%20=%20dot(-velocityV,%20centerToVertexV)%20*%200.5%20+%200.5;\n\n%20%20%20%20particlePos%20=%20mix(particlePos,%20posPrev,%20interpolation);\n\n%22;pc.shaderChunks.skyboxHDRPS=%22varying%20vec3%20vViewDir;\nuniform%20samplerCube%20texture_cubeMap;\n\nvoid%20main(void)%20{\n%20%20%20%20vec3%20color%20=%20processEnvironment($textureCubeSAMPLE(texture_cubeMap,%20fixSeamsStatic(vViewDir,%20$FIXCONST)).rgb);\n%20%20%20%20color%20=%20toneMap(color);\n%20%20%20%20color%20=%20gammaCorrectOutput(color);\n%20%20%20%20gl_FragColor%20=%20vec4(color,%201.0);\n}\n\n%22;%20pc.shaderChunks.reflectionPrefilteredCubeLodPS=%22#extension%20GL_EXT_shader_texture_lod%20:%20enable\n\nuniform%20samplerCube%20texture_prefilteredCubeMap128;\nuniform%20float%20material_reflectivity;\n\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n\n%20%20%20%20float%20bias%20=%20saturate(1.0%20-%20data.glossiness)%20*%205.0;%20//%20multiply%20by%20max%20mip%20level\n%20%20%20%20vec3%20fixedReflDir%20=%20fixSeams(cubeMapProject(data.reflDirW),%20bias);\n%20%20%20%20fixedReflDir.x%20*=%20-1.0;\n\n%20%20%20%20vec3%20refl%20=%20processEnvironment($DECODE(%20textureCubeLodEXT(texture_prefilteredCubeMap128,%20fixedReflDir,%20bias)%20).rgb);\n\n%20%20%20%20data.reflection%20+=%20vec4(refl,%20material_reflectivity);\n}\n\n%22;%20pc.shaderChunks.reflectionSpherePS=%22uniform%20mat4%20matrix_view;\nuniform%20sampler2D%20texture_sphereMap;\nuniform%20float%20material_reflectivity;\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n\n%20%20%20%20vec3%20reflDirV%20=%20(mat3(matrix_view)%20*%20data.reflDirW).xyz;\n\n%20%20%20%20float%20m%20=%202.0%20*%20sqrt(%20dot(reflDirV.xy,%20reflDirV.xy)%20+%20(reflDirV.z+1.0)*(reflDirV.z+1.0)%20);\n%20%20%20%20vec2%20sphereMapUv%20=%20reflDirV.xy%20/%20m%20+%200.5;\n\n%20%20%20%20data.reflection%20+=%20vec4($texture2DSAMPLE(texture_sphereMap,%20sphereMapUv).rgb,%20material_reflectivity);\n}\n\n\n%22;%20pc.shaderChunks.specularVertConstPS=%22uniform%20vec3%20material_specular;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.specularity%20=%20saturate(vVertexColor.$CH)%20*%20material_specular;\n}\n\n%22;pc.shaderChunks.tonemappingNonePS=%22vec3%20toneMap(vec3%20color)%20{\n%20%20%20%20return%20color;\n}\n\n%22;pc.shaderChunks.shadowVSPS=%22\nfloat%20getShadowHardVS(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20float%20depth%20=%20unpackFloat(texture2DProj(shadowMap,%20vMainShadowUv));\n%20%20%20%20return%20(depth%20%3C%20min(vMainShadowUv.z%20+%20shadowParams.z,%201.0))%20?%200.0%20:%201.0;\n}\n\nfloat%20getShadowMaskVS(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20return%20unpackMask(texture2DProj(shadowMap,%20vMainShadowUv));\n}\n\nfloat%20getShadowPCF3x3VS(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20data.shadowCoord%20=%20vMainShadowUv.xyz;\n%20%20%20%20data.shadowCoord.z%20+=%20shadowParams.z;\n%20%20%20%20data.shadowCoord.xyz%20/=%20vMainShadowUv.w;\n%20%20%20%20data.shadowCoord.z%20=%20min(data.shadowCoord.z,%201.0);\n%20%20%20%20return%20_getShadowPCF3x3(data,%20shadowMap,%20shadowParams);\n}\n\nfloat%20getShadowPCF3x3_YZWVS(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20data.shadowCoord%20=%20vMainShadowUv.xyz;\n%20%20%20%20data.shadowCoord.z%20+=%20shadowParams.z;\n%20%20%20%20data.shadowCoord.xyz%20/=%20vMainShadowUv.w;\n%20%20%20%20data.shadowCoord.z%20=%20min(data.shadowCoord.z,%201.0);\n%20%20%20%20return%20_getShadowPCF3x3_YZW(data,%20shadowMap,%20shadowParams);\n}\n\n%22;%20pc.shaderChunks.particle_lambertPS=%22\n%20%20%20%20vec3%20negNormal%20=%20max(normal,%20vec3(0.0));\n%20%20%20%20vec3%20posNormal%20=%20max(-normal,%20vec3(0.0));\n\n\n%22;pc.shaderChunks.viewNormalVS=%22\nuniform%20mat4%20matrix_view;\nvec3%20getViewNormal(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20mat3(matrix_view)%20*%20vNormalW;\n}\n%22;pc.shaderChunks.packDepthPS=%22//%20Packing%20a%20float%20in%20GLSL%20with%20multiplication%20and%20mod\n//%20http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4%20packFloat(float%20depth)%20{\n%20%20%20%20const%20vec4%20bit_shift%20=%20vec4(256.0%20*%20256.0%20*%20256.0,%20256.0%20*%20256.0,%20256.0,%201.0);\n%20%20%20%20const%20vec4%20bit_mask%20%20=%20vec4(0.0,%201.0%20/%20256.0,%201.0%20/%20256.0,%201.0%20/%20256.0);\n\n%20%20%20%20//%20combination%20of%20mod%20and%20multiplication%20and%20division%20works%20better\n%20%20%20%20vec4%20res%20=%20mod(depth%20*%20bit_shift%20*%20vec4(255),%20vec4(256)%20)%20/%20vec4(255);\n%20%20%20%20res%20-=%20res.xxyz%20*%20bit_mask;\n%20%20%20%20return%20res;\n}\n\n\n%22;%20pc.shaderChunks.basePS=%22\nuniform%20vec3%20view_position;\n\nuniform%20vec3%20light_globalAmbient;\n\nstruct%20psInternalData%20{\n%20%20%20%20vec3%20albedo;\n%20%20%20%20vec3%20specularity;\n%20%20%20%20float%20glossiness;\n%20%20%20%20vec3%20emission;\n%20%20%20%20vec3%20normalW;\n%20%20%20%20mat3%20TBN;\n%20%20%20%20vec3%20viewDirW;\n%20%20%20%20vec3%20reflDirW;\n%20%20%20%20vec3%20diffuseLight;\n%20%20%20%20vec3%20specularLight;\n%20%20%20%20vec4%20reflection;\n%20%20%20%20float%20alpha;\n%20%20%20%20vec3%20lightDirNormW;\n%20%20%20%20vec3%20lightDirW;\n%20%20%20%20vec3%20lightPosW;\n%20%20%20%20float%20atten;\n%20%20%20%20vec3%20shadowCoord;\n%20%20%20%20vec2%20uvOffset;\n%20%20%20%20vec3%20normalMap;\n%20%20%20%20float%20ao;\n};\n\nvoid%20getViewDir(inout%20psInternalData%20data)%20{\n%20%20%20%20data.viewDirW%20=%20normalize(view_position%20-%20vPositionW);\n}\n\nvoid%20getReflDir(inout%20psInternalData%20data)%20{\n%20%20%20%20data.reflDirW%20=%20normalize(-reflect(data.viewDirW,%20data.normalW));\n}\n\nvoid%20getLightDirPoint(inout%20psInternalData%20data,%20vec3%20lightPosW)%20{\n%20%20%20%20data.lightDirW%20=%20vPositionW%20-%20lightPosW;\n%20%20%20%20data.lightDirNormW%20=%20normalize(data.lightDirW);\n%20%20%20%20data.lightPosW%20=%20lightPosW;\n}\n\nfloat%20getFalloffLinear(inout%20psInternalData%20data,%20float%20lightRadius)%20{\n%20%20%20%20float%20d%20=%20length(data.lightDirW);\n%20%20%20%20return%20max(((lightRadius%20-%20d)%20/%20lightRadius),%200.0);\n}\n\nfloat%20square(float%20x)%20{\n%20%20%20%20return%20x*x;\n}\n\nfloat%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nvec3%20saturate(vec3%20x)%20{\n%20%20%20%20return%20clamp(x,%20vec3(0.0),%20vec3(1.0));\n}\n\nfloat%20getFalloffInvSquared(inout%20psInternalData%20data,%20float%20lightRadius)%20{\n%20%20%20%20float%20sqrDist%20=%20dot(data.lightDirW,%20data.lightDirW);\n%20%20%20%20float%20falloff%20=%201.0%20/%20(sqrDist%20+%201.0);\n%20%20%20%20float%20invRadius%20=%201.0%20/%20lightRadius;\n\n%20%20%20%20falloff%20*=%2016.0;\n%20%20%20%20falloff%20*=%20square(%20saturate(%201.0%20-%20square(%20sqrDist%20*%20square(invRadius)%20)%20)%20);\n\n%20%20%20%20return%20falloff;\n}\n\nfloat%20getSpotEffect(inout%20psInternalData%20data,%20vec3%20lightSpotDirW,%20float%20lightInnerConeAngle,%20float%20lightOuterConeAngle)%20{\n%20%20%20%20float%20cosAngle%20=%20dot(data.lightDirNormW,%20lightSpotDirW);\n%20%20%20%20return%20smoothstep(lightOuterConeAngle,%20lightInnerConeAngle,%20cosAngle);\n}\n\nvoid%20processMetalness(inout%20psInternalData%20data,%20float%20metalness)%20{\n%20%20%20%20const%20float%20dielectricF0%20=%200.04;\n%20%20%20%20data.specularity%20=%20mix(vec3(dielectricF0),%20data.albedo,%20metalness);\n%20%20%20%20data.albedo%20*=%201.0%20-%20metalness;\n}\n\n%22;%20pc.shaderChunks.dpAtlasQuadPS=%22varying%20vec2%20vUv0;\nuniform%20sampler2D%20source;\nuniform%20vec4%20params;\n\nvoid%20main(void)%20{\n%20%20%20%20vec2%20uv%20=%20vUv0;\n%20%20%20%20uv%20=%20uv%20*%202.0%20-%20vec2(1.0);\n%20%20%20%20uv%20*=%20params.xy;\n%20%20%20%20uv%20=%20uv%20*%200.5%20+%200.5;\n%20%20%20%20gl_FragColor%20=%20texture2D(source,%20uv);\n}\n%22;pc.shaderChunks.fullscreenQuadPS=%22varying%20vec2%20vUv0;\nuniform%20sampler2D%20source;\n\nvoid%20main(void)%20{\n%20%20%20%20gl_FragColor%20=%20texture2D(source,%20vUv0);\n}\n%22;pc.shaderChunks.transformSkinnedVS=%22mat4%20getModelMatrix(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20getBoneMatrix(vertex_boneIndices.x)%20*%20vertex_boneWeights.x%20+\n%20%20%20%20%20%20%20%20%20%20%20getBoneMatrix(vertex_boneIndices.y)%20*%20vertex_boneWeights.y%20+\n%20%20%20%20%20%20%20%20%20%20%20getBoneMatrix(vertex_boneIndices.z)%20*%20vertex_boneWeights.z%20+\n%20%20%20%20%20%20%20%20%20%20%20getBoneMatrix(vertex_boneIndices.w)%20*%20vertex_boneWeights.w;\n}\n\nvec4%20getPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.modelMatrix%20=%20getModelMatrix(data);\n%20%20%20%20vec4%20posW%20=%20data.modelMatrix%20*%20vec4(vertex_position,%201.0);\n%20%20%20%20//posW.xyz%20/=%20posW.w;\n%20%20%20%20posW.xyz%20+=%20skinPosOffset;\n%20%20%20%20data.positionW%20=%20posW.xyz;//%20/%20posW.w;\n%20%20%20%20return%20matrix_viewProjection%20*%20posW;\n}\n\nvec3%20getWorldPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20data.positionW;\n}\n\n%22;%20pc.shaderChunks.particle_lightingPS=%22\n%20%20%20%20vec3%20light%20=%20negNormal.x*lightCube[0]%20+%20posNormal.x*lightCube[1]%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20negNormal.y*lightCube[2]%20+%20posNormal.y*lightCube[3]%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20negNormal.z*lightCube[4]%20+%20posNormal.z*lightCube[5];\n\n\n%20%20%20%20rgb%20*=%20light;\n\n\n%22;pc.shaderChunks.particle_blendMultiplyPS=%22\n%20%20%20%20rgb%20=%20mix(vec3(1.0),%20rgb,%20vec3(a));\n%20%20%20%20if%20(rgb.r%20+%20rgb.g%20+%20rgb.b%20%3E%202.99)%20discard;\n\n%22;pc.shaderChunks.dilatePS=%22varying%20vec2%20vUv0;\nuniform%20sampler2D%20source;\nuniform%20vec2%20pixelOffset;\nvoid%20main(void)%20{\n%20%20%20%20vec4%20c%20=%20texture2D(source,%20vUv0);\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20-%20pixelOffset);\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(0,%20-pixelOffset.y));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(pixelOffset.x,%20-pixelOffset.y));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(-pixelOffset.x,%200));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(pixelOffset.x,%200));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(-pixelOffset.x,%20pixelOffset.y));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20vec2(0,%20pixelOffset.y));\n%20%20%20%20c%20=%20c.a%3E0.0?%20c%20:%20texture2D(source,%20vUv0%20+%20pixelOffset);\n%20%20%20%20gl_FragColor%20=%20c;\n}\n\n%22;%20pc.shaderChunks.particleUpdaterEndPS=%22\n%20%20%20tex%20=%20vec4(outPosition,%20(outRotation%20+%201000.0)%20*%20visMode)%20*%20outMask0%20+\n%20%20%20%20%20%20%20%20%20%20vec4(outVelocity,%20life)%20*%20outMask1%20+\n%20%20%20%20%20%20%20%20%20%20texR%20*%20outMask2;\n\n%20%20%20%20gl_FragColor%20=%20tex;\n}\n\n%22;pc.shaderChunks.extensionVS=%22\n%22;pc.shaderChunks.skyboxPrefilteredCubePS=%22varying%20vec3%20vViewDir;\nuniform%20samplerCube%20texture_cubeMap;\n\nvec3%20fixSeamsStretch(vec3%20vec,%20float%20mipmapIndex,%20float%20cubemapSize)%20{\n%20%20%20%20float%20scale%20=%201.0%20-%20exp2(mipmapIndex)%20/%20cubemapSize;\n%20%20%20%20float%20M%20=%20max(max(abs(vec.x),%20abs(vec.y)),%20abs(vec.z));\n%20%20%20%20if%20(abs(vec.x)%20!=%20M)%20vec.x%20*=%20scale;\n%20%20%20%20if%20(abs(vec.y)%20!=%20M)%20vec.y%20*=%20scale;\n%20%20%20%20if%20(abs(vec.z)%20!=%20M)%20vec.z%20*=%20scale;\n%20%20%20%20return%20vec;\n}\n\nvoid%20main(void)%20{\n%20%20%20%20vec3%20color%20=%20textureCubeRGBM(texture_cubeMap,%20fixSeamsStretch(vViewDir,%200.0,%20128.0));\n%20%20%20%20color%20=%20toneMap(color);\n%20%20%20%20color%20=%20gammaCorrectOutput(color);\n%20%20%20%20gl_FragColor%20=%20vec4(color,%201.0);\n}\n\n%22;%20pc.shaderChunks.particle_normalMapPS=%22\n%20%20%20%20vec3%20normalMap%20%20%20%20%20%20%20%20%20=%20normalize(%20texture2D(normalMap,%20texCoordsAlphaLife.xy).xyz%20*%202.0%20-%201.0%20);\n%20%20%20%20vec3%20normal%20=%20ParticleMat%20*%20normalMap;\n\n\n\n\n%22;pc.shaderChunks.aoSpecOccConstSimplePS=%22void%20occludeSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20float%20specOcc%20=%20data.ao;\n%20%20%20%20data.specularLight%20*=%20specOcc;\n%20%20%20%20data.reflection%20*=%20specOcc;\n}\n\n%22;pc.shaderChunks.particleVS=%22attribute%20vec4%20particle_vertexData;%20//%20XYZ%20=%20particle%20position,%20W%20=%20particle%20ID%20+%20random%20factor\n\nuniform%20mat4%20matrix_viewProjection;\nuniform%20mat4%20matrix_model;\nuniform%20mat3%20matrix_normal;\nuniform%20mat4%20matrix_viewInverse;\nuniform%20mat4%20matrix_view;\n\nuniform%20float%20numParticles,%20numParticlesPot;\nuniform%20float%20graphSampleSize;\nuniform%20float%20graphNumSamples;\nuniform%20float%20stretch;\nuniform%20vec3%20wrapBounds;\nuniform%20vec3%20emitterScale;\nuniform%20float%20rate,%20rateDiv,%20lifetime,%20deltaRandomnessStatic,%20scaleDivMult,%20alphaDivMult,%20seed;\nuniform%20sampler2D%20particleTexOUT,%20particleTexIN;\nuniform%20sampler2D%20internalTex0;\nuniform%20sampler2D%20internalTex1;\nuniform%20sampler2D%20internalTex2;\n\nvarying%20vec4%20texCoordsAlphaLife;\n\nvec3%20unpack3NFloats(float%20src)%20{\n%20%20%20%20float%20r%20=%20fract(src);\n%20%20%20%20float%20g%20=%20fract(src%20*%20256.0);\n%20%20%20%20float%20b%20=%20fract(src%20*%2065536.0);\n%20%20%20%20return%20vec3(r,%20g,%20b);\n}\n\nfloat%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nvec4%20tex1Dlod_lerp(sampler2D%20tex,%20vec2%20tc)%20{\n%20%20%20%20return%20mix(%20texture2D(tex,tc),%20texture2D(tex,tc%20+%20graphSampleSize),%20fract(tc.x*graphNumSamples)%20);\n}\n\nvec4%20tex1Dlod_lerp(sampler2D%20tex,%20vec2%20tc,%20out%20vec3%20w)%20{\n%20%20%20%20vec4%20a%20=%20texture2D(tex,tc);\n%20%20%20%20vec4%20b%20=%20texture2D(tex,tc%20+%20graphSampleSize);\n%20%20%20%20float%20c%20=%20fract(tc.x*graphNumSamples);\n\n%20%20%20%20vec3%20unpackedA%20=%20unpack3NFloats(a.w);\n%20%20%20%20vec3%20unpackedB%20=%20unpack3NFloats(b.w);\n%20%20%20%20w%20=%20mix(unpackedA,%20unpackedB,%20c);\n\n%20%20%20%20return%20mix(a,%20b,%20c);\n}\n\n\nvec2%20rotate(vec2%20quadXY,%20float%20pRotation,%20out%20mat2%20rotMatrix)%20{\n%20%20%20%20float%20c%20=%20cos(pRotation);\n%20%20%20%20float%20s%20=%20sin(pRotation);\n\n%20%20%20%20mat2%20m%20=%20mat2(c,%20-s,%20s,%20c);\n%20%20%20%20rotMatrix%20=%20m;\n\n%20%20%20%20return%20m%20*%20quadXY;\n}\n\nvec3%20billboard(vec3%20InstanceCoords,%20vec2%20quadXY,%20out%20mat3%20localMat)%20{\n%20%20%20%20vec3%20viewUp%20=%20matrix_viewInverse[1].xyz;\n%20%20%20%20vec3%20posCam%20=%20matrix_viewInverse[3].xyz;\n\n%20%20%20%20mat3%20billMat;\n%20%20%20%20billMat[2]%20=%20normalize(InstanceCoords%20-%20posCam);\n%20%20%20%20billMat[0]%20=%20normalize(cross(viewUp,%20billMat[2]));\n%20%20%20%20billMat[1]%20=%20-viewUp;\n%20%20%20%20vec3%20pos%20=%20billMat%20*%20vec3(quadXY,%200);\n\n%20%20%20%20localMat%20=%20billMat;\n\n%20%20%20%20return%20pos;\n}\n\nvoid%20main(void)%20{\n%20%20%20%20vec3%20meshLocalPos%20=%20particle_vertexData.xyz;\n%20%20%20%20float%20id%20=%20floor(particle_vertexData.w);\n\n%20%20%20%20float%20rndFactor%20=%20fract(sin(id%20+%201.0%20+%20seed));\n%20%20%20%20vec3%20rndFactor3%20=%20vec3(rndFactor,%20fract(rndFactor*10.0),%20fract(rndFactor*100.0));\n\n%20%20%20%20vec4%20particleTex%20=%20texture2D(particleTexOUT,%20vec2(id%20/%20numParticlesPot,%200.125));\n%20%20%20%20vec3%20pos%20=%20particleTex.xyz;\n%20%20%20%20float%20angle%20=%20(particleTex.w%20%3C%200.0?%20-particleTex.w%20:%20particleTex.w)%20-%201000.0;\n%20%20%20%20bool%20hide%20=%20particleTex.w%20%3C%200.0;\n\n%20%20%20%20vec4%20particleTex2%20=%20texture2D(particleTexOUT,%20vec2(id%20/%20numParticlesPot,%200.375));\n%20%20%20%20vec3%20particleVelocity%20=%20particleTex2.xyz;\n%20%20%20%20vec2%20velocityV%20=%20normalize((mat3(matrix_view)%20*%20particleVelocity).xy);%20//%20should%20be%20removed%20by%20compiler%20if%20align/stretch%20is%20not%20used\n%20%20%20%20float%20life%20=%20particleTex2.w;\n\n%20%20%20%20float%20particleLifetime%20=%20lifetime;\n\n%20%20%20%20if%20(life%20%3C=%200.0%20||%20life%20%3E%20particleLifetime%20||%20hide)%20meshLocalPos%20=%20vec3(0.0);\n%20%20%20%20vec2%20quadXY%20=%20meshLocalPos.xy;\n%20%20%20%20float%20nlife%20=%20clamp(life%20/%20particleLifetime,%200.0,%201.0);\n\n%20%20%20%20vec3%20paramDiv;\n%20%20%20%20vec4%20params%20=%20tex1Dlod_lerp(internalTex2,%20vec2(nlife,%200),%20paramDiv);\n%20%20%20%20float%20scale%20=%20params.y;\n%20%20%20%20float%20scaleDiv%20=%20paramDiv.x;\n%20%20%20%20float%20alphaDiv%20=%20paramDiv.z;\n\n%20%20%20%20scale%20+=%20(scaleDiv%20*%202.0%20-%201.0)%20*%20scaleDivMult%20*%20fract(rndFactor*10000.0);\n\n%20%20%20%20texCoordsAlphaLife%20=%20vec4(quadXY%20*%20-0.5%20+%200.5,%20%20%20%20(alphaDiv%20*%202.0%20-%201.0)%20*%20alphaDivMult%20*%20fract(rndFactor*1000.0),%20%20%20%20nlife);\n\n%20%20%20%20vec3%20particlePos%20=%20pos;\n%20%20%20%20vec3%20particlePosMoved%20=%20vec3(0.0);\n\n%20%20%20%20mat2%20rotMatrix;\n%20%20%20%20mat3%20localMat;\n\n\n%22;%20pc.shaderChunks.normalXYPS=%22vec3%20unpackNormal(vec4%20nmap)%20{\n%20%20%20%20vec3%20normal;\n%20%20%20%20normal.xy%20=%20nmap.wy%20*%202.0%20-%201.0;\n%20%20%20%20normal.z%20=%20sqrt(1.0%20-%20saturate(dot(normal.xy,%20normal.xy)));\n%20%20%20%20return%20normal;\n}\n\n%22;pc.shaderChunks.outputCubemapPS=%22varying%20vec2%20vUv0;\n\nuniform%20samplerCube%20source;\nuniform%20vec4%20params;\n\nfloat%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nvec4%20encodeRGBM(vec4%20color)%20{%20//%20modified%20RGBM\n%20%20%20%20color.rgb%20=%20pow(color.rgb,%20vec3(0.5));\n%20%20%20%20color.rgb%20*=%201.0%20/%208.0;\n\n%20%20%20%20color.a%20=%20saturate(%20max(%20max(%20color.r,%20color.g%20),%20max(%20color.b,%201.0%20/%20255.0%20)%20)%20);\n%20%20%20%20color.a%20=%20ceil(color.a%20*%20255.0)%20/%20255.0;\n\n%20%20%20%20color.rgb%20/=%20color.a;\n%20%20%20%20return%20color;\n}\n\nvoid%20main(void)%20{\n\n%20%20%20%20vec2%20st%20=%20vUv0%20*%202.0%20-%201.0;\n%20%20%20%20float%20face%20=%20params.x;\n\n%20%20%20%20vec3%20vec;\n%20%20%20%20if%20(face==0.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(1,%20-st.y,%20-st.x);\n%20%20%20%20}%20else%20if%20(face==1.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(-1,%20-st.y,%20st.x);\n%20%20%20%20}%20else%20if%20(face==2.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%201,%20st.y);\n%20%20%20%20}%20else%20if%20(face==3.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%20-1,%20-st.y);\n%20%20%20%20}%20else%20if%20(face==4.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%20-st.y,%201);\n%20%20%20%20}%20else%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(-st.x,%20-st.y,%20-1);\n%20%20%20%20}\n\n%20%20%20%20gl_FragColor%20=%20textureCube(source,%20vec);\n%20%20%20%20if%20(params.w%20%3E=%202.0)%20gl_FragColor%20=%20encodeRGBM(gl_FragColor);\n}\n\n%22;%20pc.shaderChunks.normalXYZPS=%22vec3%20unpackNormal(vec4%20nmap)%20{\n%20%20%20%20return%20nmap.xyz%20*%202.0%20-%201.0;\n}\n\n%22;pc.shaderChunks.metalnessConstPS=%22uniform%20float%20material_metalness;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20processMetalness(data,%20material_metalness);\n}\n\n%22;pc.shaderChunks.reflectionSphereLowPS=%22uniform%20sampler2D%20texture_sphereMap;\nuniform%20float%20material_reflectivity;\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n\n%20%20%20%20vec3%20reflDirV%20=%20vNormalV;\n\n%20%20%20%20vec2%20sphereMapUv%20=%20reflDirV.xy%20*%200.5%20+%200.5;\n%20%20%20%20data.reflection%20+=%20vec4($texture2DSAMPLE(texture_sphereMap,%20sphereMapUv).rgb,%20material_reflectivity);\n}\n\n%22;%20pc.shaderChunks.outputAlphaPremulPS=%22gl_FragColor.rgb%20*=%20data.alpha;\ngl_FragColor.a%20=%20data.alpha;\n%22;pc.shaderChunks.parallaxPS=%22uniform%20sampler2D%20texture_heightMap;\nuniform%20float%20material_heightMapFactor;\nvoid%20getParallax(inout%20psInternalData%20data)%20{\n%20%20%20%20float%20parallaxScale%20=%20material_heightMapFactor;\n%20%20%20%20const%20float%20parallaxBias%20=%200.01;\n\n%20%20%20%20float%20height%20=%20texture2D(texture_heightMap,%20$UV).$CH%20*%20parallaxScale%20-%20parallaxBias;\n%20%20%20%20vec3%20viewDirT%20=%20data.viewDirW%20*%20data.TBN;\n\n%20%20%20%20data.uvOffset%20=%20min(height%20*%20viewDirT.xy,%20vec2(parallaxBias));\n}\n\n%22;%20pc.shaderChunks.particle_blendNormalPS=%22\n%20%20%20%20if%20(a%20%3C%200.01)%20discard;\n%22;pc.shaderChunks.specularAaToksvigPS=%22float%20antiAliasGlossiness(inout%20psInternalData%20data,%20float%20power)%20{\n%20%20%20%20float%20rlen%20=%201.0%20/%20saturate(length(data.normalMap));\n%20%20%20%20float%20toksvig%20=%201.0%20/%20(1.0%20+%20power%20*%20(rlen%20-%201.0));\n%20%20%20%20return%20power%20*%20toksvig;\n}\n\n%22;pc.shaderChunks.emissiveConstPS=%22uniform%20vec3%20material_emissive;\nvec3%20getEmission(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20material_emissive;\n}\n\n%22;%20pc.shaderChunks.TBNfastPS=%22void%20getTBN(inout%20psInternalData%20data)%20{\n%20%20%20%20data.TBN%20=%20mat3((vTangentW),%20(vBinormalW),%20(vNormalW));\n}\n\n%22;pc.shaderChunks.aoSpecOccPS=%22uniform%20float%20material_occludeSpecularIntensity;\nvoid%20occludeSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20//%20approximated%20specular%20occlusion%20from%20AO\n%20%20%20%20float%20specPow%20=%20exp2(data.glossiness%20*%2011.0);\n%20%20%20%20//%20http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n%20%20%20%20float%20specOcc%20=%20saturate(pow(dot(data.normalW,%20data.viewDirW)%20+%20data.ao,%200.01*specPow)%20-%201.0%20+%20data.ao);\n%20%20%20%20specOcc%20=%20mix(1.0,%20specOcc,%20material_occludeSpecularIntensity);\n\n%20%20%20%20data.specularLight%20*=%20specOcc;\n%20%20%20%20data.reflection%20*=%20specOcc;\n}\n\n%22;%20pc.shaderChunks.gamma2_2PS=%22vec3%20gammaCorrectInput(vec3%20color)%20{\n%20%20%20%20return%20pow(color,%20vec3(2.2));\n}\n\nfloat%20gammaCorrectInput(float%20color)%20{\n%20%20%20%20return%20pow(color,%202.2);\n}\n\nvec4%20gammaCorrectInput(vec4%20color)%20{\n%20%20%20%20return%20vec4(pow(color.rgb,%20vec3(2.2)),%20color.a);\n}\n\nvec4%20texture2DSRGB(sampler2D%20tex,%20vec2%20uv)%20{\n%20%20%20%20vec4%20rgba%20=%20texture2D(tex,%20uv);\n%20%20%20%20rgba.rgb%20=%20gammaCorrectInput(rgba.rgb);\n%20%20%20%20return%20rgba;\n}\n\nvec4%20textureCubeSRGB(samplerCube%20tex,%20vec3%20uvw)%20{\n%20%20%20%20vec4%20rgba%20=%20textureCube(tex,%20uvw);\n%20%20%20%20rgba.rgb%20=%20gammaCorrectInput(rgba.rgb);\n%20%20%20%20return%20rgba;\n}\n\nvec3%20gammaCorrectOutput(vec3%20color)%20{\n%20%20%20%20color%20+=%20vec3(0.0000001);\n%20%20%20%20return%20pow(color,%20vec3(0.45));\n}\n\n%22;%20pc.shaderChunks.particle_blendAddPS=%22\n%20%20%20%20rgb%20*=%20gammaCorrectInput(a);\n%20%20%20%20if%20((rgb.r%20+%20rgb.g%20+%20rgb.b)%20%3C%200.000001)%20discard;\n\n%22;pc.shaderChunks.startVS=%22\nvoid%20main(void)%20{\n%20%20%20%20vsInternalData%20data;\n\n%20%20%20%20gl_Position%20=%20getPosition(data);\n%22;pc.shaderChunks.normalSkinnedVS=%22vec3%20getNormal(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.normalMatrix%20=%20mat3(data.modelMatrix[0].xyz,%20data.modelMatrix[1].xyz,%20data.modelMatrix[2].xyz);\n%20%20%20%20return%20normalize(data.normalMatrix%20*%20vertex_normal);\n}\n\n%22;%20pc.shaderChunks.particleUpdaterRespawnPS=%22%20%20%20%20if%20(life%20%3E=%20particleLifetime)%20{\n%20%20%20%20%20%20%20%20life%20-=%20max(particleLifetime,%20(numParticles%20-%201.0)%20*%20particleRate);\n%20%20%20%20%20%20%20%20visMode%20=%201.0;\n%20%20%20%20}\n%20%20%20%20visMode%20=%20life%20%3C%200.0?%201.0:%20visMode;\n\n%22;pc.shaderChunks.bakeLmEndPS=%22\ngl_FragColor.rgb%20=%20data.diffuseLight;\ngl_FragColor.rgb%20=%20pow(gl_FragColor.rgb,%20vec3(0.5));\ngl_FragColor.rgb%20/=%208.0;\ngl_FragColor.a%20=%20clamp(%20max(%20max(%20gl_FragColor.r,%20gl_FragColor.g%20),%20max(%20gl_FragColor.b,%201.0%20/%20255.0%20)%20),%200.0,1.0%20);\ngl_FragColor.a%20=%20ceil(gl_FragColor.a%20*%20255.0)%20/%20255.0;\ngl_FragColor.rgb%20/=%20gl_FragColor.a;\n\n%22;%20pc.shaderChunks.lightmapSingleVertPS=%22void%20addLightMap(inout%20psInternalData%20data)%20{\n%20%20%20%20data.diffuseLight%20+=%20saturate(vVertexColor.$CH);\n}\n\n%22;pc.shaderChunks.opacityConstPS=%22uniform%20float%20material_opacity;\nvoid%20getOpacity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.alpha%20=%20material_opacity;\n}\n\n%22;pc.shaderChunks.baseVS=%22\nattribute%20vec3%20vertex_position;\nattribute%20vec3%20vertex_normal;\nattribute%20vec4%20vertex_tangent;\nattribute%20vec2%20vertex_texCoord0;\nattribute%20vec2%20vertex_texCoord1;\nattribute%20vec4%20vertex_color;\n\nuniform%20mat4%20matrix_viewProjection;\nuniform%20mat4%20matrix_model;\nuniform%20mat3%20matrix_normal;\n\nstruct%20vsInternalData%20{\n%20%20%20%20vec3%20positionW;\n%20%20%20%20mat4%20modelMatrix;\n%20%20%20%20mat3%20normalMatrix;\n%20%20%20%20vec3%20lightPosW;\n%20%20%20%20vec3%20lightDirNormW;\n%20%20%20%20vec3%20normalW;\n};\n\n%22;%20pc.shaderChunks.glossVertPS=%22void%20getGlossiness(inout%20psInternalData%20data)%20{\n%20%20%20%20data.glossiness%20=%20saturate(vVertexColor.$CH)%20+%200.0000001;\n}\n\n%22;pc.shaderChunks.ambientPrefilteredCubePS=%22void%20addAmbient(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20fixedReflDir%20=%20fixSeamsStatic(data.normalW,%201.0%20-%201.0%20/%204.0);\n%20%20%20%20fixedReflDir.x%20*=%20-1.0;\n%20%20%20%20data.diffuseLight%20+=%20processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4,%20fixedReflDir)).rgb);\n}\n\n%22;pc.shaderChunks.aoSpecOccConstPS=%22void%20occludeSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20//%20approximated%20specular%20occlusion%20from%20AO\n%20%20%20%20float%20specPow%20=%20exp2(data.glossiness%20*%2011.0);\n%20%20%20%20//%20http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n%20%20%20%20float%20specOcc%20=%20saturate(pow(dot(data.normalW,%20data.viewDirW)%20+%20data.ao,%200.01*specPow)%20-%201.0%20+%20data.ao);\n\n%20%20%20%20data.specularLight%20*=%20specOcc;\n%20%20%20%20data.reflection%20*=%20specOcc;\n}\n\n%22;%20pc.shaderChunks.particle_wrapVS=%22\n%20%20%20%20vec3%20origParticlePos%20=%20particlePos;\n%20%20%20%20particlePos%20-=%20matrix_model[3].xyz;\n%20%20%20%20particlePos%20=%20mod(particlePos,%20wrapBounds)%20-%20wrapBounds%20*%200.5;\n%20%20%20%20particlePos%20+=%20matrix_model[3].xyz;\n%20%20%20%20particlePosMoved%20=%20particlePos%20-%20origParticlePos;\n\n\n%22;pc.shaderChunks.combineDiffuseSpecularPS=%22vec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20mix(data.albedo%20*%20data.diffuseLight,%20data.specularLight%20+%20data.reflection.rgb%20*%20data.reflection.a,%20data.specularity);\n}\n\n%22;%20pc.shaderChunks.normalInstancedVS=%22vec3%20getNormal(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.normalMatrix%20=%20mat3(instance_line1.xyz,%20instance_line2.xyz,%20instance_line3.xyz);\n%20%20%20%20return%20normalize(data.normalMatrix%20*%20vertex_normal);\n}\n\n%22;pc.shaderChunks.glossTexConstPS=%22uniform%20sampler2D%20texture_glossMap;\nuniform%20float%20material_shininess;\nvoid%20getGlossiness(inout%20psInternalData%20data)%20{\n%20%20%20%20data.glossiness%20=%20material_shininess%20*%20texture2D(texture_glossMap,%20$UV).$CH%20+%200.0000001;\n}\n\n%22;%20pc.shaderChunks.fresnelSchlickPS=%22//%20Schlick's%20approximation\nuniform%20float%20material_fresnelFactor;%20//%20unused\nvoid%20getFresnel(inout%20psInternalData%20data)%20{\n%20%20%20%20float%20fresnel%20=%201.0%20-%20max(dot(data.normalW,%20data.viewDirW),%200.0);\n%20%20%20%20float%20fresnel2%20=%20fresnel%20*%20fresnel;\n%20%20%20%20fresnel%20*=%20fresnel2%20*%20fresnel2;\n%20%20%20%20fresnel%20*=%20data.glossiness%20*%20data.glossiness;\n%20%20%20%20data.specularity%20=%20data.specularity%20+%20(1.0%20-%20data.specularity)%20*%20fresnel;\n}\n\n%22;pc.shaderChunks.diffuseConstPS=%22uniform%20vec3%20material_diffuse;\nvoid%20getAlbedo(inout%20psInternalData%20data)%20{\n%20%20%20%20data.albedo%20=%20material_diffuse.rgb;\n}\n\n%22;%20pc.shaderChunks.particle_normalVS=%22\n%20%20%20%20Normal%20=%20normalize(localPos%20-%20localMat[2]);\n\n\n%22;pc.shaderChunks.combineDiffuseSpecularNoConservePS=%22vec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20data.albedo%20*%20data.diffuseLight%20+%20(data.specularLight%20+%20data.reflection.rgb%20*%20data.reflection.a)%20*%20data.specularity;\n}\n\n%22;pc.shaderChunks.uv0VS=%22\nvec2%20getUv0(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20vertex_texCoord0;\n}\n%22;pc.shaderChunks.opacityVertConstPS=%22uniform%20float%20material_opacity;\nvoid%20getOpacity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.alpha%20=%20saturate(vVertexColor.$CH)%20*%20material_opacity;\n}\n\n%22;%20pc.shaderChunks.emissiveTexPS=%22uniform%20sampler2D%20texture_emissiveMap;\nvec3%20getEmission(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20$texture2DSAMPLE(texture_emissiveMap,%20$UV).$CH;\n}\n\n%22;pc.shaderChunks.tonemappingLinearPS=%22uniform%20float%20exposure;\nvec3%20toneMap(vec3%20color)%20{\n%20%20%20%20return%20color%20*%20exposure;\n}\n\n%22;pc.shaderChunks.genParaboloidPS=%22varying%20vec2%20vUv0;\n\nuniform%20samplerCube%20source;\nuniform%20vec4%20params;%20//%20x%20=%20mip\n\nvoid%20main(void)%20{\n\n%20%20%20%20vec2%20uv%20=%20vUv0;\n\n%20%20%20%20float%20side%20=%20uv.x%20%3C%200.5?%201.0%20:%20-1.0;\n%20%20%20%20vec2%20tc;\n%20%20%20%20tc.x%20=%20fract(uv.x%20*%202.0)%20*%202.0%20-%201.0;\n%20%20%20%20tc.y%20=%20uv.y%20*%202.0%20-%201.0;\n\n%20%20%20%20//%20scale%20projection%20a%20bit%20to%20have%20a%20little%20overlap%20for%20filtering\n%20%20%20%20const%20float%20scale%20=%201.1;\n%20%20%20%20tc%20*=%20scale;\n\n%20%20%20%20vec3%20dir;\n%20%20%20%20dir.y%20=%20(dot(tc,%20tc)%20-%201.0)%20*%20side;%20//%20from%201.0%20center%20to%200.0%20borders%20quadratically\n%20%20%20%20dir.xz%20=%20tc%20*%20-2.0;\n\n%20%20%20%20dir.x%20*=%20-side%20*%20params.y;%20//%20flip%20original%20cubemap%20x%20instead%20of%20doing%20it%20at%20runtime\n\n%20%20%20%20dir%20=%20fixSeams(dir,%20params.x);\n\n%20%20%20%20vec4%20color%20=%20textureCube(source,%20dir,%20-100.0);\n%20%20%20%20gl_FragColor%20=%20color;\n}\n%22;%20pc.shaderChunks.specularAaNonePS=%22float%20antiAliasGlossiness(inout%20psInternalData%20data,%20float%20power)%20{\n%20%20%20%20return%20power;\n}\n\n%22;pc.shaderChunks.specularAaToksvigFloatPS=%22float%20antiAliasGlossiness(inout%20psInternalData%20data,%20float%20power)%20{\n%20%20%20%20float%20rlen%20=%201.0%20/%20saturate(length(data.normalMap));\n%20%20%20%20float%20toksvig%20=%201.0%20/%20(1.0%20+%20power%20*%20(rlen%20-%201.0));\n%20%20%20%20return%20power%20*%20mix(1.0,%20toksvig,%20material_bumpiness);\n}\n\n%22;pc.shaderChunks.prefilterCubemapPS=%22varying%20vec2%20vUv0;\n\nuniform%20samplerCube%20source;\nuniform%20vec4%20params;\n\nfloat%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nfloat%20rnd(vec2%20uv)%20{\n%20%20%20%20return%20fract(sin(dot(uv,%20vec2(12.9898,%2078.233)%20*%202.0))%20*%2043758.5453);\n}\n\nconst%20float%20PI%20=%203.14159265358979;\nvec3%20hemisphereSample_cos(vec2%20uv,%20mat3%20vecSpace,%20vec3%20cubeDir,%20float%20gloss)%20{%20//%20cos%20+%20lerped%20cone%20size%20(better%20than%20just%20lerped)\n%20%20%20%20float%20phi%20=%20uv.y%20*%202.0%20*%20PI;\n%20%20%20%20float%20cosTheta%20=%20sqrt(1.0%20-%20uv.x);\n%20%20%20%20float%20sinTheta%20=%20sqrt(1.0%20-%20cosTheta%20*%20cosTheta);\n%20%20%20%20vec3%20sampleDir%20=%20vec3(cos(phi)%20*%20sinTheta,%20sin(phi)%20*%20sinTheta,%20cosTheta);\n%20%20%20%20return%20normalize(mix(vecSpace%20*%20sampleDir,%20cubeDir,%20params.y));\n}\n\nvec3%20hemisphereSample_phong(vec2%20uv,%20mat3%20vecSpace,%20vec3%20cubeDir,%20float%20specPow)%20{\n%20%20%20%20float%20phi%20=%20uv.y%20*%202.0%20*%20PI;\n%20%20%20%20float%20cosTheta%20=%20pow(1.0%20-%20uv.x,%201.0%20/%20(specPow%20+%201.0));\n%20%20%20%20float%20sinTheta%20=%20sqrt(1.0%20-%20cosTheta%20*%20cosTheta);\n%20%20%20%20vec3%20sampleDir%20=%20vec3(cos(phi)%20*%20sinTheta,%20sin(phi)%20*%20sinTheta,%20cosTheta);\n%20%20%20%20return%20vecSpace%20*%20sampleDir;\n}\n\nmat3%20matrixFromVector(vec3%20n)%20{%20//%20frisvad\n%20%20%20%20float%20a%20=%201.0%20/%20(1.0%20+%20n.z);\n%20%20%20%20float%20b%20=%20-n.x%20*%20n.y%20*%20a;\n%20%20%20%20vec3%20b1%20=%20vec3(1.0%20-%20n.x%20*%20n.x%20*%20a,%20b,%20-n.x);\n%20%20%20%20vec3%20b2%20=%20vec3(b,%201.0%20-%20n.y%20*%20n.y%20*%20a,%20-n.y);\n%20%20%20%20return%20mat3(b1,%20b2,%20n);\n}\n\nvec4%20encodeRGBM(vec3%20color)%20{%20//%20modified%20RGBM\n%20%20%20%20vec4%20encoded;\n%20%20%20%20encoded.rgb%20=%20pow(color.rgb,%20vec3(0.5));\n%20%20%20%20encoded.rgb%20*=%201.0%20/%208.0;\n\n%20%20%20%20encoded.a%20=%20saturate(%20max(%20max(%20encoded.r,%20encoded.g%20),%20max(%20encoded.b,%201.0%20/%20255.0%20)%20)%20);\n%20%20%20%20encoded.a%20=%20ceil(encoded.a%20*%20255.0)%20/%20255.0;\n\n%20%20%20%20encoded.rgb%20/=%20encoded.a;\n%20%20%20%20return%20encoded;\n}\n\nvoid%20main(void)%20{\n\n%20%20%20%20vec2%20st%20=%20vUv0%20*%202.0%20-%201.0;\n\n%20%20%20%20if%20(params.w==1.0%20||%20params.w==3.0)%20{\n%20%20%20%20%20%20%20%20st%20=%202.0%20*%20floor(gl_FragCoord.xy)%20/%20(params.z%20-%201.0)%20-%201.0;\n%20%20%20%20}\n\n%20%20%20%20float%20face%20=%20params.x;\n\n%20%20%20%20vec3%20vec;\n%20%20%20%20if%20(face==0.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(1,%20-st.y,%20-st.x);\n%20%20%20%20}%20else%20if%20(face==1.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(-1,%20-st.y,%20st.x);\n%20%20%20%20}%20else%20if%20(face==2.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%201,%20st.y);\n%20%20%20%20}%20else%20if%20(face==3.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%20-1,%20-st.y);\n%20%20%20%20}%20else%20if%20(face==4.0)%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(st.x,%20-st.y,%201);\n%20%20%20%20}%20else%20{\n%20%20%20%20%20%20%20%20vec%20=%20vec3(-st.x,%20-st.y,%20-1);\n%20%20%20%20}\n\n%20%20%20%20mat3%20vecSpace%20=%20matrixFromVector(normalize(vec));\n\n%20%20%20%20vec3%20color%20=%20vec3(0.0);\n%20%20%20%20const%20int%20samples%20=%20$NUMSAMPLES;\n%20%20%20%20vec3%20vect;\n%20%20%20%20for(int%20i=0;%20i%3Csamples;%20i++)%20{\n%20%20%20%20%20%20%20%20float%20sini%20=%20sin(float(i));\n%20%20%20%20%20%20%20%20float%20cosi%20=%20cos(float(i));\n%20%20%20%20%20%20%20%20float%20rand%20=%20rnd(vec2(sini,%20cosi));\n\n%20%20%20%20%20%20%20%20vect%20=%20hemisphereSample_$METHOD(vec2(float(i)%20/%20float(samples),%20rand),%20vecSpace,%20vec,%20params.y);\n\n%20%20%20%20%20%20%20%20color%20+=%20$textureCube(source,%20vect).rgb;\n%20%20%20%20}\n%20%20%20%20color%20/=%20float(samples);\n\n%20%20%20%20gl_FragColor%20=%20params.w%20%3C%202.0?%20vec4(color,%201.0)%20:%20encodeRGBM(color);\n}\n%22;%20pc.shaderChunks.particleAnimFrameClampVS=%22\n%20%20%20%20float%20animFrame%20=%20min(floor(texCoordsAlphaLife.w%20*%20animTexParams.z),%20animTexParams.w);\n\n%22;pc.shaderChunks.glossVertConstPS=%22uniform%20float%20material_shininess;\nvoid%20getGlossiness(inout%20psInternalData%20data)%20{\n%20%20%20%20data.glossiness%20=%20material_shininess%20*%20saturate(vVertexColor.$CH)%20+%200.0000001;\n}\n\n%22;pc.shaderChunks.cubeMapProjectBoxPS=%22uniform%20vec3%20envBoxMin,%20envBoxMax;\n\nvec3%20cubeMapProject(vec3%20nrdir)%20{\n%20%20%20%20vec3%20rbmax%20=%20(envBoxMax%20-%20vPositionW)%20/%20nrdir;\n%20%20%20%20vec3%20rbmin%20=%20(envBoxMin%20-%20vPositionW)%20/%20nrdir;\n\n%20%20%20%20vec3%20rbminmax;\n%20%20%20%20rbminmax.x%20=%20nrdir.x%3E0.0?%20rbmax.x%20:%20rbmin.x;\n%20%20%20%20rbminmax.y%20=%20nrdir.y%3E0.0?%20rbmax.y%20:%20rbmin.y;\n%20%20%20%20rbminmax.z%20=%20nrdir.z%3E0.0?%20rbmax.z%20:%20rbmin.z;\n\n%20%20%20%20float%20fa%20=%20min(min(rbminmax.x,%20rbminmax.y),%20rbminmax.z);\n\n%20%20%20%20vec3%20posonbox%20=%20vPositionW%20+%20nrdir%20*%20fa;\n%20%20%20%20vec3%20envBoxPos%20=%20(envBoxMin%20+%20envBoxMax)%20*%200.5;\n%20%20%20%20return%20posonbox%20-%20envBoxPos;\n}\n\n%22;%20pc.shaderChunks.fixCubemapSeamsStretchPS=%22vec3%20fixSeams(vec3%20vec,%20float%20mipmapIndex)%20{\n%20%20%20%20float%20scale%20=%201.0%20-%20exp2(mipmapIndex)%20/%20128.0;\n%20%20%20%20float%20M%20=%20max(max(abs(vec.x),%20abs(vec.y)),%20abs(vec.z));\n%20%20%20%20if%20(abs(vec.x)%20!=%20M)%20vec.x%20*=%20scale;\n%20%20%20%20if%20(abs(vec.y)%20!=%20M)%20vec.y%20*=%20scale;\n%20%20%20%20if%20(abs(vec.z)%20!=%20M)%20vec.z%20*=%20scale;\n%20%20%20%20return%20vec;\n}\n\nvec3%20fixSeams(vec3%20vec)%20{\n%20%20%20%20float%20scale%20=%201.0%20-%201.0%20/%20128.0;\n%20%20%20%20float%20M%20=%20max(max(abs(vec.x),%20abs(vec.y)),%20abs(vec.z));\n%20%20%20%20if%20(abs(vec.x)%20!=%20M)%20vec.x%20*=%20scale;\n%20%20%20%20if%20(abs(vec.y)%20!=%20M)%20vec.y%20*=%20scale;\n%20%20%20%20if%20(abs(vec.z)%20!=%20M)%20vec.z%20*=%20scale;\n%20%20%20%20return%20vec;\n}\n\nvec3%20fixSeamsStatic(vec3%20vec,%20float%20invRecMipSize)%20{\n%20%20%20%20float%20scale%20=%20invRecMipSize;\n%20%20%20%20float%20M%20=%20max(max(abs(vec.x),%20abs(vec.y)),%20abs(vec.z));\n%20%20%20%20if%20(abs(vec.x)%20!=%20M)%20vec.x%20*=%20scale;\n%20%20%20%20if%20(abs(vec.y)%20!=%20M)%20vec.y%20*=%20scale;\n%20%20%20%20if%20(abs(vec.z)%20!=%20M)%20vec.z%20*=%20scale;\n%20%20%20%20return%20vec;\n}\n\n%22;%20pc.shaderChunks.opacityTexConstPS=%22uniform%20sampler2D%20texture_opacityMap;\nuniform%20float%20material_opacity;\nvoid%20getOpacity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.alpha%20=%20texture2D(texture_opacityMap,%20$UV).$CH%20*%20material_opacity;\n}\n\n%22;pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS=%22uniform%20vec3%20material_ambient;\nvec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20(data.diffuseLight%20-%20light_globalAmbient)%20*%20data.albedo%20+%20data.specularLight%20*%20data.specularity%20+%20material_ambient%20*%20light_globalAmbient;\n}\n\n%22;%20pc.shaderChunks.tangentBinormalVS=%22\nvec3%20getTangent(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20normalize(data.normalMatrix%20*%20vertex_tangent.xyz);\n}\n\nvec3%20getBinormal(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20cross(vNormalW,%20vTangentW)%20*%20vertex_tangent.w;\n}\n\n%22;pc.shaderChunks.emissiveVertConstPS=%22uniform%20vec3%20material_emissive;\nvec3%20getEmission(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20gammaCorrectInput(saturate(vVertexColor.$CH))%20*%20material_emissive;\n}\n\n%22;pc.shaderChunks.specularTexPS=%22uniform%20sampler2D%20texture_specularMap;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.specularity%20=%20texture2D(texture_specularMap,%20$UV).$CH;\n}\n\n%22;%20pc.shaderChunks.particle_TBNVS=%22\n%20%20%20%20mat3%20rot3%20=%20mat3(rotMatrix[0][0],%20rotMatrix[0][1],%200.0,%20%20%20%20%20%20%20%20rotMatrix[1][0],%20rotMatrix[1][1],%200.0,%20%20%20%20%20%20%20%200.0,%200.0,%201.0);\n%20%20%20%20localMat[2]%20*=%20-1.0;\n%20%20%20%20ParticleMat%20=%20localMat%20*%20rot3;\n\n\n\n\n%22;pc.shaderChunks.normalMapFloatTBNfastPS=%22uniform%20sampler2D%20texture_normalMap;\nuniform%20float%20material_bumpiness;\nvoid%20getNormal(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20normalMap%20=%20unpackNormal(texture2D(texture_normalMap,%20$UV));\n%20%20%20%20data.normalMap%20=%20normalMap;\n%20%20%20%20normalMap%20=%20mix(vec3(0.0,%200.0,%201.0),%20normalMap,%20material_bumpiness);\n%20%20%20%20data.normalW%20=%20normalize(data.TBN%20*%20normalMap);\n}\n\n%22;%20pc.shaderChunks.fixCubemapSeamsNonePS=%22vec3%20fixSeams(vec3%20vec,%20float%20mipmapIndex)%20{\n%20%20%20%20return%20vec;\n}\n\nvec3%20fixSeams(vec3%20vec)%20{\n%20%20%20%20return%20vec;\n}\n\nvec3%20fixSeamsStatic(vec3%20vec,%20float%20invRecMipSize)%20{\n%20%20%20%20return%20vec;\n}\n%22;pc.shaderChunks.particle_cpuVS=%22attribute%20vec4%20particle_vertexData;%20%20%20%20%20//%20XYZ%20=%20world%20pos,%20W%20=%20life\nattribute%20vec4%20particle_vertexData2;%20%20%20%20%20//%20X%20=%20angle,%20Y%20=%20scale,%20Z%20=%20alpha,%20W%20=%20velocity.x\nattribute%20vec4%20particle_vertexData3;%20%20%20%20%20//%20XYZ%20=%20particle%20local%20pos,%20W%20=%20velocity.y\nattribute%20vec2%20particle_vertexData4;%20%20%20%20%20//%20X%20=%20velocity.z,%20W%20=%20particle%20ID\n\nuniform%20mat4%20matrix_viewProjection;\nuniform%20mat4%20matrix_model;\nuniform%20mat4%20matrix_view;\nuniform%20mat3%20matrix_normal;\nuniform%20mat4%20matrix_viewInverse;\n\nuniform%20float%20numParticles;\nuniform%20float%20lifetime;\nuniform%20float%20stretch;\n//uniform%20float%20graphSampleSize;\n//uniform%20float%20graphNumSamples;\nuniform%20vec3%20wrapBounds,%20emitterScale;\nuniform%20sampler2D%20texLifeAndSourcePosOUT;\nuniform%20sampler2D%20internalTex0;\nuniform%20sampler2D%20internalTex1;\nuniform%20sampler2D%20internalTex2;\n\nvarying%20vec4%20texCoordsAlphaLife;\n\n\nvec2%20rotate(vec2%20quadXY,%20float%20pRotation,%20out%20mat2%20rotMatrix)\n{\n%20%20%20%20float%20c%20=%20cos(pRotation);\n%20%20%20%20float%20s%20=%20sin(pRotation);\n%20%20%20%20//vec4%20rotationMatrix%20=%20vec4(c,%20-s,%20s,%20c);\n\n%20%20%20%20mat2%20m%20=%20mat2(c,%20-s,%20s,%20c);\n%20%20%20%20rotMatrix%20=%20m;\n\n%20%20%20%20return%20m%20*%20quadXY;\n}\n\nvec3%20billboard(vec3%20InstanceCoords,%20vec2%20quadXY,%20out%20mat3%20localMat)\n{\n%20%20%20%20vec3%20viewUp%20=%20matrix_viewInverse[1].xyz;\n%20%20%20%20vec3%20posCam%20=%20matrix_viewInverse[3].xyz;\n\n%20%20%20%20mat3%20billMat;\n%20%20%20%20billMat[2]%20=%20normalize(InstanceCoords%20-%20posCam);\n%20%20%20%20billMat[0]%20=%20normalize(cross(viewUp,%20billMat[2]));\n%20%20%20%20billMat[1]%20=%20-viewUp;\n%20%20%20%20vec3%20pos%20=%20billMat%20*%20vec3(quadXY,%200);\n\n%20%20%20%20localMat%20=%20billMat;\n\n%20%20%20%20return%20pos;\n}\n\n\nvoid%20main(void)\n{\n%20%20%20%20vec3%20particlePos%20=%20particle_vertexData.xyz;\n%20%20%20%20vec3%20pos%20=%20particlePos;\n%20%20%20%20vec3%20vertPos%20=%20particle_vertexData3.xyz;\n%20%20%20%20vec3%20particleVelocity%20=%20vec3(particle_vertexData2.w,%20particle_vertexData3.w,%20particle_vertexData4.x);\n%20%20%20%20vec2%20velocityV%20=%20normalize((mat3(matrix_view)%20*%20particleVelocity).xy);%20//%20should%20be%20removed%20by%20compiler%20if%20align/stretch%20is%20not%20used\n\n%20%20%20%20vec2%20quadXY%20=%20vertPos.xy;\n%20%20%20%20texCoordsAlphaLife%20=%20vec4(quadXY%20*%20-0.5%20+%200.5,%20particle_vertexData2.z,%20particle_vertexData.w);\n\n%20%20%20%20mat2%20rotMatrix;\n%20%20%20%20mat3%20localMat;\n\n%20%20%20%20float%20angle%20=%20particle_vertexData2.x;\n%20%20%20%20vec3%20particlePosMoved%20=%20vec3(0.0);\n%20%20%20%20vec3%20meshLocalPos%20=%20particle_vertexData3.xyz;\n\n%22;%20pc.shaderChunks.transformVS=%22mat4%20getModelMatrix(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20matrix_model;\n}\n\nvec4%20getPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.modelMatrix%20=%20getModelMatrix(data);\n%20%20%20%20vec4%20posW%20=%20data.modelMatrix%20*%20vec4(vertex_position,%201.0);\n%20%20%20%20data.positionW%20=%20posW.xyz;\n%20%20%20%20return%20matrix_viewProjection%20*%20posW;\n}\n\nvec3%20getWorldPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20data.positionW;\n}\n\n%22;pc.shaderChunks.specularVertPS=%22void%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.specularity%20=%20saturate(vVertexColor.$CH);\n}\n\n%22;%20pc.shaderChunks.particleUpdaterNoRespawnPS=%22%20%20%20%20if%20(life%20%3E=%20particleLifetime)%20{\n%20%20%20%20%20%20%20%20life%20-=%20max(particleLifetime,%20(numParticles%20-%201.0)%20*%20particleRate);\n%20%20%20%20%20%20%20%20visMode%20=%20-1.0;\n%20%20%20%20}\n%22;pc.shaderChunks.opacityVertPS=%22void%20getOpacity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.alpha%20=%20saturate(vVertexColor.$CH);\n}\n\n%22;pc.shaderChunks.fogExpPS=%22uniform%20vec3%20fog_color;\nuniform%20float%20fog_density;\nvec3%20addFog(inout%20psInternalData%20data,%20vec3%20color)%20{\n%20%20%20%20float%20depth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%20%20%20%20float%20fogFactor%20=%20exp(-depth%20*%20fog_density);\n%20%20%20%20fogFactor%20=%20clamp(fogFactor,%200.0,%201.0);\n%20%20%20%20return%20mix(fog_color,%20color,%20fogFactor);\n}\n%22;%20pc.shaderChunks.metalnessTexPS=%22uniform%20sampler2D%20texture_metalnessMap;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20processMetalness(data,%20texture2D(texture_metalnessMap,%20$UV).$CH);\n}\n\n%22;pc.shaderChunks.metalnessVertPS=%22void%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20processMetalness(data,%20saturate(vVertexColor.$CH));\n}\n\n%22;pc.shaderChunks.cubeMapProjectNonePS=%22vec3%20cubeMapProject(vec3%20dir)%20{\n%20%20%20%20return%20dir;\n}\n\n%22;pc.shaderChunks.particle_billboardVS=%22\n%20%20%20%20quadXY%20=%20rotate(quadXY,%20angle,%20rotMatrix);\n%20%20%20%20vec3%20localPos%20=%20billboard(particlePos,%20quadXY,%20localMat);\n\n%22;%20pc.shaderChunks.particleAnimTexVS=%22\n%20%20%20%20float%20atlasX%20=%20animFrame%20*%20animTexParams.x;\n%20%20%20%20float%20atlasY%20=%20floor(atlasX)%20*%20animTexParams.y;\n%20%20%20%20atlasX%20=%20fract(atlasX);\n\n%20%20%20%20texCoordsAlphaLife.xy%20*=%20animTexParams.xy;\n%20%20%20%20texCoordsAlphaLife.xy%20+=%20vec2(atlasX,%20atlasY);\n%20%20%20%20texCoordsAlphaLife.y%20=%201.0%20-%20texCoordsAlphaLife.y;\n\n%22;pc.shaderChunks.outputAlphaOpaquePS=%22gl_FragColor.a%20=%201.0;\n%22;pc.shaderChunks.glossTexPS=%22uniform%20sampler2D%20texture_glossMap;\nvoid%20getGlossiness(inout%20psInternalData%20data)%20{\n%20%20%20%20data.glossiness%20=%20texture2D(texture_glossMap,%20$UV).$CH%20+%200.0000001;\n}\n\n%22;%20pc.shaderChunks.combineDiffuseSpecularNoReflPS=%22vec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20data.albedo%20*%20data.diffuseLight%20+%20data.specularLight%20*%20data.specularity;\n}\n\n%22;pc.shaderChunks.particle_meshVS=%22\n%20%20%20%20vec3%20localPos%20=%20meshLocalPos;\n%20%20%20%20localPos.xy%20=%20rotate(localPos.xy,%20angle,%20rotMatrix);\n%20%20%20%20localPos.yz%20=%20rotate(localPos.yz,%20angle,%20rotMatrix);\n\n%20%20%20%20billboard(particlePos,%20quadXY,%20localMat);\n\n\n%22;pc.shaderChunks.particle_endPS=%22%20%20%20%20rgb%20=%20addFog(data,%20rgb);\n%20%20%20%20rgb%20=%20toneMap(rgb);\n%20%20%20%20rgb%20=%20gammaCorrectOutput(rgb);\n%20%20%20%20gl_FragColor%20=%20vec4(rgb,%20a);\n}\n%22;%20pc.shaderChunks.shadowCoordPS=%22void%20_getShadowCoordOrtho(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams,%20vec3%20wPos)%20{\n%20%20%20%20vec4%20projPos%20=%20shadowMatrix%20*%20vec4(wPos,%201.0);\n%20%20%20%20projPos.z%20+=%20shadowParams.z;\n%20%20%20%20projPos.z%20=%20min(projPos.z,%201.0);\n%20%20%20%20data.shadowCoord%20=%20projPos.xyz;\n}\n\nvoid%20_getShadowCoordPersp(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec4%20shadowParams,%20vec3%20wPos)%20{\n%20%20%20%20vec4%20projPos%20=%20shadowMatrix%20*%20vec4(wPos,%201.0);\n%20%20%20%20projPos.xyz%20/=%20projPos.w;\n%20%20%20%20projPos.z%20+=%20shadowParams.z;\n%20%20%20%20data.shadowCoord%20=%20projPos.xyz;\n}\n\nvoid%20getShadowCoordOrtho(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20_getShadowCoordOrtho(data,%20shadowMatrix,%20shadowParams,%20vPositionW);\n}\n\nvoid%20getShadowCoordPersp(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec4%20shadowParams)%20{\n%20%20%20%20_getShadowCoordPersp(data,%20shadowMatrix,%20shadowParams,%20vPositionW);\n}\n\nvoid%20getShadowCoordPerspNormalOffset(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec4%20shadowParams)%20{\n%20%20%20%20float%20distScale%20=%20abs(dot(vPositionW%20-%20data.lightPosW,%20data.lightDirNormW));%20//%20fov?\n%20%20%20%20vec3%20wPos%20=%20vPositionW%20+%20vNormalW%20*%20shadowParams.y%20*%20clamp(1.0%20-%20dot(vNormalW,%20-data.lightDirNormW),%200.0,%201.0)%20*%20distScale;\n\n%20%20%20%20_getShadowCoordPersp(data,%20shadowMatrix,%20shadowParams,%20wPos);\n}\n\nvoid%20getShadowCoordOrthoNormalOffset(inout%20psInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20vec3%20wPos%20=%20vPositionW%20+%20vNormalW%20*%20shadowParams.y%20*%20clamp(1.0%20-%20dot(vNormalW,%20-data.lightDirNormW),%200.0,%201.0);%20//0.08\n\n%20%20%20%20_getShadowCoordOrtho(data,%20shadowMatrix,%20shadowParams,%20wPos);\n}\n\n%22;%20pc.shaderChunks.fullscreenQuadVS=%22attribute%20vec2%20aPosition;\n\nvarying%20vec2%20vUv0;\n\nvoid%20main(void)\n{\n%20%20%20%20gl_Position%20=%20vec4(aPosition,%200.5,%201.0);\n%20%20%20%20vUv0%20=%20aPosition.xy*0.5+0.5;\n}\n\n%22;pc.shaderChunks.extensionPS=%22\n%22;pc.shaderChunks.particlePS=%22varying%20vec4%20texCoordsAlphaLife;\n\nuniform%20sampler2D%20colorMap;\nuniform%20sampler2D%20internalTex3;\nuniform%20float%20graphSampleSize;\nuniform%20float%20graphNumSamples;\nuniform%20float%20camera_far;\nuniform%20float%20softening;\nuniform%20float%20colorMult;\n\nfloat%20saturate(float%20x)%20{\n%20%20%20%20return%20clamp(x,%200.0,%201.0);\n}\n\nfloat%20unpackFloat(vec4%20rgbaDepth)%20{\n%20%20%20%20const%20vec4%20bitShift%20=%20vec4(1.0%20/%20(256.0%20*%20256.0%20*%20256.0),%201.0%20/%20(256.0%20*%20256.0),%201.0%20/%20256.0,%201.0);\n%20%20%20%20float%20depth%20=%20dot(rgbaDepth,%20bitShift);\n%20%20%20%20return%20depth;\n}\n\nvoid%20main(void)%20{\n%20%20%20%20psInternalData%20data;\n%20%20%20%20vec4%20tex%20%20%20%20%20%20%20%20%20=%20texture2DSRGB(colorMap,%20texCoordsAlphaLife.xy);\n%20%20%20%20vec4%20ramp%20%20%20%20%20=%20texture2DSRGB(internalTex3,%20vec2(texCoordsAlphaLife.w,%200.0));\n%20%20%20%20ramp.rgb%20*=%20colorMult;\n\n%20%20%20%20ramp.a%20+=%20texCoordsAlphaLife.z;\n\n%20%20%20%20vec3%20rgb%20=%20%20%20%20%20tex.rgb%20*%20ramp.rgb;\n%20%20%20%20float%20a%20=%20%20%20%20%20%20%20%20%20tex.a%20*%20ramp.a;\n\n%22;%20pc.shaderChunks.lightSpecularBlinnPS=%22//%20Energy-conserving%20(hopefully)%20Blinn-Phong\nfloat%20getLightSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20h%20=%20normalize(%20-data.lightDirNormW%20+%20data.viewDirW%20);\n%20%20%20%20float%20nh%20=%20max(%20dot(%20h,%20data.normalW%20),%200.0%20);\n\n%20%20%20%20float%20specPow%20=%20exp2(data.glossiness%20*%2011.0);%20//%20glossiness%20is%20linear,%20power%20is%20not;%200%20-%202048\n%20%20%20%20specPow%20=%20antiAliasGlossiness(data,%20specPow);\n\n%20%20%20%20//%20Hack:%20On%20Mac%20OS%20X,%20calling%20pow%20with%20zero%20for%20the%20exponent%20generates%20hideous%20artifacts%20so%20bias%20up%20a%20little\n%20%20%20%20specPow%20=%20max(specPow,%200.0001);\n\n%20%20%20%20return%20pow(nh,%20specPow)%20*%20(specPow%20+%202.0)%20/%208.0;\n}\n\n%22;%20pc.shaderChunks.shadowCoordVS=%22void%20getLightDirPoint(inout%20vsInternalData%20data,%20vec3%20lightPosW)%20{\n%20%20%20%20vec3%20lightDirW%20=%20vPositionW%20-%20lightPosW;\n%20%20%20%20data.lightDirNormW%20=%20normalize(lightDirW);\n%20%20%20%20data.lightPosW%20=%20lightPosW;\n}\n\nvoid%20_getShadowCoordOrtho(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams,%20vec3%20wPos)%20{\n%20%20%20%20vec4%20projPos%20=%20shadowMatrix%20*%20vec4(wPos,%201.0);\n%20%20%20%20vMainShadowUv%20=%20projPos;\n}\n\nvoid%20_getShadowCoordPersp(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams,%20vec3%20wPos)%20{\n%20%20%20%20vec4%20projPos%20=%20shadowMatrix%20*%20vec4(wPos,%201.0);\n%20%20%20%20vMainShadowUv%20=%20projPos;\n}\n\nvoid%20getShadowCoordOrtho(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20_getShadowCoordOrtho(data,%20shadowMatrix,%20shadowParams,%20vPositionW);\n}\n\nvoid%20getShadowCoordPersp(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20_getShadowCoordPersp(data,%20shadowMatrix,%20shadowParams,%20vPositionW);\n}\n\nvoid%20getShadowCoordPerspNormalOffset(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20float%20distScale%20=%20abs(dot(vPositionW%20-%20data.lightPosW,%20data.lightDirNormW));%20//%20fov?\n%20%20%20%20vec3%20wPos%20=%20vPositionW%20+%20data.normalW%20*%20shadowParams.y%20*%20clamp(1.0%20-%20dot(data.normalW,%20-data.lightDirNormW),%200.0,%201.0)%20*%20distScale;\n\n%20%20%20%20_getShadowCoordPersp(data,%20shadowMatrix,%20shadowParams,%20wPos);\n}\n\nvoid%20getShadowCoordOrthoNormalOffset(inout%20vsInternalData%20data,%20mat4%20shadowMatrix,%20vec3%20shadowParams)%20{\n%20%20%20%20vec3%20wPos%20=%20vPositionW%20+%20data.normalW%20*%20shadowParams.y%20*%20clamp(1.0%20-%20dot(data.normalW,%20-data.lightDirNormW),%200.0,%201.0);%20//0.08\n\n%20%20%20%20_getShadowCoordOrtho(data,%20shadowMatrix,%20shadowParams,%20wPos);\n}\n\n%22;%20pc.shaderChunks.rgbmPS=%22vec3%20decodeRGBM(vec4%20rgbm)%20{\n%20%20%20%20vec3%20color%20=%20(8.0%20*%20rgbm.a)%20*%20rgbm.rgb;\n%20%20%20%20return%20color%20*%20color;\n}\n\nvec3%20texture2DRGBM(sampler2D%20tex,%20vec2%20uv)%20{\n%20%20%20%20return%20decodeRGBM(texture2D(tex,%20uv));\n}\n\nvec3%20textureCubeRGBM(samplerCube%20tex,%20vec3%20uvw)%20{\n%20%20%20%20return%20decodeRGBM(textureCube(tex,%20uvw));\n}\n\n%22;pc.shaderChunks.reflectionCubePS=%22uniform%20samplerCube%20texture_cubeMap;\nuniform%20float%20material_reflectivity;\nvoid%20addReflection(inout%20psInternalData%20data)%20{\n%20%20%20%20vec3%20lookupVec%20=%20fixSeams(cubeMapProject(data.reflDirW));\n%20%20%20%20lookupVec.x%20*=%20-1.0;\n%20%20%20%20data.reflection%20+=%20vec4($textureCubeSAMPLE(texture_cubeMap,%20lookupVec).rgb,%20material_reflectivity);\n}\n%22;%20pc.shaderChunks.specularConstPS=%22uniform%20vec3%20material_specular;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.specularity%20=%20material_specular;\n}\n\n%22;pc.shaderChunks.packDepthMaskPS=%22vec4%20packFloat(float%20depth)%20{\n%20%20%20%20const%20vec4%20bit_shift%20=%20vec4(256.0%20*%20256.0%20*%20256.0,%20256.0%20*%20256.0,%20256.0,%201.0);\n%20%20%20%20const%20vec4%20bit_mask%20%20=%20vec4(0.0,%201.0%20/%20256.0,%201.0%20/%20256.0,%201.0%20/%20256.0);\n\n%20%20%20%20//%20combination%20of%20mod%20and%20multiplication%20and%20division%20works%20better\n%20%20%20%20vec4%20res%20=%20mod(depth%20*%20bit_shift%20*%20vec4(255),%20vec4(256)%20)%20/%20vec4(255);\n%20%20%20%20res.x%20=%200.0;\n%20%20%20%20res%20-=%20res.xxyz%20*%20bit_mask;\n%20%20%20%20return%20res;\n}\n\n%22;%20pc.shaderChunks.metalnessVertConstPS=%22uniform%20float%20material_metalness;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20processMetalness(data,%20saturate(vVertexColor.$CH)%20*%20material_metalness);\n}\n\n%22;pc.shaderChunks.diffuseTexPS=%22uniform%20sampler2D%20texture_diffuseMap;\nvoid%20getAlbedo(inout%20psInternalData%20data)%20{\n%20%20%20%20data.albedo%20=%20texture2DSRGB(texture_diffuseMap,%20$UV).$CH;\n}\n\n%22;pc.shaderChunks.endPS=%22%20%20%20gl_FragColor.rgb%20=%20combineColor(data);\n%20%20%20gl_FragColor.rgb%20+=%20getEmission(data);\n%20%20%20gl_FragColor.rgb%20=%20addFog(data,%20gl_FragColor.rgb);\n%20%20%20gl_FragColor.rgb%20=%20toneMap(gl_FragColor.rgb);\n%20%20%20gl_FragColor.rgb%20=%20gammaCorrectOutput(gl_FragColor.rgb);\n%22;%20pc.shaderChunks.transformUv1VS=%22mat4%20getModelMatrix(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20matrix_model;\n}\nvec4%20getPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20data.modelMatrix%20=%20getModelMatrix(data);\n%20%20%20%20vec4%20posW%20=%20data.modelMatrix%20*%20vec4(vertex_position,%201.0);\n%20%20%20%20data.positionW%20=%20posW.xyz;\n%20%20%20%20return%20vec4(vertex_texCoord1.xy%20*%202.0%20-%201.0,%200.5,%201);\n}\nvec3%20getWorldPosition(inout%20vsInternalData%20data)%20{\n%20%20%20%20return%20data.positionW;\n}\n\n%22;pc.shaderChunks.aoTexPS=%22uniform%20sampler2D%20texture_aoMap;\nvoid%20applyAO(inout%20psInternalData%20data)%20{\n%20%20%20%20data.ao%20=%20texture2D(texture_aoMap,%20$UV).$CH;\n%20%20%20%20data.diffuseLight%20*=%20data.ao;\n}\n\n%22;%20pc.shaderChunks.fogNonePS=%22vec3%20addFog(inout%20psInternalData%20data,%20vec3%20color)%20{\n%20%20%20%20return%20color;\n}\n\n\n%22;pc.shaderChunks.gamma1_0PS=%22vec4%20texture2DSRGB(sampler2D%20tex,%20vec2%20uv)%20{\n%20%20%20%20return%20texture2D(tex,%20uv);\n}\n\nvec4%20textureCubeSRGB(samplerCube%20tex,%20vec3%20uvw)%20{\n%20%20%20%20return%20textureCube(tex,%20uvw);\n}\n\nvec3%20gammaCorrectOutput(vec3%20color)%20{\n%20%20%20%20return%20color;\n}\n\nvec3%20gammaCorrectInput(vec3%20color)%20{\n%20%20%20%20return%20color;\n}\n\nfloat%20gammaCorrectInput(float%20color)%20{\n%20%20%20%20return%20color;\n}\n\nvec4%20gammaCorrectInput(vec4%20color)%20{\n%20%20%20%20return%20color;\n}\n\n%22;%20pc.shaderChunks.fogExp2PS=%22uniform%20vec3%20fog_color;\nuniform%20float%20fog_density;\nvec3%20addFog(inout%20psInternalData%20data,%20vec3%20color)%20{\n%20%20%20%20float%20depth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%20%20%20%20float%20fogFactor%20=%20exp(-depth%20*%20depth%20*%20fog_density%20*%20fog_density);\n%20%20%20%20fogFactor%20=%20clamp(fogFactor,%200.0,%201.0);\n%20%20%20%20return%20mix(fog_color,%20color,%20fogFactor);\n}\n%22;pc.shaderChunks.aoVertPS=%22void%20applyAO(inout%20psInternalData%20data)%20{\n%20%20%20%20data.ao%20=%20saturate(vVertexColor.$CH);\n%20%20%20%20data.diffuseLight%20*=%20data.ao;\n}\n\n%22;%20pc.shaderChunks.envMultiplyPS=%22uniform%20float%20skyboxIntensity;\nvec3%20processEnvironment(vec3%20color)%20{\n%20%20%20%20return%20color%20*%20skyboxIntensity;\n}\n\n%22;pc.shaderChunks.lightDiffuseLambertPS=%22float%20getLightDiffuse(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20max(dot(data.normalW,%20-data.lightDirNormW),%200.0);\n}\n\n%22;pc.shaderChunks.diffuseTexConstPS=%22uniform%20sampler2D%20texture_diffuseMap;\nuniform%20vec3%20material_diffuse;\nvoid%20getAlbedo(inout%20psInternalData%20data)%20{\n%20%20%20%20data.albedo%20=%20texture2DSRGB(texture_diffuseMap,%20$UV).$CH%20*%20material_diffuse;\n}\n\n%22;%20pc.shaderChunks.particleUpdaterSpherePS=%22uniform%20float%20spawnBoundsSphere;\nvec3%20calcSpawnPosition(vec3%20inBounds,%20float%20rndFactor)%20{\n%20%20%20%20float%20rnd4%20=%20fract(rndFactor%20*%201000.0);\n%20%20%20%20return%20emitterPos%20+%20normalize(inBounds.xyz%20-%20vec3(0.5))%20*%20rnd4%20*%20spawnBoundsSphere;\n}\n\nvoid%20addInitialVelocity(inout%20vec3%20localVelocity,%20vec3%20inBounds)%20{\n%20%20%20%20localVelocity%20+=%20normalize(inBounds%20-%20vec3(0.5))%20*%20initialVelocity;\n}\n\n%22;pc.shaderChunks.ambientConstantPS=%22\nvoid%20addAmbient(inout%20psInternalData%20data)%20{\n%20%20%20%20data.diffuseLight%20+=%20light_globalAmbient;\n}\n%22;%20pc.shaderChunks.diffuseVertConstPS=%22uniform%20vec3%20material_diffuse;\nvoid%20getAlbedo(inout%20psInternalData%20data)%20{\n%20%20%20%20data.albedo%20=%20gammaCorrectInput(saturate(vVertexColor.$CH))%20*%20material_diffuse;\n}\n\n%22;pc.shaderChunks.shadowPS=%22//%20-----%20Unpacking%20-----\n\nfloat%20unpackFloat(vec4%20rgbaDepth)%20{\n%20%20%20%20const%20vec4%20bitShift%20=%20vec4(1.0%20/%20(256.0%20*%20256.0%20*%20256.0),%201.0%20/%20(256.0%20*%20256.0),%201.0%20/%20256.0,%201.0);\n%20%20%20%20return%20dot(rgbaDepth,%20bitShift);\n}\n\nfloat%20unpackMask(vec4%20rgbaDepth)%20{\n%20%20%20%20return%20rgbaDepth.x;\n}\n\nfloat%20unpackFloatYZW(vec4%20enc)%20{\n%20%20%20%20const%20vec4%20bitShift%20=%20vec4(1.0%20/%20(256.0%20*%20256.0%20*%20256.0),%201.0%20/%20(256.0%20*%20256.0),%201.0%20/%20256.0,%201.0);\n%20%20%20%20float%20v%20=%20dot(enc.yzw,%20bitShift.yzw);\n%20%20%20%20return%20v;\n}\n\n\n//%20-----%20Aux%20-----\n\nvec3%20lessThan2(vec3%20a,%20vec3%20b)%20{\n%20%20%20%20return%20clamp((b%20-%20a)*1000.0,%200.0,%201.0);%20//%20softer%20version\n}\n\nvec3%20greaterThan2(vec3%20a,%20vec3%20b)%20{\n%20%20%20%20return%20clamp((a%20-%20b)*1000.0,%200.0,%201.0);%20//%20softer%20version\n}\n\n\n//%20-----%20Direct/Spot%20Sampling%20-----\n\nfloat%20getShadowHard(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20float%20depth%20=%20unpackFloat(texture2D(shadowMap,%20data.shadowCoord.xy));\n%20%20%20%20return%20(depth%20%3C%20data.shadowCoord.z)%20?%200.0%20:%201.0;\n}\n\nfloat%20getShadowSpotHard(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec4%20shadowParams)%20{\n%20%20%20%20float%20depth%20=%20unpackFloat(texture2D(shadowMap,%20data.shadowCoord.xy));\n%20%20%20%20return%20(depth%20%3C%20(length(data.lightDirW)%20*%20shadowParams.w%20+%20shadowParams.z))%20?%200.0%20:%201.0;\n}\n\nfloat%20getShadowMask(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20return%20unpackMask(texture2D(shadowMap,%20data.shadowCoord.xy));\n}\n\nfloat%20_xgetShadowPCF3x3(mat3%20depthKernel,%20inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20mat3%20shadowKernel;\n%20%20%20%20vec3%20shadowCoord%20=%20data.shadowCoord;\n%20%20%20%20vec3%20shadowZ%20=%20vec3(shadowCoord.z);\n%20%20%20%20shadowKernel[0]%20=%20vec3(greaterThan(depthKernel[0],%20shadowZ));\n%20%20%20%20shadowKernel[1]%20=%20vec3(greaterThan(depthKernel[1],%20shadowZ));\n%20%20%20%20shadowKernel[2]%20=%20vec3(greaterThan(depthKernel[2],%20shadowZ));\n\n%20%20%20%20vec2%20fractionalCoord%20=%20fract(%20shadowCoord.xy%20*%20shadowParams.x%20);\n\n%20%20%20%20shadowKernel[0]%20=%20mix(shadowKernel[0],%20shadowKernel[1],%20fractionalCoord.x);\n%20%20%20%20shadowKernel[1]%20=%20mix(shadowKernel[1],%20shadowKernel[2],%20fractionalCoord.x);\n\n%20%20%20%20vec4%20shadowValues;\n%20%20%20%20shadowValues.x%20=%20mix(shadowKernel[0][0],%20shadowKernel[0][1],%20fractionalCoord.y);\n%20%20%20%20shadowValues.y%20=%20mix(shadowKernel[0][1],%20shadowKernel[0][2],%20fractionalCoord.y);\n%20%20%20%20shadowValues.z%20=%20mix(shadowKernel[1][0],%20shadowKernel[1][1],%20fractionalCoord.y);\n%20%20%20%20shadowValues.w%20=%20mix(shadowKernel[1][1],%20shadowKernel[1][2],%20fractionalCoord.y);\n\n%20%20%20%20return%20dot(%20shadowValues,%20vec4(%201.0%20)%20)%20*%200.25;\n}\n\nfloat%20_getShadowPCF3x3(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20vec3%20shadowCoord%20=%20data.shadowCoord;\n\n%20%20%20%20float%20xoffset%20=%201.0%20/%20shadowParams.x;%20//%201/shadow%20map%20width\n%20%20%20%20float%20dx0%20=%20-xoffset;\n%20%20%20%20float%20dx1%20=%20xoffset;\n\n%20%20%20%20mat3%20depthKernel;\n%20%20%20%20depthKernel[0][0]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%20dx0)));\n%20%20%20%20depthKernel[0][1]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%200.0)));\n%20%20%20%20depthKernel[0][2]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%20dx1)));\n%20%20%20%20depthKernel[1][0]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(0.0,%20dx0)));\n%20%20%20%20depthKernel[1][1]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy));\n%20%20%20%20depthKernel[1][2]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(0.0,%20dx1)));\n%20%20%20%20depthKernel[2][0]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%20dx0)));\n%20%20%20%20depthKernel[2][1]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%200.0)));\n%20%20%20%20depthKernel[2][2]%20=%20unpackFloat(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%20dx1)));\n\n%20%20%20%20return%20_xgetShadowPCF3x3(depthKernel,%20data,%20shadowMap,%20shadowParams);\n}\n\nfloat%20getShadowPCF3x3(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20return%20_getShadowPCF3x3(data,%20shadowMap,%20shadowParams);\n}\n\nfloat%20getShadowSpotPCF3x3(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec4%20shadowParams)%20{\n%20%20%20%20data.shadowCoord.z%20=%20length(data.lightDirW)%20*%20shadowParams.w%20+%20shadowParams.z;\n%20%20%20%20return%20_getShadowPCF3x3(data,%20shadowMap,%20shadowParams.xyz);\n}\n\nfloat%20_getShadowPCF3x3_YZW(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20vec3%20shadowCoord%20=%20data.shadowCoord;\n\n%20%20%20%20float%20xoffset%20=%201.0%20/%20shadowParams.x;%20//%201/shadow%20map%20width\n%20%20%20%20float%20dx0%20=%20-xoffset;\n%20%20%20%20float%20dx1%20=%20xoffset;\n\n%20%20%20%20mat3%20depthKernel;\n%20%20%20%20depthKernel[0][0]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%20dx0)));\n%20%20%20%20depthKernel[0][1]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%200.0)));\n%20%20%20%20depthKernel[0][2]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx0,%20dx1)));\n%20%20%20%20depthKernel[1][0]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(0.0,%20dx0)));\n%20%20%20%20depthKernel[1][1]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy));\n%20%20%20%20depthKernel[1][2]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(0.0,%20dx1)));\n%20%20%20%20depthKernel[2][0]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%20dx0)));\n%20%20%20%20depthKernel[2][1]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%200.0)));\n%20%20%20%20depthKernel[2][2]%20=%20unpackFloatYZW(texture2D(shadowMap,%20shadowCoord.xy%20+%20vec2(dx1,%20dx1)));\n\n%20%20%20%20return%20_xgetShadowPCF3x3(depthKernel,%20data,%20shadowMap,%20shadowParams);\n}\n\nfloat%20getShadowPCF3x3_YZW(inout%20psInternalData%20data,%20sampler2D%20shadowMap,%20vec3%20shadowParams)%20{\n%20%20%20%20return%20_getShadowPCF3x3_YZW(data,%20shadowMap,%20shadowParams);\n}\n\n\n//%20-----%20Point%20Sampling%20-----\n\nfloat%20getShadowPointHard(inout%20psInternalData%20data,%20samplerCube%20shadowMap,%20vec4%20shadowParams)%20{\n%20%20%20%20float%20depth%20=%20unpackFloat(textureCube(shadowMap,%20data.lightDirNormW));\n%20%20%20%20return%20float(depth%20%3E%20length(data.lightDirW)%20*%20shadowParams.w%20+%20shadowParams.z);\n}\n\nfloat%20_getShadowPoint(inout%20psInternalData%20data,%20samplerCube%20shadowMap,%20vec4%20shadowParams,%20vec3%20dir)%20{\n\n%20%20%20%20vec3%20tc%20=%20normalize(dir);\n%20%20%20%20vec3%20tcAbs%20=%20abs(tc);\n\n%20%20%20%20vec4%20dirX%20=%20vec4(1,0,0,%20tc.x);\n%20%20%20%20vec4%20dirY%20=%20vec4(0,1,0,%20tc.y);\n%20%20%20%20float%20majorAxisLength%20=%20tc.z;\n%20%20%20%20if%20((tcAbs.x%20%3E%20tcAbs.y)%20&&%20(tcAbs.x%20%3E%20tcAbs.z))%20{\n%20%20%20%20%20%20%20%20dirX%20=%20vec4(0,0,1,%20tc.z);\n%20%20%20%20%20%20%20%20dirY%20=%20vec4(0,1,0,%20tc.y);\n%20%20%20%20%20%20%20%20majorAxisLength%20=%20tc.x;\n%20%20%20%20}%20else%20if%20((tcAbs.y%20%3E%20tcAbs.x)%20&&%20(tcAbs.y%20%3E%20tcAbs.z))%20{\n%20%20%20%20%20%20%20%20dirX%20=%20vec4(1,0,0,%20tc.x);\n%20%20%20%20%20%20%20%20dirY%20=%20vec4(0,0,1,%20tc.z);\n%20%20%20%20%20%20%20%20majorAxisLength%20=%20tc.y;\n%20%20%20%20}\n\n%20%20%20%20float%20shadowParamsInFaceSpace%20=%20((1.0/shadowParams.x)%20*%202.0)%20*%20abs(majorAxisLength);\n\n%20%20%20%20vec3%20xoffset%20=%20(dirX.xyz%20*%20shadowParamsInFaceSpace);\n%20%20%20%20vec3%20yoffset%20=%20(dirY.xyz%20*%20shadowParamsInFaceSpace);\n%20%20%20%20vec3%20dx0%20=%20-xoffset;\n%20%20%20%20vec3%20dy0%20=%20-yoffset;\n%20%20%20%20vec3%20dx1%20=%20xoffset;\n%20%20%20%20vec3%20dy1%20=%20yoffset;\n\n%20%20%20%20mat3%20shadowKernel;\n%20%20%20%20mat3%20depthKernel;\n\n%20%20%20%20depthKernel[0][0]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx0%20+%20dy0));\n%20%20%20%20depthKernel[0][1]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx0));\n%20%20%20%20depthKernel[0][2]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx0%20+%20dy1));\n%20%20%20%20depthKernel[1][0]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dy0));\n%20%20%20%20depthKernel[1][1]%20=%20unpackFloat(textureCube(shadowMap,%20tc));\n%20%20%20%20depthKernel[1][2]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dy1));\n%20%20%20%20depthKernel[2][0]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx1%20+%20dy0));\n%20%20%20%20depthKernel[2][1]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx1));\n%20%20%20%20depthKernel[2][2]%20=%20unpackFloat(textureCube(shadowMap,%20tc%20+%20dx1%20+%20dy1));\n\n%20%20%20%20vec3%20shadowZ%20=%20vec3(length(dir)%20*%20shadowParams.w%20+%20shadowParams.z);\n\n%20%20%20%20shadowKernel[0]%20=%20vec3(lessThan2(depthKernel[0],%20shadowZ));\n%20%20%20%20shadowKernel[1]%20=%20vec3(lessThan2(depthKernel[1],%20shadowZ));\n%20%20%20%20shadowKernel[2]%20=%20vec3(lessThan2(depthKernel[2],%20shadowZ));\n\n%20%20%20%20vec2%20uv%20=%20(vec2(dirX.w,%20dirY.w)%20/%20abs(majorAxisLength))%20*%200.5;\n\n%20%20%20%20vec2%20fractionalCoord%20=%20fract(%20uv%20*%20shadowParams.x%20);\n\n%20%20%20%20shadowKernel[0]%20=%20mix(shadowKernel[0],%20shadowKernel[1],%20fractionalCoord.x);\n%20%20%20%20shadowKernel[1]%20=%20mix(shadowKernel[1],%20shadowKernel[2],%20fractionalCoord.x);\n\n%20%20%20%20vec4%20shadowValues;\n%20%20%20%20shadowValues.x%20=%20mix(shadowKernel[0][0],%20shadowKernel[0][1],%20fractionalCoord.y);\n%20%20%20%20shadowValues.y%20=%20mix(shadowKernel[0][1],%20shadowKernel[0][2],%20fractionalCoord.y);\n%20%20%20%20shadowValues.z%20=%20mix(shadowKernel[1][0],%20shadowKernel[1][1],%20fractionalCoord.y);\n%20%20%20%20shadowValues.w%20=%20mix(shadowKernel[1][1],%20shadowKernel[1][2],%20fractionalCoord.y);\n\n%20%20%20%20return%201.0%20-%20dot(%20shadowValues,%20vec4(%201.0%20)%20)%20*%200.25;\n}\n\nfloat%20getShadowPointPCF3x3(inout%20psInternalData%20data,%20samplerCube%20shadowMap,%20vec4%20shadowParams)%20{\n%20%20%20%20return%20_getShadowPoint(data,%20shadowMap,%20shadowParams,%20data.lightDirW);\n}\n\nvoid%20normalOffsetPointShadow(inout%20psInternalData%20data,%20vec4%20shadowParams)%20{\n%20%20%20%20float%20distScale%20=%20length(data.lightDirW);\n%20%20%20%20vec3%20wPos%20=%20vPositionW%20+%20vNormalW%20*%20shadowParams.y%20*%20clamp(1.0%20-%20dot(vNormalW,%20-data.lightDirNormW),%200.0,%201.0)%20*%20distScale;%20//0.02\n%20%20%20%20vec3%20dir%20=%20wPos%20-%20data.lightPosW;\n%20%20%20%20data.lightDirW%20=%20dir;\n}\n\n%22;%20pc.shaderChunks.aoSpecOccSimplePS=%22uniform%20float%20material_occludeSpecularIntensity;\nvoid%20occludeSpecular(inout%20psInternalData%20data)%20{\n%20%20%20%20float%20specOcc%20=%20mix(1.0,%20data.ao,%20material_occludeSpecularIntensity);\n%20%20%20%20data.specularLight%20*=%20specOcc;\n%20%20%20%20data.reflection%20*=%20specOcc;\n}\n\n%22;pc.shaderChunks.TBNPS=%22void%20getTBN(inout%20psInternalData%20data)%20{\n%20%20%20%20data.TBN%20=%20mat3(normalize(vTangentW),%20normalize(vBinormalW),%20normalize(vNormalW));\n}\n\n%22;pc.shaderChunks.particle_halflambertPS=%22\n%20%20%20%20vec3%20negNormal%20=%20normal*0.5+0.5;\n%20%20%20%20vec3%20posNormal%20=%20-normal*0.5+0.5;\n%20%20%20%20negNormal%20*=%20negNormal;\n%20%20%20%20posNormal%20*=%20posNormal;\n\n\n%22;%20pc.shaderChunks.combineDiffusePS=%22vec3%20combineColor(inout%20psInternalData%20data)%20{\n%20%20%20%20return%20data.albedo%20*%20data.diffuseLight;\n}\n\n%22;pc.shaderChunks.particleUpdaterInitPS=%22varying%20vec2%20vUv0;\n\nuniform%20sampler2D%20particleTexIN;\nuniform%20sampler2D%20internalTex0;\nuniform%20sampler2D%20internalTex1;\nuniform%20sampler2D%20internalTex2;\n\nuniform%20mat3%20emitterMatrix;\nuniform%20vec3%20emitterScale;\n\nuniform%20vec3%20emitterPos,%20frameRandom,%20localVelocityDivMult,%20velocityDivMult;\nuniform%20float%20delta,%20rate,%20rateDiv,%20lifetime,%20numParticles,%20rotSpeedDivMult,%20seed;\nuniform%20float%20startAngle,%20startAngle2;\nuniform%20float%20initialVelocity;\n\nuniform%20float%20graphSampleSize;\nuniform%20float%20graphNumSamples;\n\n%22;%20pc.shaderChunks.fogLinearPS=%22uniform%20vec3%20fog_color;\nuniform%20float%20fog_start;\nuniform%20float%20fog_end;\nvec3%20addFog(inout%20psInternalData%20data,%20vec3%20color)%20{\n%20%20%20%20float%20depth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%20%20%20%20float%20fogFactor%20=%20(fog_end%20-%20depth)%20/%20(fog_end%20-%20fog_start);\n%20%20%20%20fogFactor%20=%20clamp(fogFactor,%200.0,%201.0);\n%20%20%20%20fogFactor%20=%20gammaCorrectInput(fogFactor);\n%20%20%20%20return%20mix(fog_color,%20color,%20fogFactor);\n}\n%22;pc.shaderChunks.particle_endVS=%22\n%20%20%20%20localPos%20*=%20scale%20*%20emitterScale;\n%20%20%20%20localPos%20+=%20particlePos;\n\n%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20vec4(localPos.xyz,%201.0);\n}\n%22;%20pc.shaderChunks.particle_softPS=%22\n%20%20%20%20vec2%20screenTC%20=%20gl_FragCoord.xy%20*%20uScreenSize.zw;\n%20%20%20%20float%20depth%20=%20unpackFloat(%20texture2D(uDepthMap,%20screenTC)%20)%20*%20camera_far;\n%20%20%20%20float%20particleDepth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%20%20%20%20float%20depthDiff%20=%20saturate(abs(particleDepth%20-%20depth)%20*%20softening);\n%20%20%20%20a%20*=%20depthDiff;\n\n%22;pc.shaderChunks.specularTexConstPS=%22uniform%20sampler2D%20texture_specularMap;\nuniform%20vec3%20material_specular;\nvoid%20getSpecularity(inout%20psInternalData%20data)%20{\n%20%20%20%20data.specularity%20=%20texture2D(texture_specularMap,%20$UV).$CH%20*%20material_specular;\n}\n\n%22;%20pc.shaderChunks.envConstPS=%22vec3%20processEnvironment(vec3%20color)%20{\n%20%20%20%20return%20color;\n}\n\n%22;pc.shaderChunks.startPS=%22\nvoid%20main(void)%20{\n%20%20%20%20psInternalData%20data;\n\tdata.diffuseLight%20=%20vec3(0);\n\tdata.specularLight%20=%20vec3(0);\n%20%20%20%20data.reflection%20=%20vec4(0);\n%20%20%20%20data.specularity%20=%20vec3(0);\n\n\n%22;pc.shaderChunks.outputAlphaPS=%22gl_FragColor.a%20=%20data.alpha;\n%22;pc.shaderChunks.lightmapSinglePS=%22uniform%20sampler2D%20texture_lightMap;\nvoid%20addLightMap(inout%20psInternalData%20data)%20{\n%20%20%20%20data.diffuseLight%20+=%20$texture2DSAMPLE(texture_lightMap,%20$UV).$CH;\n}\n\n%22;%20pc.shaderChunks.particleUpdaterOnStopPS=%22%20%20%20%20visMode%20=%20life%20%3C%200.0?%20-1.0:%20visMode;\n\n%22;pc.shaderChunks.instancingVS=%22\nattribute%20vec4%20instance_line1;\nattribute%20vec4%20instance_line2;\nattribute%20vec4%20instance_line3;\nattribute%20vec4%20instance_line4;\n\n%22;pc.programlib={getSnippet:function(f,a){var%20b=%22%22;switch(a){case%20%22common_main_begin%22:b+=%22void%20main(void)\n{\n%22;break;case%20%22common_main_end%22:b+=%22}\n%22;break;case%20%22fs_alpha_test_decl%22:b+=%22uniform%20float%20alpha_ref;\n%22;break;case%20%22fs_alpha_test%22:b+=%22%20%20%20%20if%20(gl_FragColor.a%20%3C%20alpha_ref)%20discard;\n\n%22;break;case%20%22fs_clamp%22:b+=%22%20%20%20%20gl_FragColor%20=%20clamp(gl_FragColor,%200.0,%201.0);\n%22;break;case%20%22fs_flat_color_decl%22:b+=%22uniform%20vec4%20uColor;\n%22;break;case%20%22fs_flat_color%22:b+=%22%20%20%20%20gl_FragColor%20=%20uColor;\n%22;break;case%20%22fs_fog_linear_decl%22:case%20%22fs_fog_exp_decl%22:case%20%22fs_fog_exp2_decl%22:b+=%20%22uniform%20vec3%20fog_color;\n%22;b=%22fs_fog_linear_decl%22===a?b+%22uniform%20float%20fog_start;\nuniform%20float%20fog_end;\n\n%22:b+%22uniform%20float%20fog_density;\n\n%22;break;case%20%22fs_fog_linear%22:case%20%22fs_fog_exp%22:case%20%22fs_fog_exp2%22:b+=%22%20%20%20%20float%20depth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%22;b=%22fs_fog_linear%22===a?b+%22%20%20%20%20float%20fogFactor%20=%20(fog_end%20-%20depth)%20/%20(fog_end%20-%20fog_start);\n%22:%22fs_fog_exp%22===a?b+%22%20%20%20%20float%20fogFactor%20=%20exp(-depth%20*%20fog_density);\n%22:b+%22%20%20%20%20float%20fogFactor%20=%20exp(-depth%20*%20depth%20*%20fog_density%20*%20fog_density);\n%22;%20b+=%22%20%20%20%20fogFactor%20=%20clamp(fogFactor,%200.0,%201.0);\n%22;b+=%22%20%20%20%20gl_FragColor.rgb%20=%20mix(fog_color,%20gl_FragColor.rgb,%20fogFactor);\n%22;break;case%20%22fs_precision%22:b+=%22precision%20%22+f.precision+%22%20float;\n\n%22;break;case%20%22fs_height_map_funcs%22:b+=%22vec3%20perturb_normal(%20vec3%20N,%20vec3%20p,%20vec2%20uv%20)\n%22;b+=%22{\n%22;b+=%22%20%20%20%20vec3%20dp1%20=%20dFdx(%20p%20);\n%22;b+=%22%20%20%20%20vec3%20dp2%20=%20dFdy(%20p%20);\n%22;b+=%22%20%20%20%20vec2%20duv1%20=%20dFdx(%20uv%20);\n%22;b+=%22%20%20%20%20vec2%20duv2%20=%20dFdy(%20uv%20);\n\n%22;b+=%22%20%20%20%20vec3%20dp2perp%20=%20cross(%20dp2,%20N%20);\n%22;b+=%22%20%20%20%20vec3%20dp1perp%20=%20cross(%20N,%20dp1%20);\n\n%22;%20b+=%22%20%20%20%20const%20float%20bumpScale%20=%200.125;\n%22;b+=%22%20%20%20%20float%20Hll%20=%20bumpScale%20*%20texture2D(%20texture_heightMap,%20uv%20).x;\n%22;b+=%22%20%20%20%20float%20dBx%20=%20bumpScale%20*%20texture2D(%20texture_heightMap,%20uv%20+%20duv1%20).x%20-%20Hll;\n%22;b+=%22%20%20%20%20float%20dBy%20=%20bumpScale%20*%20texture2D(%20texture_heightMap,%20uv%20+%20duv2%20).x%20-%20Hll;\n\n%22;b+=%22%20%20%20%20float%20fDet%20=%20dot(%20dp1,%20dp2perp%20);\n%22;b+=%22%20%20%20%20vec3%20vGrad%20=%20sign(%20fDet%20)%20*%20(%20dBx%20*%20dp2perp%20+%20dBy%20*%20dp1perp%20);\n%22;b+=%22%20%20%20%20return%20normalize(%20abs(%20fDet%20)%20*%20N%20-%20vGrad%20);\n%22;b+=%22}\n\n%22;break;case%20%22fs_normal_map_funcs%22:pc.precalculatedTangents||%20(b+=%22mat3%20cotangent_frame(%20vec3%20N,%20vec3%20p,%20vec2%20uv%20)\n%22,b+=%22{\n%22,b+=%22%20%20%20%20vec3%20dp1%20=%20dFdx(%20p%20);\n%22,b+=%22%20%20%20%20vec3%20dp2%20=%20dFdy(%20p%20);\n%22,b+=%22%20%20%20%20vec2%20duv1%20=%20dFdx(%20uv%20);\n%22,b+=%22%20%20%20%20vec2%20duv2%20=%20dFdy(%20uv%20);\n\n%22,b+=%22%20%20%20%20vec3%20dp2perp%20=%20cross(%20dp2,%20N%20);\n%22,b+=%22%20%20%20%20vec3%20dp1perp%20=%20cross(%20N,%20dp1%20);\n%22,b+=%22%20%20%20%20vec3%20T%20=%20dp2perp%20*%20duv1.x%20+%20dp1perp%20*%20duv2.x;\n%22,b+=%22%20%20%20%20vec3%20B%20=%20dp2perp%20*%20duv1.y%20+%20dp1perp%20*%20duv2.y;\n\n%22,b+=%22%20%20%20%20float%20invmax%20=%20inversesqrt(%20max(%20dot(T,T),%20dot(B,B)%20)%20);\n%22,b+=%22%20%20%20%20return%20mat3(%20T%20*%20invmax,%20B%20*%20invmax,%20N%20);\n%22,%20b+=%22}\n\n%22,b+=%22vec3%20perturb_normal(%20vec3%20N,%20vec3%20V,%20vec2%20uv%20)\n%22,b+=%22{\n%22,b+=%22%20%20%20%20vec3%20map%20=%20texture2D(%20texture_normalMap,%20uv%20).xyz;\n%22,b+=%22%20%20%20%20map%20=%20map%20*%20255./127.%20-%20128./127.;\n%22,b+=%22%20%20%20%20map.xy%20=%20map.xy%20*%20material_bumpiness;\n%22,b+=%22%20%20%20%20mat3%20TBN%20=%20cotangent_frame(%20N,%20-V,%20uv%20);\n%22,b+=%22%20%20%20%20return%20normalize(%20TBN%20*%20map%20);\n%22,b+=%22}\n\n%22);break;case%20%22vs_skin_decl%22:b=f.supportsBoneTextures?b+%22attribute%20vec4%20vertex_boneWeights;\nattribute%20vec4%20vertex_boneIndices;\n\nuniform%20sampler2D%20texture_poseMap;\nuniform%20vec2%20texture_poseMapSize;\nuniform%20vec3%20skinPosOffset;\n\nmat4%20getBoneMatrix(const%20in%20float%20i)\n{\n%20%20%20%20float%20j%20=%20i%20*%204.0;\n%20%20%20%20float%20x%20=%20mod(j,%20float(texture_poseMapSize.x));\n%20%20%20%20float%20y%20=%20floor(j%20/%20float(texture_poseMapSize.x));\n\n%20%20%20%20float%20dx%20=%201.0%20/%20float(texture_poseMapSize.x);\n%20%20%20%20float%20dy%20=%201.0%20/%20float(texture_poseMapSize.y);\n\n%20%20%20%20y%20=%20dy%20*%20(y%20+%200.5);\n\n%20%20%20%20vec4%20v1%20=%20texture2D(texture_poseMap,%20vec2(dx%20*%20(x%20+%200.5),%20y));\n%20%20%20%20vec4%20v2%20=%20texture2D(texture_poseMap,%20vec2(dx%20*%20(x%20+%201.5),%20y));\n%20%20%20%20vec4%20v3%20=%20texture2D(texture_poseMap,%20vec2(dx%20*%20(x%20+%202.5),%20y));\n%20%20%20%20vec4%20v4%20=%20texture2D(texture_poseMap,%20vec2(dx%20*%20(x%20+%203.5),%20y));\n\n%20%20%20%20mat4%20bone%20=%20mat4(v1,%20v2,%20v3,%20v4);\n\n%20%20%20%20return%20bone;\n}%22:%20b+[%22attribute%20vec4%20vertex_boneWeights;\nattribute%20vec4%20vertex_boneIndices;\n%22,%22uniform%20mat4%20matrix_pose[%22+f.getBoneLimit()+%22];%22,%22uniform%20vec3%20skinPosOffset;\n\nmat4%20getBoneMatrix(const%20in%20float%20i)\n{\n%20%20%20%20mat4%20bone%20=%20matrix_pose[int(i)];\n\n%20%20%20%20return%20bone;\n}%22].join(%22\n%22);b+=%22\n\n%22;break;case%20%22vs_transform_decl%22:b+=%22attribute%20vec3%20vertex_position;\n%22,b+=%22uniform%20mat4%20matrix_model;\n%22,b+=%22uniform%20mat4%20matrix_viewProjection;\n\n%22}return%20b},gammaCode:function(f){return%20f===pc.GAMMA_NONE?pc.shaderChunks.gamma1_0PS:%20f===pc.GAMMA_SRGBFAST?pc.shaderChunks.gamma2_2FastPS:pc.shaderChunks.gamma2_2PS},tonemapCode:function(f){return%20f?pc.shaderChunks.tonemappingFilmicPS:pc.shaderChunks.tonemappingLinearPS}};pc.programlib.basic={generateKey:function(f,a){var%20b=%22basic%22;a.fog&&(b+=%22_fog%22);a.alphaTest&&(b+=%22_atst%22);a.vertexColors&&(b+=%22_vcol%22);a.diffuseMap&&(b+=%22_diff%22);return%20b},createShaderDefinition:function(f,a){var%20b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var%20d=pc.programlib.getSnippet,e;e=%22%22+%20d(f,%22vs_transform_decl%22);a.skin&&(e+=d(f,%22vs_skin_decl%22));a.vertexColors&&(e+=%22attribute%20vec4%20vertex_color;\nvarying%20vec4%20vColor;\n%22);a.diffuseMap&&(e+=%22attribute%20vec2%20vertex_texCoord0;\n%22,e+=%22varying%20vec2%20vUv0;\n%22);e+=d(f,%22common_main_begin%22);a.skin?(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20vertex_boneWeights.x%20*%20getBoneMatrix(vertex_boneIndices.x)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.y%20*%20getBoneMatrix(vertex_boneIndices.y)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.z%20*%20getBoneMatrix(vertex_boneIndices.z)%20+\n%22,%20e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.w%20*%20getBoneMatrix(vertex_boneIndices.w);\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22,e+=%22%20%20%20%20positionW.xyz%20+=%20skinPosOffset;\n%22):(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20matrix_model;\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22);e+=%22\n%22;e+=%22%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20positionW;\n\n%22;a.vertexColors&&(e+=%22%20%20%20%20vColor%20=%20vertex_color;\n%22);a.diffuseMap&&(e+=%22%20%20%20%20vUv0%20=%20vertex_texCoord0;\n%22);var%20g=e+=%20d(f,%22common_main_end%22);e=d(f,%22fs_precision%22);e=a.vertexColors?e+%22varying%20vec4%20vColor;\n%22:e+%22uniform%20vec4%20uColor;\n%22;a.diffuseMap&&(e+=%22varying%20vec2%20vUv0;\n%22,e+=%22uniform%20sampler2D%20texture_diffuseMap;\n%22);a.fog&&(e+=d(f,%22fs_fog_decl%22));a.alphatest&&(e+=d(f,%22fs_alpha_test_decl%22));e+=d(f,%22common_main_begin%22);e=a.vertexColors?e+%22%20%20%20%20gl_FragColor%20=%20vColor;\n%22:e+%22%20%20%20%20gl_FragColor%20=%20uColor;\n%22;a.diffuseMap&&(e+=%22%20%20%20%20gl_FragColor%20*=%20texture2D(texture_diffuseMap,%20vUv0);\n%22);a.alphatest&&(e+=d(f,%22fs_alpha_test%22));%20e+=d(f,%22fs_clamp%22);a.fog&&(e+=d(f,%22fs_fog%22));e+=d(f,%22common_main_end%22);return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depth={generateKey:function(f,a){var%20b=%22depth%22;a.skin&&(b+=%22_skin%22);a.opacityMap&&(b+=%22_opam%22);return%20b},createShaderDefinition:function(f,a){var%20b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var%20d=pc.programlib.getSnippet,e;e=%22%22+d(f,%22vs_transform_decl%22);a.skin&&(e+=d(f,%22vs_skin_decl%22));a.opacityMap&&(e+=%22attribute%20vec2%20vertex_texCoord0;\n\nvarying%20vec2%20vUv0;\n\n%22);%20e+=d(f,%22common_main_begin%22);a.skin?(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20vertex_boneWeights.x%20*%20getBoneMatrix(vertex_boneIndices.x)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.y%20*%20getBoneMatrix(vertex_boneIndices.y)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.z%20*%20getBoneMatrix(vertex_boneIndices.z)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.w%20*%20getBoneMatrix(vertex_boneIndices.w);\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22,e+=%22%20%20%20%20positionW.xyz%20+=%20skinPosOffset;\n%22):%20(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20matrix_model;\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22);e+=%22\n%22;e+=%22%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20positionW;\n\n%22;a.opacityMap&&(e+=%22%20%20%20%20vUv0%20=%20vertex_texCoord0;\n%22);var%20g=e+=d(f,%22common_main_end%22);e=d(f,%22fs_precision%22);e+=%22uniform%20float%20camera_near;\n%22;e+=%22uniform%20float%20camera_far;\n%22;e+=%22vec4%20packFloat(float%20depth)\n%22;e+=%22{\n%22;e+=%22%20%20%20%20const%20vec4%20bit_shift%20=%20vec4(256.0%20*%20256.0%20*%20256.0,%20256.0%20*%20256.0,%20256.0,%201.0);\n%22;e+=%22%20%20%20%20const%20vec4%20bit_mask%20%20=%20vec4(0.0,%201.0%20/%20256.0,%201.0%20/%20256.0,%201.0%20/%20256.0);\n%22;%20e+=%22%20%20%20%20vec4%20res%20=%20mod(depth%20*%20bit_shift%20*%20vec4(255),%20vec4(256)%20)%20/%20vec4(255);\n%22;e+=%22%20%20%20%20res%20-=%20res.xxyz%20*%20bit_mask;\n%22;e+=%22%20%20%20%20return%20res;\n%22;e+=%22}\n\n%22;e+=d(f,%22common_main_begin%22);e+=%22float%20depth%20=%20gl_FragCoord.z%20/%20gl_FragCoord.w;\n%22;e+=%22gl_FragColor%20=%20packFloat(depth%20/%20camera_far);\n%22;e+=d(f,%22common_main_end%22);return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depthrgba={generateKey:function(f,a){var%20b=%22depthrgba%22;a.skin&&(b+=%22_skin%22);a.opacityMap&&(b+=%22_opam%22+a.opacityChannel);a.point&&(b+=%22_pnt%22);return%20b+=%22_%22+a.shadowType},createShaderDefinition:function(f,a){var%20b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var%20d=pc.programlib.getSnippet,e;e=%22%22+d(f,%22vs_transform_decl%22);a.skin&&(e+=d(f,%20%22vs_skin_decl%22));a.opacityMap&&(e+=%22attribute%20vec2%20vertex_texCoord0;\n\nvarying%20vec2%20vUv0;\n\n%22);a.point&&(e+=%22varying%20vec3%20worldPos;\n\n%22);e+=d(f,%22common_main_begin%22);a.skin?(e+=%22%20%20%20%22,e+=%22%20%20%20%20mat4%20modelMatrix%20=%20vertex_boneWeights.x%20*%20getBoneMatrix(vertex_boneIndices.x)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.y%20*%20getBoneMatrix(vertex_boneIndices.y)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.z%20*%20getBoneMatrix(vertex_boneIndices.z)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.w%20*%20getBoneMatrix(vertex_boneIndices.w);\n%22,%20e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22,e+=%22%20%20%20%20positionW.xyz%20+=%20skinPosOffset;\n%22):(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20matrix_model;\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22);e+=%22\n%22;e+=%22%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20positionW;\n\n%22;a.opacityMap&&(e+=%22%20%20%20%20vUv0%20=%20vertex_texCoord0;\n%22);a.point&&(e+=%22%20%20%20%20worldPos%20=%20positionW.xyz;\n%22);var%20g=e+=d(f,%22common_main_end%22);e=d(f,%22fs_precision%22);a.opacityMap&&(e+=%22varying%20vec2%20vUv0;\n\n%22,e+=%22uniform%20sampler2D%20texture_opacityMap;\n\n%22);%20a.point&&(e+=%22varying%20vec3%20worldPos;\n\n%22,e+=%22uniform%20vec3%20view_position;\n\n%22,e+=%22uniform%20float%20light_radius;\n\n%22);e+=pc.shaderChunks.packDepthPS;e+=d(f,%22common_main_begin%22);a.opacityMap&&(e+=%22%20%20%20%20if%20(texture2D(texture_opacityMap,%20vUv0).%22+a.opacityChannel+%22%20%3C%200.25)%20discard;\n\n%22);e=a.point?e+%22%20%20%20gl_FragData[0]%20=%20packFloat(min(distance(view_position,%20worldPos)%20/%20light_radius,%200.99999));\n%22:e+%22%20%20%20%20gl_FragData[0]%20=%20packFloat(gl_FragCoord.z);\n%22;e+=d(f,%22common_main_end%22);return{attributes:b,vshader:g,%20fshader:e}}};pc.programlib.particle={generateKey:function(f,a){var%20b=%22particle%22,d;for(d%20in%20a)a.hasOwnProperty(d)&&(b+=a[d]);return%20b},_animTex:function(f,a){var%20b;b=%22%22+(f.animTexLoop?a.particleAnimFrameLoopVS:a.particleAnimFrameClampVS);return%20b+=a.particleAnimTexVS},createShaderDefinition:function(f,a){var%20b=pc.programlib.getSnippet,d=pc.shaderChunks,e=%22%22,b=b(f,%22fs_precision%22)+%22\n%22;a.useCpu?(a.animTex&&(e+=%22\nuniform%20vec4%20animTexParams;\n%22),2==a.normal&&(e+=%22\nvarying%20mat3%20ParticleMat;\n%22),1==a.normal&&(e+=%22\nvarying%20vec3%20Normal;\n%22),%20e+=d.particle_cpuVS,a.animTex&&(e+=this._animTex(a,d)),a.alignToMotion&&(e+=d.particle_pointAlongVS),e+=a.mesh?d.particle_meshVS:d.particle_billboardVS,1==a.normal&&(e+=d.particle_normalVS),2==a.normal&&(e+=d.particle_TBNVS),0%3Ca.stretch&&(e+=d.particle_stretchVS),e+=d.particle_cpu_endVS):(a.animTex&&(e+=%22\nuniform%20vec4%20animTexParams;\n%22),2==a.normal&&(e+=%22\nvarying%20mat3%20ParticleMat;\n%22),1==a.normal&&(e+=%22\nvarying%20vec3%20Normal;\n%22),e+=d.particleVS,a.animTex&&(e+=this._animTex(a,d)),a.wrap&&(e+=d.particle_wrapVS),%20a.alignToMotion&&(e+=d.particle_pointAlongVS),e+=a.mesh?d.particle_meshVS:d.particle_billboardVS,1==a.normal&&(e+=d.particle_normalVS),2==a.normal&&(e+=d.particle_TBNVS),0%3Ca.stretch&&(e+=d.particle_stretchVS),e+=d.particle_endVS);0%3Ca.normal&&(1==a.normal?b+=%22\nvarying%20vec3%20Normal;\n%22:2==a.normal&&(b+=%22\nvarying%20mat3%20ParticleMat;\n%22),b+=%22\nuniform%20vec3%20lightCube[6];\n%22);0===a.normal&&%22none%22===a.fog&&(a.srgb=!1);b+=pc.programlib.gammaCode(a.gamma);b=b+%22struct%20psInternalData%20{float%20dummy;};\n%22+pc.programlib.tonemapCode(a.toneMap);%20b=%22linear%22===a.fog?b+d.fogLinearPS:%22exp%22===a.fog?b+d.fogExpPS:%22exp2%22===a.fog?b+d.fogExp2PS:b+d.fogNonePS;2==a.normal&&(b+=%22\nuniform%20sampler2D%20normalMap;\n%22);0%3Ca.soft&&(b+=%22\nuniform%20sampler2D%20uDepthMap;\n%20uniform%20vec4%20uScreenSize;\n%22);b+=d.particlePS;0%3Ca.soft&&(b+=d.particle_softPS);1==a.normal&&(b+=%22\nvec3%20normal%20=%20Normal;\n%22);2==a.normal&&(b+=d.particle_normalMapPS);0%3Ca.normal&&(b+=a.halflambert?d.particle_halflambertPS:d.particle_lambertPS);0%3Ca.normal&&(b+=d.particle_lightingPS);a.blend==pc.BLEND_NORMAL?%20b+=d.particle_blendNormalPS:a.blend==pc.BLEND_ADDITIVE?b+=d.particle_blendAddPS:a.blend==pc.BLEND_MULTIPLICATIVE&&(b+=d.particle_blendMultiplyPS);b+=d.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(e),vshader:e,fshader:b}}};pc.programlib.phong={hashCode:function(f){var%20a=0;if(0===f.length)return%20a;for(i=0;i%3Cf.length;i++)char=f.charCodeAt(i),a=(a%3C%3C5)-a+char,a&=a;return%20a},generateKey:function(f,a){var%20b=[],d=%22phong%22,e;for(e%20in%20a)if(%22lights%22===e)for(var%20g=0;g%3Ca.lights.length;g++)b.push(a.lights[g].getType()+%22_%22+(a.lights[g].getCastShadows()?1:0)+%22_%22+a.lights[g].getFalloffMode()+%22_%22+!!a.lights[g].getNormalOffsetBias());else%20if(%22chunks%22===e)for(var%20h%20in%20a[e])a[e].hasOwnProperty(h)&&b.push(h+a.chunks[h]);else%20a[e]&&b.push(e);%20b.sort();for(e%20in%20b)d+=b[e]+a[b[e]];return%20this.hashCode(d)},_correctChannel:function(f,a){if(0%3Cpc._matTex2D[f]){if(pc._matTex2D[f]%3Ca.length)return%20a.substring(0,pc._matTex2D[f]);if(pc._matTex2D[f]%3Ea.length){var%20b=a,d=b.charAt(b.length-1),e=pc._matTex2D[f]-b.length;for(i=0;i%3Ce;i++)b+=d;return%20b}return%20a}},_setMapTransform:function(f,a,b,d){f[0]+=%22uniform%20vec4%20texture_%22+a+%22MapTransform;\n%22;var%20e=b+100*d;f[3][e]||(f[1]+=%22varying%20vec2%20vUV%22+d+%22_%22+b+%22;\n%22,f[2]+=%22%20%20%20vUV%22+d+%22_%22+b+%22%20=%20uv%22+d+%22%20*%20texture_%22+%20a+%22MapTransform.xy%20+%20texture_%22+a+%22MapTransform.zw;\n%22,f[3][e]=!0);return%20f},_uvSource:function(f,a){return%200===f?%22vUv%22+a:%22vUV%22+a+%22_%22+f},_addMap:function(f,a,b,d,e,g){var%20h,k=f+%22Map%22;return%20a[k+%22VertexColor%22]?(e||(e=a[f+%22Tint%22]?b[f+%22VertConstPS%22]:b[f+%22VertPS%22]),e.replace(/\$CH/g,a[k+%22Channel%22])):a[k]?(h=k+%22Channel%22,d=this._uvSource(a[k+%22Transform%22],a[k+%22Uv%22])+d,e||(e=a[f+%22Tint%22]?b[f+%22TexConstPS%22]:b[f+%22TexPS%22]),void%200!==g&&(e=e.replace(/\$texture2DSAMPLE/g,0===g?%22texture2DSRGB%22:1===g?%22texture2DRGBM%22:%20%22texture2D%22)),e.replace(/\$UV/g,d).replace(/\$CH/g,a[h])):b[f+%22ConstPS%22]},_nonPointShadowMapProjection:function(f,a){return%20f.getNormalOffsetBias()?f.getType()==pc.LIGHTTYPE_SPOT?%22%20%20%20getShadowCoordPerspNormalOffset%22+a:%22%20%20%20getShadowCoordOrthoNormalOffset%22+a:f.getType()===pc.LIGHTTYPE_SPOT?%22%20%20%20getShadowCoordPersp%22+a:%22%20%20%20getShadowCoordOrtho%22+a},_addVaryingIfNeeded:function(f,a,b){return%200%3C=f.indexOf(b)?%22varying%20%22+a+%22%20%22+b+%22;\n%22:%22%22},createShaderDefinition:function(f,a){var%20b,d,e=0%3Ca.lights.length;a.shadingModel===%20pc.SPECULAR_PHONG?(a.fresnelModel=0,a.specularAA=!1,a.prefilteredCubemap=!1,a.dpAtlas=!1,a.ambientSH=!1):a.fresnelModel=0===a.fresnelModel?pc.FRESNEL_SCHLICK:a.fresnelModel;var%20g=a.cubeMap||a.prefilteredCubemap&&a.useSpecular,h=a.sphereMap||g||a.dpAtlas,k=pc.precalculatedTangents,n=a.useTexCubeLod;if(a.cubeMap||a.prefilteredCubemap)a.sphereMap=null;a.dpAtlas&&(a.sphereMap=a.cubeMap=a.prefilteredCubemap=g=null);a.useSpecular||(a.specularMap=a.glossMap=null);var%20r=e||h||a.ambientSH||a.prefilteredCubemap;%20this.options=a;var%20u=pc.programlib.getSnippet,l=%22%22,m=%22%22,w=%22%22,s=pc.shaderChunks,D;if(a.chunks){var%20y=[];for(d%20in%20s)s.hasOwnProperty(d)&&(a.chunks[d]?(y[d]=a.chunks[d],r||(y[d]=y[d].replace(/vertex_normal/g,%22vec3(0)%22).replace(/vertex_tangent/g,%22vec4(0)%22))):y[d]=s[d]);s=y}s.extensionVS&&(l+=s.extensionVS+%22\n%22);var%20l=l+s.baseVS,x=-1;if(!a.noShadow){for(b=0;b%3Ca.lights.length;b++)if(D=a.lights[b].getType(),a.lights[b].getCastShadows()&&D===pc.LIGHTTYPE_DIRECTIONAL){l+=%22uniform%20mat4%20light%22+b+%22_shadowMatrixVS;\n%22;%20l+=%22uniform%20vec3%20light%22+b+%22_shadowParamsVS;\n%22;l+=%22uniform%20vec3%20light%22+b+(D===pc.LIGHTTYPE_DIRECTIONAL?%22_directionVS%22:%22_positionVS%22)+%22;\n%22;x=b;break}0%3C=x&&(l+=s.shadowCoordVS)}y={vertex_position:pc.SEMANTIC_POSITION};m+=%22%20%20%20vPositionW%20%20%20%20=%20getWorldPosition(data);\n%22;a.useInstancing&&(y.instance_line1=pc.SEMANTIC_TEXCOORD2,y.instance_line2=pc.SEMANTIC_TEXCOORD3,y.instance_line3=pc.SEMANTIC_TEXCOORD4,y.instance_line4=pc.SEMANTIC_TEXCOORD5,l+=s.instancingVS);if(r){y.vertex_normal=pc.SEMANTIC_NORMAL;%20m+=%22%20%20%20vNormalW%20%20%20%20=%20data.normalW%20=%20getNormal(data);\n%22;a.sphereMap&&16%3E=f.fragmentUniformsCount&&(l+=s.viewNormalVS,m+=%22%20%20%20vNormalV%20%20%20%20=%20getViewNormal(data);\n%22);if((a.heightMap||a.normalMap)&&k)y.vertex_tangent=pc.SEMANTIC_TANGENT,l+=s.tangentBinormalVS,m+=%22%20%20%20vTangentW%20%20%20=%20getTangent(data);\n%20%20%20vBinormalW%20%20=%20getBinormal(data);\n%22;0%3C=x&&(D=a.lights[x].getType(),m=D===pc.LIGHTTYPE_DIRECTIONAL?m+(%22%20%20%20data.lightDirNormW%20=%20light%22+x+%22_directionVS;\n%22):m+(%22%20%20%20getLightDirPoint(data,%20light%22+x+%22_positionVS);\n%22),%20m+=this._nonPointShadowMapProjection(a.lights[x],%22(data,%20light%22+x+%22_shadowMatrixVS,%20light%22+x+%22_shadowParamsVS);\n%22))}D=[];var%20A=[],C,B,z;for(d%20in%20pc._matTex2D)b=d+%22Map%22,a[b+%22VertexColor%22]?(C=b+%22Channel%22,a[C]=this._correctChannel(d,a[C])):a[b]&&(C=b+%22Channel%22,B=b+%22Transform%22,z=b+%22Uv%22,a[z]=Math.min(a[z],1),a[C]=this._correctChannel(d,a[C]),z=a[z],D[z]=!0,A[z]=A[z]||a[b]&&!a[B]);a.forceUv1&&(D[1]=!0);for(b=0;2%3Eb;b++)D[b]&&(y[%22vertex_texCoord%22+b]=pc[%22SEMANTIC_TEXCOORD%22+b],l+=s[%22uv%22+b+%22VS%22],m+=%22%20%20%20vec2%20uv%22+%20b+%22%20=%20getUv%22+b+%22(data);\n%22),A[b]&&(m+=%22%20%20%20vUv%22+b+%22%20=%20uv%22+b+%22;\n%22);m=[l,w,m,[]];for(d%20in%20pc._matTex2D)b=d+%22Map%22,a[b]&&(B=b+%22Transform%22,a[B]&&(z=b+%22Uv%22,this._setMapTransform(m,d,a[B],a[z])));l=m[0];w=m[1];m=m[2];a.vertexColors&&(y.vertex_color=pc.SEMANTIC_COLOR,m+=%22%20%20%20vVertexColor%20=%20vertex_color;\n%22);a.skin?(y.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,y.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES,l+=u(f,%22vs_skin_decl%22),l+=s.transformSkinnedVS,r&&(l+=s.normalSkinnedVS)):a.useInstancing?(l+=s.transformInstancedVS,%20r&&(l+=s.normalInstancedVS)):(l+=s.transformVS,r&&(l+=s.normalVS));l=l+%22\n%22+s.startVS;l+=m;d=l+=%22}%22;b=w;w=%22%22+this._addVaryingIfNeeded(l,%22vec4%22,%22vMainShadowUv%22);w+=this._addVaryingIfNeeded(l,%22vec4%22,%22vVertexColor%22);w+=this._addVaryingIfNeeded(l,%22vec3%22,%22vPositionW%22);w+=this._addVaryingIfNeeded(l,%22vec3%22,%22vNormalV%22);w+=this._addVaryingIfNeeded(l,%22vec3%22,%22vNormalW%22);w+=this._addVaryingIfNeeded(l,%22vec3%22,%22vTangentW%22);w+=this._addVaryingIfNeeded(l,%22vec3%22,%22vBinormalW%22);w+=this._addVaryingIfNeeded(l,%22vec2%22,%22vUv0%22);%20w+=this._addVaryingIfNeeded(l,%22vec2%22,%22vUv1%22);w+=b;d=w+d;a.forceFragmentPrecision&&(%22highp%22!=a.forceFragmentPrecision&&%22mediump%22!==a.forceFragmentPrecision&&%22lowp%22!==a.forceFragmentPrecision)&&(a.forceFragmentPrecision=null);a.forceFragmentPrecision&&(%22highp%22===a.forceFragmentPrecision&&%22highp%22!==f.maxPrecision&&(a.forceFragmentPrecision=%22mediump%22),%22mediump%22===a.forceFragmentPrecision&&%22lowp%22===f.maxPrecision&&(a.forceFragmentPrecision=%22lowp%22));l=%22%22;s.extensionPS&&(l+=s.extensionPS+%22\n%22);l+=a.forceFragmentPrecision?%20%22precision%20%22+a.forceFragmentPrecision+%22%20float;\n\n%22:u(f,%22fs_precision%22);if(a.customFragmentShader)return%20g=l+a.customFragmentShader,{attributes:y,vshader:d,fshader:g,tag:pc.SHADERTAG_MATERIAL};l+=w;l+=s.basePS;for(b=w=0;b%3Ca.lights.length;b++)D=a.lights[b].getType(),l+=%22uniform%20vec3%20light%22+b+%22_color;\n%22,D===pc.LIGHTTYPE_DIRECTIONAL?l+=%22uniform%20vec3%20light%22+b+%22_direction;\n%22:(l+=%22uniform%20vec3%20light%22+b+%22_position;\n%22,l+=%22uniform%20float%20light%22+b+%22_radius;\n%22,D===pc.LIGHTTYPE_SPOT&&(l+=%22uniform%20vec3%20light%22+%20b+%22_spotDirection;\n%22,l+=%22uniform%20float%20light%22+b+%22_innerConeAngle;\n%22,l+=%22uniform%20float%20light%22+b+%22_outerConeAngle;\n%22)),a.lights[b].getCastShadows()&&!a.noShadow&&(l+=%22uniform%20mat4%20light%22+b+%22_shadowMatrix;\n%22,l=D!==pc.LIGHTTYPE_DIRECTIONAL?l+(%22uniform%20vec4%20light%22+b+%22_shadowParams;\n%22):l+(%22uniform%20vec3%20light%22+b+%22_shadowParams;\n%22),l=D===pc.LIGHTTYPE_POINT?l+(%22uniform%20samplerCube%20light%22+b+%22_shadowMap;\n%22):l+(%22uniform%20sampler2D%20light%22+b+%22_shadowMap;\n%22),w++);l+=%22\n%22;b=a.heightMap?%22%20+%20data.uvOffset%22:%20%22%22;m=a.fastTbn?s.TBNfastPS:s.TBNPS;r&&(a.normalMap&&k?(l+=a.packedNormal?s.normalXYPS:s.normalXYZPS,k=this._uvSource(a.normalMapTransform,a.normalMapUv)+b,l=a.needsNormalFloat?l+(a.fastTbn?s.normalMapFloatTBNfastPS:s.normalMapFloatPS).replace(/\$UV/g,k):l+s.normalMapPS.replace(/\$UV/g,k),l+=m):l+=s.normalVertexPS);l+=pc.programlib.gammaCode(a.gamma);l+=pc.programlib.tonemapCode(a.toneMap);l=%22linear%22===a.fog?l+s.fogLinearPS:%22exp%22===a.fog?l+s.fogExpPS:%22exp2%22===a.fog?l+s.fogExp2PS:l+s.fogNonePS;a.useRgbm&&%20(l+=s.rgbmPS);if(g||a.prefilteredCubemap)l+=a.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS;r&&(l+=0%3Ca.cubeMapProjection?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS,l+=a.skyboxIntensity?s.envMultiplyPS:s.envConstPS);l+=this._addMap(%22diffuse%22,a,s,b);if(a.blendType!==pc.BLEND_NONE||a.alphaTest)l+=this._addMap(%22opacity%22,a,s,b);l+=this._addMap(%22emissive%22,a,s,b,null,a.emissiveFormat);a.useSpecular&&(l=a.specularAA&&a.normalMap?a.needsNormalFloat&&r?l+s.specularAaToksvigFloatPS:l+s.specularAaToksvigPS:%20l+s.specularAaNonePS,l+=this._addMap(a.useMetalness?%22metalness%22:%22specular%22,a,s,b),l+=this._addMap(%22gloss%22,a,s,b),0%3Ca.fresnelModel&&(a.fresnelModel===pc.FRESNEL_SIMPLE?l+=s.fresnelSimplePS:a.fresnelModel===pc.FRESNEL_SCHLICK?l+=s.fresnelSchlickPS:a.fresnelModel===pc.FRESNEL_COMPLEX&&(l+=s.fresnelComplexPS)));a.heightMap&&(a.normalMap||(l+=m),l+=this._addMap(%22height%22,a,s,%22%22,s.parallaxPS));if(k=a.aoMap||a.aoMapVertexColor)l+=this._addMap(%22ao%22,a,s,b,a.aoMapVertexColor?s.aoVertPS:s.aoTexPS),a.occludeSpecular&&%20(l=a.occludeSpecular===pc.SPECOCC_AO?l+(a.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS):l+(a.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS));D=a.rgbmReflection?%22decodeRGBM%22:a.hdrReflection?%22%22:%22gammaCorrectInput%22;if(g||a.prefilteredCubemap)l=a.prefilteredCubemap?n?l+s.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,D):l+s.reflectionPrefilteredCubePS.replace(/\$DECODE/g,D):l+s.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,a.rgbmReflection?%22textureCubeRGBM%22:a.hdrReflection?%20%22textureCube%22:%22textureCubeSRGB%22);a.sphereMap&&(m=16%3Cf.fragmentUniformsCount?s.reflectionSpherePS:s.reflectionSphereLowPS,m=m.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?%22texture2DRGBM%22:a.hdrReflection?%22texture2D%22:%22texture2DSRGB%22),l+=m);a.dpAtlas&&(l+=s.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?%22texture2DRGBM%22:a.hdrReflection?%22texture2D%22:%22texture2DSRGB%22));if((g||a.sphereMap||a.dpAtlas)&&a.refraction)l+=s.refractionPS;m=!0;if(a.lightMap||a.lightMapVertexColor)l+=this._addMap(%22light%22,%20a,s,b,a.lightMapVertexColor?s.lightmapSingleVertPS:s.lightmapSinglePS,a.lightMapFormat),m=a.lightMapWithoutAmbient;m&&(l=a.ambientSH?l+s.ambientSHPS:a.prefilteredCubemap?n?l+s.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,D):l+s.ambientPrefilteredCubePS.replace(/\$DECODE/g,D):l+s.ambientConstantPS);0%3Cw&&(l+=s.shadowCoordPS+s.shadowPS,0%3C=x&&(l+=s.shadowVSPS));l+=s.lightDiffuseLambertPS;n=!1;a.useSpecular?(l+=a.shadingModel===pc.SPECULAR_PHONG?s.lightSpecularPhongPS:s.lightSpecularBlinnPS,a.sphereMap||%20g||a.dpAtlas||0%3Ca.fresnelModel?l=0%3Ca.fresnelModel?a.conserveEnergy?l+s.combineDiffuseSpecularPS:l+s.combineDiffuseSpecularNoConservePS:l+s.combineDiffuseSpecularOldPS:a.diffuseMap?l+=s.combineDiffuseSpecularNoReflPS:(l+=s.combineDiffuseSpecularNoReflSeparateAmbientPS,n=!0)):l+=s.combineDiffusePS;a.modulateAmbient&&!n&&(l+=%22uniform%20vec3%20material_ambient;\n%22);a.alphaTest&&(l+=%22%20%20%20uniform%20float%20alpha_ref;\n%22);l+=s.startPS;w=!1;a.blendType===pc.BLEND_NONE&&!a.alphaTest?l+=%22%20%20%20data.alpha%20=%201.0;\n%22:a.heightMap&&%20a.opacityMap?w=!0:(l+=%22%20%20%20getOpacity(data);\n%22,a.alphaTest&&(l+=%22%20%20%20if%20(data.alpha%20%3C%20alpha_ref)%20discard;\n%22));if(r){l+=%22%20%20%20getViewDir(data);\n%22;if(a.heightMap||a.normalMap)l+=%22%20%20%20getTBN(data);\n%22;a.heightMap&&(l+=%22%20%20%20getParallax(data);\n%22);w&&(l+=%22%20%20%20getOpacity(data);\n%22,a.alphaTest&&(l+=%22%20%20%20if%20(data.alpha%20%3C%20alpha_ref)%20discard;\n%22));l+=%22%20%20%20getNormal(data);\n%22;a.useSpecular&&(l+=%22%20%20%20getReflDir(data);\n%22)}l+=%22%20%20%20getAlbedo(data);\n%22;if(e&&a.useSpecular||h)l+=%22%20%20%20getSpecularity(data);\n%22,l+=%22%20%20%20getGlossiness(data);\n%22,%200%3Ca.fresnelModel&&(l+=%22%20%20%20getFresnel(data);\n%22);m&&(l+=%22%20%20%20addAmbient(data);\n%22);a.modulateAmbient&&!n&&(l+=%22%20%20%20data.diffuseLight%20*=%20material_ambient;\n%22);k&&!a.occludeDirect&&(l+=%22%20%20%20%20applyAO(data);\n%22);if(a.lightMap||a.lightMapVertexColor)l+=%22%20%20%20addLightMap(data);\n%22;if(e||h){if(g||a.sphereMap||a.dpAtlas)l+=%22%20%20%20addReflection(data);\n%22;for(b=0;b%3Ca.lights.length;b++)h=a.lights[b],D=h.getType(),D===pc.LIGHTTYPE_DIRECTIONAL?(l+=%22%20%20%20data.lightDirNormW%20=%20light%22+b+%22_direction;\n%22,l+=%22%20%20%20data.atten%20=%201.0;\n%22):%20(l+=%22%20%20%20getLightDirPoint(data,%20light%22+b+%22_position);\n%22,l=h.getFalloffMode()==pc.LIGHTFALLOFF_LINEAR?l+(%22%20%20%20data.atten%20=%20getFalloffLinear(data,%20light%22+b+%22_radius);\n%22):l+(%22%20%20%20data.atten%20=%20getFalloffInvSquared(data,%20light%22+b+%22_radius);\n%22),D===pc.LIGHTTYPE_SPOT&&(l+=%22%20%20%20data.atten%20*=%20getSpotEffect(data,%20light%22+b+%22_spotDirection,%20light%22+b+%22_innerConeAngle,%20light%22+b+%22_outerConeAngle);\n%22)),l+=%22%20%20%20data.atten%20*=%20getLightDiffuse(data);\n%22,h.getCastShadows()&&!a.noShadow&&(r=null,a.shadowSampleType===pc.SHADOWSAMPLE_HARD?%20r=%22Hard%22:h._shadowType===pc.SHADOW_DEPTH&&a.shadowSampleType===pc.SHADOWSAMPLE_PCF3X3&&(r=%22PCF3x3%22),null!==r&&(D===pc.LIGHTTYPE_POINT?(e=%22(data,%20light%22+b+%22_shadowMap,%20light%22+b+%22_shadowParams);\n%22,h.getNormalOffsetBias()&&(l+=%22%20%20%20normalOffsetPointShadow(data,%20light%22+b+%22_shadowParams);\n%22),l+=%22%20%20%20data.atten%20*=%20getShadowPoint%22+r+e):(x===b?r+=%22VS%22:(e=%22(data,%20light%22+b+%22_shadowMatrix,%20light%22+b+%22_shadowParams);\n%22,l+=this._nonPointShadowMapProjection(a.lights[b],e)),D===pc.LIGHTTYPE_SPOT&&(r=%22Spot%22+r),l+=%20%22%20%20%20data.atten%20*=%20getShadow%22+r+%22(data,%20light%22+b+%22_shadowMap,%20light%22+b+%22_shadowParams);\n%22))),l+=%22%20%20%20data.diffuseLight%20+=%20data.atten%20*%20light%22+b+%22_color;\n%22,a.useSpecular&&(l+=%22%20%20%20data.atten%20*=%20getLightSpecular(data);\n%22,l+=%22%20%20%20data.specularLight%20+=%20data.atten%20*%20light%22+b+%22_color;\n%22),l+=%22\n%22;if((g||a.sphereMap||a.dpAtlas)&&a.refraction)l+=%22%20%20%20addRefraction(data);\n%22}l+=%22\n%22;k&&(a.occludeDirect&&(l+=%22%20%20%20%20applyAO(data);\n%22),a.occludeSpecular&&(l+=%22%20%20%20%20occludeSpecular(data);\n%22));l+=s.endPS;l=a.blendType===%20pc.BLEND_NORMAL||a.blendType===pc.BLEND_ADDITIVEALPHA?l+s.outputAlphaPS:a.blendType===pc.BLEND_PREMULTIPLIED?l+s.outputAlphaPremulPS:l+s.outputAlphaOpaquePS;l+=%22\n%22;g=l+=u(f,%22common_main_end%22);return{attributes:y,vshader:d,fshader:g,tag:pc.SHADERTAG_MATERIAL}}};pc.programlib.pick={generateKey:function(f,a){var%20b=%22pick%22;a.skin&&(b+=%22_skin%22);return%20b},createShaderDefinition:function(f,a){var%20b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);var%20d=pc.programlib.getSnippet,e;e=%22%22+d(f,%22vs_transform_decl%22);a.skin&&(e+=d(f,%22vs_skin_decl%22));e+=d(f,%22common_main_begin%22);a.skin?(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20vertex_boneWeights.x%20*%20getBoneMatrix(vertex_boneIndices.x)%20+\n%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.y%20*%20getBoneMatrix(vertex_boneIndices.y)%20+\n%22,%20e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.z%20*%20getBoneMatrix(vertex_boneIndices.z)%20+\n%22,e+=%22%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vertex_boneWeights.w%20*%20getBoneMatrix(vertex_boneIndices.w);\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22,e+=%22%20%20%20%20positionW.xyz%20+=%20skinPosOffset;\n%22):(e+=%22%20%20%20%20mat4%20modelMatrix%20=%20matrix_model;\n%22,e+=%22%20%20%20%20vec4%20positionW%20=%20modelMatrix%20*%20vec4(vertex_position,%201.0);\n%22);e+=%22\n%22;e+=%22%20%20%20%20gl_Position%20=%20matrix_viewProjection%20*%20positionW;\n\n%22;var%20g=e+=d(f,%22common_main_end%22);%20e=d(f,%22fs_precision%22);e+=d(f,%22fs_flat_color_decl%22);e+=d(f,%22common_main_begin%22);e+=d(f,%22fs_flat_color%22);e+=d(f,%22common_main_end%22);return{attributes:b,vshader:g,fshader:e}}};pc.programlib.skybox={generateKey:function(f,a){return%22skybox%22+a.rgbm+%22%20%22+a.hdr+%22%20%22+a.fixSeams+%22%22+a.toneMapping+%22%22+a.gamma+%22%22+a.useIntensity+%22%22+a.mip},createShaderDefinition:function(f,a){var%20b=pc.programlib.getSnippet,d=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:%22attribute%20vec3%20aPosition;\n\nuniform%20mat4%20matrix_view;\nuniform%20mat4%20matrix_projection;\n\nvarying%20vec3%20vViewDir;\n\nvoid%20main(void)\n{\n%20%20%20%20mat4%20view%20=%20matrix_view;\n%20%20%20%20view[3][0]%20=%20view[3][1]%20=%20view[3][2]%20=%200.0;\n%20%20%20%20gl_Position%20=%20matrix_projection%20*%20view%20*%20vec4(aPosition,%201.0);\n%20%20%20%20gl_Position.z%20=%20gl_Position.w%20-%200.00001;\n%20%20%20%20vViewDir%20=%20aPosition;\n%20%20%20%20vViewDir.x%20*=%20-1.0;\n}%22,%20fshader:b(f,%22fs_precision%22)+(a.mip?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS)+(a.useIntensity?d.envMultiplyPS:d.envConstPS)+pc.programlib.gammaCode(a.gamma)+pc.programlib.tonemapCode(a.toneMapping)+d.rgbmPS+d.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,a.rgbm?%22textureCubeRGBM%22:a.hdr?%22textureCube%22:%22textureCubeSRGB%22).replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][a.mip]+%22%22)}}};pc.extend(pc,function(){var%20f=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.createFullscreenQuad(a);this.needsDepthBuffer=!1};f.prototype={render:function(){}};return{PostEffect:f,createFullscreenQuad:function(a){var%20b=new%20pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]),a=new%20pc.VertexBuffer(a,b,4),b=new%20pc.VertexIterator(a);b.element[pc.SEMANTIC_POSITION].set(-1,-1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,-1);b.next();%20b.element[pc.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,1);b.end();return%20a},drawFullscreenQuad:function(a,b,d,e,g){a.setRenderTarget(b);a.updateBegin();var%20f=null!==b?b.width:a.width,b=null!==b?b.height:a.height,k=0,n=0;g&&(k=g.x*f,n=g.y*b,f*=g.z,b*=g.w);a.setViewport(k,n,f,b);a.setScissor(k,n,f,b);var%20g=a.getBlending(),f=a.getDepthTest(),b=a.getDepthWrite(),k=a.getCullMode(),n=a.writeRed,r=a.writeGreen,u=a.writeBlue,l=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);%20a.setDepthWrite(!1);a.setCullMode(pc.CULLFACE_BACK);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(d,0);a.setShader(e);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setBlending(g);a.setDepthTest(f);a.setDepthWrite(b);a.setCullMode(k);a.setColorWrite(n,r,u,l);a.updateEnd()}}}());(function(){var%20f={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,FOG_NONE:%22none%22,FOG_LINEAR:%22linear%22,FOG_EXP:%22exp%22,FOG_EXP2:%22exp2%22,FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_DEPTH:0,SHADOWSAMPLE_HARD:0,SHADOWSAMPLE_PCF3X3:1,%20SHADOWSAMPLE_MASK:2,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,%20SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2};pc.extend(pc,f);pc.scene={};pc.extend(pc.scene,f)})();%20pc.extend(pc,function(){var%20f=function(){this.root=null;this._gravity=new%20pc.Vec3(0,-9.8,0);this.drawCalls=[];this.shadowCasters=[];this.immediateDrawCalls=[];this.fog=pc.FOG_NONE;this.fogColor=new%20pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new%20pc.Color(0,0,0);this._gammaCorrection=pc.GAMMA_NONE;this._toneMapping=0;this.exposure=1;this._skyboxModel=this._skyboxCubeMap=this._skyboxPrefiltered4=this._skyboxPrefiltered8=this._skyboxPrefiltered16=this._skyboxPrefiltered32=%20this._skyboxPrefiltered64=this._skyboxPrefiltered128=null;this._skyboxIntensity=1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=2048;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0};this._models=[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this._updateShaders=!0;this._sceneShadersVersion=0};Object.defineProperty(f.prototype,%22updateShaders%22,{get:function(){return%20this._updateShaders},set:function(a){if(a!==this._updateShaders&&%20(this._updateShaders=a,this._models)){a&&this._sceneShadersVersion++;for(a=0;a%3Cthis._models.length;a++)this._models[a]._shadersVersion=this._sceneShadersVersion}}});Object.defineProperty(f.prototype,%22fog%22,{get:function(){return%20this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(f.prototype,%22gammaCorrection%22,{get:function(){return%20this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,this.updateShaders=!0)}});%20Object.defineProperty(f.prototype,%22toneMapping%22,{get:function(){return%20this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,this.updateShaders=!0)}});Object.defineProperty(f.prototype,%22skybox%22,{get:function(){return%20this._skyboxCubeMap},set:function(a){this._skyboxCubeMap=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxIntensity%22,{get:function(){return%20this._skyboxIntensity},set:function(a){this._skyboxIntensity=a;this._resetSkyboxModel();%20this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxMip%22,{get:function(){return%20this._skyboxMip},set:function(a){this._skyboxMip=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered128%22,{get:function(){return%20this._skyboxPrefiltered128},set:function(a){this._skyboxPrefiltered128=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered64%22,{get:function(){return%20this._skyboxPrefiltered64},set:function(a){this._skyboxPrefiltered64=%20a;this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered32%22,{get:function(){return%20this._skyboxPrefiltered32},set:function(a){this._skyboxPrefiltered32=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered16%22,{get:function(){return%20this._skyboxPrefiltered16},set:function(a){this._skyboxPrefiltered16=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered8%22,{get:function(){return%20this._skyboxPrefiltered8},set:function(a){this._skyboxPrefiltered8=%20a;this.updateShaders=!0}});Object.defineProperty(f.prototype,%22skyboxPrefiltered4%22,{get:function(){return%20this._skyboxPrefiltered4},set:function(a){this._skyboxPrefiltered4=a;this.updateShaders=!0}});f.prototype.applySettings=function(a){this._gravity.set(a.physics.gravity[0],a.physics.gravity[1],a.physics.gravity[2]);var%20b=a.render.global_ambient;this.ambientLight=new%20pc.Color(b[0],b[1],b[2]);this.fog=a.render.fog;b=a.render.fog_color;this.fogColor=new%20pc.Color(b[0],b[1],b[2]);this.fogStart=a.render.fog_start;%20this.fogEnd=a.render.fog_end;this.fogDensity=a.render.fog_density;this.gammaCorrection=a.render.gamma_correction;this.toneMapping=a.render.tonemapping;this.lightmapSizeMultiplier=a.render.lightmapSizeMultiplier;this.lightmapMaxResolution=a.render.lightmapMaxResolution;this.exposure=a.render.exposure;this.skyboxIntensity=void%200===a.render.skyboxIntensity?1:a.render.skyboxIntensity;this.skyboxMip=void%200===a.render.skyboxMip?0:a.render.skyboxMip};f.prototype.updateShadersFunc=function(a){var%20b;if(this._skyboxCubeMap&&%20!this._skyboxModel){var%20d=new%20pc.Material,e=this;d.updateShader=function(){var%20b=a.getProgramLibrary().getProgram(%22skybox%22,{rgbm:e._skyboxCubeMap.rgbm,hdr:e._skyboxCubeMap.rgbm||e._skyboxCubeMap.format===pc.PIXELFORMAT_RGBA32F,useIntensity:1!==e.skyboxIntensity,mip:e._skyboxCubeMap.fixCubemapSeams?e.skyboxMip:0,fixSeams:e._skyboxCubeMap.fixCubemapSeams,gamma:e.gammaCorrection,toneMapping:e.toneMapping});this.setShader(b)};d.updateShader();!this._skyboxCubeMap.fixCubemapSeams||!e._skyboxMip?d.setParameter(%22texture_cubeMap%22,%20this._skyboxCubeMap):(b=this[%22skyboxPrefiltered%22+[null,%2264%22,%2216%22,%228%22,%224%22][e._skyboxMip]])&&d.setParameter(%22texture_cubeMap%22,b);d.cull=pc.CULLFACE_NONE;b=new%20pc.GraphNode;var%20g=pc.createBox(a),d=new%20pc.MeshInstance(b,g,d);d.updateKey=function(){this.key=pc._getDrawcallSortKey(this.layer,this.material.blendType,!1,0)};d.updateKey();d.cull=!1;d.drawToDepth=!1;g=new%20pc.Model;g.graph=b;g.meshInstances=[d];this._skyboxModel=g;this.addModel(g)}d=[];g=this.drawCalls;for(b=0;b%3Cg.length;b++){var%20f=g[b];void%200!==%20f.material&&-1===d.indexOf(f.material)&&d.push(f.material)}for(b=0;b%3Cd.length;b++)g=d[b],g.updateShader!==pc.Material.prototype.updateShader&&(g.clearVariants(),g.shader=null)};f.prototype.getModels=function(){return%20this._models};f.prototype._updateStats=function(){this._stats.meshInstances=this.drawCalls.length;this._updateLightStats()};f.prototype._updateLightStats=function(){var%20a=this._stats;a.lights=this._lights.length;a.dynamicLights=0;a.bakedLights=0;for(var%20b,d=0;d%3Ca.lights;d++)b=this._lights[d],%20(b.mask&pc.MASK_DYNAMIC||b.mask&pc.MASK_BAKED)&&a.dynamicLights++,b.mask&pc.MASK_LIGHTMAP&&a.bakedLights++};f.prototype.addModel=function(a){var%20b,d=a._shadersVersion!==this._sceneShadersVersion;a._shadersVersion=this._sceneShadersVersion;if(-1===this._models.indexOf(a)){this._models.push(a);var%20e=a.getMaterials();for(b=0;b%3Ce.length;b++)e[b].scene=this;var%20g=a.meshInstances.length;for(b=0;b%3Cg;b++)e=a.meshInstances[b],d&&e.material.clearVariants(),-1===this.drawCalls.indexOf(e)&&this.drawCalls.push(e),%20e.castShadow&&-1===this.shadowCasters.indexOf(e)&&this.shadowCasters.push(e);a=a.getLights();b=0;for(len=a.length;b%3Clen;b++)this.addLight(a[b]);this._updateStats()}};f.prototype.removeModel=function(a){var%20b,d=this._models.indexOf(a);if(-1!==d){this._models.splice(d,1);d=a.getMaterials();for(b=0;b%3Cd.length;b++)d[b].scene=null;var%20e,g=a.meshInstances.length;for(b=0;b%3Cg;b++)e=a.meshInstances[b],d=this.drawCalls.indexOf(e),-1!==d&&this.drawCalls.splice(d,1),e.castShadow&&(d=this.shadowCasters.indexOf(e),%20-1!==d&&this.shadowCasters.splice(d,1));a=a.getLights();b=0;for(len=a.length;b%3Clen;b++)this.removeLight(a[b]);this._updateStats()}};f.prototype.containsModel=function(a){return%200%3C=this._models.indexOf(a)};f.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn(%22pc.Scene#addLight:%20light%20is%20already%20in%20the%20scene%22):(this._lights.push(a),a._scene=this,this.updateShaders=!0);this._updateLightStats()};f.prototype.removeLight=function(a){var%20b=this._lights.indexOf(a);-1===b?console.warn(%22pc.Scene#removeLight:%20light%20is%20not%20in%20the%20scene%22):%20(this._lights.splice(b,1),a._scene=null,this.updateShaders=!0);this._updateLightStats()};f.prototype._resetSkyboxModel=function(){this._skyboxModel&&this.containsModel(this._skyboxModel)&&this.removeModel(this._skyboxModel);this._skyboxModel=null};f.prototype.setSkybox=function(a){null!==a?(this._skyboxPrefiltered128=a[1],this._skyboxPrefiltered64=a[2],this._skyboxPrefiltered32=a[3],this._skyboxPrefiltered16=a[4],this._skyboxPrefiltered8=a[5],this._skyboxPrefiltered4=a[6],this.skybox=a[0]):this.skybox=%20this._skyboxPrefiltered4=this._skyboxPrefiltered8=this._skyboxPrefiltered16=this._skyboxPrefiltered32=this._skyboxPrefiltered64=this._skyboxPrefiltered128=null};f.prototype.update=function(){for(var%20a=0,b=this._models.length;a%3Cb;a++)this._models[a].getGraph().syncHierarchy()};f.prototype.destroy=function(){var%20a,b=this.getModels();for(a=0;a%3Cb.length;a++)this.removeModel(b[a]);for(a=0;a%3Cthis._lights.length;a++)this.removeLight(this._lights[a]);this.skybox=null};return{Scene:f}}());pc.extend(pc,function(){function%20f(a,b){return%20a.zdist&&b.zdist?b.zdist-a.zdist:b.key-a.key}function%20a(a){var%20b=Array(a),a=function(a){return%20b[a]};a.size=0;a.push=function(a){b[this.size]=a;++this.size};a.data=b;return%20a}function%20b(a,b,d){b=new%20pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:d,autoMipmap:!1});b.minFilter=pc.FILTER_NEAREST;b.magFilter=pc.FILTER_NEAREST;b.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return%20new%20pc.RenderTarget(a,b,!0)}function%20d(a,%20b){var%20d=new%20pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:b,cubemap:!0,autoMipmap:!1});d.minFilter=pc.FILTER_NEAREST;d.magFilter=pc.FILTER_NEAREST;d.addressU=pc.ADDRESS_CLAMP_TO_EDGE;d.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var%20e=[],g=0;6%3Eg;g++){var%20f=new%20pc.RenderTarget(a,d,{face:g,depth:!0});e.push(f)}return%20e}function%20e(a,e){var%20g;e.getType()===pc.LIGHTTYPE_POINT?(e._cacheShadowMap?(g=C[e._shadowResolution],g||(g=d(a,e._shadowResolution),C[e._shadowResolution]=g)):g=d(a,e._shadowResolution),%20e._shadowCamera.setRenderTarget(g[0]),e._shadowCubeMap=g):(e._cacheShadowMap?(g=A[e._shadowResolution],g||(g=b(a,e._shadowResolution,e._shadowResolution),A[e._shadowResolution]=g)):g=b(a,e._shadowResolution,e._shadowResolution),e._shadowCamera.setRenderTarget(g))}function%20g(a){this.device=a;this._cullTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._removedByInstancing=this._immediateRendered=this._instancedDrawCalls=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=%20this._depthDrawCalls=0;a=this.device.getProgramLibrary();this._depthShaderStatic=a.getProgram(%22depth%22,{skin:!1});this._depthShaderSkin=a.getProgram(%22depth%22,{skin:!0});this._depthProgStatic=[];this._depthProgSkin=[];this._depthProgStaticOp=[];this._depthProgSkinOp=[];this._depthProgStaticPoint=[];this._depthProgSkinPoint=[];this._depthProgStaticOpPoint=[];this._depthProgSkinOpPoint=[];for(var%20b=[%22r%22,%22g%22,%22b%22,%22a%22],d=0;d%3Cpc.SHADOW_DEPTH+1;d++){this._depthProgStatic[d]=a.getProgram(%22depthrgba%22,{skin:!1,%20opacityMap:!1,shadowType:d});this._depthProgSkin[d]=a.getProgram(%22depthrgba%22,{skin:!0,opacityMap:!1,shadowType:d});this._depthProgStaticPoint[d]=a.getProgram(%22depthrgba%22,{skin:!1,opacityMap:!1,point:!0});this._depthProgSkinPoint[d]=a.getProgram(%22depthrgba%22,{skin:!0,opacityMap:!1,point:!0});this._depthProgStaticOp[d]={};this._depthProgSkinOp[d]={};this._depthProgStaticOpPoint[d]={};this._depthProgSkinOpPoint[d]={};for(var%20e=0;4%3Ee;e++)this._depthProgStaticOp[d][b[e]]=a.getProgram(%22depthrgba%22,{skin:!1,%20opacityMap:!0,shadowType:d,opacityChannel:b[e]}),this._depthProgSkinOp[d][b[e]]=a.getProgram(%22depthrgba%22,{skin:!0,opacityMap:!0,shadowType:d,opacityChannel:b[e]}),this._depthProgStaticOpPoint[d][b[e]]=a.getProgram(%22depthrgba%22,{skin:!1,opacityMap:!0,point:!0,opacityChannel:b[e]}),this._depthProgSkinOpPoint[d][b[e]]=a.getProgram(%22depthrgba%22,{skin:!0,opacityMap:!0,point:!0,opacityChannel:b[e]})}a=this.device.scope;this.projId=a.resolve(%22matrix_projection%22);this.viewId=a.resolve(%22matrix_view%22);this.viewId3=%20a.resolve(%22matrix_view3%22);this.viewInvId=a.resolve(%22matrix_viewInverse%22);this.viewProjId=a.resolve(%22matrix_viewProjection%22);this.viewPosId=a.resolve(%22view_position%22);this.nearClipId=a.resolve(%22camera_near%22);this.farClipId=a.resolve(%22camera_far%22);this.lightRadiusId=a.resolve(%22light_radius%22);this.fogColorId=a.resolve(%22fog_color%22);this.fogStartId=a.resolve(%22fog_start%22);this.fogEndId=a.resolve(%22fog_end%22);this.fogDensityId=a.resolve(%22fog_density%22);this.modelMatrixId=a.resolve(%22matrix_model%22);this.normalMatrixId=%20a.resolve(%22matrix_normal%22);this.poseMatrixId=a.resolve(%22matrix_pose[0]%22);this.boneTextureId=a.resolve(%22texture_poseMap%22);this.boneTextureSizeId=a.resolve(%22texture_poseMapSize%22);this.skinPosOffsetId=a.resolve(%22skinPosOffset%22);this.alphaTestId=a.resolve(%22alpha_ref%22);this.depthMapId=a.resolve(%22uDepthMap%22);this.screenSizeId=a.resolve(%22uScreenSize%22);this._screenSize=new%20pc.Vec4;this.fogColor=new%20Float32Array(3);this.ambientColor=new%20Float32Array(3)}var%20h=(new%20pc.Mat4).mul2((new%20pc.Mat4).setTranslate(0.5,%200.5,0.5),(new%20pc.Mat4).setScale(0.5,0.5,0.5)),k=new%20pc.Mat4,n=new%20pc.Mat4,r=new%20pc.Mat4,u=new%20pc.Mat4,l=new%20pc.Mat4,m=new%20pc.Mat3,w=new%20pc.Mat4,s=new%20pc.Vec3,D={},y,x=new%20pc.BoundingBox,A={},C={},B=[];for(i=0;8%3Ei;i++)B.push(new%20pc.Vec3);new%20pc.Vec3;new%20pc.Vec3;new%20pc.Vec3;new%20a(3);new%20a(3);new%20a(3);new%20a(36);var%20z=[new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3];pc.extend(g.prototype,{_isVisible:function(a,b){y=b.aabb.center;b._aabb._radius||(b._aabb._radius=%20b._aabb.halfExtents.length());D.center=y;D.radius=b._aabb._radius;return%20a._frustum.containsSphere(D)},getShadowCamera:function(a,b){var%20d=b._shadowCamera,g;null===d?(d=pc.CLEARFLAG_DEPTH,a.extDepthTexture||(d|=pc.CLEARFLAG_COLOR),g=new%20pc.Camera,g.setClearOptions({color:[1,1,1,1],depth:1,flags:d}),g._node=new%20pc.GraphNode,d=b._shadowCamera=g,e(a,b)):(g=d.getRenderTarget(),(g.width!==b._shadowResolution||g.height!==b._shadowResolution)&&e(a,b));return%20d},updateCameraFrustum:function(a){var%20b=a.getProjectionMatrix(),%20d=a._node.getPosition(),e=a._node.getRotation();u.setTRS(d,e,pc.Vec3.ONE);this.viewInvId.setValue(u.data);l.copy(u).invert();a._frustum.update(b,l)},setCamera:function(a,b){var%20d=a.getProjectionMatrix();this.projId.setValue(d.data);var%20e=a._node.getPosition(),g=a._node.getRotation();u.setTRS(e,g,pc.Vec3.ONE);this.viewInvId.setValue(u.data);l.copy(u).invert();this.viewId.setValue(l.data);m.data[0]=l.data[0];m.data[1]=l.data[1];m.data[2]=l.data[2];m.data[3]=l.data[4];m.data[4]=l.data[5];m.data[5]=l.data[6];%20m.data[6]=l.data[8];m.data[7]=l.data[9];m.data[8]=l.data[10];this.viewId3.setValue(m.data);w.mul2(d,l);this.viewProjId.setValue(w.data);this.viewPosId.setValue(a._node.getPosition().data);this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(d,l);var%20d=this.device,f=a.getRenderTarget();d.setRenderTarget(f);d.updateBegin();var%20g=a.getRect(),e=f?f.width:d.width,f=f?f.height:d.height,h=Math.floor(g.x*e),k=Math.floor(g.y*f),r=Math.floor(g.width*e),g=Math.floor(g.height*%20f);d.setViewport(h,k,r,g);d.setScissor(h,k,r,g);d.clear(a.getClearOptions());b&&d.setScissor(1,1,e-2,f-2)},dispatchGlobalLights:function(a){var%20b;this.mainLight=-1;var%20d=this.device.scope;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(b=0;3%3Eb;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);d.resolve(%22light_globalAmbient%22).setValue(this.ambientColor);d.resolve(%22exposure%22).setValue(a.exposure);a._skyboxModel&&%20d.resolve(%22skyboxIntensity%22).setValue(a.skyboxIntensity)},dispatchDirectLights:function(a,b){var%20d=a._globalLights,e=d.length,g,f,h,k,r=0,l=this.device.scope;for(g=0;g%3Ce;g++)if(d[g].mask&b){f=d[g];h=f._node.getWorldTransform();k=%22light%22+r;l.resolve(k+%22_color%22).setValue(a.gammaCorrection?f._linearFinalColor.data:f._finalColor.data);h.getY(f._direction).scale(-1);l.resolve(k+%22_direction%22).setValue(f._direction.normalize().data);if(f.getCastShadows()){h=this.device.extDepthTexture?f._shadowCamera._renderTarget._depthTexture:%20f._shadowCamera._renderTarget.colorBuffer;var%20n=100*(f._shadowBias/f._shadowCamera.getFarClip());l.resolve(k+%22_shadowMap%22).setValue(h);l.resolve(k+%22_shadowMatrix%22).setValue(f._shadowMatrix.data);l.resolve(k+%22_shadowParams%22).setValue([f._shadowResolution,f._normalOffsetBias,n]);0%3Ethis.mainLight&&(l.resolve(k+%22_shadowMatrixVS%22).setValue(f._shadowMatrix.data),l.resolve(k+%22_shadowParamsVS%22).setValue([f._shadowResolution,f._normalOffsetBias,n]),l.resolve(k+%22_directionVS%22).setValue(f._direction.normalize().data),%20this.mainLight=g)}r++}return%20r},dispatchLocalLights:function(a,b,d){var%20e,g,f,h,k;e=a._localLights;var%20r=0;h=e[pc.LIGHTTYPE_POINT-1];var%20l=e[pc.LIGHTTYPE_SPOT-1],n=h.length,s=l.length,m=this.device.scope;for(e=0;e%3Cn;e++)h[e].mask&b&&(f=h[e],g=f._node.getWorldTransform(),k=%22light%22+(d+r),m.resolve(k+%22_radius%22).setValue(f._attenuationEnd),m.resolve(k+%22_color%22).setValue(a.gammaCorrection?f._linearFinalColor.data:f._finalColor.data),g.getTranslation(f._position),m.resolve(k+%22_position%22).setValue(f._position.data),%20f.getCastShadows()&&(g=this.device.extDepthTexture?f._shadowCamera._renderTarget._depthTexture:f._shadowCamera._renderTarget.colorBuffer,m.resolve(k+%22_shadowMap%22).setValue(g),m.resolve(k+%22_shadowMatrix%22).setValue(f._shadowMatrix.data),m.resolve(k+%22_shadowParams%22).setValue([f._shadowResolution,f._normalOffsetBias,f._shadowBias,1/f.getAttenuationEnd()])),r++);for(e=0;e%3Cs;e++)l[e].mask&b&&(h=l[e],g=h._node.getWorldTransform(),k=%22light%22+(d+r),m.resolve(k+%22_innerConeAngle%22).setValue(h._innerConeAngleCos),%20m.resolve(k+%22_outerConeAngle%22).setValue(h._outerConeAngleCos),m.resolve(k+%22_radius%22).setValue(h._attenuationEnd),m.resolve(k+%22_color%22).setValue(a.gammaCorrection?h._linearFinalColor.data:h._finalColor.data),g.getTranslation(h._position),m.resolve(k+%22_position%22).setValue(h._position.data),g.getY(h._direction).scale(-1),m.resolve(k+%22_spotDirection%22).setValue(h._direction.normalize().data),h.getCastShadows()&&(f=20*h._shadowBias,g=this.device.extDepthTexture?h._shadowCamera._renderTarget._depthTexture:%20h._shadowCamera._renderTarget.colorBuffer,m.resolve(k+%22_shadowMap%22).setValue(g),m.resolve(k+%22_shadowMatrix%22).setValue(h._shadowMatrix.data),m.resolve(k+%22_shadowParams%22).setValue([h._shadowResolution,h._normalOffsetBias,f,1/h.getAttenuationEnd()]),0%3Ethis.mainLight&&(m.resolve(k+%22_shadowMatrixVS%22).setValue(h._shadowMatrix.data),m.resolve(k+%22_shadowParamsVS%22).setValue([h._shadowResolution,h._normalOffsetBias,f,1/h.getAttenuationEnd()]),m.resolve(k+%22_positionVS%22).setValue(h._position.data),this.mainLight=%20e)),r++)},render:function(a,b){var%20d,e,g=this.device,l=g.scope;a._activeCamera=b;a.updateShaders&&(a.updateShadersFunc(g),a.updateShaders=!1);var%20m=b.getRenderTarget(),u=!1,w=a._gammaCorrection,A=a._toneMapping,C=a.exposure;if(m&&(m=m.colorBuffer.format,m===pc.PIXELFORMAT_RGB16F||m===pc.PIXELFORMAT_RGB32F))u=!0,a._gammaCorrection=pc.GAMMA_NONE,a._toneMapping=pc.TONEMAP_LINEAR,a.exposure=1;var%20F,O,da,H,T=a._lights,m=a.drawCalls,ea=m.length,K=a.shadowCasters,L,ha=null,X;a._globalLights.length=0;a._localLights[0].length=%200;for(F=a._localLights[1].length=0;F%3CT.length;F++)H=T[F],H.getEnabled()&&(H.getType()===pc.LIGHTTYPE_DIRECTIONAL?a._globalLights.push(H):a._localLights[H.getType()===pc.LIGHTTYPE_POINT?0:1].push(H));var%20Z=[],ca;L=pc.now();this.updateCameraFrustum(b);for(F=0;F%3Cea;F++)H=m[F],H.skinInstance&&H.skinInstance.updateMatrices();var%20S=b._node.getPosition(),fa=b._node.forward;for(F=0;F%3Cea;F++){H=m[F];d=!0;y=null;if(!H.command){if(H._hidden)continue;e=H;e.layer===pc.LAYER_WORLD&&(b.frustumCulling&&H.cull&&(d=%20this._isVisible(b,e)),d&&(ca=e.material.blendType,ca!==pc.BLEND_NONE?(y||(y=e.aabb.center),e.zdist=(y.x-S.x)*fa.x+(y.y-S.y)*fa.y+(y.z-S.z)*fa.z):void%200!==e.zdist&&delete%20e.zdist))}d&&Z.push(H)}this._cullTime+=pc.now()-L;for(F=0;F%3Ca.immediateDrawCalls.length;F++)Z.push(a.immediateDrawCalls[F]);this._immediateRendered+=a.immediateDrawCalls.length;m=Z;ea=Z.length;for(F=0;F%3Cea;F++)H=m[F],H.skinInstance&&H.skinInstance.updateMatrixPalette();m.sort(f);if(b._renderDepthRequests){H=b._rect;F=Math.floor(H.width*%20g.width);H=Math.floor(H.height*g.height);b._depthTarget&&(b._depthTarget.width!==F&&b._depthTarget.height!==H)&&(b._depthTarget.destroy(),b._depthTarget=null);b._depthTarget||(F=new%20pc.Texture(g,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:F,height:H}),F.minFilter=pc.FILTER_NEAREST,F.magFilter=pc.FILTER_NEAREST,F.addressU=pc.ADDRESS_CLAMP_TO_EDGE,F.addressV=pc.ADDRESS_CLAMP_TO_EDGE,b._depthTarget=new%20pc.RenderTarget(g,F,{depth:!0}));ca=b.getRenderTarget();b.setRenderTarget(b._depthTarget);this.setCamera(b);%20S=g.getBlending();g.setBlending(!1);for(F=0;F%3Cea;F++)H=m[F],!H.command&&(H.drawToDepth&&e.material.blendType===pc.BLEND_NONE)&&(e=H,d=e.mesh,this.modelMatrixId.setValue(e.node.worldTransform.data),e.skinInstance?(this._skinDrawCalls++,this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),g.supportsBoneTextures?(X=e.skinInstance.boneTexture,this.boneTextureId.setValue(X),this.boneTextureSizeId.setValue([X.width,X.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette),%20g.setShader(this._depthShaderSkin)):g.setShader(this._depthShaderStatic),X=e.renderStyle,g.setVertexBuffer(d.vertexBuffer,0),g.setIndexBuffer(d.indexBuffer[X]),g.draw(d.primitive[X]),this._depthDrawCalls++),b.setRenderTarget(ca);g.setBlending(S)}else%20b._depthTarget&&(b._depthTarget.destroy(),b._depthTarget=null);var%20$,V,W,aa;for(F=0;F%3CT.length;F++)if(H=T[F],ca=H.getType(),H.getCastShadows()&&H.getEnabled()&&H.shadowUpdateMode!==pc.SHADOWUPDATE_NONE){H.shadowUpdateMode===pc.SHADOWUPDATE_THISFRAME&&%20(H.shadowUpdateMode=pc.SHADOWUPDATE_NONE);S=this.getShadowCamera(g,H);fa=1;S._node.setPosition(H._node.getPosition());S._node.setRotation(H._node.getRotation());S._node.rotateLocal(-90,0,0);if(ca===pc.LIGHTTYPE_DIRECTIONAL){W=b;$=H.getShadowDistance()||b.getFarClip();V=B;e=W.getNearClip();Z=W.getFov()*Math.PI/180;O=W.getAspectRatio();aa=W.getProjection();var%20Y=void%200;d=void%200;d=aa===pc.PROJECTION_PERSPECTIVE?Math.tan(Z/2)*e:W._orthoHeight;Y=d*O;V[0].x=Y;V[0].y=-d;V[0].z=-e;V[1].x=Y;V[1].y=d;V[1].z=%20-e;V[2].x=-Y;V[2].y=d;V[2].z=-e;V[3].x=-Y;V[3].y=-d;V[3].z=-e;aa===pc.PROJECTION_PERSPECTIVE&&(d=Math.tan(Z/2)*$,Y=d*O);V[4].x=Y;V[4].y=-d;V[4].z=-$;V[5].x=Y;V[5].y=d;V[5].z=-$;V[6].x=-Y;V[6].y=d;V[6].z=-$;V[7].x=-Y;V[7].y=-d;V[7].z=-$;frustumSize=s.sub2(B[0],B[6]).length();frustumSize=Math.max(frustumSize,s.sub2(B[4],B[6]).length());k.copy(S._node.getWorldTransform()).invert();r.copy(k).mul(b._node.worldTransform);for(O=0;8%3EO;O++)r.transformPoint(B[O],B[O]);$=V=W=1E6;aa=Z=e=-1E6;for(O=0;8%3EO;O++)Y=%20B[O],Y.x%3C$&&($=Y.x),Y.x%3Eaa&&(aa=Y.x),Y.y%3CV&&(V=Y.y),Y.y%3EZ&&(Z=Y.y),Y.z%3CW&&(W=Y.z),Y.z%3Ee&&(e=Y.z);e=frustumSize/H.getShadowResolution();O=0.5*(frustumSize-(aa-$));$=Math.floor(($-O)/e)*e;O=0.5*(frustumSize-(Z-V));V=Math.floor((V-O)/e)*e;aa=$+frustumSize;Z=V+frustumSize;$=0.5*(aa+$);V=0.5*(Z+V);S._node.translateLocal($,V,1E5);S.setProjection(pc.PROJECTION_ORTHOGRAPHIC);S.setNearClip(0);S.setFarClip(2E5);S.setAspectRatio(1);S.setOrthoHeight(0.5*frustumSize)}else%20if(ca===pc.LIGHTTYPE_SPOT){if(b.frustumCulling&&%20(H._node.getWorldTransform(),H.getBoundingSphere(D),!b._frustum.containsSphere(D)))continue;S.setProjection(pc.PROJECTION_PERSPECTIVE);S.setNearClip(H.getAttenuationEnd()/1E3);S.setFarClip(H.getAttenuationEnd());S.setAspectRatio(1);S.setFov(2*H.getOuterConeAngle());this.viewPosId.setValue(S._node.getPosition().data);this.lightRadiusId.setValue(H.getAttenuationEnd())}else%20if(ca===pc.LIGHTTYPE_POINT){if(b.frustumCulling&&(H._node.getWorldTransform(),H.getBoundingSphere(D),!b._frustum.containsSphere(D)))continue;%20S.setProjection(pc.PROJECTION_PERSPECTIVE);S.setNearClip(H.getAttenuationEnd()/1E3);S.setFarClip(H.getAttenuationEnd());S.setAspectRatio(1);S.setFov(90);fa=6;this.viewPosId.setValue(S._node.getPosition().data);this.lightRadiusId.setValue(H.getAttenuationEnd())}this._shadowMapUpdates+=fa;Y=%22r%22;for(aa=0;aa%3Cfa;aa++){ca===pc.LIGHTTYPE_POINT&&(0===aa?S._node.setEulerAngles(0,90,180):1===aa?S._node.setEulerAngles(0,-90,180):2===aa?S._node.setEulerAngles(90,0,0):3===aa?S._node.setEulerAngles(-90,0,0):4===%20aa?S._node.setEulerAngles(0,180,180):5===aa&&S._node.setEulerAngles(0,0,180),S._node.setPosition(H._node.getPosition()),S.setRenderTarget(H._shadowCubeMap[aa]));this.setCamera(S,ca!==pc.LIGHTTYPE_POINT);Z=[];L=pc.now();O=0;for(da=K.length;O%3Cda;O++)e=K[O],d=!0,e.cull&&(d=this._isVisible(S,e)),d&&Z.push(e);this._cullTime+=pc.now()-L;if(ca===pc.LIGHTTYPE_DIRECTIONAL){d=!0;for(O=0;O%3CZ.length;O++)e=Z[O],e=e.aabb,d?(x.copy(e),d=!1):x.add(e);e=k;O=x.getMin();d=x.getMax();z[0].x=z[1].x=z[2].x=z[3].x=O.x;%20z[1].y=z[3].y=z[7].y=z[5].y=O.y;z[2].z=z[3].z=z[6].z=z[7].z=O.z;z[4].x=z[5].x=z[6].x=z[7].x=d.x;z[0].y=z[2].y=z[4].y=z[6].y=d.y;z[0].z=z[1].z=z[4].z=z[5].z=d.z;d=9999999999;O=-9999999999;L=void%200;for(X=0;8%3EX;++X)e.transformPoint(z[X],z[X]),L=z[X].z,L%3Cd&&(d=L),L%3EO&&(O=L);e=O;d%3EW&&(W=d);S._node.setPosition(H._node.getPosition());S._node.translateLocal($,V,e);S.setFarClip(e-W);this.setCamera(S,!0)}ca!==pc.LIGHTTYPE_POINT&&(k.setTRS(S._node.getPosition(),S._node.getRotation(),pc.Vec3.ONE).invert(),n.mul2(S.getProjectionMatrix(),%20k),H._shadowMatrix.mul2(h,n));g.setBlending(!1);g.setColorWrite(!0,!0,!0,!0);g.setDepthWrite(!0);g.setDepthTest(!0);g.extDepthTexture&&g.setColorWrite(!1,!1,!1,!1);O=0;for(da=Z.length;O%3Cda;O++)e=Z[O],d=e.mesh,L=e.material,g.setCullMode(L.cull),this.modelMatrixId.setValue(e.node.worldTransform.data),L.opacityMap&&(l.resolve(%22texture_opacityMap%22).setValue(L.opacityMap),L.opacityMapChannel&&(Y=L.opacityMapChannel)),e.skinInstance?(this._skinDrawCalls++,this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),%20g.supportsBoneTextures?(X=e.skinInstance.boneTexture,this.boneTextureId.setValue(X),this.boneTextureSizeId.setValue([X.width,X.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette),ca!==pc.LIGHTTYPE_DIRECTIONAL?g.setShader(L.opacityMap?this._depthProgSkinOpPoint[H._shadowType][Y]:this._depthProgSkinPoint[H._shadowType]):g.setShader(L.opacityMap?this._depthProgSkinOp[H._shadowType][Y]:this._depthProgSkin[H._shadowType])):ca!==pc.LIGHTTYPE_DIRECTIONAL?g.setShader(L.opacityMap?this._depthProgStaticOpPoint[H._shadowType][Y]:%20this._depthProgStaticPoint[H._shadowType]):g.setShader(L.opacityMap?this._depthProgStaticOp[H._shadowType][Y]:this._depthProgStatic[H._shadowType]),X=e.renderStyle,g.setVertexBuffer(d.vertexBuffer,0),g.setIndexBuffer(d.indexBuffer[X]),g.draw(d.primitive[X]),this._shadowDrawCalls++}}this.setCamera(b);this.dispatchGlobalLights(a);if(a.fog!==pc.FOG_NONE){this.fogColor[0]=a.fogColor.r;this.fogColor[1]=a.fogColor.g;this.fogColor[2]=a.fogColor.b;if(a.gammaCorrection)for(F=0;3%3EF;F++)this.fogColor[F]=Math.pow(this.fogColor[F],%202.2);this.fogColorId.setValue(this.fogColor);a.fog===pc.FOG_LINEAR?(this.fogStartId.setValue(a.fogStart),this.fogEndId.setValue(a.fogEnd)):this.fogDensityId.setValue(a.fogDensity)}pc._instanceVertexFormat||(pc._instanceVertexFormat=new%20pc.VertexFormat(g,[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,%20components:4,type:pc.ELEMENTTYPE_FLOAT32}]));g.enableAutoInstancing&&!pc._autoInstanceBuffer&&(pc._autoInstanceBuffer=new%20pc.VertexBuffer(g,pc._instanceVertexFormat,g.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),pc._autoInstanceBufferData=new%20Float32Array(pc._autoInstanceBuffer.lock()));var%20ga,ja,ia;this._screenSize.x=g.width;this._screenSize.y=g.height;this._screenSize.z=1/g.width;this._screenSize.w=1/g.height;this.screenSizeId.setValue(this._screenSize.data);b._depthTarget&&this.depthMapId.setValue(b._depthTarget.colorBuffer);%20for(F=0;F%3Cea;F++)if(H=m[F],H.command)H.command();else{e=H;d=e.mesh;L=e.material;l=e._shaderDefs;T=e.mask;if(g.enableAutoInstancing&&(F!==ea-1&&g.extInstancing)&&(K=F+1,m[K].mesh===d&&m[K].material===L)){for(O=0;16%3EO;O++)pc._autoInstanceBufferData[O]=H.node.worldTransform.data[O];for(F=1;K!==ea&&m[K].mesh===d&&m[K].material===L;){for(O=0;16%3EO;O++)pc._autoInstanceBufferData[16*F+O]=m[K].node.worldTransform.data[O];F++;K++}e.instancingData={};e.instancingData.count=F;e.instancingData._buffer=pc._autoInstanceBuffer;%20e.instancingData._buffer.unlock();F=K-1}e.instancingData&&g.extInstancing?(l|=pc.SHADERDEF_INSTANCING,e.instancingData._buffer||(e.instancingData._buffer=new%20pc.VertexBuffer(g,pc._instanceVertexFormat,H.instancingData.count,H.instancingData.usage,e.instancingData.buffer))):(l&=~pc.SHADERDEF_INSTANCING,K=e.node.worldTransform,W=e.normalMatrix,K.invertTo3x3(W),W.transpose(),this.modelMatrixId.setValue(K.data),this.normalMatrixId.setValue(W.data));e.skinInstance&&(this._skinDrawCalls++,this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),%20g.supportsBoneTextures?(X=e.skinInstance.boneTexture,this.boneTextureId.setValue(X),this.boneTextureSizeId.setValue([X.width,X.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette));L&&(L===ha&&l!==ga)&&(ha=null);if(L!==ha){this._materialSwitches++;if(!e._shader||e._shaderDefs!==l)e._shader=L.variants[l],e._shader||(L.updateShader(g,a,l),e._shader=L.variants[l]=L.shader),e._shaderDefs=l;g.setShader(e._shader);ga=L.parameters;for(ia%20in%20ga)K=ga[ia],K.scopeId||(K.scopeId=g.scope.resolve(ia)),%20K.scopeId.setValue(K.data);if(!ha||T!==ja)usedDirLights=this.dispatchDirectLights(a,T),this.dispatchLocalLights(a,T,usedDirLights);this.alphaTestId.setValue(L.alphaTest);g.setBlending(L.blend);g.setBlendFunction(L.blendSrc,L.blendDst);g.setBlendEquation(L.blendEquation);g.setColorWrite(L.redWrite,L.greenWrite,L.blueWrite,L.alphaWrite);g.setCullMode(L.cull);g.setDepthWrite(L.depthWrite);g.setDepthTest(L.depthTest)}ga=e.parameters;for(ia%20in%20ga)K=ga[ia],K.scopeId||(K.scopeId=g.scope.resolve(ia)),K.scopeId.setValue(K.data);%20g.setVertexBuffer(d.vertexBuffer,0);X=e.renderStyle;g.setIndexBuffer(d.indexBuffer[X]);e.instancingData?(this._instancedDrawCalls++,this._removedByInstancing+=H.instancingData.count,g.setVertexBuffer(e.instancingData._buffer,1),g.draw(d.primitive[X],H.instancingData.count),e.instancingData._buffer===pc._autoInstanceBuffer&&(e.instancingData=null)):g.draw(d.primitive[X]);this._forwardDrawCalls++;if(F%3Cea-1&&m[F+1].material===L)for(ia%20in%20ga)(K=L.parameters[ia])&&K.scopeId.setValue(K.data);ha=L;ga=l;%20ja=T}g.setColorWrite(!0,!0,!0,!0);0%3Ca.immediateDrawCalls.length&&(a.immediateDrawCalls=[]);u&&(a._gammaCorrection=w,a._toneMapping=A,a.exposure=C);this._camerasRendered++}});return{ForwardRenderer:g}}());pc.extend(pc,function(){var%20f=function(){this.name=%22Untitled%22;this._labels={};this.localPosition=new%20pc.Vec3(0,0,0);this.localRotation=new%20pc.Quat(0,0,0,1);this.localScale=new%20pc.Vec3(1,1,1);this.localEulerAngles=new%20pc.Vec3(0,0,0);this.position=new%20pc.Vec3(0,0,0);this.rotation=new%20pc.Quat(0,0,0,1);this.eulerAngles=new%20pc.Vec3(0,0,0);this.localTransform=new%20pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new%20pc.Mat4;this.dirtyWorld=!1;this._right=new%20pc.Vec3;this._up=new%20pc.Vec3;this._forward=new%20pc.Vec3;%20this._parent=null;this._children=[];this._enabled=!0;this._enabledInHierarchy=!1};Object.defineProperty(f.prototype,%22right%22,{get:function(){return%20this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(f.prototype,%22up%22,{get:function(){return%20this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(f.prototype,%22forward%22,{get:function(){return%20this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(f.prototype,%22enabled%22,%20{get:function(){return%20this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(f.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var%20d=a._children,e=0,g=d.length;e%3Cg;e++)d[e]._enabled&&this._notifyHierarchyStateChanged(d[e],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;%20a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=!1},clone:function(){var%20a=%20new%20pc.GraphNode;this._cloneInternal(a);return%20a},find:function(a,b){var%20d,e=this.getChildren(),g=e.length,f=[];this[a]&&(d=this[a]instanceof%20Function?this[a]():this[a],d===b&&f.push(this));for(d=0;d%3Cg;++d)f=f.concat(e[d].find(a,b));return%20f},findOne:function(a,b){var%20d,e=this.getChildren(),g=e.length,f=null;if(this[a]&&(d=this[a]instanceof%20Function?this[a]():this[a],d===b))return%20this;for(d=0;d%3Cg;++d)if(f=e[d].findOne(a,b),null!==f)return%20f;return%20null},findByName:function(a){if(this.name===a)return%20this;%20for(var%20b=0;b%3Cthis._children.length;b++){var%20d=this._children[b].findByName(a);if(null!==d)return%20d}return%20null},findByPath:function(a){for(var%20a=a.split(%22/%22),b=this,d=null,e=0,g=a.length;e%3Cg&&b;e++){for(var%20f=a[e],d=null,b=b._children,k=0,n=b.length;k%3Cn;k++)if(b[k].name==f){d=b[k];break}b=d}return%20d},getPath:function(){var%20a=this._parent;if(a){for(var%20b=this.name;a&&a._parent;)b=pc.string.format(%22{0}/{1}%22,a.name,b),a=a._parent;return%20b}return%22%22},getRoot:function(){var%20a=this.getParent();if(!a)return%20this;%20for(;a.getParent();)a=a.getParent();return%20a},getParent:function(){return%20this._parent},getChildren:function(){return%20this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return%20this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);return%20this.localEulerAngles},getLocalPosition:function(){return%20this.localPosition},getLocalRotation:function(){return%20this.localRotation},getLocalScale:function(){return%20this.localScale},%20getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);return%20this.localTransform},getName:function(){return%20this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return%20this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return%20this.rotation},getWorldTransform:function(){var%20a=[];return%20function(){var%20b=this;for(a.length=%200;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0%3C=b;b--)a[b].sync();return%20this.worldTransform}}(),reparent:function(a,b){var%20d=this.getParent();d&&d.removeChild(this);a&&(0%3C=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(){var%20a,b,d;switch(arguments.length){case%201:a=arguments[0].x;b=arguments[0].y;d=arguments[0].z;break;case%203:a=arguments[0],b=arguments[1],d=arguments[2]}this.localRotation.setFromEulerAngles(a,b,d);this.dirtyLocal=!0},setLocalPosition:function(){1===%20arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=%20a},setPosition:function(){var%20a=new%20pc.Vec3,b=new%20pc.Mat4;return%20function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var%20a=new%20pc.Quat,b=new%20pc.Quat;return%20function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===%20this._parent)this.localRotation.copy(a);else{var%20d=this._parent.getRotation();b.copy(d).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var%20a=new%20pc.Quat;return%20function(){var%20b,d,e;switch(arguments.length){case%201:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case%203:b=arguments[0],d=arguments[1],e=arguments[2]}this.localRotation.setFromEulerAngles(b,d,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,%20this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw%20Error(%22GraphNode%20is%20already%20parented%22);this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var%20b=a.getPosition(),d=a.getRotation(),e=a.getParent();e&&e.removeChild(a);void%200===this.tmpMat4&&(this.tmpMat4=new%20pc.Mat4,this.tmpQuat=new%20pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(d));%20this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a.getParent())throw%20Error(%22GraphNode%20is%20already%20parented%22);this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var%20b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a.dirtyWorld=!0},removeChild:function(a){var%20b,d=this._children.length;a._parent=null;for(b=0;b%3Cd;++b)if(this._children[b]===a){this._children.splice(b,%201);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return%20Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete%20this._labels[a]},findByLabel:function(a,b){var%20d,e=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(d=0;d%3Ce;++d)b=this._children[d].findByLabel(a,b);return%20b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=%20!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var%20a=0,b=this._children.length;a%3Cb;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var%20a=function(){if(this._enabled){this.sync();for(var%20b=this._children,d=0,e=b.length;d%3Ce;d++)a.call(b[d])}};return%20a}(),lookAt:function(){var%20a=new%20pc.Mat4,b=new%20pc.Vec3,d=new%20pc.Vec3,e=new%20pc.Quat;return%20function(){switch(arguments.length){case%201:b.copy(arguments[0]);%20d.copy(pc.Vec3.UP);break;case%202:b.copy(arguments[0]);d.copy(arguments[1]);break;case%203:b.set(arguments[0],arguments[1],arguments[2]);d.copy(pc.Vec3.UP);break;case%206:b.set(arguments[0],arguments[1],arguments[2]),d.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),b,d);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var%20a=new%20pc.Vec3;return%20function(){switch(arguments.length){case%201:a.copy(arguments[0]);break;case%203:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());%20this.setPosition(a)}}(),translateLocal:function(){var%20a=new%20pc.Vec3;return%20function(){switch(arguments.length){case%201:a.copy(arguments[0]);break;case%203:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);this.dirtyLocal=!0}}(),rotate:function(){var%20a=new%20pc.Quat,b=new%20pc.Quat;return%20function(){var%20d,e,g;switch(arguments.length){case%201:d=arguments[0].x;e=arguments[0].y;g=arguments[0].z;break;case%203:d=arguments[0],e=arguments[1],g=arguments[2]}a.setFromEulerAngles(d,%20e,g);null===this._parent?this.localRotation.mul2(a,this.localRotation):(d=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,d));this.dirtyLocal=!0}}(),rotateLocal:function(){var%20a=new%20pc.Quat;return%20function(){var%20b,d,e;switch(arguments.length){case%201:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case%203:b=arguments[0],d=arguments[1],e=arguments[2]}a.setFromEulerAngles(b,d,e);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:f}}());pc.extend(pc,function(){var%20f=function(){this._projection=pc.PROJECTION_PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this.frustumCulling=this._horizontalFov=!1;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new%20pc.Mat4;this._viewMat=new%20pc.Mat4;this._viewProjMat=new%20pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new%20pc.Frustum(this._projMat,this._viewMat);this._depthTarget=this._renderTarget=null;this._clearOptions=%20{color:[186/255,186/255,177/255,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this._node=null};f.prototype={clone:function(){var%20a=new%20pc.Camera;a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions());a.frustumCulling=this.frustumCulling;return%20a},worldToScreen:function(a,b,d,e){void%200===e&&(e=%20new%20pc.Vec3);var%20g=this.getProjectionMatrix(),f=this._node.getWorldTransform();this._viewMat.copy(f).invert();this._viewProjMat.mul2(g,this._viewMat);this._viewProjMat.transformPoint(a,e);a=a.data;g=this._viewProjMat.data;a=a[0]*g[3]+a[1]*g[7]+a[2]*g[11]+1*g[15];e.x=0.5*(e.x/a+1)*b;e.y=0.5*(1-e.y/a)*d;return%20e},screenToWorld:function(a,b,d,e,g,f){void%200===f&&(f=new%20pc.Vec3);var%20k=this.getProjectionMatrix(),n=this._node.getWorldTransform();this._viewMat.copy(n).invert();this._viewProjMat.mul2(k,this._viewMat);%20k=this._viewProjMat.clone().invert();this._projection===pc.PROJECTION_PERSPECTIVE?(b=new%20pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,1),a=k.transformPoint(b),a.scale(1/(b.x*k.data[3]+b.y*k.data[7]+b.z*k.data[11]+k.data[15])),d/=this._farClip,f.lerp(this._node.getPosition(),a,d)):(d=new%20pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,2*((this._farClip-d)/(this._farClip-this._nearClip))-1),k.transformPoint(d,f));return%20f},getAspectRatio:function(){return%20this._aspect},getClearOptions:function(){return%20this._clearOptions},getFarClip:function(){return%20this._farClip},%20getFov:function(){return%20this._fov},getFrustum:function(){return%20this._frustum},getNearClip:function(){return%20this._nearClip},getOrthoHeight:function(){return%20this._orthoHeight},getProjection:function(){return%20this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{var%20a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,%20b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return%20this._projMat},getRect:function(){return%20this._rect},getRenderTarget:function(){return%20this._renderTarget},setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=!0},setNearClip:function(a){this._nearClip=a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=%20a;this._projMatDirty=!0},setHorizontalFov:function(a){this._horizontalFov=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,d,e){this._rect.x=a;this._rect.y=b;this._rect.width=d;this._rect.height=e},setRenderTarget:function(a){this._renderTarget=a},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}};return{Camera:f}}());pc.extend(pc,function(){var%20f=new%20pc.Vec3,a=new%20pc.Vec3,b=new%20pc.Vec3,d=function(){this._type=pc.LIGHTTYPE_DIRECTIONAL;this._color=new%20pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._falloffMode=0;this._shadowType=pc.SHADOW_DEPTH;this.mask=1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new%20pc.Vec3(0.8,0.8,0.8);this._linearFinalColor=new%20pc.Vec3;this._position=new%20pc.Vec3(0,0,0);this._direction=new%20pc.Vec3(0,%200,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new%20pc.Mat4;this._shadowDistance=40;this._shadowResolution=1024;this._shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this._node=this._scene=null};d.prototype={clone:function(){var%20a=new%20pc.Light;a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());%20a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());a.setFalloffMode(this.getFalloffMode());a.setShadowType(this.getShadowType());a.shadowUpdateMode=this.shadowUpdateMode;a.mask=this.mask;a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setNormalOffsetBias(this.getNormalOffsetBias());a.setShadowResolution(this.getShadowResolution());%20a.setShadowDistance(this.getShadowDistance());return%20a},getAttenuationEnd:function(){return%20this._attenuationEnd},getAttenuationStart:function(){return%20this._attenuationStart},getFalloffMode:function(){return%20this._falloffMode},getShadowType:function(){return%20this._shadowType},getCastShadows:function(){return%20this._castShadows&&this.mask!==pc.MASK_LIGHTMAP&&0!==this.mask},getColor:function(){return%20this._color},getEnabled:function(){return%20this._enabled},getInnerConeAngle:function(){return%20this._innerConeAngle},%20getIntensity:function(){return%20this._intensity},getOuterConeAngle:function(){return%20this._outerConeAngle},getShadowBias:function(){return%20this._shadowBias},getNormalOffsetBias:function(){return%20this._normalOffsetBias},getShadowDistance:function(){return%20this._shadowDistance},getShadowResolution:function(){return%20this._shadowResolution},getType:function(){return%20this._type},setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=a},setFalloffMode:function(a){this._falloffMode=%20a;null!==this._scene&&(this._scene.updateShaders=!0)},setShadowType:function(a){this._shadowType=a;null!==this._scene&&(this._scene.updateShaders=!0)},setMask:function(a){this.mask=a;null!==this._scene&&(this._scene.updateShaders=!0)},getBoundingSphere:function(d){if(this._type===pc.LIGHTTYPE_SPOT){var%20g=this.getAttenuationEnd(),h=this.getOuterConeAngle(),k=Math.cos(h*pc.math.DEG_TO_RAD);f.copy(this._node.up);f.scale(0.5*-g*k);f.add(this._node.getPosition());d.center=f;a.copy(this._node.up);a.scale(-g);%20b.copy(this._node.right);b.scale(Math.sin(h*pc.math.DEG_TO_RAD)*g);a.add(b);d.radius=0.5*a.length()}else%20this._type===pc.LIGHTTYPE_POINT&&(d.center=this._node.getPosition(),d.radius=this.getAttenuationEnd())},setCastShadows:function(a){this._castShadows=a;null!==this._scene&&(this._scene.updateShaders=!0)},setColor:function(){var%20a,b,d;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,d=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],d=arguments[2]);this._color.set(a,b,%20d);var%20f=this._intensity;this._finalColor.set(a*f,b*f,d*f);for(a=0;3%3Ea;a++)this._linearFinalColor.data[a]=1%3C=f?Math.pow(this._finalColor.data[a]/f,2.2)*f:Math.pow(this._finalColor.data[a],2.2)},setEnabled:function(a){this._enabled!==a&&(this._enabled=a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var%20b=this._color,a=this._intensity;this._finalColor.set(b.r*%20a,b.g*a,b.b*a);for(b=0;3%3Eb;b++)this._linearFinalColor.data[b]=1%3C=a?Math.pow(this._finalColor.data[b]/a,2.2)*a:Math.pow(this._finalColor.data[b],2.2)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setNormalOffsetBias:function(a){if(!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)this._scene.updateShaders=!0;this._normalOffsetBias=a},setShadowDistance:function(a){this._shadowDistance=a},setShadowResolution:function(a){var%20b=%20pc.Application.getApplication().graphicsDevice;this._shadowResolution=a=this._type===pc.LIGHTTYPE_POINT?Math.min(a,b.maxCubeMapSize):Math.min(a,b.maxTextureSize)},setType:function(a){this._type=a;this._destroyShadowMap()},_destroyShadowMap:function(){if(this._shadowCamera){var%20a=this._shadowCamera._renderTarget,b;if(a)if(a.length)for(b=0;b%3Ca.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else%20a.colorBuffer&&a.colorBuffer.destroy(),a.destroy();this._shadowCubeMap=this._shadowCamera=%20this._shadowCamera._renderTarget=null}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}};return{Light:d}}());pc.extend(pc,function(){var%20f=0,a=function(){this.name=%22Untitled%22;this.id=f++;this.shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,%22blendType%22,{get:function(){return!this.blend&&this.blendSrc===%20pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NONE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NORMAL:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_ADDITIVE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===%20pc.BLENDEQUATION_ADD?pc.BLEND_ADDITIVEALPHA:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_SRC_COLOR&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_MULTIPLICATIVE2X:this.blend&&this.blendSrc===pc.BLENDMODE_ONE_MINUS_DST_COLOR&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_SCREEN:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_MULTIPLICATIVE:%20this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_PREMULTIPLIED:pc.BLEND_NORMAL},set:function(a){switch(a){case%20pc.BLEND_NONE:this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;%20break;case%20pc.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_ADDITIVEALPHA:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_MULTIPLICATIVE2X:this.blend=!0;%20this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_SRC_COLOR;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_SCREEN:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE_MINUS_DST_COLOR;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case%20pc.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=pc.BLENDMODE_DST_COLOR,this.blendDst=pc.BLENDMODE_ZERO,this.blendEquation=pc.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=function(a){a.name=%20this.name;a.id=f++;a.shader=null;a.variants={};a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var%20a=new%20pc.Material;this._cloneInternal(a);return%20a};a.prototype._updateMeshInstanceKeys=%20function(){var%20a,d=this.meshInstances;for(a=0;a%3Cd.length;a++)d[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return%20this.parameters};a.prototype.clearVariants=function(){this.variants={};for(i=0;i%3Cthis.meshInstances.length;i++)this.meshInstances[i]._shader=null};a.prototype.getParameter=function(a){return%20this.parameters[a]};a.prototype.setParameter=function(a,d){var%20e;if(void%200===d){if(a.length){for(e=%200;e%3Ca.length;e++)this.setParameter(a[e]);return}e=a.name;d=a.value}else%20e=a;var%20g=this.parameters[e];g?g.data=d:this.parameters[e]={scopeId:null,data:d}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete%20this.parameters[a]};a.prototype.setParameters=function(){for(var%20a%20in%20this.parameters){var%20d=this.parameters[a];d.scopeId||(d.scopeId=device.scope.resolve(a));d.scopeId.setValue(d.data)}};a.prototype.update=function(){throw%20Error(%22Not%20Implemented%20in%20base%20class%22);};a.prototype.init=%20function(){throw%20Error(%22Not%20Implemented%20in%20base%20class%22);};a.prototype.getName=function(){return%20this.name};a.prototype.setName=function(a){this.name=a};a.prototype.getShader=function(){return%20this.shader};a.prototype.setShader=function(a){this.shader=a};return{Material:a}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.color=new%20pc.Color(1,1,1,1);this.colorMap=null;this.vertexColors=!1;this.update()},pc.Material);pc.extend(f.prototype,{clone:function(){var%20a=new%20pc.BasicMaterial;pc.Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.vertexColors=this.vertexColors;a.update();return%20a},update:function(){this.clearParameters();this.setParameter(%22uColor%22,this.color.data);this.colorMap&&this.setParameter(%22texture_diffuseMap%22,%20this.colorMap)},updateShader:function(a){var%20b={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap};this.shader=a.getProgramLibrary().getProgram(%22basic%22,b)}});return{BasicMaterial:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){},pc.Material);pc.extend(f.prototype,{clone:function(){var%20a=new%20pc.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return%20a},update:function(){},updateShader:function(a){var%20b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram(%22depth%22,b)}});return{DepthMaterial:f}}());pc.extend(pc,function(){new%20pc.Vec3;new%20pc.Vec3;var%20f=function(){this.reset();this.update()},a=[],b=[],d=[],e=[],g={},h=function(b,e,h,k){var%20r=%22_%22+e+%22Map%22,l=r+%22Tiling%22,n=r+%22Offset%22,m=r.substring(1)+%22Transform%22,u=r+%22Uv%22,E=r+%22Channel%22,G=r+%22VertexColor%22;b[r]=null;b[l]=new%20pc.Vec2(1,1);b[n]=new%20pc.Vec2(0,0);b[m]=null;b[u]=h;0%3Ck&&(b[E]=1%3Ck?%22rgb%22:%22g%22);b[G]=!1;pc._matTex2D||(pc._matTex2D=[]);pc._matTex2D[e]=k;Object.defineProperty(f.prototype,r.substring(1),{get:function(){return%20this[r]},set:function(a){var%20b=%20this[r];if(!b&&a||b&&!a)this.dirtyShader=!0;if(b&&a&&(b.rgbm!==a.rgbm||b.fixCubemapSeams!==a.fixCubemapSeams||b.format!==a.format))this.dirtyShader=!0;this[r]=a}});b=l.substring(1);e=n.substring(1);Object.defineProperty(f.prototype,b,{get:function(){this.dirtyShader=!0;return%20this[l]},set:function(a){this.dirtyShader=!0;this[l]=a}});g[b]=function(a,b,d){a=a._updateMapTransform(d?a[m]:null,b,a[n]);return{name:%22texture_%22+m,value:a.data}};Object.defineProperty(f.prototype,e,{get:function(){this.dirtyShader=%20!0;return%20this[n]},set:function(a){this.dirtyShader=!0;this[n]=a}});g[e]=function(a,b,d){a=a._updateMapTransform(d?a[m]:null,a[l],b);return{name:%22texture_%22+m,value:a.data}};Object.defineProperty(f.prototype,u.substring(1),{get:function(){return%20this[u]},set:function(a){this.dirtyShader=!0;this[u]=a}});Object.defineProperty(f.prototype,E.substring(1),{get:function(){return%20this[E]},set:function(a){this.dirtyShader=!0;this[E]=a}});Object.defineProperty(f.prototype,G.substring(1),{get:function(){return%20this[G]},%20set:function(a){this.dirtyShader=!0;this[G]=a}});a.push(r.substring(1));a.push(l.substring(1));a.push(n.substring(1));a.push(u.substring(1));a.push(E.substring(1));a.push(G.substring(1));d.push(m)},k=[],n=function(b,d,h,r){var%20l=%22_%22+d,n=d+%22Uniform%22,m=d+%22Intensity%22,u=%22_%22+m;b[l]=h;b[n]=new%20Float32Array(3);Object.defineProperty(f.prototype,d,{get:function(){this.dirtyShader=this.dirtyColor=!0;return%20this[l]},set:function(a){var%20b=this[l],d=0===a.r&&0===a.g&&0===a.b||1===a.r&&1===a.g&&1===a.b;if(0===%20b.r&&0===b.g&&0===b.b||1===b.r&&1===b.g&&1===b.b||d)this.dirtyShader=!0;this.dirtyColor=!0;this[l]=a}});a.push(d);e.push(n);k.push(d);g[d]=function(a,b,e){for(var%20e=e?a[n]:new%20Float32Array(3),g=a._scene||pc.Application.getApplication().scene,f=0;3%3Ef;f++)e[f]=g.gammaCorrection?Math.pow(b.data[f],2.2):b.data[f],r&&(e[f]*=a[u]);return{name:%22material_%22+d,value:e}};r&&(b[u]=1,Object.defineProperty(f.prototype,m,{get:function(){return%20this[u]},set:function(a){var%20b=this[u];if(0===b||1===b||0===a||1===a)this.dirtyShader=%20!0;this.dirtyColor=!0;this[u]=a}}),a.push(m),g[m]=function(a,b,e){for(var%20b=e?a[n]:new%20Float32Array(3),e=a._scene||pc.Application.getApplication().scene,g=0;3%3Eg;g++)b[g]=e.gammaCorrection?Math.pow(a[l].data[g],2.2):a[l].data[g],b[g]*=a[u];return{name:%22material_%22+d,value:b}})},r=function(b,d,e,h){var%20k=%22_%22+d;b[k]=e;Object.defineProperty(f.prototype,d,{get:function(){return%20this[k]},set:function(a){var%20b=this[k];if(0===b||1===b||0===a||1===a)this.dirtyShader=!0;this[k]=a}});a.push(d);g[d]=void%200!==%20h?h:function(a,b){return{name:%22material_%22+d,value:b}}},u=function(b,d,e){var%20h=%22_%22+d;b[h]=null;Object.defineProperty(f.prototype,d,{get:function(){return%20this[h]},set:function(a){var%20b=this[h];if(!b&&a||b&&!a)this.dirtyShader=!0;this[h]=a}});a.push(d);g[d]=e},l=function(b,d,e){var%20g=%22_%22+d;b[g]=e;Object.defineProperty(f.prototype,d,{get:function(){return%20this[g]},set:function(a){this.dirtyShader=!0;this[g]=a}});a.push(d)},f=pc.inherits(f,pc.Material);pc.extend(f.prototype,{reset:function(){this.blendType=%20pc.BLEND_NONE;var%20g;for(g=0;g%3Ca.length;g++){var%20f=b[g];this[a[g]]=f?f.clone?f.clone():f:f}for(g=0;g%3Cd.length;g++)this[d[g]]=null;for(g=0;g%3Ce.length;g++)this[e[g]]=new%20Float32Array(3);this._chunks={};this._chunks.copy=function(a){for(var%20b%20in%20a)a.hasOwnProperty(b)&&%22copy%22!==b&&(this[b]=a[b])};this.cubeMapMinUniform=new%20Float32Array(3);this.cubeMapMaxUniform=new%20Float32Array(3)},clone:function(){var%20b=new%20pc.PhongMaterial;pc.Material.prototype._cloneInternal.call(this,b);for(var%20d,e=0;e%3Ca.length;e++)d=%20a[e],void%200!==this[d]&&(this[d]&&this[d].copy?b[d]?b[d].copy(this[d]):b[d]=this[d].clone():b[d]=this[d]);b.update();return%20b},init:function(a){this.reset();this.name=a.name;for(var%20b=0;b%3Ca.parameters.length;b++){var%20d=a.parameters[b];if(%22vec3%22===d.type)this[d.name]=new%20pc.Color(d.data[0],d.data[1],d.data[2]);else%20if(%22vec2%22===d.type)this[d.name]=new%20pc.Vec2(d.data[0],d.data[1]);else%20if(%22texture%22===d.type){var%20e=d.name;d=d.data?d.data%20instanceof%20pc.Texture?d.data:null:null;this[e]=d}else%22cubemap%22===%20d.type?(e=d.name,d=d.data&&d.data%20instanceof%20pc.Texture?d.data:null,this[e]=d):%22bumpMapFactor%22===d.name?this.bumpiness=d.data:this[d.name]=d.data}this.update()},_updateMapTransform:function(a,b,d){a=a||new%20pc.Vec4;a.set(b.x,b.y,d.x,d.y);return%201===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_collectLights:function(a,b,d,e){for(var%20g=0;g%3Cb.length;g++)b[g].getEnabled()&&b[g].mask&e&&b[g].getType()==a&&d.push(b[g])},_updateMap:function(a){a+=%22Map%22;if(this[a]){this.setParameter(%22texture_%22+a,this[a]);var%20b=%20a+%22Transform%22;this[b]=this._updateMapTransform(this[b],this[a+%22Tiling%22],this[a+%22Offset%22]);this[b]&&this.setParameter(%22texture_%22+b,this[b].data)}},getUniform:function(a,b,d){return(a=g[a])?a(this,b,d):null},update:function(){this.clearParameters();this.setParameter(%22material_ambient%22,this.ambientUniform);(!this.diffuseMap||this.diffuseMapTint)&&this.setParameter(%22material_diffuse%22,this.diffuseUniform);this.useMetalness?(!this.metalnessMap||1%3Ethis.metalness)&&this.setParameter(%22material_metalness%22,%20this.metalness):(!this.specularMap||this.specularMapTint)&&this.setParameter(%22material_specular%22,this.specularUniform);this.setParameter(this.getUniform(%22shininess%22,this.shininess,!0));(!this.emissiveMap||this.emissiveMapTint)&&this.setParameter(%22material_emissive%22,this.emissiveUniform);0%3Cthis.refraction&&(this.setParameter(%22material_refraction%22,this.refraction),this.setParameter(%22material_refractionIndex%22,this.refractionIndex));this.setParameter(%22material_opacity%22,this.opacity);this.occludeSpecular&&%20this.setParameter(%22material_occludeSpecularIntensity%22,this.occludeSpecularIntensity);this.cubeMapProjection===pc.CUBEPROJ_BOX&&this.setParameter(this.getUniform(%22cubeMapProjectionBox%22,this.cubeMapProjectionBox,!0));for(var%20a%20in%20pc._matTex2D)this._updateMap(a);this.ambientSH&&this.setParameter(%22ambientSH[0]%22,this.ambientSH);this.normalMap&&this.setParameter(%22material_bumpiness%22,this.bumpiness);this.heightMap&&this.setParameter(this.getUniform(%22heightMapFactor%22,this.heightMapFactor,!0));this.cubeMap&&%20this.setParameter(%22texture_cubeMap%22,this.cubeMap);this.prefilteredCubeMap128&&this.setParameter(%22texture_prefilteredCubeMap128%22,this.prefilteredCubeMap128);this.prefilteredCubeMap64&&this.setParameter(%22texture_prefilteredCubeMap64%22,this.prefilteredCubeMap64);this.prefilteredCubeMap32&&this.setParameter(%22texture_prefilteredCubeMap32%22,this.prefilteredCubeMap32);this.prefilteredCubeMap16&&this.setParameter(%22texture_prefilteredCubeMap16%22,this.prefilteredCubeMap16);this.prefilteredCubeMap8&&this.setParameter(%22texture_prefilteredCubeMap8%22,%20this.prefilteredCubeMap8);this.prefilteredCubeMap4&&this.setParameter(%22texture_prefilteredCubeMap4%22,this.prefilteredCubeMap4);this.sphereMap&&this.setParameter(%22texture_sphereMap%22,this.sphereMap);this.dpAtlas&&this.setParameter(%22texture_sphereMap%22,this.dpAtlas);this.setParameter(%22material_reflectivity%22,this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()},_processColor:function(){if(this._scene&&this.dirtyColor){for(i=0;i%3Ck.length;i++){var%20a=%20this[%22_%22+k[i]],b=this[k[i]+%22Uniform%22];for(c=0;3%3Ec;c++)b[c]=this._scene.gammaCorrection?Math.pow(a.data[c],2.2):a.data[c]}for(c=0;3%3Ec;c++)this.emissiveUniform[c]*=this.emissiveIntensity;this.dirtyColor=!1}},_getMapTransformID:function(a,b){if(!a)return%200;this._mapXForms[b]||(this._mapXForms[b]=[]);var%20d,e,g;for(d=0;d%3Cthis._mapXForms[b].length;d++){g=!0;for(e=0;e%3Ca.data.length;e++)if(this._mapXForms[b][d][e]!=a.data[e]){g=!1;break}if(g)return%20d+1}d=this._mapXForms[b].length;this._mapXForms[b][d]=[];%20for(e=0;e%3Ca.data.length;e++)this._mapXForms[b][d][e]=a.data[e];return%20d+1},updateShader:function(a,b,d){this._scene||(this._scene=b,this._processColor());var%20e=b._lights;this._mapXForms=[];var%20g=a.useTexCubeLod,f=!a.extTextureLod,h=this.prefilteredCubeMap128||b.skyboxPrefiltered128,k=this.prefilteredCubeMap64||b.skyboxPrefiltered64,r=this.prefilteredCubeMap32||b.skyboxPrefiltered32,l=this.prefilteredCubeMap16||b.skyboxPrefiltered16,n=this.prefilteredCubeMap8||b.skyboxPrefiltered8,m=this.prefilteredCubeMap4||%20b.skyboxPrefiltered4;if(h){var%20u=h&&k&&r&&l&&n&&m;f&&u?(h.dpAtlas||(h.dpAtlas=pc.generateDpAtlas(a,[h,k,r,l,n,m]),h.sh=pc.shFromCubemap(l)),this.dpAtlas=h.dpAtlas,this.ambientSH=h.sh,this.setParameter(%22ambientSH[0]%22,this.ambientSH),this.setParameter(%22texture_sphereMap%22,this.dpAtlas)):g?6%3Eh._levels.length?u?this.setParameter(%22texture_prefilteredCubeMap128%22,h):console.log(%22Can't%20use%20prefiltered%20cubemap:%20%22+u+%22,%20%22+g+%22,%20%22+h._levels):this.setParameter(%22texture_prefilteredCubeMap128%22,h):u?(this.setParameter(%22texture_prefilteredCubeMap128%22,%20h),this.setParameter(%22texture_prefilteredCubeMap64%22,k),this.setParameter(%22texture_prefilteredCubeMap32%22,r),this.setParameter(%22texture_prefilteredCubeMap16%22,l),this.setParameter(%22texture_prefilteredCubeMap8%22,n),this.setParameter(%22texture_prefilteredCubeMap4%22,m)):console.log(%22Can't%20use%20prefiltered%20cubemap:%20%22+u+%22,%20%22+g+%22,%20%22+h._levels)}f=!1;(k=(k=(this.useMetalness?!0:!!this.specularMap)||!!this.sphereMap||!!this.cubeMap||!!this.dpAtlas)||(this.useMetalness?!0:!(0===this.specular.r&&0===this.specular.g&&%200===this.specular.b)))&&this.specularMapTint&&!this.useMetalness&&(f=1!==this.specular.r||1!==this.specular.g||1!==this.specular.b);r=(h?h.rgbm:!1)||(this.cubeMap?this.cubeMap.rgbm:!1)||(this.sphereMap?this.sphereMap.rgbm:!1)||(this.dpAtlas?this.dpAtlas.rgbm:!1);b={fog:this.noFog?%22none%22:b.fog,gamma:b.gammaCorrection,toneMap:b.toneMapping,blendMapsWithColors:!0,modulateAmbient:this.ambientTint,diffuseTint:(1!=this.diffuse.r||1!=this.diffuse.g||1!=this.diffuse.b)&&this.diffuseMapTint,specularTint:f,%20metalnessTint:this.useMetalness&&1%3Ethis.metalness,glossTint:!0,emissiveTint:(1!=this.emissive.r||1!=this.emissive.g||1!=this.emissive.b||1!=this.emissiveIntensity)&&this.emissiveMapTint,opacityTint:1!=this.opacity&&this.blendType!==pc.BLEND_NONE,alphaTest:0%3Cthis.alphaTest,needsNormalFloat:this.normalizeNormalMap,sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap,dpAtlas:!!this.dpAtlas,ambientSH:!!this.ambientSH,useSpecular:k,rgbmReflection:r,hdrReflection:(h?h.rgbm||h.format===pc.PIXELFORMAT_RGBA32F:%20!1)||(this.cubeMap?this.cubeMap.rgbm||this.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.sphereMap?this.sphereMap.rgbm||this.sphereMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.dpAtlas?this.dpAtlas.rgbm||this.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:!1),fixSeams:h?h.fixCubemapSeams:this.cubeMap?this.cubeMap.fixCubemapSeams:!1,prefilteredCubemap:!!h,emissiveFormat:this.emissiveMap?this.emissiveMap.rgbm?1:this.emissiveMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,lightMapFormat:this.lightMap?this.lightMap.rgbm?%201:this.lightMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,useRgbm:r||(this.emissiveMap?this.emissiveMap.rgbm:0)||(this.lightMap?this.lightMap.rgbm:0),specularAA:this.specularAntialias,conserveEnergy:this.conserveEnergy,occludeSpecular:this.occludeSpecular,occludeSpecularFloat:1!==this.occludeSpecularIntensity,occludeDirect:this.occludeDirect,shadingModel:this.shadingModel,fresnelModel:this.fresnelModel,packedNormal:this.normalMap?this.normalMap.format===pc.PIXELFORMAT_DXT5:!1,shadowSampleType:this.shadowSampleType,%20forceFragmentPrecision:this.forceFragmentPrecision,fastTbn:this.fastTbn,cubeMapProjection:this.cubeMapProjection,chunks:this.chunks,customFragmentShader:this.customFragmentShader,refraction:!!this.refraction,useMetalness:this.useMetalness,blendType:this.blendType,skyboxIntensity:h===b.skyboxPrefiltered128&&h&&1!==b.skyboxIntensity,forceUv1:this.forceUv1,useTexCubeLod:g};f=h=g=!1;d&&(b.noShadow=0!==(d&pc.SHADERDEF_NOSHADOW),b.skin=0!==(d&pc.SHADERDEF_SKIN),b.useInstancing=0!==(d&pc.SHADERDEF_INSTANCING),%200!==(d&pc.SHADERDEF_LM)&&(b.lightMapFormat=1,b.lightMap=!0,b.lightMapChannel=%22rgb%22,b.lightMapUv=1,b.lightMapTransform=0,b.lightMapWithoutAmbient=!0,b.useRgbm=!0),g=0!==(d&pc.SHADERDEF_UV0),h=0!==(d&pc.SHADERDEF_UV1),f=0!==(d&pc.SHADERDEF_VCOLOR));for(var%20P%20in%20pc._matTex2D)%22opacity%22===P&&this.blendType===pc.BLEND_NONE&&0===this.alphaTest||(k=P+%22Map%22,r=k+%22VertexColor%22,%22height%22!==P&&this[r]?f&&(k+=%22Channel%22,b[r]=this[r],b[k]=this[k],b.vertexColors=!0):this[k]&&(r=k+%22Uv%22,l=!0,0===this[r]&&!g&&(l=!1),%201===this[r]&&!h&&(l=!1),l&&(b[k]=!!this[k],l=k+%22Transform%22,k+=%22Channel%22,b[l]=this._getMapTransformID(this[l],this[r]),b[k]=this[k],b[r]=this[r])));b.aoMapUv=b.aoMapUv||this.aoUvSet;this._mapXForms=null;P=[];g=d?d%3E%3E8:1;this._collectLights(pc.LIGHTTYPE_DIRECTIONAL,e,P,g);this._collectLights(pc.LIGHTTYPE_POINT,e,P,g);this._collectLights(pc.LIGHTTYPE_SPOT,e,P,g);b.lights=P;this.shader=a.getProgramLibrary().getProgram(%22phong%22,b);d||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});%20var%20m=f.prototype;m.dirtyShader=!0;m.dirtyColor=!0;m._scene=null;n(m,%22ambient%22,new%20pc.Color(0.7,0.7,0.7));n(m,%22diffuse%22,new%20pc.Color(1,1,1));n(m,%22specular%22,new%20pc.Color(0,0,0));n(m,%22emissive%22,new%20pc.Color(0,0,0),!0);r(m,%22shininess%22,25,function(a,b){return{name:%22material_shininess%22,value:a.shadingModel===pc.SPECULAR_PHONG?Math.pow(2,0.11*b):0.01*b}});r(m,%22heightMapFactor%22,1,function(a,b){return{name:%22material_heightMapFactor%22,value:0.025*b}});r(m,%22opacity%22,1);r(m,%22alphaTest%22,0);r(m,%22bumpiness%22,1);%20r(m,%22reflectivity%22,1);r(m,%22occludeSpecularIntensity%22,1);r(m,%22refraction%22,0);r(m,%22refractionIndex%22,1/1.5);r(m,%22metalness%22,1);r(m,%22aoUvSet%22,0,null);u(m,%22ambientSH%22,function(a,b){return{name:%22ambientSH[0]%22,value:b}});u(m,%22cubeMapProjectionBox%22,function(a,b,d){var%20e=d?a.cubeMapMinUniform:new%20Float32Array(3),a=d?a.cubeMapMaxUniform:new%20Float32Array(3);e[0]=b.center.x-b.halfExtents.x;e[1]=b.center.y-b.halfExtents.y;e[2]=b.center.z-b.halfExtents.z;a[0]=b.center.x+b.halfExtents.x;a[1]=b.center.y+b.halfExtents.y;%20a[2]=b.center.z+b.halfExtents.z;return[{name:%22envBoxMin%22,value:e},{name:%22envBoxMax%22,value:a}]});(function(){this._chunks=null;Object.defineProperty(f.prototype,%22chunks%22,{get:function(){this.dirtyShader=!0;return%20this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});a.push(%22chunks%22)})(m);l(m,%22ambientTint%22,!1);l(m,%22diffuseMapTint%22,!1);l(m,%22specularMapTint%22,!1);l(m,%22emissiveMapTint%22,!1);l(m,%22fastTbn%22,!1);l(m,%22specularAntialias%22,!1);l(m,%22useMetalness%22,!1);l(m,%22occludeDirect%22,!1);l(m,%22normalizeNormalMap%22,%20!0);l(m,%22conserveEnergy%22,!0);l(m,%22occludeSpecular%22,pc.SPECOCC_AO);l(m,%22shadingModel%22,pc.SPECULAR_PHONG);l(m,%22fresnelModel%22,pc.FRESNEL_NONE);l(m,%22cubeMapProjection%22,pc.CUBEPROJ_NONE);l(m,%22shadowSampleType%22,pc.SHADOWSAMPLE_PCF3X3);l(m,%22customFragmentShader%22,null);l(m,%22forceFragmentPrecision%22,null);l(m,%22noFog%22,!1);l(m,%22forceUv1%22,!1);h(m,%22diffuse%22,0,3);h(m,%22specular%22,0,3);h(m,%22emissive%22,0,3);h(m,%22normal%22,0,-1);h(m,%22metalness%22,0,1);h(m,%22gloss%22,0,1);h(m,%22opacity%22,0,1);h(m,%22height%22,0,1);h(m,%22ao%22,0,1);h(m,%20%22light%22,1,3);u(m,%22cubeMap%22);u(m,%22sphereMap%22);u(m,%22dpAtlas%22);u(m,%22prefilteredCubeMap128%22);u(m,%22prefilteredCubeMap64%22);u(m,%22prefilteredCubeMap32%22);u(m,%22prefilteredCubeMap16%22);u(m,%22prefilteredCubeMap8%22);u(m,%22prefilteredCubeMap4%22);for(h=0;h%3Ca.length;h++)b[h]=m[a[h]];return{PhongMaterial:f}}());pc.extend(pc,function(){function%20f(a,b,g,f){return(a&7)%3C%3C28|(b&3)%3C%3C26|(g?1:0)%3C%3C25|(f&33554431)%3C%3C0}var%20a=function(a,b,g){this.buffer=new%20Float32Array(a*(g||16));this.count=a;this.usage=b?pc.BUFFER_DYNAMIC:pc.BUFFER_STATIC;this._buffer=null};a.prototype={update:function(){this._buffer&&this._buffer.setData(this.buffer)}};var%20b=function(a,b,g){this.node=a;this.mesh=b;this.material=g;this._shader=null;this._shaderDefs=256;this._shaderDefs|=b.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0;this._shaderDefs|=%20b.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0;this.layer=pc.LAYER_WORLD;this.renderStyle=pc.RENDERSTYLE_SOLID;this.castShadow=!1;this.pick=this.cull=this.drawToDepth=this._receiveShadow=!0;this.key=0;this.updateKey();this._skinInstance=null;this.aabb=new%20pc.BoundingBox;this.normalMatrix=new%20pc.Mat3;this._boneAabb=null;this.parameters={}};Object.defineProperty(b.prototype,%22aabb%22,{get:function(){if(this.skinInstance){var%20a=this.mesh.skin.boneNames.length,%20b;if(!this.mesh.boneAabb){this.mesh.boneAabb=[];this.mesh.boneUsed=[];var%20g=this.mesh.vertexBuffer.format.elements,f=this.mesh.vertexBuffer.numVertices,k=this.mesh.vertexBuffer.format.size,n,r,u,l,m;for(b=0;b%3Cg.length;b++)g[b].name===pc.SEMANTIC_POSITION?n=g[b].offset:g[b].name===pc.SEMANTIC_BLENDINDICES?r=g[b].offset:g[b].name===pc.SEMANTIC_BLENDWEIGHT&&(u=g[b].offset);var%20g=new%20Uint8Array(this.mesh.vertexBuffer.storage),w=new%20Float32Array(this.mesh.vertexBuffer.storage);n/=4;var%20s=u/4,D=k/4,y,x,%20A,C,B;u=[];var%20z=[],E=this.mesh.boneUsed;for(b=0;b%3Ca;b++)u[b]=new%20pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),z[b]=new%20pc.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(l=0;l%3Cf;l++)for(m=0;4%3Em;m++)0%3Cw[l*D+s+m]&&(b=g[l*k+r+m],A=w[l*D+n],C=w[l*D+n+1],B=w[l*D+n+2],y=z[b],x=u[b],x.x%3EA&&(x.x=A),x.y%3EC&&(x.y=C),x.z%3EB&&(x.z=B),y.x%3CA&&(y.x=A),y.y%3CC&&(y.y=C),y.z%3CB&&(y.z=B),E[b]=!0);for(b=0;b%3Ca;b++)f=new%20pc.BoundingBox,f.setMinMax(u[b],z[b]),this.mesh.boneAabb.push(f)}if(!this._boneAabb){this._boneAabb=%20[];for(b=0;b%3Cthis.mesh.boneAabb.length;b++)this._boneAabb[b]=new%20pc.BoundingBox}E=this.mesh.boneUsed;for(b=0;b%3Cthis.mesh.boneAabb.length;b++)E[b]&&(this._boneAabb[b].setFromTransformedAabb(this.mesh.boneAabb[b],this.skinInstance.matrices[b]),this._boneAabb[b].center.add(this.skinInstance.rootNode.getPosition()));a=!0;for(b=0;b%3Cthis.mesh.boneAabb.length;b++)E[b]&&(a?(this._aabb.center.copy(this._boneAabb[b].center),this._aabb.halfExtents.copy(this._boneAabb[b].halfExtents),a=!1):this._aabb.add(this._boneAabb[b]))}else%20this._aabb.setFromTransformedAabb(this.mesh.aabb,%20this.node.worldTransform);return%20this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(b.prototype,%22material%22,{get:function(){return%20this._material},set:function(a){this._shader=null;if(this._material){var%20b=this._material.meshInstances,g=b.indexOf(this);-1!==g&&b.splice(g,1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(b.prototype,%22layer%22,{get:function(){return%20this._layer},set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(b.prototype,%20%22receiveShadow%22,{get:function(){return%20this._receiveShadow},set:function(a){this._shaderDefs=(this._receiveShadow=a)?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW;this._shader=null}});Object.defineProperty(b.prototype,%22skinInstance%22,{get:function(){return%20this._skinInstance},set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;this._shader=null}});Object.defineProperty(b.prototype,%22mask%22,{get:function(){return%20this._shaderDefs%3E%3E%208},set:function(a){this._shaderDefs=this._shaderDefs&255|a%3C%3C8;this._shader=null}});pc.extend(b.prototype,{syncAabb:function(){},updateKey:function(){var%20a=this.material;this.key=f(this.layer,a.blendType,!1,a.id)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});%20return{Command:function(a,b,g){this.key=f(a,b,!0,0);this.command=g},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new%20pc.BoundingBox;this.boneAabb=null},MeshInstance:b,InstancingData:a,_getDrawcallSortKey:f}}());pc.extend(pc,function(){var%20f=function(a,b){this.skin=a;this.rootNode=b;this.bones=[];var%20d=a.inverseBindPose.length,e=a.device;if(e.supportsBoneTextures){var%20g;g=256%3Cd?64:64%3Cd?32:16%3Cd?16:8;this.matrixPalette=new%20Float32Array(4*g*g);this.boneTexture=new%20pc.Texture(e,{width:g,height:g,format:pc.PIXELFORMAT_RGBA32F,autoMipmap:!1});this.boneTexture.minFilter=pc.FILTER_NEAREST;this.boneTexture.magFilter=pc.FILTER_NEAREST;this.matrixPalette=this.boneTexture.lock()}else%20this.matrixPalette=new%20Float32Array(16*%20d);this.matrices=[];for(e=0;e%3Cd;e++)this.matrices[e]=new%20pc.Mat4};f.prototype={updateMatrices:function(){for(var%20a=this.rootNode.getPosition(),b=this.bones.length-1;0%3C=b;b--)this.matrices[b].mul2(this.bones[b].getWorldTransform(),this.skin.inverseBindPose[b]),this.matrices[b].data[12]-=a.x,this.matrices[b].data[13]-=a.y,this.matrices[b].data[14]-=a.z},updateMatrixPalette:function(){for(var%20a,b=this.matrixPalette,d,e=this.bones.length-1;0%3C=e;e--)a=this.matrices[e].data,d=16*e,b[d]=a[0],b[d+1]=a[1],%20b[d+2]=a[2],b[d+3]=a[3],b[d+4]=a[4],b[d+5]=a[5],b[d+6]=a[6],b[d+7]=a[7],b[d+8]=a[8],b[d+9]=a[9],b[d+10]=a[10],b[d+11]=a[11],b[d+12]=a[12],b[d+13]=a[13],b[d+14]=a[14],b[d+15]=a[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,b,d){this.device=a;this.inverseBindPose=b;this.boneNames=d},SkinInstance:f}}());pc.extend(pc,function(){function%20f(){this.index=0;this.boneIndices=[0,0,0,0]}function%20a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,d,e){var%20g=-1;if(void%200!==this.indexMap[d])g=this.indexMap[d],this.indices.push(g);else{for(g=0;4%3Eg;g++)0!==e.blendWeight.data[4*d+g]&&(a.boneIndices[g]=this.getBoneRemap(e.blendIndices.data[4*a.index+g]));g=this.vertices.length;%20this.indices.push(g);this.vertices.push(a);this.indexMap[d]=g}},addPrimitive:function(a,d,e,g){var%20f,k,n=[],r=0,u=a.length;for(f=0;f%3Cu;f++)for(var%20l=a[f].index,m=0;4%3Em;m++)if(0%3Ce.blendWeight.data[4*l+m]){var%20w=e.blendIndices.data[4*l+m],s=!0;for(k=0;k%3Cr;k++)if(n[k]==w){s=!1;break}s&&(n[r]=w,k=this.getBoneRemap(w),r+=-1===k?1:0)}if(this.boneIndices.length+r%3Eg)return!1;for(f=0;f%3Cr;f++)this.boneIndices.push(n[f]);for(f=0;f%3Cu;f++)this.addVertex(a[f],d[f],e);return!0},getBoneRemap:function(a){for(var%20d=%200;d%3Cthis.boneIndices.length;d++)if(this.boneIndices[d]===a)return%20d;return-1}};return{partitionSkin:function(b,d,e){var%20g,h,k,n,r=b.vertices,u=b.skins,l=b.meshes,m=b.meshInstances;for(g=0;g%3Cl.length;g++)l[g].vertices=r[l[g].vertices],void%200!==l[g].skin&&(l[g].skin=u[l[g].skin]);for(g=0;g%3Cm.length;g++)m[g].mesh=l[m[g].mesh];var%20r=b.vertices,u=b.skins,w,l=b.meshes,m=b.meshInstances,s=function(a){var%20b=new%20f;b.index=a;return%20b};for(g=u.length-1;0%3C=g;g--)if(u[g].boneNames.length%3Ee){var%20D=u.splice(g,1)[0],%20y=[];for(h=0;h%3Cl.length;h++)l[h].skin===D&&y.push(l[h]);for(h=0;h%3Cy.length;h++)n=l.indexOf(y[h]),-1!==n&&l.splice(n,1);if(0===y.length)throw%20Error(%22partitionSkin:%20There%20should%20be%20at%20least%20one%20mesh%20that%20references%20a%20skin%22);var%20x=y[0].vertices;for(h=1;h%3Cy.length;h++)if(y[h].vertices!==x)throw%20Error(%22partitionSkin:%20All%20meshes%20that%20share%20a%20skin%20should%20also%20share%20the%20same%20vertex%20buffer%22);var%20A=[],C=[];k=[];var%20B=0;for(h=0;h%3Cy.length;h++){w=y[h];for(var%20z=w.indices,E=w.base;E%3Cw.base+w.count;){n=z[E++];%20C[0]=s(n);k[0]=n;n=z[E++];C[1]=s(n);k[1]=n;n=z[E++];C[2]=s(n);k[2]=n;for(var%20G=!1,R=B;R%3CA.length;R++)if(n=A[R],n.addPrimitive(C,k,x,e)){G=!0;break}G||(n=new%20a,n.originalMesh=w,n.addPrimitive(C,k,x,e),A.push(n))}B=A.length}w=[];y=[];for(h=0;h%3CA.length;h++)if(n=A[h],n.vertices.length&&n.indices.length){C=w.length;k=n.vertices.length;B=y.length;z=n.indices.length;n.partition=h;n.vertexStart=C;n.vertexCount=k;n.indexStart=B;n.indexCount=z;E=0;for(G=C;E%3Ck;)w[G++]=n.vertices[E++];E=0;for(G=B;E%3Cz;)y[G++]=%20n.indices[E++]+C}C=[];for(h=0;h%3CA.length;h++){n=A[h];B=[];z=[];for(k=0;k%3Cn.boneIndices.length;k++)B.push(D.inverseBindMatrices[n.boneIndices[k]]),z.push(D.boneNames[n.boneIndices[k]]);n={inverseBindMatrices:B,boneNames:z};C.push(n);u.push(n)}var%20I,D={};for(I%20in%20x)D[I]={components:x[I].components,data:[],type:x[I].type};for(I%20in%20x)if(%22blendIndices%22===I){n=D[I].data;for(h=0;h%3Cw.length;h++)k=w[h].boneIndices,n.push(k[0],k[1],k[2],k[3])}else{h=x[I];data=h.data;components=h.components;for(h=0;h%3Cw.length;h++){n=%20w[h].index;for(k=0;k%3Ccomponents;k++)D[I].data.push(data[n*components+k])}}r[r.indexOf(x)]=D;for(h=0;h%3CA.length;h++){n=A[h];w={aabb:{min:[0,0,0],max:[0,0,0]},vertices:D,skin:C[h],indices:y.splice(0,n.indexCount),type:%22triangles%22,base:0,count:n.indexCount};l.push(w);for(k=m.length-1;0%3C=k;k--)m[k].mesh===n.originalMesh&&(m.push({mesh:w,node:m[k].node}),d&&d.push({material:d[k].material,path:d[k].path}))}for(h=0;h%3CA.length;h++){n=A[h];for(k=m.length-1;0%3C=k;k--)m[k].mesh===n.originalMesh&&(m.splice(k,%201),d&&d.splice(k,1))}}d=b.vertices;e=b.skins;I=b.meshes;g=b.meshInstances;for(b=0;b%3CI.length;b++)I[b].vertices=d.indexOf(I[b].vertices),void%200!==I[b].skin&&(I[b].skin=e.indexOf(I[b].skin));for(b=0;b%3Cg.length;b++)g[b].mesh=I.indexOf(g[b].mesh)}}}());pc.extend(pc,function(){var%20f=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0};f.prototype={getGraph:function(){return%20this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return%20this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return%20this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var%20a,b=[];for(a=0;a%3Cthis.meshInstances.length;a++){var%20d=this.meshInstances[a];%20-1===b.indexOf(d.material)&&b.push(d.material)}return%20b},clone:function(){var%20a,b=[],d=[],e=function(a){var%20g=a.clone();b.push(a);d.push(g);for(var%20a=a.getChildren(),f=0;f%3Ca.length;f++)g.addChild(e(a[f]));return%20g},g=e(this.graph),f=[],k=[];for(a=0;a%3Cthis.skinInstances.length;a++){var%20n=this.skinInstances[a].skin,r=new%20pc.SkinInstance(n,g),u=[];for(j=0;j%3Cn.boneNames.length;j++){var%20l=g.findByName(n.boneNames[j]);u.push(l)}r.bones=u;k.push(r)}for(a=0;a%3Cthis.meshInstances.length;a++)n=this.meshInstances[a],%20r=b.indexOf(n.node),r=new%20pc.MeshInstance(d[r],n.mesh,n.material),n.skinInstance&&(n=this.skinInstances.indexOf(n.skinInstance),r.skinInstance=k[n]),f.push(r);a=new%20pc.Model;a.graph=g;a.meshInstances=f;a.skinInstances=k;a.getGraph().syncHierarchy();return%20a},generateWireframe:function(){var%20a,b,d,e,g,f,k,n,r,u,l=[];for(a=0;a%3Cthis.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===l.indexOf(f)&&l.push(f);var%20m=[[0,1],[1,2],[2,0]];for(a=0;a%3Cl.length;a++){f=l[a];k=f.primitive[pc.RENDERSTYLE_SOLID].base;%20n=f.primitive[pc.RENDERSTYLE_SOLID].count;r=f.indexBuffer[pc.RENDERSTYLE_SOLID];u=new%20Uint16Array(r.lock());var%20w={},s=[];for(b=k;b%3Ck+n;b+=3)for(d=0;3%3Ed;d++){e=u[b+m[d][0]];g=u[b+m[d][1]];var%20D=e%3Eg?g%3C%3C16|e:e%3C%3C16|g;void%200===w[D]&&(w[D]=0,s.push(e,g))}r.unlock();b=new%20pc.IndexBuffer(r.device,pc.INDEXFORMAT_UINT16,s.length);d=new%20Uint16Array(b.lock());d.set(s);b.unlock();f.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:s.length,indexed:!0};f.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=%20b}}};return{Model:f}}());pc.extend(pc,function(){function%20f(a){return%20Math.max(Math.min(a,1),0)}function%20a(a,b,d,e){var%20g,f,h;if(void%200===d||2%3Ed)return%20b*=a.length-1,g=a[Math.floor(b)],f=a[Math.ceil(b)],pc.math.lerp(g,f,b%1);b*=a.length/d-1;e||(e=[]);for(var%20k=0;k%3Cd;k++)g=a[Math.floor(b)*d+k],f=a[Math.ceil(b)*d+k],h=b%1,e[k]=pc.math.lerp(g,f,h);return%20e}function%20b(a,b){U[a]=void%200!==ba[a]&&null!==ba[a]?ba[a]:b}function%20d(a,b){for(var%20d=a.length/3,e=Array(4*d),g=0;g%3Cd;g++)e[4*g]=a[3*g],e[4*g+1]=a[3*g+1],e[4*g+2]=a[3*g+2],%20e[4*g+3]=(255*b[3*g]%3C%3C16|255*b[3*g+1]%3C%3C8|255*b[3*g+2])/16777216;return%20e}function%20e(a,b,d){for(var%20e=new%20Float32Array(b.length),g=0;g%3Cb.length;g++)e[g]=b[g]-a[g];for(var%20g=d.length,f=e.length/g,a=0;a%3Cf;a++)for(b=0;b%3Cg;b++){var%20h=Math.abs(e[a*g+b]);d[b]=Math.max(d[b],h)}a=d.length;f=e.length/a;for(b=0;b%3Cf;b++)for(g=0;g%3Ca;g++)e[b*a+g]/=d[g],e[b*a+g]*=0.5,e[b*a+g]+=0.5;return%20e}function%20g(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=%20a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var%20h=[[-1,-1],[1,-1],[1,1],[-1,1]],k=function(a,b,d,e,g,f){g||(g=pc.PIXELFORMAT_RGBA32F);a=new%20pc.Texture(a,{width:b,height:d,format:g,cubemap:!1,autoMipmap:!1});a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;b=a.lock();if(g==pc.PIXELFORMAT_R8_G8_B8_A8){a.minFilter=pc.FILTER_LINEAR;a.magFilter=pc.FILTER_LINEAR;g=new%20Uint8Array(e.length);for(d=%200;d%3Ce.length;d++)g[d]=255*e[d]*f;e=g}b.set(e);a.unlock();return%20a},n=new%20pc.Curve([0,0,1,0]),r=new%20pc.Curve([0,1,1,1]),u=new%20pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),l=new%20pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),m=null,w=new%20pc.Vec3,s=new%20pc.Vec3,D=new%20pc.Vec3,y=new%20pc.Vec3,x=new%20pc.Vec3,A=new%20pc.Vec3,C=new%20pc.Vec3,B=new%20pc.Vec3,z=new%20pc.Vec3,E=new%20pc.Mat4,G=new%20pc.Mat3,R=new%20pc.Mat3,I=1,P,Q=new%20pc.Mat4,M=new%20pc.Vec3,J=new%20pc.Vec3,N=new%20pc.Vec3;new%20pc.Vec3;var%20U,ba,F=function(a,d){this.graphicsDevice=%20a;this.precision=32;if(!m){var%20e=new%20Float32Array(1024),g,h,s,w;for(h=0;16%3Eh;h++)for(g=0;16%3Eg;g++)s=g+1-8.5,w=h+1-8.5,w=f(1-f(Math.sqrt(s*s+w*w)/16)-0.5),s=16*h+g,e[4*s]=1,e[4*s+1]=1,e[4*s+2]=1,e[4*s+3]=w;m=k(a,16,16,e,pc.PIXELFORMAT_R8_G8_B8_A8,1);m.minFilter=pc.FILTER_LINEAR;m.magFilter=pc.FILTER_LINEAR}U=this;ba=d;b(%22numParticles%22,1);b(%22rate%22,1);b(%22rate2%22,this.rate);b(%22lifetime%22,50);b(%22emitterExtents%22,new%20pc.Vec3(0,0,0));b(%22emitterRadius%22,0);b(%22emitterShape%22,pc.EMITTERSHAPE_BOX);b(%22initialVelocity%22,%201);b(%22wrap%22,!1);b(%22wrapBounds%22,null);b(%22colorMap%22,m);b(%22normalMap%22,null);b(%22loop%22,!0);b(%22preWarm%22,!1);b(%22sort%22,pc.PARTICLESORT_NONE);b(%22mode%22,pc.PARTICLEMODE_GPU);b(%22scene%22,null);b(%22lighting%22,!1);b(%22halfLambert%22,!1);b(%22intensity%22,1);b(%22stretch%22,0);b(%22alignToMotion%22,!1);b(%22depthSoftening%22,0);b(%22mesh%22,null);b(%22depthWrite%22,!1);b(%22noFog%22,!1);b(%22blendType%22,pc.BLEND_NORMAL);b(%22node%22,null);b(%22startAngle%22,0);b(%22startAngle2%22,this.startAngle);b(%22animTilesX%22,1);b(%22animTilesY%22,1);b(%22animNumFrames%22,1);b(%22animSpeed%22,%201);b(%22animLoop%22,!0);this.frameRandom=new%20pc.Vec3(0,0,0);b(%22colorGraph%22,l);b(%22colorGraph2%22,this.colorGraph);b(%22scaleGraph%22,r);b(%22scaleGraph2%22,this.scaleGraph);b(%22alphaGraph%22,r);b(%22alphaGraph2%22,this.alphaGraph);b(%22localVelocityGraph%22,u);b(%22localVelocityGraph2%22,this.localVelocityGraph);b(%22velocityGraph%22,u);b(%22velocityGraph2%22,this.velocityGraph);b(%22rotationSpeedGraph%22,n);b(%22rotationSpeedGraph2%22,this.rotationSpeedGraph);this.constantParticleTexIN=a.scope.resolve(%22particleTexIN%22);this.constantParticleTexOUT=%20a.scope.resolve(%22particleTexOUT%22);this.constantEmitterPos=a.scope.resolve(%22emitterPos%22);this.constantEmitterScale=a.scope.resolve(%22emitterScale%22);this.constantSpawnBounds=a.scope.resolve(%22spawnBounds%22);this.constantSpawnBoundsSphere=a.scope.resolve(%22spawnBoundsSphere%22);this.constantInitialVelocity=a.scope.resolve(%22initialVelocity%22);this.constantFrameRandom=a.scope.resolve(%22frameRandom%22);this.constantDelta=a.scope.resolve(%22delta%22);this.constantRate=a.scope.resolve(%22rate%22);this.constantRateDiv=a.scope.resolve(%22rateDiv%22);%20this.constantLifetime=a.scope.resolve(%22lifetime%22);this.constantLightCube=a.scope.resolve(%22lightCube[0]%22);this.constantGraphSampleSize=a.scope.resolve(%22graphSampleSize%22);this.constantGraphNumSamples=a.scope.resolve(%22graphNumSamples%22);this.constantInternalTex0=a.scope.resolve(%22internalTex0%22);this.constantInternalTex1=a.scope.resolve(%22internalTex1%22);this.constantInternalTex2=a.scope.resolve(%22internalTex2%22);this.constantEmitterMatrix=a.scope.resolve(%22emitterMatrix%22);this.constantNumParticles=a.scope.resolve(%22numParticles%22);%20this.constantNumParticlesPot=a.scope.resolve(%22numParticlesPot%22);this.constantLocalVelocityDivMult=a.scope.resolve(%22localVelocityDivMult%22);this.constantVelocityDivMult=a.scope.resolve(%22velocityDivMult%22);this.constantRotSpeedDivMult=a.scope.resolve(%22rotSpeedDivMult%22);this.constantSeed=a.scope.resolve(%22seed%22);this.constantStartAngle=a.scope.resolve(%22startAngle%22);this.constantStartAngle2=a.scope.resolve(%22startAngle2%22);this.lightCube=new%20Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=%20new%20pc.Vec3(-1,0,0);this.lightCubeDir[1]=new%20pc.Vec3(1,0,0);this.lightCubeDir[2]=new%20pc.Vec3(0,-1,0);this.lightCubeDir[3]=new%20pc.Vec3(0,1,0);this.lightCubeDir[4]=new%20pc.Vec3(0,0,-1);this.lightCubeDir[5]=new%20pc.Vec3(0,0,1);this.animParams=new%20pc.Vec4;this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=%20null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=0;this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTime=0;this.beenReset=!1;this.rebuild()};F.prototype={onChangeCamera:function(){0%3Cthis.depthSoftening&&this.camera&&this.camera.requestDepthMap();this.regenShader();this.resetMaterial()},rebuild:function(){var%20a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=m);this.spawnBounds=this.emitterShape===pc.EMITTERSHAPE_BOX?this.emitterExtents:%20this.emitterRadius;this.useCpu=this.useCpu||this.sort%3Epc.PARTICLESORT_NONE||!(b.extTextureFloat&&1%3C=b.maxVertexTextures&&b.extTextureFloatRenderable)||100%3Eb.fragmentUniformsCount;this.vertexBuffer=void%200;this.useMesh=!1;this.mesh&&(65535%3Cthis.numParticles*this.mesh.vertexBuffer.numVertices?console.warn(%22WARNING:%20particle%20system%20can't%20render%20mesh%20particles%20because%20numParticles%20*%20numVertices%20is%20more%20than%2065k.%20Reverting%20to%20quad%20particles.%22):this.useMesh=!0);this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);%20this.rebuildGraphs();this.vbToSort=Array(this.numParticles);this.particleDistance=new%20Float32Array(this.numParticles);this.frameRandom.x=Math.random();this.frameRandom.y=Math.random();this.frameRandom.z=Math.random();this.particleTex=new%20Float32Array(16*this.numParticlesPot);var%20d=null===this.node?pc.Vec3.ZERO:this.node.getPosition();this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.node?Q.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):Q.setTRS(pc.Vec3.ZERO,this.node.getRotation(),N.copy(this.spawnBounds).mul(this.node.getLocalScale())));%20for(a=0;a%3Cthis.numParticles;a++)this.calcSpawnPosition(d,a),this.particleTex[4*a+3+8*this.numParticlesPot]=1;this.particleTexStart=new%20Float32Array(16*this.numParticlesPot);for(a=0;a%3Cthis.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.particleTexIN=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexOUT=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexStart=k(b,this.numParticlesPot,4,this.particleTexStart),this.rtParticleTexIN=new%20pc.RenderTarget(b,%20this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new%20pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;var%20d=a.particleUpdaterInitPS+(this.emitterShape===pc.EMITTERSHAPE_BOX?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS,e=d+a.particleUpdaterNoRespawnPS+a.particleUpdaterEndPS,g=d+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,d+a.particleUpdaterRespawnPS+%20a.particleUpdaterEndPS,%22fsQuad0%22+this.emitterShape);this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,e,%22fsQuad1%22+this.emitterShape);this.shaderParticleUpdateOnStop=a.createShaderFromCode(b,a.fullscreenQuadVS,g,%22fsQuad2%22+this.emitterShape);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new%20pc.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=%20this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new%20pc.Material;this.material.cullMode=pc.CULLFACE_NONE;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();this.meshInstance=new%20pc.MeshInstance(this.node,b,this.material);%20this.meshInstance.updateKey();this.meshInstance.drawToDepth=!1;this._initializeTextures();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime);this.resetTime()},_isAnimated:function(){return%201%3C=this.animNumFrames&&(1%3Cthis.animTilesX||1%3Cthis.animTilesY)&&(this.colorMap&&this.colorMap!==m||this.normalMap)},calcSpawnPosition:function(a,b){var%20d=Math.random(),e=Math.random(),g=Math.random(),f=Math.random();this.particleTex[4*b+0+8*this.numParticlesPot]=d;this.particleTex[4*b+1+8*this.numParticlesPot]=%20e;this.particleTex[4*b+2+8*this.numParticlesPot]=g;M.data[0]=d-0.5;M.data[1]=e-0.5;M.data[2]=g-0.5;this.emitterShape===pc.EMITTERSHAPE_BOX?J.copy(a).add(Q.transformPoint(M)):(M.normalize(),J.copy(a).add(M.scale(f*this.spawnBounds)));this.particleTex[4*b]=J.data[0];this.particleTex[4*b+1]=J.data[1];this.particleTex[4*b+2]=J.data[2];this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,d);d=-pc.math.lerp(this.rate,this.rate2,d)*b;this.particleTex[4*%20b+3+4*this.numParticlesPot]=d},rebuildGraphs:function(){var%20a=this.precision,b=this.graphicsDevice,g;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);%20this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(g=0;g%3Ca;g++)this.qRotSpeed[g]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[g]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new%20pc.Vec3(0,0,0);this.velocityUMax=new%20pc.Vec3(0,0,0);this.colorUMax=new%20pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=e(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=%20e(this.qVelocity,this.qVelocity2,this.velocityUMax.data);this.qColorDiv=e(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=e(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=e(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=e(this.qAlpha,this.qAlpha2,this.alphaUMax);if(!this.useCpu){this.internalTex0=k(b,a,1,d(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=k(b,a,1,d(this.qVelocity,this.qVelocityDiv));g=this.qRotSpeed;for(var%20f=this.qScale,h=this.qScaleDiv,%20r=this.qRotSpeedDiv,l=this.qAlphaDiv,n=Array(4*g.length),m=0;m%3Cg.length;m++)n[4*m]=g[m],n[4*m+1]=f[m],n[4*m+2]=0,n[4*m+3]=(255*h[m]%3C%3C16|255*r[m]%3C%3C8|255*l[m])/16777216;this.internalTex2=k(b,a,1,n)}g=this.qColor;f=this.qAlpha;h=Array(4*f.length);for(r=0;r%3Cf.length;r++)h[4*r]=g[3*r],h[4*r+1]=g[3*r+1],h[4*r+2]=g[3*r+2],h[4*r+3]=f[r];this.internalTex3=k(b,a,1,h,pc.PIXELFORMAT_R8_G8_B8_A8,1)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter(%22colorMap%22,this.colorMap),this.lighting&&%20this.normalMap&&this.material.setParameter(%22normalMap%22,this.normalMap))},regenShader:function(){var%20a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());var%20b=a.getProgram(%22particle%22,{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,%20halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:%22none%22,wrap:this.emitter.wrap&&this.emitter.wrapBounds,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop});%20this.setShader(b)};this.material.updateShader()},resetMaterial:function(){var%20a=this.material;a.setParameter(%22stretch%22,this.stretch);this._isAnimated()&&a.setParameter(%22animTexParams%22,this.animParams.data);a.setParameter(%22colorMult%22,this.intensity);this.useCpu||(a.setParameter(%22internalTex0%22,this.internalTex0),a.setParameter(%22internalTex1%22,this.internalTex1),a.setParameter(%22internalTex2%22,this.internalTex2));a.setParameter(%22internalTex3%22,this.internalTex3);a.setParameter(%22numParticles%22,this.numParticles);%20a.setParameter(%22numParticlesPot%22,this.numParticlesPot);a.setParameter(%22lifetime%22,this.lifetime);a.setParameter(%22rate%22,this.rate);a.setParameter(%22rateDiv%22,this.rate2-this.rate);a.setParameter(%22seed%22,this.seed);a.setParameter(%22scaleDivMult%22,this.scaleUMax[0]);a.setParameter(%22alphaDivMult%22,this.alphaUMax[0]);a.setParameter(%22graphNumSamples%22,this.precision);a.setParameter(%22graphSampleSize%22,1/this.precision);a.setParameter(%22emitterScale%22,pc.Vec3.ONE.data);this.wrap&&this.wrapBounds&&a.setParameter(%22wrapBounds%22,%20this.wrapBounds.data);this.colorMap&&a.setParameter(%22colorMap%22,this.colorMap);this.lighting&&this.normalMap&&a.setParameter(%22normalMap%22,this.normalMap);0%3Cthis.depthSoftening&&a.setParameter(%22softening%22,1/(100*this.depthSoftening*this.depthSoftening));0%3Cthis.stretch&&(a.cull=pc.CULLFACE_NONE)},_allocate:function(a){var%20b=a*this.numParticleVerts,d=a*this.numParticleIndices,e;if(void%200===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){e=this.useCpu?[{semantic:pc.SEMANTIC_ATTR0,components:4,%20type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:2,type:pc.ELEMENTTYPE_FLOAT32}]:[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32}];e=new%20pc.VertexFormat(this.graphicsDevice,e);this.vertexBuffer=new%20pc.VertexBuffer(this.graphicsDevice,e,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new%20pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,%20d);e=new%20Float32Array(this.vertexBuffer.lock());var%20g,f;this.useMesh&&(g=new%20Float32Array(this.mesh.vertexBuffer.lock()),f=g.length/this.mesh.vertexBuffer.numVertices);for(d=0;d%3Cb;d++){id=Math.floor(d/this.numParticleVerts);if(this.useMesh){var%20k=d%this.numParticleVerts;e[4*d]=g[k*f];e[4*d+1]=g[k*f+1];e[4*d+2]=g[k*f+2]}else%20k=d%4,e[4*d]=h[k][0],e[4*d+1]=h[k][1],e[4*d+2]=0;e[4*d+3]=id}this.useCpu&&(this.vbCPU=new%20Float32Array(e),this.vbOld=new%20Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();%20this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;indices=new%20Uint16Array(this.indexBuffer.lock());this.useMesh&&(g=new%20Uint16Array(this.mesh.indexBuffer[0].lock()));for(d=0;d%3Ca;d++)if(this.useMesh)for(f=0;f%3Cthis.numParticleIndices;f++)indices[d*this.numParticleIndices+f]=g[f]+d*this.numParticleVerts;else%20f=4*d,indices[b++]=f,indices[b++]=f+1,indices[b++]=f+2,indices[b++]=f,indices[b++]=f+2,indices[b++]=f+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=%20!0;this.seed=Math.random();this.material.setParameter(%22seed%22,this.seed);if(this.useCpu)for(var%20a=0;a%3Cthis.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else%20this._initializeTextures();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){for(var%20b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision),a=a/b,d=0;d%3Cb;d++)this.addTime(a)},resetTime:function(){var%20a=Math.max(this.rate,%20this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},onEnableDepth:function(){0%3Cthis.depthSoftening&&this.camera&&this.camera.requestDepthMap()},onDisableDepth:function(){0%3Cthis.depthSoftening&&this.camera&&this.camera.releaseDepthMap()},addTime:function(b,d){var%20e,h,k=this.graphicsDevice;this._isAnimated()&&(e=this.animParams,e.x=1/this.animTilesX,e.y=1/this.animTilesY,e.z=this.animNumFrames*this.animSpeed,e.w=this.animNumFrames-1);if(this.lighting){if(!this.scene){console.error(%22There%20is%20no%20scene%20defined%20for%20lighting%20particles%22);%20return}for(e=0;6%3Ee;e++)this.lightCube[3*e]=this.scene.ambientLight.r,this.lightCube[3*e+1]=this.scene.ambientLight.g,this.lightCube[3*e+2]=this.scene.ambientLight.b;h=this.scene._globalLights;for(e=0;e%3Ch.length;e++)for(var%20r=0;6%3Er;r++){var%20l=Math.max(this.lightCubeDir[r].dot(h[e]._direction),0)*h[e]._intensity;this.lightCube[3*r]+=h[e]._color.r*l;this.lightCube[3*r+1]+=h[e]._color.g*l;this.lightCube[3*r+2]+=h[e]._color.b*l}this.constantLightCube.setValue(this.lightCube)}this.scene&&this.camera!=this.scene._activeCamera&&%20(this.camera=this.scene._activeCamera,this.onChangeCamera());this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.meshInstance.node?Q.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.emitterExtents):Q.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),N.copy(this.emitterExtents).mul(this.meshInstance.node.getLocalScale())));e=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.getLocalScale().data;this.material.setParameter(%22emitterScale%22,e);if(this.useCpu){k=new%20Float32Array(this.vertexBuffer.lock());%20if(this.meshInstance.node){e=this.meshInstance.node.worldTransform;for(h=0;12%3Eh;h++)E.data[h]=e.data[h];P=this.meshInstance.node.getLocalScale();I=Math.max(Math.max(P.x,P.y),P.z)}h=null===this.meshInstance.node?pc.Vec3.ZERO:this.meshInstance.node.getPosition();r=this.camera?this.camera._node.getPosition():pc.Vec3.ZERO;for(e=0;e%3Cthis.numParticles;e++){var%20l=Math.floor(this.vbCPU[4*e*this.numParticleVerts+3]),n=this.particleTex[4*l+0+8*this.numParticlesPot];x.x=n;x.y=this.particleTex[4*l+1+8*this.numParticlesPot];%20x.z=this.particleTex[4*l+2+8*this.numParticlesPot];var%20m=pc.math.lerp(this.rate,this.rate2,n),u=this.lifetime,F=this.particleTex[4*l+3+4*this.numParticlesPot]+b,J=f(F/u),U=0,$=0,V=0%3CF&&F%3Cu;if(V){s.data=a(this.qLocalVelocity,J,3,s.data);y.data=a(this.qLocalVelocity2,J,3,y.data);w.data=a(this.qVelocity,J,3,w.data);D.data=a(this.qVelocity2,J,3,D.data);var%20W=a(this.qRotSpeed,J),$=a(this.qRotSpeed2,J),U=a(this.qScale,J),aa=a(this.qScale2,J),Y=a(this.qAlpha,J),ba=a(this.qAlpha2,J);s.x=pc.math.lerp(s.x,%20y.x,x.x);s.y=pc.math.lerp(s.y,y.y,x.y);s.z=pc.math.lerp(s.z,y.z,x.z);0%3Cthis.initialVelocity&&(this.emitterShape===pc.EMITTERSHAPE_SPHERE?(M.copy(x).scale(2).sub(pc.Vec3.ONE).normalize(),s.add(M.scale(this.initialVelocity))):s.add(pc.Vec3.FORWARD.scale(this.initialVelocity)));w.x=pc.math.lerp(w.x,D.x,x.x);w.y=pc.math.lerp(w.y,D.y,x.y);w.z=pc.math.lerp(w.z,D.z,x.z);W=pc.math.lerp(W,$,x.y);U=pc.math.lerp(U,aa,1E4*n%1)*I;$=(ba-Y)*(1E3*n%1);this.meshInstance.node&&E.transformPoint(s,s);s.add(w.mul(P));%20z.copy(s);A.x=this.particleTex[4*l];A.y=this.particleTex[4*l+1];A.z=this.particleTex[4*l+2];C.copy(A).add(s.scale(b));B.copy(C);this.particleTex[4*l]=B.x;this.particleTex[4*l+1]=B.y;this.particleTex[4*l+2]=B.z;this.particleTex[4*l+3]+=W*b;this.wrap&&this.wrapBounds&&(B.sub(h),B.x=B.x-this.wrapBounds.x*Math.floor(B.x/this.wrapBounds.x)-0.5*this.wrapBounds.x,B.y=B.y-this.wrapBounds.y*Math.floor(B.y/this.wrapBounds.y)-0.5*this.wrapBounds.y,B.z=B.z-this.wrapBounds.z*Math.floor(B.z/this.wrapBounds.z)-%200.5*this.wrapBounds.z,B.add(h));0%3Cthis.sort&&(1===this.sort?(N.copy(B).sub(r),this.particleDistance[l]=-(N.x*N.x+N.y*N.y+N.z*N.z)):2===this.sort?this.particleDistance[l]=F:3===this.sort&&(this.particleDistance[l]=-F))}else%20this.calcSpawnPosition(h,l);d?0%3EF&&(this.particleTex[4*l+3+8*this.numParticlesPot]=-1):(F%3E=u&&(F-=Math.max(u,(this.numParticles-1)*m),this.particleTex[4*l+3+8*this.numParticlesPot]=this.loop?1:-1),0%3EF&&this.loop&&(this.particleTex[4*l+3+8*this.numParticlesPot]=1));0%3Ethis.particleTex[4*%20l+3+8*this.numParticlesPot]&&(V=!1);this.particleTex[4*l+3+4*this.numParticlesPot]=F;for(n=0;n%3Cthis.numParticleVerts;n++)m=this.vbCPU[4*e*this.numParticleVerts+4*n],u=this.vbCPU[4*e*this.numParticleVerts+4*n+1],F=this.vbCPU[4*e*this.numParticleVerts+4*n+2],V||(m=u=F=0),W=14*e*this.numParticleVerts+14*n,k[W]=B.x,k[W+1]=B.y,k[W+2]=B.z,k[W+3]=J,k[W+4]=this.alignToMotion?0:this.particleTex[4*l+3],k[W+5]=U,k[W+6]=$,k[W+7]=z.x,k[W+8]=m,k[W+9]=u,k[W+10]=F,k[W+11]=z.y,k[W+12]=z.z}if(this.sort%3Epc.PARTICLESORT_NONE&&%20this.camera){for(e=0;e%3Cthis.numParticles;e++)this.vbToSort[e]=[e,Math.floor(this.vbCPU[4*e*this.numParticleVerts+3])];for(e=0;e%3Cthis.vbCPU.length;e++)this.vbOld[e]=this.vbCPU[e];var%20ja=this.particleDistance;this.vbToSort.sort(function(a,b){return%20ja[a[1]]-ja[b[1]]});for(e=0;e%3Cthis.numParticles;e++){k=this.vbToSort[e][0];for(r=0;r%3Cthis.numParticleVerts;r++)for(h=0;4%3Eh;h++)this.vbCPU[4*e*this.numParticleVerts+4*r+h]=this.vbOld[4*k*this.numParticleVerts+4*r+h]}}this.vertexBuffer.unlock()}else%20k.setBlending(!1),%20k.setColorWrite(!0,!0,!0,!0),k.setCullMode(pc.CULLFACE_NONE),k.setDepthTest(!1),k.setDepthWrite(!1),this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),%20this.constantInternalTex2.setValue(this.internalTex2),h=null===this.meshInstance.node?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,r=null===this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),this.emitterShape===pc.EMITTERSHAPE_BOX?(g(Q,G),this.constantSpawnBounds.setValue(G.data)):this.constantSpawnBoundsSphere.setValue(this.emitterRadius),this.constantInitialVelocity.setValue(this.initialVelocity),g(r,R),this.constantEmitterPos.setValue(h),this.constantFrameRandom.setValue(this.frameRandom.data),%20this.constantDelta.setValue(b),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),this.constantLifetime.setValue(this.lifetime),this.constantEmitterScale.setValue(e),this.constantEmitterMatrix.setValue(R.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),%20this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),e=this.swapTex?this.particleTexOUT:this.particleTexIN,e=this.beenReset?this.particleTexStart:e,h=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(e),d?pc.drawQuadWithShader(k,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.shaderParticleUpdateOnStop):pc.drawQuadWithShader(k,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.loop?this.shaderParticleUpdateRespawn:this.shaderParticleUpdateNoRespawn),%20this.constantParticleTexOUT.setValue(h),this.material.setParameter(%22particleTexOUT%22,h),this.material.setParameter(%22particleTexIN%22,e),this.beenReset=!1,this.swapTex=!this.swapTex,k.setDepthTest(!0),k.setDepthWrite(!0);if(!this.loop&&this.onFinished&&Date.now()%3Ethis.endTime)this.onFinished()}};return{ParticleEmitter:F}}());pc.extend(pc,function(){function%20f(a,d){return%20d.key-a.key}var%20a=function(a,d,e){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram(%22pick%22,{skin:!1});this.pickProgSkin=a.getProgram(%22pick%22,{skin:!0});this.pickColor=new%20Float32Array(4);this.scene=null;this.drawCalls=[];this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.resize(d,e)};a.prototype.getSelection=function(a){var%20d=this.device;a.width=a.width||1;a.height=a.height||1;var%20e=d.getRenderTarget();%20d.setRenderTarget(this._pickBufferTarget);d.updateBegin();var%20g=new%20Uint8Array(4*a.width*a.height);d.readPixels(a.x,a.y,a.width,a.height,g);d.updateEnd();d.setRenderTarget(e);d=[];for(e=0;e%3Ca.width*a.height;e++){var%20f=g[4*e+0]%3C%3C16|g[4*e+1]%3C%3C8|g[4*e+2];16777215!==f&&(f=this.drawCalls[f],-1===d.indexOf(f)&&d.push(f))}return%20d};a.prototype.prepare=function(a,d){var%20e=this.device;this.scene=d;var%20g=e.getRenderTarget();e.setRenderTarget(this._pickBufferTarget);e.updateBegin();e.setViewport(0,0,this._pickBufferTarget.width,%20this._pickBufferTarget.height);e.setScissor(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);e.clear(this.clearOptions);var%20h,k,n,r,u;k=e.scope;var%20l=k.resolve(%22matrix_model%22),m=k.resolve(%22texture_poseMap%22),w=k.resolve(%22texture_poseMapSize%22),s=k.resolve(%22skinPosOffset%22),D=k.resolve(%22matrix_pose[0]%22),y=k.resolve(%22uColor%22);h=k.resolve(%22matrix_projection%22);k=k.resolve(%22matrix_viewProjection%22);r=a._node.getWorldTransform();n=a.getProjectionMatrix();r=r.clone().invert();u=new%20pc.Mat4;u.mul2(n,%20r);h.setValue(n.data);k.setValue(u.data);this.drawCalls=d.drawCalls.slice(0);this.drawCalls.sort(f);for(h=0;h%3Cthis.drawCalls.length;h++)if(this.drawCalls[h].command)this.drawCalls[h].command();else%20if(this.drawCalls[h].pick){n=this.drawCalls[h];k=n.mesh;r=n.material;u=k.primitive[pc.RENDERSTYLE_SOLID].type;var%20x=r%20instanceof%20pc.PhongMaterial||r%20instanceof%20pc.BasicMaterial;if((u===pc.PRIMITIVE_TRIANGLES||u===pc.PRIMITIVE_TRISTRIP||u===pc.PRIMITIVE_TRIFAN)&&x)e.setBlending(!1),e.setCullMode(r.cull),%20e.setDepthWrite(r.depthWrite),e.setDepthTest(r.depthTest),l.setValue(n.node.worldTransform.data),n.skinInstance&&(s.setValue(n.node.getPosition().data),e.supportsBoneTextures?(m.setValue(n.skinInstance.boneTexture),w.setValue([n.skinInstance.boneTexture.width,n.skinInstance.boneTexture.height])):D.setValue(n.skinInstance.matrixPalette)),this.pickColor[0]=(h%3E%3E16&255)/255,this.pickColor[1]=(h%3E%3E8&255)/255,this.pickColor[2]=(h&255)/255,this.pickColor[3]=1,y.setValue(this.pickColor),e.setShader(k.skin?%20this.pickProgSkin:this.pickProgStatic),e.setVertexBuffer(k.vertexBuffer,0),e.setIndexBuffer(k.indexBuffer[pc.RENDERSTYLE_SOLID]),e.draw(k.primitive[pc.RENDERSTYLE_SOLID])}e.setViewport(0,0,e.width,e.height);e.setScissor(0,0,e.width,e.height);e.updateEnd();e.setRenderTarget(g)};a.prototype.resize=function(a,d){var%20e=new%20pc.Texture(this.device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a,height:d,autoMipmap:!1});e.minFilter=pc.FILTER_NEAREST;e.magFilter=pc.FILTER_NEAREST;e.addressU=pc.ADDRESS_CLAMP_TO_EDGE;%20e.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new%20pc.RenderTarget(this.device,e,{depth:!0})};Object.defineProperty(a.prototype,%22renderTarget%22,{get:function(){return%20this._pickBufferTarget}});Object.defineProperty(a.prototype,%22width%22,{get:function(){return%20this._pickBufferTarget.width}});Object.defineProperty(a.prototype,%22height%22,{get:function(){return%20this._pickBufferTarget.height}});return{Picker:a}}());var%20primitiveUv1Padding=0.0625,primitiveUv1PaddingScale=1-2*primitiveUv1Padding;%20pc.calculateNormals=function(f,a){var%20b=a.length/3,d=f.length/3,e,g,h,k,n=new%20pc.Vec3,r=new%20pc.Vec3,u=new%20pc.Vec3,l=new%20pc.Vec3,m=new%20pc.Vec3,w=new%20pc.Vec3;new%20pc.Vec3;var%20s=[];for(k=0;k%3Cf.length;k++)s[k]=0;for(k=0;k%3Cb;k++)e=a[3*k],g=a[3*k+1],h=a[3*k+2],n.set(f[3*e],f[3*e+1],f[3*e+2]),r.set(f[3*g],f[3*g+1],f[3*g+2]),u.set(f[3*h],f[3*h+1],f[3*h+2]),l.sub2(r,n),m.sub2(u,n),w.cross(l,m).normalize(),s[3*e]+=w.x,s[3*e+1]+=w.y,s[3*e+2]+=w.z,s[3*g]+=w.x,s[3*g+1]+=w.y,s[3*g+2]+=w.z,s[3*h]+=w.x,s[3*h+1]+=%20w.y,s[3*h+2]+=w.z;for(k=0;k%3Cd;k++)b=s[3*k],e=s[3*k+1],g=s[3*k+2],b=1/Math.sqrt(b*b+e*e+g*g),s[3*k]*=b,s[3*k+1]*=b,s[3*k+2]*=b;return%20s};%20pc.calculateTangents=function(f,a,b,d){var%20e=d.length/3,g=f.length/3,h,k,n,r,u,l,m,w,s,D,y,x,A,C,B=new%20pc.Vec3,z=new%20pc.Vec3,E=new%20pc.Vec3,G=new%20pc.Vec3,R=new%20pc.Vec3,I=new%20pc.Vec2,P=new%20pc.Vec2,Q=new%20pc.Vec2,M,J=new%20Float32Array(3*g),N=new%20Float32Array(3*g),U=[];for(M=0;M%3Ce;M++)h=d[3*M],k=d[3*M+1],n=d[3*M+2],E.set(f[3*h],f[3*h+1],f[3*h+2]),G.set(f[3*k],f[3*k+1],f[3*k+2]),R.set(f[3*n],f[3*n+1],f[3*n+2]),I.set(b[2*h],b[2*h+1]),P.set(b[2*k],b[2*k+1]),Q.set(b[2*n],b[2*n+1]),r=G.x-E.x,u=R.x-E.x,l=G.y-%20E.y,m=R.y-E.y,w=G.z-E.z,s=R.z-E.z,D=P.x-I.x,y=Q.x-I.x,x=P.y-I.y,A=Q.y-I.y,C=1/(D*A-y*x),B.set((A*r-x*u)*C,(A*l-x*m)*C,(A*w-x*s)*C),z.set((D*u-y*r)*C,(D*m-y*l)*C,(D*s-y*w)*C),J[3*h+0]+=B.x,J[3*h+1]+=B.y,J[3*h+2]+=B.z,J[3*k+0]+=B.x,J[3*k+1]+=B.y,J[3*k+2]+=B.z,J[3*n+0]+=B.x,J[3*n+1]+=B.y,J[3*n+2]+=B.z,N[3*h+0]+=z.x,N[3*h+1]+=z.y,N[3*h+2]+=z.z,N[3*k+0]+=z.x,N[3*k+1]+=z.y,N[3*k+2]+=z.z,N[3*n+0]+=z.x,N[3*n+1]+=z.y,N[3*n+2]+=z.z;x=new%20pc.Vec3;A=new%20pc.Vec3;f=new%20pc.Vec3;b=new%20pc.Vec3;for(M=0;M%3Cg;M++)f.set(a[3*%20M],a[3*M+1],a[3*M+2]),x.set(J[3*M],J[3*M+1],J[3*M+2]),A.set(N[3*M],N[3*M+1],N[3*M+2]),d=f.dot(x),b.copy(f).scale(d),b.sub2(x,b).normalize(),U[4*M]=b.x,U[4*M+1]=b.y,U[4*M+2]=b.z,b.cross(f,x),U[4*M+3]=0%3Eb.dot(A)?-1:1;return%20U};%20pc.createMesh=function(f,a,b){var%20d=b&&void%200!==b.normals?b.normals:null,e=b&&void%200!==b.tangents?b.tangents:null,g=b&&void%200!==b.colors?b.colors:null,h=b&&void%200!==b.uvs?b.uvs:null,k=b&&void%200!==b.uvs1?b.uvs1:null,b=b&&void%200!==b.indices?b.indices:null,n=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}];null!==d&&n.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.ELEMENTTYPE_FLOAT32});null!==e&&n.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.ELEMENTTYPE_FLOAT32});%20null!==g&&n.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.ELEMENTTYPE_UINT8,normalize:!0});null!==h&&n.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.ELEMENTTYPE_FLOAT32});null!==k&&n.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.ELEMENTTYPE_FLOAT32});for(var%20r=new%20pc.VertexFormat(f,n),n=a.length/3,r=new%20pc.VertexBuffer(f,r,n),u=new%20pc.VertexIterator(r),l=0;l%3Cn;l++)u.element[pc.SEMANTIC_POSITION].set(a[3*l],a[3*l+1],a[3*l+2]),null!==d&&u.element[pc.SEMANTIC_NORMAL].set(d[3*%20l],d[3*l+1],d[3*l+2]),null!==e&&u.element[pc.SEMANTIC_TANGENT].set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),null!==g&&u.element[pc.SEMANTIC_COLOR].set(g[4*l],g[4*l+1],g[4*l+2],g[4*l+3]),null!==h&&u.element[pc.SEMANTIC_TEXCOORD0].set(h[2*l],h[2*l+1]),null!==k&&u.element[pc.SEMANTIC_TEXCOORD1].set(k[2*l],k[2*l+1]),u.next();u.end();d=null;if(e=null!==b)d=new%20pc.IndexBuffer(f,pc.INDEXFORMAT_UINT16,b.length),(new%20Uint16Array(d.lock())).set(b),d.unlock();f=new%20pc.BoundingBox;f.compute(a);a=new%20pc.Mesh;a.vertexBuffer=%20r;a.indexBuffer[0]=d;a.primitive[0].type=pc.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=e?b.length:n;a.primitive[0].indexed=e;a.aabb=f;return%20a};%20pc.createTorus=function(f,a){var%20b=a&&void%200!==a.tubeRadius?a.tubeRadius:0.2,d=a&&void%200!==a.ringRadius?a.ringRadius:0.3,e=a&&void%200!==a.segments?a.segments:30,g=a&&void%200!==a.sides?a.sides:20,h,k,n,r,u,l,m,w,s,D,y=[],x=[],A=[],C=[];for(h=0;h%3C=g;h++)for(k=0;k%3C=e;k++)n=Math.cos(2*Math.PI*k/e)*(d+b*Math.cos(2*Math.PI*h/g)),r=Math.sin(2*Math.PI*h/g)*b,u=Math.sin(2*Math.PI*k/e)*(d+b*Math.cos(2*Math.PI*h/g)),l=Math.cos(2*Math.PI*k/e)*Math.cos(2*Math.PI*h/g),m=Math.sin(2*Math.PI*h/g),w=Math.sin(2*Math.PI*%20k/e)*Math.cos(2*Math.PI*h/g),s=h/g,D=1-k/e,y.push(n,r,u),x.push(l,m,w),A.push(s,D),h%3Cg&&k%3Ce&&(n=h*(e+1)+k,r=(h+1)*(e+1)+k,u=h*(e+1)+(k+1),l=(h+1)*(e+1)+(k+1),C.push(n,r,u),C.push(r,l,u));b={normals:x,uvs:A,indices:C};pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(y,x,A,C));return%20pc.createMesh(f,y,b)};%20pc._createConeData=function(f,a,b,d,e,g){var%20h,k,n,r,u,l=new%20pc.Vec3;n=new%20pc.Vec3;var%20m=new%20pc.Vec3,w,s=[],D=[],y=[],x=[],A=[],C;if(0%3Cb)for(h=0;h%3C=d;h++)for(k=0;k%3C=e;k++)theta=2*(k/e)*Math.PI-Math.PI,C=Math.sin(theta),w=Math.cos(theta),u=new%20pc.Vec3(C*f,-b/2,w*f),r=new%20pc.Vec3(C*a,b/2,w*a),l.lerp(u,r,h/d),n.sub2(r,u).normalize(),w=new%20pc.Vec3(w,0,-C),m.cross(w,n).normalize(),s.push(l.x,l.y,l.z),D.push(m.x,m.y,m.z),r=k/e,u=h/d,y.push(r,u),w=u,u=r,r=w,r/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,%20u=u*primitiveUv1PaddingScale+primitiveUv1Padding,x.push(r,u),h%3Cd&&k%3Ce&&(w=h*(e+1)+k,C=h*(e+1)+(k+1),r=(h+1)*(e+1)+k,u=(h+1)*(e+1)+(k+1),A.push(w,C,r),A.push(C,u,r));if(g){f=Math.floor(e/2);l=b/2;for(b=0;b%3C=f;b++){theta=0.5*b*Math.PI/f;C=Math.sin(theta);w=Math.cos(theta);for(h=0;h%3C=e;h++)phi=2*h*Math.PI/e-Math.PI/2,r=Math.sin(phi),u=Math.cos(phi),g=u*C,k=w,n=r*C,r=1-h/e,u=1-b/f,s.push(g*a,k*a+l,n*a),D.push(g,k,n),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+%20primitiveUv1Padding,r+=1/3,x.push(r,u)}m=(d+1)*(e+1);for(b=0;b%3Cf;++b)for(h=0;h%3Ce;++h)w=b*(e+1)+h,C=w+e+1,A.push(m+w+1,m+C,m+w),A.push(m+w+1,m+C+1,m+C);for(b=0;b%3C=f;b++){theta=0.5*Math.PI+0.5*b*Math.PI/f;C=Math.sin(theta);w=Math.cos(theta);for(h=0;h%3C=e;h++)phi=2*h*Math.PI/e-Math.PI/2,r=Math.sin(phi),u=Math.cos(phi),g=u*C,k=w,n=r*C,r=1-h/e,u=1-b/f,s.push(g*a,k*a-l,n*a),D.push(g,k,n),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,%20r+=2/3,x.push(r,u)}m=(d+1)*(e+1)+(e+1)*(f+1);for(b=0;b%3Cf;++b)for(h=0;h%3Ce;++h)w=b*(e+1)+h,C=w+e+1,A.push(m+w+1,m+C,m+w),A.push(m+w+1,m+C+1,m+C)}else{m=(d+1)*(e+1);if(0%3Cf)for(h=0;h%3Ce;h++)theta=2*(h/e)*Math.PI,g=Math.sin(theta),k=-b/2,n=Math.cos(theta),r=1-(g+1)/2,u=(n+1)/2,s.push(g*f,k,n*f),D.push(0,-1,0),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,r+=1/3,x.push(r,u),1%3Ch&&A.push(m,m+h,m+h-1);m+=e;if(0%3Ca)for(h=0;h%3Ce;h++)theta=%202*(h/e)*Math.PI,g=Math.sin(theta),k=b/2,n=Math.cos(theta),r=1-(g+1)/2,u=(n+1)/2,s.push(g*a,k,n*a),D.push(0,1,0),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,r+=2/3,x.push(r,u),1%3Ch&&A.push(m,m+h-1,m+h)}return{positions:s,normals:D,uvs:y,uvs1:x,indices:A}};%20pc.createCylinder=function(f,a){var%20b=a&&void%200!==a.baseRadius?a.baseRadius:0.5,b=pc._createConeData(b,b,a&&void%200!==a.height?a.height:1,a&&void%200!==a.heightSegments?a.heightSegments:5,a&&void%200!==a.capSegments?a.capSegments:20,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return%20pc.createMesh(f,b.positions,b)};%20pc.createCapsule=function(f,a){var%20b=a&&void%200!==a.radius?a.radius:0.3,b=pc._createConeData(b,b,(a&&void%200!==a.height?a.height:1)-2*b,a&&void%200!==a.heightSegments?a.heightSegments:1,a&&void%200!==a.sides?a.sides:20,!0);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return%20pc.createMesh(f,b.positions,b)};%20pc.createCone=function(f,a){var%20b=pc._createConeData(a&&void%200!==a.baseRadius?a.baseRadius:0.5,a&&void%200!==a.peakRadius?a.peakRadius:0,a&&void%200!==a.height?a.height:1,a&&void%200!==a.heightSegments?a.heightSegments:5,a&&void%200!==a.capSegments?a.capSegments:18,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return%20pc.createMesh(f,b.positions,b)};%20pc.createSphere=function(f,a){var%20b=a&&void%200!==a.radius?a.radius:0.5,d=a&&void%200!==a.latitudeBands?a.latitudeBands:16,e=a&&void%200!==a.longitudeBands?a.longitudeBands:16,g,h,k,n,r,u,l,m,w,s=[],D=[],y=[],x=[];for(h=0;h%3C=d;h++){g=h*Math.PI/d;k=Math.sin(g);n=Math.cos(g);for(g=0;g%3C=e;g++)r=2*g*Math.PI/e-Math.PI/2,u=Math.sin(r),r=Math.cos(r),r*=k,l=n,u*=k,m=1-g/e,w=1-h/d,s.push(r*b,l*b,u*b),D.push(r,l,u),y.push(m,w)}for(h=0;h%3Cd;++h)for(g=0;g%3Ce;++g)b=h*(e+1)+g,k=b+e+1,x.push(b+1,k,b),x.push(b+1,k+1,k);%20d={normals:D,uvs:y,uvs1:y,indices:x};pc.precalculatedTangents&&(d.tangents=pc.calculateTangents(s,D,y,x));return%20pc.createMesh(f,s,d)};%20pc.createPlane=function(f,a){var%20b=a&&void%200!==a.halfExtents?a.halfExtents:new%20pc.Vec2(0.5,0.5),d=a&&void%200!==a.widthSegments?a.widthSegments:5,e=a&&void%200!==a.lengthSegments?a.lengthSegments:5,g,h,k,n,r,u,l=[],m=[],w=[],s=[];for(g=0;g%3C=d;g++)for(h=0;h%3C=e;h++)k=-b.x+2*b.x*g/d,n=-(-b.y+2*b.y*h/e),r=g/d,u=h/e,l.push(k,0,n),m.push(0,1,0),w.push(r,u),g%3Cd&&h%3Ce&&(s.push(h+g*(d+1),h+(g+1)*(d+1),h+g*(d+1)+1),s.push(h+(g+1)*(d+1),h+(g+1)*(d+1)+1,h+g*(d+1)+1));b={normals:m,uvs:w,uvs1:w,indices:s};pc.precalculatedTangents&&%20(b.tangents=pc.calculateTangents(l,m,w,s));return%20pc.createMesh(f,l,b)};%20pc.createBox=function(f,a){var%20b=a&&void%200!==a.halfExtents?a.halfExtents:new%20pc.Vec3(0.5,0.5,0.5),d=a&&void%200!==a.widthSegments?a.widthSegments:1,e=a&&void%200!==a.lengthSegments?a.lengthSegments:1,g=a&&void%200!==a.heightSegments?a.heightSegments:1,h=[new%20pc.Vec3(-b.x,-b.y,b.z),new%20pc.Vec3(b.x,-b.y,b.z),new%20pc.Vec3(b.x,b.y,b.z),new%20pc.Vec3(-b.x,b.y,b.z),new%20pc.Vec3(b.x,-b.y,-b.z),new%20pc.Vec3(-b.x,-b.y,-b.z),new%20pc.Vec3(-b.x,b.y,-b.z),new%20pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,%202],[5,0,6]],n=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],r=[],u=[],l=[],m=[],w=[],b=function(a,b,d){var%20e,g,f,B,z=r.length/3;for(f=0;f%3C=b;f++)for(B=0;B%3C=d;B++){e=new%20pc.Vec3;g=new%20pc.Vec3;var%20E=new%20pc.Vec3,G=new%20pc.Vec3;e.lerp(h[k[a][0]],h[k[a][1]],f/b);g.lerp(h[k[a][0]],h[k[a][2]],B/d);E.sub2(g,h[k[a][0]]);G.add2(e,E);e=f/b;g=B/d;r.push(G.x,G.y,G.z);u.push(n[a][0],n[a][1],n[a][2]);l.push(e,g);e/=3;g/=3;e=e*primitiveUv1PaddingScale+primitiveUv1Padding;g=g*primitiveUv1PaddingScale+primitiveUv1Padding;%20e+=a%3/3;g+=Math.floor(a/3)/3;m.push(e,g);f%3Cb&&B%3Cd&&(w.push(z+B+f*(b+1),z+B+(f+1)*(b+1),z+B+f*(b+1)+1),w.push(z+B+(f+1)*(b+1),z+B+(f+1)*(b+1)+1,z+B+f*(b+1)+1))}};b(0,d,g);b(1,d,g);b(2,d,e);b(3,d,e);b(4,e,g);b(5,e,g);d={normals:u,uvs:l,uvs1:m,indices:w};pc.precalculatedTangents&&(d.tangents=pc.calculateTangents(r,u,l,w));return%20pc.createMesh(f,r,d)};pc.extend(pc,function(){var%20f=function(){this._name=%22%22;this._duration=0;this._nodes=[];this._nodeDict={}};f.prototype.getDuration=function(){return%20this._duration};f.prototype.getName=function(){return%20this._name};f.prototype.getNode=function(a){return%20this._nodeDict[a]};f.prototype.getNodes=function(){return%20this._nodes};f.prototype.setDuration=function(a){this._duration=a};f.prototype.setName=function(a){this._name=a};f.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=a};%20return{Animation:f,Key:function(a,b,d,e){this.time=a;this.position=b;this.rotation=d;this.scale=e},Node:function(){this._name=%22%22;this._keys=[]}}}());pc.extend(pc,function(){function%20f(){this._written=!1;this._name=%22%22;this._keyFrames=[];this._quat=new%20pc.Quat;this._pos=new%20pc.Vec3;this._scale=new%20pc.Vec3;this._targetNode=null}f.prototype={getTarget:function(){return%20this._targetNode},setTarget:function(a){this._targetNode=a}};var%20a=function(a){function%20d(a){var%20b=a.getName(),k=new%20f;k._name=b;e._interpolatedKeys.push(k);e._interpolatedKeyDict[b]=k;e._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b%3Ca.length;b++)d(a[b])}this._animation=null;this._time=%200;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var%20e=this;d(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==r||this.looping)){var%20d,e,g,f,k,n=this._animation.getNodes();this._time+=a;var%20r=this._animation.getDuration();if(this._time%3Er){this._time=this.looping?0:r;for(r=0;r%3Cn.length;r++)d=n[r],e=d._name,this._currKeyIndices[e]=0}else%20if(0%3Ethis._time){this._time=this.looping?r:0;for(r=0;r%3Cn.length;r++)d=n[r],%20e=d._name,this._currKeyIndices[e]=d._keys.length-2}a=0%3C=a?1:-1;for(r=0;r%3Cn.length;r++)if(d=n[r],e=d._name,g=d._keys,d=this._interpolatedKeyDict[e],1===g.length)d._pos.copy(g[0].position),d._quat.copy(g[0].rotation),d._scale(g[0].scale);else%20for(var%20u=this._currKeyIndices[e];u%3Cg.length-1&&0%3C=u;u+=a)if(f=g[u],k=g[u+1],f.time%3C=this._time&&k.time%3E=this._time){g=(this._time-f.time)/(k.time-f.time);d._pos.lerp(f.position,k.position,g);d._quat.slerp(f.rotation,k.rotation,g);d._scale.lerp(f.scale,k.scale,%20g);d._written=!0;this._currKeyIndices[e]=u;break}}};a.prototype.blend=function(a,d,e){for(var%20g=this._interpolatedKeys.length,f=0;f%3Cg;f++){var%20k=a._interpolatedKeys[f],n=d._interpolatedKeys[f],r=this._interpolatedKeys[f];k._written&&n._written?(r._quat.slerp(k._quat,d._interpolatedKeys[f]._quat,e),r._pos.lerp(k._pos,d._interpolatedKeys[f]._pos,e),r._scale.lerp(k._scale,n._scale,e),r._written=!0):k._written?(r._quat.copy(k._quat),r._pos.copy(k._pos),r._scale.copy(k._scale),r._written=!0):n._written&&%20(r._quat.copy(n._quat),r._pos.copy(n._pos),r._scale.copy(n._scale),r._written=!0)}};a.prototype.getAnimation=function(){return%20this._animation};a.prototype.getCurrentTime=function(){return%20this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var%20a=this._interpolatedKeys.length,d=0;d%3Ca;d++)this._currKeyIndices[this._interpolatedKeys[d]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return%20this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=%20a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var%20d;if(this.graph=a)for(d=0;d%3Cthis._interpolatedKeys.length;d++){var%20e=a.findByName(this._interpolatedKeys[d]._name);this._interpolatedKeys[d].setTarget(e)}else%20for(d=0;d%3Cthis._interpolatedKeys.length;d++)this._interpolatedKeys[d].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var%20a=0;a%3Cthis._interpolatedKeys.length;a++){var%20d=this._interpolatedKeys[a];if(d._written){var%20e=d.getTarget();e.localPosition.copy(d._pos);%20e.localRotation.copy(d._quat);e.localScale.copy(d._scale);e.dirtyLocal=!0;d._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return%20this.looping};return{Skeleton:a}}());pc.extend(pc,function(){function%20f(){return!!(%22undefined%22!==typeof%20AudioContext||%22undefined%22!==typeof%20webkitAudioContext)}var%20a=function(){if(f()&&(%22undefined%22!==typeof%20AudioContext?this.context=new%20AudioContext:%22undefined%22!==typeof%20webkitAudioContext&&(this.context=new%20webkitAudioContext),this.context)){var%20a=this.context;if(/iPad|iPhone|iPod/.test(navigator.platform)){var%20d=function(){var%20e=a.createBuffer(1,1,22050),g=a.createBufferSource();g.buffer=e;g.connect(a.destination);g.start(0);window.removeEventListener(%22touchend%22,%20d)};window.addEventListener(%22touchend%22,d)}}this.listener=new%20pc.Listener(this);this._volume=1;this.suspended=!1;pc.events.attach(this)};a.hasAudio=function(){return%22undefined%22!==typeof%20Audio};a.hasAudioContext=f;a.prototype={suspend:function(){this.suspended=!0;this.fire(%22suspend%22)},resume:function(){this.suspended=!1;this.fire(%22resume%22)},destroy:function(){this.fire(%22destroy%22);this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){console.warn('DEPRECATED:%20getListener%20is%20deprecated.%20Get%20the%20%22listener%22%20field%20instead.');%20return%20this.listener},getVolume:function(){console.warn('DEPRECATED:%20getVolume%20is%20deprecated.%20Get%20the%20%22volume%22%20property%20instead.');return%20this.volume},setVolume:function(a){console.warn('DEPRECATED:%20setVolume%20is%20deprecated.%20Set%20the%20%22volume%22%20property%20instead.');this.volume=a},playSound:function(a,d){var%20d=d||{},e=null;pc.Channel&&(e=new%20pc.Channel(this,a,d),e.play());return%20e},playSound3d:function(a,d,e){var%20e=e||{},g=null;pc.Channel3d&&(g=new%20pc.Channel3d(this,a,e),g.setPosition(d),e.volume&&g.setVolume(e.volume),%20e.loop&&g.setLoop(e.loop),e.maxDistance&&g.setMaxDistance(e.maxDistance),e.minDistance&&g.setMinDistance(e.minDistance),e.rollOffFactor&&g.setRollOffFactor(e.rollOffFactor),e.distanceModel&&g.setDistanceModel(e.distanceModel),g.play());return%20g}};Object.defineProperty(a.prototype,%22volume%22,{get:function(){return%20this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.fire(%22volumechange%22,a)}});pc.AudioManager=a;return{SoundManager:a}}());pc.extend(pc,function(){var%20f=function(a){a%20instanceof%20Audio?this.audio=a:this.buffer=a};Object.defineProperty(f.prototype,%22duration%22,{get:function(){var%20a=0;this.buffer?a=this.buffer.duration:this.audio&&(a=this.audio.duration);return%20a||0}});return{Sound:f}}());pc.extend(pc,function(){var%20f=function(a){this.position=new%20pc.Vec3;this.velocity=new%20pc.Vec3;this.orientation=new%20pc.Mat4;pc.AudioManager.hasAudioContext()&&(this.listener=a.context.listener)};f.prototype={getPosition:function(){return%20this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return%20this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);%20this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},getOrientation:function(){return%20this.orientation}};return{Listener:f}}());pc.extend(pc,function(){var%20f;pc.SoundManager.hasAudioContext()?(f=function(a,b,d){pc.events.attach(this);d=d||{};this._volume=void%200!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void%200!==d.pitch?Math.max(0.01,Number(d.pitch)||0):1;this._loop=!!(void%200!==d.loop&&d.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(d.startTime)||0);this._duration=Math.max(0,Number(d.duration)||0);this._startedAt=%200;this._startOffset=null;this._calculatedCurrentTimeAt=this._currentTime=0;this._playWhenLoaded=!0;this._manager=a;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;this._initializeNodes();this._endedHandler=this._onEnded.bind(this);this.source=null;this._createSource()},f.prototype={_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&%20this.stop();if(!this.source)return!1;var%20a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._startedAt=this._manager.context.currentTime-a;this._currentTime=0;this._calculatedCurrentTimeAt=this._manager.context.currentTime;this._state=0;this._playWhenLoaded=!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on(%22volumechange%22,this._onManagerVolumeChange,%20this);this._manager.on(%22suspend%22,this._onManagerSuspend,this);this._manager.on(%22resume%22,this._onManagerResume,this);this._manager.on(%22destroy%22,this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this.fire(%22play%22,this);return!0},pause:function(){if(0!==this._state||!this.source)return!1;this._state=1;this._currentTime=(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*this.pitch)%this.duration||0;this._calculatedCurrentTimeAt=%20this._manager.context.currentTime;this._suspendEndEvent=!0;this.source.stop(0);this._createSource();this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this.fire(%22pause%22,this);return!0},resume:function(){if(1!==this._state||!this.source)return!1;var%20a=(this._startTime+this._currentTime)%this._sound.duration||0;null!==this._startOffset&&(a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,%20a,this._duration):this.source.start(0,a);this._state=0;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this.fire(%22resume%22,this);return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off(%22volumechange%22,this._onManagerVolumeChange,this);this._manager.off(%22suspend%22,this._onManagerSuspend,this);this._manager.off(%22resume%22,this._onManagerResume,this);this._manager.off(%22destroy%22,this._onManagerDestroy,this);%20this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this._state=2;this._createSource();this._suspendInstanceEvents||this.fire(%22stop%22,this);return!0},setExternalNodes:function(a,b){if(a){b||(b=a);var%20d=this._manager.context.destination;this._firstNode!==a&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(d),this._firstNode=a,this._connectorNode.connect(a));this._lastNode!==b&&(this._lastNode&&%20this._lastNode.disconnect(d),this._lastNode=b,this._lastNode.connect(d))}else%20logError(%22The%20firstNode%20must%20be%20a%20valid%20Audio%20Node%22)},clearExternalNodes:function(){var%20a=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(a),this._lastNode=null);this._connectorNode.connect(a)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return%20null;%20var%20a=this._manager.context;this._sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)),this._suspendInstanceEvents||this.fire(%22ready%22,this));return%20this.source},_onEnded:function(){this._suspendEndEvent?%20this._suspendEndEvent=!1:(this.fire(%22end%22,this),this.stop())},_onManagerDestroy:function(){this.source&&this.isPlaying&&(this.source.stop(0),this.source=null)}},Object.defineProperty(f.prototype,%22volume%22,{get:function(){return%20this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this._manager.volume)}}),Object.defineProperty(f.prototype,%22pitch%22,{get:function(){return%20this._pitch},set:function(a){var%20b=this._pitch;this._calculatedCurrentTimeAt&&(this._currentTime=%20(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*b)%this.duration||0,this._calculatedCurrentTimeAt=this._manager.context.currentTime);this._pitch=Math.max(Number(a)||0,0.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(f.prototype,%22loop%22,{get:function(){return%20this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.prototype,%22sound%22,{get:function(){return%20this._sound},%20set:function(a){this._sound=a;this.isStopped?this._createSource():this.stop()}}),Object.defineProperty(f.prototype,%22currentTime%22,{get:function(){if(null!==this._startOffset)return%20this._startOffset;if(this.isStopped||!this.source)return%200;if(this.isPaused)return%20this._currentTime;this._currentTime=(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*this.pitch)%this.duration||0;this._calculatedCurrentTimeAt=this._manager.context.currentTime;return%20this._currentTime},%20set:function(a){if(!(0%3Ea))if(this.isPlaying){this.stop();var%20b=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=a;this.play();this._suspendInstanceEvents=b}else%20this._currentTime=this._startOffset=a,this._calculatedCurrentTimeAt=this._manager.context.currentTime}})):pc.SoundManager.hasAudio()?(f=function(a,b,d){pc.events.attach(this);d=d||{};this._volume=void%200!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void%200!==d.pitch?Math.max(0.01,Number(d.pitch)||%200):1;this._loop=!!(void%200!==d.loop&&d.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(d.startTime)||0);this._duration=Math.max(0,Number(d.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=a;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);this._timeUpdateHandler=this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this.source=null;this._createSource()},%20f.prototype={play:function(){2!==this._state&&this.stop();if(!this.source)return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=!1;this._manager.on(%22volumechange%22,this._onManagerVolumeChange,this);this._manager.on(%22suspend%22,this._onManagerSuspend,this);this._manager.on(%22resume%22,this._onManagerResume,this);this._manager.on(%22destroy%22,this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||%20this.fire(%22play%22,this);return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;this._suspendInstanceEvents||this.fire(%22pause%22,this);return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this.fire(%22resume%22,this));return!0},stop:function(){if(!this.source||2===%20this._state)return!1;this._manager.off(%22volumechange%22,this._onManagerVolumeChange,this);this._manager.off(%22suspend%22,this._onManagerSuspend,this);this._manager.off(%22resume%22,this._onManagerResume,this);this._manager.off(%22destroy%22,this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this.fire(%22stop%22,this);return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,%20null]},_onLoadedMetadata:function(){this.source.removeEventListener(%22loadedmetadata%22,this._loadedMetadataHandler);this._isReady=!0;var%20a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=a},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener(%22loadedmetadata%22,this._loadedMetadataHandler),this.source.addEventListener(%22timeupdate%22,%20this._timeUpdateHandler),this.source.onended=this._endedHandler,this._suspendInstanceEvents||this.fire(%22ready%22,this.source));return%20this.source},_onTimeUpdate:function(){if(this._duration&&this.source.currentTime%3E((this._startTime+this._duration)%this.source.duration||0))this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener(%22timeupdate%22,this._timeUpdateHandler),this.source.pause(),this._onEnded())},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=%20!1:(this.fire(%22end%22,this),this.stop())},_onManagerDestroy:function(){this.source&&this.source.pause()}},Object.defineProperty(f.prototype,%22volume%22,{get:function(){return%20this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this._manager.volume)}}),Object.defineProperty(f.prototype,%22pitch%22,{get:function(){return%20this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,0.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(f.prototype,%20%22loop%22,{get:function(){return%20this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.prototype,%22sound%22,{get:function(){return%20this._sound},set:function(a){this.stop();this._sound=a;this._createSource()}}),Object.defineProperty(f.prototype,%22currentTime%22,{get:function(){return%20null!==this._startOffset?this._startOffset:this.isStopped||!this.source?0:this.source.currentTime-this._startTime},set:function(a){0%3Ea||(this._startOffset=a,this.source&&%20this._isReady&&(this.source.currentTime=(this._startTime+(a%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):(console.warn(%22No%20support%20for%202D%20audio%20found%22),f=function(){});pc.extend(f.prototype,{_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){this.isPlaying&&!this._suspended&&(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(f.prototype,%22startTime%22,%20{get:function(){return%20this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(f.prototype,%22duration%22,{get:function(){return!this._sound?0:this._duration?this._duration%this._sound.duration||0:this._sound.duration},set:function(a){this._duration=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(f.prototype,%22isPlaying%22,{get:function(){return%200===this._state}});Object.defineProperty(f.prototype,%20%22isPaused%22,{get:function(){return%201===this._state}});Object.defineProperty(f.prototype,%22isStopped%22,{get:function(){return%202===this._state}});Object.defineProperty(f.prototype,%22isSuspended%22,{get:function(){return%20this._suspended}});return{SoundInstance:f}}());pc.extend(pc,function(){var%20f;if(pc.SoundManager.hasAudioContext())f=function(a,d,e){e=e||{};this._position=new%20pc.Vec3;e.position&&(this.position=e.position);this._velocity=new%20pc.Vec3;e.velocity&&(this.velocity=e.velocity);this.maxDistance=void%200!==e.maxDistance?Number(e.maxDistance):1E4;this.refDistance=void%200!==e.refDistance?Number(e.refDistance):1;this.rollOffFactor=void%200!==e.rollOffFactor?Number(e.rollOffFactor):1;this.distanceModel=void%200!==e.distanceModel?e.distanceModel:pc.DISTANCE_LINEAR},%20f=pc.inherits(f,pc.SoundInstance),f.prototype=pc.extend(f.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(f.prototype,%22position%22,{get:function(){return%20this._position},set:function(a){this._position.copy(a);this.panner.setPosition(a.x,a.y,%20a.z)}}),Object.defineProperty(f.prototype,%22velocity%22,{get:function(){return%20this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}}),Object.defineProperty(f.prototype,%22maxDistance%22,{get:function(){return%20this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}}),Object.defineProperty(f.prototype,%22refDistance%22,{get:function(){return%20this.panner.refDistance},set:function(a){this.panner.refDistance=a}}),Object.defineProperty(f.prototype,%22rollOffFactor%22,%20{get:function(){return%20this.panner.rollOffFactor},set:function(a){this.panner.rollOffFactor=a}}),Object.defineProperty(f.prototype,%22distanceModel%22,{get:function(){return%20this.panner.distanceModel},set:function(a){this.panner.distanceModel=a}});else%20if(pc.SoundManager.hasAudio()){var%20a=new%20pc.Vec3;f=function(a,d,e){e=e||{};this._position=new%20pc.Vec3;e.position&&(this.position=e.position);this._velocity=new%20pc.Vec3;e.velocity&&(this.velocity=e.velocity);this._maxDistance=void%200!==e.maxDistance?Number(e.maxDistance):%201E4;this._refDistance=void%200!==e.refDistance?Number(e.refDistance):1;this._rollOffFactor=void%200!==e.rollOffFactor?Number(e.rollOffFactor):1;this._distanceModel=void%200!==e.distanceModel?e.distanceModel:pc.DISTANCE_LINEAR};f=pc.inherits(f,pc.SoundInstance);Object.defineProperty(f.prototype,%22position%22,{get:function(){return%20this._position},set:function(b){this._position.copy(b);if(this.source){var%20d=this._manager.listener.getPosition();var%20b=this.refDistance,e=this.maxDistance,g=this.rollOffFactor,f=%20this.distanceModel;a=a.sub2(d,this._position);d=a.length();if(d%3Cb)b=1;else%20if(d%3Ee)b=0;else{var%20k=0;f===pc.DISTANCE_LINEAR?k=1-g*(d-b)/(e-b):f===pc.DISTANCE_INVERSE?k=b/(b+g*(d-b)):f===pc.DISTANCE_EXPONENTIAL&&(k=Math.pow(d/b,-g));b=pc.math.clamp(k,0,1)}this.source.volume=this.volume*b}}});Object.defineProperty(f.prototype,%22velocity%22,{get:function(){return%20this._velocity},set:function(a){this._velocity.copy(a)}});Object.defineProperty(f.prototype,%22maxDistance%22,{get:function(){return%20this._maxDistance},%20set:function(a){this._maxDistance=a}});Object.defineProperty(f.prototype,%22refDistance%22,{get:function(){return%20this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(f.prototype,%22rollOffFactor%22,{get:function(){return%20this._rollOffFactor},set:function(a){this._rollOffFactor=a}});Object.defineProperty(f.prototype,%22distanceModel%22,{get:function(){return%20this._distanceModel},set:function(a){this._distanceModel=a}})}else%20console.warn(%22No%20support%20for%203D%20audio%20found%22),f=function(){};%20return{SoundInstance3d:f}}());pc.extend(pc,function(){var%20f;pc.AudioManager.hasAudioContext()?(f=function(a,b,d){d=d||{};this.volume=void%200===d.volume?1:d.volume;this.loop=void%200===d.loop?!1:d.loop;this.pitch=void%200===d.pitch?1:d.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},f.prototype={play:function(){if(this.source)throw%20Error(%22Call%20stop()%20before%20calling%20play()%22);this._createSource();if(this.source&&(this.startTime=this.manager.context.currentTime,%20this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on(%22volumechange%22,this.onManagerVolumeChange,this),this.manager.on(%22suspend%22,this.onManagerSuspend,this),this.manager.on(%22resume%22,this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=%20null)},unpause:function(){this.source||!this.paused?console.warn(%22Call%20pause()%20before%20unpausing.%22):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off(%22volumechange%22,this.onManagerVolumeChange,this);this.manager.off(%22suspend%22,%20this.onManagerSuspend,this);this.manager.off(%22resume%22,this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this.manager.volume)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return%20this.source?this.source.buffer.duration:%200},_createSource:function(){var%20a=this.manager.context;this.sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(a.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):pc.AudioManager.hasAudio()?(f=function(a,b,d){this.volume=d.volume||1;this.loop=d.loop||!1;this.sound=b;this.pitch=void%200!==d.pitch?d.pitch:1;this.suspended=this.paused=!1;this.manager=a;b.audio&&(this.source=b.audio.cloneNode(!1),%20this.source.pause())},f.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on(%22volumechange%22,this.onManagerVolumeChange,this);this.manager.on(%22suspend%22,this.onManagerSuspend,this);this.manager.on(%22resume%22,this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=%20!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off(%22volumechange%22,this.onManagerVolumeChange,this);this.manager.off(%22suspend%22,this.onManagerSuspend,this);this.manager.off(%22resume%22,this.onManagerResume,this)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this.manager.volume)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=%20a)},getDuration:function(){if(this.source){var%20a=this.source.duration;if(a===a)return%20a}return%200},isPlaying:function(){return!this.source.paused}}):(console.warn(%22No%20support%20for%202D%20audio%20found%22),f=function(){});pc.extend(f.prototype,{getVolume:function(){return%20this.volume},getLoop:function(){return%20this.loop},getPitch:function(){return%20this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},%20onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:f}}());pc.extend(pc,function(){var%20f;if(pc.AudioManager.hasAudioContext())f=function(a){this.position=new%20pc.Vec3;this.velocity=new%20pc.Vec3;this.panner=a.context.createPanner()},f=pc.inherits(f,pc.Channel),f.prototype=pc.extend(f.prototype,{getPosition:function(){return%20this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return%20this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return%20this.panner.maxDistance},%20setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return%20this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return%20this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return%20this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},_createSource:function(){var%20a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=%20this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}});else%20if(pc.AudioManager.hasAudio()){var%20a=new%20pc.Vec3;f=pc.inherits(function(){this.position=new%20pc.Vec3;this.velocity=new%20pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=pc.DISTANCE_INVERSE},pc.Channel);f.prototype=pc.extend(f.prototype,{getPosition:function(){return%20this.position},setPosition:function(b){this.position.copy(b);%20if(this.source){var%20d=this.manager.listener.getPosition();var%20b=this.minDistance,e=this.maxDistance,g=this.rollOffFactor,f=this.distanceModel;a=a.sub2(d,this.position);d=a.length();if(d%3Cb)b=1;else%20if(d%3Ee)b=0;else{var%20k=0;f===pc.DISTANCE_LINEAR?k=1-g*(d-b)/(e-b):f===pc.DISTANCE_INVERSE?k=b/(b+g*(d-b)):f===pc.DISTANCE_EXPONENTIAL&&(k=Math.pow(d/b,-g));b=pc.math.clamp(k,0,1)}e=this.getVolume();this.source.volume=e*b}},getVelocity:function(){return%20this.velocity},setVelocity:function(a){this.velocity.copy(a)},%20getMaxDistance:function(){return%20this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return%20this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return%20this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a},getDistanceModel:function(){return%20this.distanceModel},setDistanceModel:function(a){this.distanceModel=a}})}else%20console.warn(%22No%20support%20for%203D%20audio%20found%22),f=function(){};return{Channel3d:f}}());(function(){var%20f={ACTION_MOUSE:%22mouse%22,ACTION_KEYBOARD:%22keyboard%22,ACTION_GAMEPAD:%22gamepad%22,AXIS_MOUSE_X:%22mousex%22,AXIS_MOUSE_Y:%22mousey%22,AXIS_PAD_L_X:%22padlx%22,AXIS_PAD_L_Y:%22padly%22,AXIS_PAD_R_X:%22padrx%22,AXIS_PAD_R_Y:%22padry%22,AXIS_KEY:%22key%22,EVENT_KEYDOWN:%22keydown%22,EVENT_KEYUP:%22keyup%22,EVENT_MOUSEDOWN:%22mousedown%22,EVENT_MOUSEMOVE:%22mousemove%22,EVENT_MOUSEUP:%22mouseup%22,EVENT_MOUSEWHEEL:%22mousewheel%22,EVENT_TOUCHSTART:%22touchstart%22,EVENT_TOUCHEND:%22touchend%22,EVENT_TOUCHMOVE:%22touchmove%22,EVENT_TOUCHCANCEL:%22touchcancel%22,%20KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,%20KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,%20KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,%20PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};pc.extend(pc,f);pc.input={};pc.extend(pc.input,f)})();pc.extend(pc,function(){var%20f=function(a,b){var%20d={x:0,y:0};if(b){if(b%20instanceof%20f)throw%20Error(%22Expected%20MouseEvent%22);d=a._getTargetCoords(b)}else%20b={};if(d)this.x=d.x,this.y=d.y;else%20if(pc.Mouse.isPointerLocked())this.y=this.x=0;else%20return;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);%20this.button=%22mousedown%22===b.type||%22mouseup%22===b.type?b.button:pc.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=%20this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!(!document.pointerLockElement&&!document.mozPointerLockElement&&!document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener(%22mouseup%22,this._upHandler,!1),window.addEventListener(%22mousedown%22,this._downHandler,!1),window.addEventListener(%22mousemove%22,%20this._moveHandler,!1),window.addEventListener(%22mousewheel%22,this._wheelHandler,!1),window.addEventListener(%22DOMMouseScroll%22,this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener(%22mouseup%22,this._upHandler),window.removeEventListener(%22mousedown%22,this._downHandler),window.removeEventListener(%22mousemove%22,this._moveHandler),window.removeEventListener(%22mousewheel%22,this._wheelHandler),window.removeEventListener(%22DOMMouseScroll%22,this._wheelHandler))},disableContextMenu:function(){this._target&&%20this._target.addEventListener(%22contextmenu%22,this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener(%22contextmenu%22,this._contextMenuHandler)},enablePointerLock:function(a,b){if(document.body.requestPointerLock){var%20d=function(){a();document.removeEventListener(%22pointerlockchange%22,d)},f=function(){b();document.removeEventListener(%22pointerlockerror%22,f)};a&&document.addEventListener(%22pointerlockchange%22,d,!1);b&&document.addEventListener(%22pointerlockerror%22,%20f,!1);document.body.requestPointerLock()}else%20b&&b()},disablePointerLock:function(a){if(document.exitPointerLock){var%20b=function(){a();document.removeEventListener(%22pointerlockchange%22,b)};a&&document.addEventListener(%22pointerlockchange%22,b,!1);document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return%20this._buttons[a]},wasPressed:function(a){return%20this._buttons[a]&&!this._lastbuttons[a]},%20wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new%20f(this,a);a.event&&this.fire(pc.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new%20f(this,a);a.event&&this.fire(pc.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new%20f(this,a);a.event&&(this.fire(pc.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new%20f(this,a);a.event&&this.fire(pc.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var%20b=%20this._target.getBoundingClientRect(),d=Math.floor(b.left),b=Math.floor(b.top);return%20a.clientX%3Cd||a.clientX%3E=d+this._target.clientWidth||a.clientY%3Cb||a.clientY%3E=b+this._target.clientHeight?null:{x:a.clientX-d,y:a.clientY-b}}};if(!(%22undefined%22===typeof%20navigator||%22undefined%22===typeof%20document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var%20b=function(){var%20a=document.createEvent(%22CustomEvent%22);a.initCustomEvent(%22pointerlockchange%22,!0,!1,null);document.dispatchEvent(a)},%20d=function(){var%20a=document.createEvent(%22CustomEvent%22);a.initCustomEvent(%22pointerlockerror%22,!0,!1,null);document.dispatchEvent(a)};document.addEventListener(%22webkitpointerlockchange%22,b,!1);document.addEventListener(%22webkitpointerlocklost%22,b,!1);document.addEventListener(%22mozpointerlockchange%22,b,!1);document.addEventListener(%22mozpointerlocklost%22,b,!1);document.addEventListener(%22webkitpointerlockerror%22,d,!1);document.addEventListener(%22mozpointerlockerror%22,d,!1);Element.prototype.requestPointerLock=%20Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,d)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||%20(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:f}}());pc.extend(pc,function(){function%20f(a){return%22string%22==typeof%20a?a.toUpperCase().charCodeAt(0):a}var%20a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:%22Tab%22,13:%22Enter%22,16:%22Shift%22,17:%22Control%22,18:%22Alt%22,27:%22Escape%22,37:%22Left%22,38:%22Up%22,39:%22Right%22,40:%22Down%22,46:%22Delete%22,91:%22Win%22},d=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);pc.events.attach(this);%20this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};d.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener(%22keydown%22,this._keyDownHandler,!1);this._element.addEventListener(%22keypress%22,this._keyPressHandler,!1);this._element.addEventListener(%22keyup%22,this._keyUpHandler,!1)};d.prototype.detach=function(){this._element.removeEventListener(%22keydown%22,this._keyDownHandler);%20this._element.removeEventListener(%22keypress%22,this._keyPressHandler);this._element.removeEventListener(%22keyup%22,this._keyUpHandler);this._element=null};d.prototype.toKeyIdentifier=function(a){var%20a=f(a),d,h;if(d=b[a.toString()])return%20d;d=a.toString(16).toUpperCase();h=d.length;for(a=0;a%3C4-h;a++)d=%220%22+d;return%22U+%22+d};d.prototype._handleKeyDown=function(b){var%20d=this.toKeyIdentifier(b.keyCode||b.charCode);this._keymap[d]=!0;this.fire(%22keydown%22,new%20a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&%20b.stopPropagation()};d.prototype._handleKeyUp=function(b){var%20d=this.toKeyIdentifier(b.keyCode||b.charCode);delete%20this._keymap[d];this.fire(%22keyup%22,new%20a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};d.prototype._handleKeyPress=function(b){this.toKeyIdentifier(b.keyCode||b.charCode);this.fire(%22keypress%22,new%20a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};d.prototype.update=function(){var%20a;this._lastmap={};%20for(a%20in%20this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};d.prototype.isPressed=function(a){a=f(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};d.prototype.wasPressed=function(a){a=f(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};d.prototype.wasReleased=function(a){a=f(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};return{Keyboard:d}}());pc.extend(pc,function(){var%20f=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:%22PAD_FACE_1%20PAD_FACE_2%20PAD_FACE_3%20PAD_FACE_4%20PAD_L_SHOULDER_1%20PAD_R_SHOULDER_1%20PAD_L_SHOULDER_2%20PAD_R_SHOULDER_2%20PAD_SELECT%20PAD_START%20PAD_L_STICK_BUTTON%20PAD_R_STICK_BUTTON%20PAD_UP%20PAD_DOWN%20PAD_LEFT%20PAD_RIGHT%20PAD_VENDOR%22.split(%22%20%22),axes:[%22PAD_L_STICK_X%22,%22PAD_L_STICK_Y%22,%22PAD_R_STICK_X%22,%22PAD_R_STICK_Y%22]},PS3:{buttons:%22PAD_FACE_1%20PAD_FACE_2%20PAD_FACE_4%20PAD_FACE_3%20PAD_L_SHOULDER_1%20PAD_R_SHOULDER_1%20PAD_L_SHOULDER_2%20PAD_R_SHOULDER_2%20PAD_SELECT%20PAD_START%20PAD_L_STICK_BUTTON%20PAD_R_STICK_BUTTON%20PAD_UP%20PAD_DOWN%20PAD_LEFT%20PAD_RIGHT%20PAD_VENDOR%22.split(%22%20%22),%20axes:[%22PAD_L_STICK_X%22,%22PAD_L_STICK_Y%22,%22PAD_R_STICK_X%22,%22PAD_R_STICK_Y%22]}},b={%22Product:%200268%22:%22PS3%22};f.prototype={update:function(){var%20a=this.poll(),b,g=a.length;for(b=0;b%3Cg;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var%20a=[];if(this.gamepadsSupported){var%20b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),g,f=b.length;for(g=0;g%3Cf;g++)b[g]&&a.push({map:this.getMap(b[g]),pad:b[g]})}return%20a},getMap:function(d){for(var%20e%20in%20b)if(0%3C=d.id.indexOf(e))return%20a[b[e]];%20return%20a.DEFAULT},isPressed:function(a,b){return!this.current[a]?!1:this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed},wasPressed:function(a,b){if(!this.current[a])return!1;var%20g=pc[this.current[a].map.buttons[b]];return%20this.current[a].pad.buttons[g].pressed&&!this.previous[a].pad.buttons[g].pressed},getAxis:function(a,b){if(!this.current[a])return!1;var%20g=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(g)%3Cthis.deadZone&&(g=0);return%20g}};return{GamePads:f}}());pc.extend(pc,function(){var%20f=function(b,e){this.element=e.target;this.event=e;this.touches=[];this.changedTouches=[];if(e){var%20g,f=e.touches.length;for(g=0;g%3Cf;g++)this.touches.push(new%20a(e.touches[g]));f=e.changedTouches.length;for(g=0;g%3Cf;g++)this.changedTouches.push(new%20a(e.changedTouches[g]))}};f.prototype={getTouchById:function(a,b){var%20g,f=b.length;for(g=0;g%3Cf;g++)if(b[g].id===a)return%20b[g];return%20null}};var%20a=function(a){var%20b=pc.getTouchTargetCoords(a);this.id=a.identifier;this.x=b.x;this.y=%20b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener(%22touchstart%22,this._startHandler,!1);this._element.addEventListener(%22touchend%22,this._endHandler,%20!1);this._element.addEventListener(%22touchmove%22,this._moveHandler,!1);this._element.addEventListener(%22touchcancel%22,this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener(%22touchstart%22,this._startHandler,!1),this._element.removeEventListener(%22touchend%22,this._endHandler,!1),this._element.removeEventListener(%22touchmove%22,this._moveHandler,!1),this._element.removeEventListener(%22touchcancel%22,this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire(%22touchstart%22,%20new%20f(this,a))},_handleTouchEnd:function(a){this.fire(%22touchend%22,new%20f(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire(%22touchmove%22,new%20f(this,a))},_handleTouchCancel:function(a){this.fire(%22touchcancel%22,new%20f(this,a))}};return{getTouchTargetCoords:function(a){for(var%20b=0,g=0,f=a.target;!(f%20instanceof%20HTMLElement);)f=f.parentNode;do%20b+=f.offsetLeft-f.scrollLeft,g+=f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-g}},TouchDevice:b}}());pc.extend(pc,function(){var%20f=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};f.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};f.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};f.prototype.disableContextMenu=%20function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};f.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};f.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var%20b%20in%20this._axes)this._axesValues[b]=[]};f.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw%20Error(pc.string.format(%22Action:%20{0}%20already%20registered%22,%20a));if(void%200===b)throw%20Error(%22Invalid%20button%22);b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.ACTION_KEYBOARD,keys:b}]};f.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void%200===b)throw%20Error(%22Invalid%20button%22);this._actions[a]?this._actions[a].push({type:pc.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.ACTION_MOUSE,button:-b}]};f.prototype.registerPadButton=function(a,b,d){if(void%200===d)throw%20Error(%22Invalid%20button%22);%20this._actions[a]?this._actions[a].push({type:pc.ACTION_GAMEPAD,button:d,pad:b}):this._actions[a]=[{type:pc.ACTION_GAMEPAD,button:d,pad:b}]};f.prototype.registerAxis=function(a){var%20b=a.name;this._axes[b]||(this._axes[b]=[]);var%20d=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.PAD_1;var%20e=function(e,f,k,n){switch(f){case%20%22mousex%22:e._mouse.on(pc.EVENT_MOUSEMOVE,function(a){e._axesValues[b][d]=a.dx/10});break;case%20%22mousey%22:e._mouse.on(pc.EVENT_MOUSEMOVE,function(a){e._axesValues[b][d]=a.dy/10});break;%20case%20%22key%22:e._axes[b].push(function(){return%20e._keyboard.isPressed(n)?k:0});break;case%20%22padrx%22:e._axes[b].push(function(){return%20e._gamepads.getAxis(a.pad,pc.PAD_R_STICK_X)});break;case%20%22padry%22:e._axes[b].push(function(){return%20e._gamepads.getAxis(a.pad,pc.PAD_R_STICK_Y)});break;case%20%22padlx%22:e._axes[b].push(function(){return%20e._gamepads.getAxis(a.pad,pc.PAD_L_STICK_X)});break;case%20%22padly%22:e._axes[b].push(function(){return%20e._gamepads.getAxis(a.pad,pc.PAD_L_STICK_Y)});break;default:throw%20Error(%22Unknown%20axis%22);%20}};e(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&e(this,a.negative,-1,a.negativeKey)};f.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var%20b,d=0,e=this._actions[a].length,d=0;d%3Ce;++d)switch(b=this._actions[a][d],b.type){case%20pc.ACTION_KEYBOARD:if(this._keyboard){var%20g,f=b.keys.length;for(g=0;g%3Cf;g++)if(this._keyboard.isPressed(b.keys[g]))return!0}break;case%20pc.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(b.button))return!0;break;case%20pc.ACTION_GAMEPAD:if(this._gamepads&&%20this._gamepads.isPressed(b.pad,b.button))return!0}return!1};f.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var%20b=0,d=this._actions[a].length,b=0;b%3Cd;++b){var%20e=this._actions[a][b];switch(e.type){case%20pc.ACTION_KEYBOARD:if(this._keyboard){var%20g,f=e.keys.length;for(g=0;g%3Cf;g++)if(this._keyboard.wasPressed(e.keys[g]))return!0}break;case%20pc.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;break;case%20pc.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,%20e.button))return!0}}return!1};f.prototype.getAxis=function(a){var%20b=0;if(this._axes[a]){var%20d,e=this._axes[a].length;for(d=0;d%3Ce;d++)if(%22function%22===pc.type(this._axes[a][d])){var%20g=this._axes[a][d]();Math.abs(g)%3EMath.abs(b)&&(b=g)}else%20this._axesValues[a]&&Math.abs(this._axesValues[a][d])%3EMath.abs(b)&&(b=this._axesValues[a][d])}return%20b};f.prototype._enableMouse=function(){this._mouse=new%20pc.Mouse;if(!this._element)throw%20Error(%22Controller%20must%20be%20attached%20to%20an%20Element%22);this._mouse.attach(this._element)};%20f.prototype._enableKeyboard=function(){this._keyboard=new%20pc.Keyboard;if(!this._element)throw%20Error(%22Controller%20must%20be%20attached%20to%20an%20Element%22);this._keyboard.attach(this._element)};return{Controller:f}}());pc.extend(pc,function(){var%20f=function(){};f.ContentType={FORM_URLENCODED:%22application/x-www-form-urlencoded%22,GIF:%22image/gif%22,JPEG:%22image/jpeg%22,DDS:%22image/dds%22,JSON:%22application/json%22,PNG:%22image/png%22,TEXT:%22text/plain%22,XML:%22application/xml%22,WAV:%22audio/x-wav%22,OGG:%22audio/ogg%22,MP3:%22audio/mpeg%22,BIN:%22application/octet-stream%22};f.ResponseType={TEXT:%22text%22,ARRAY_BUFFER:%22arraybuffer%22,BLOB:%22blob%22,DOCUMENT:%22document%22};f.binaryExtensions=[%22.model%22,%22.wav%22,%22.ogg%22,%22.mp3%22,%22.dds%22];f.prototype={ContentType:f.ContentType,%20ResponseType:f.ResponseType,binaryExtensions:f.binaryExtensions,get:function(a,b,d){%22function%22===typeof%20b&&(d=b,b={});return%20this.request(%22GET%22,a,b,d)},post:function(a,b,d,e){%22function%22===typeof%20d&&(e=d,d={});d.postdata=b;return%20this.request(%22POST%22,a,d,e)},put:function(a,b,d,e){%22function%22===typeof%20d&&(e=d,d={});d.postdata=b;return%20this.request(%22PUT%22,a,d,e)},del:function(a,b,d){%22function%22===typeof%20b&&(d=b,b={});return%20this.request(%22DELETE%22,a,b,d)},request:function(a,b,d,e){var%20g,h,k,n=!1;%22function%22===%20typeof%20d&&(e=d,d={});d.callback=e;null==d.async&&(d.async=!0);null==d.headers&&(d.headers={});if(null!=d.postdata)if(d.postdata%20instanceof%20Document)h=d.postdata;else%20if(d.postdata%20instanceof%20FormData)h=d.postdata;else%20if(d.postdata%20instanceof%20Object)switch(h=d.headers[%22Content-Type%22],void%200===h&&(d.headers[%22Content-Type%22]=f.ContentType.FORM_URLENCODED,h=d.headers[%22Content-Type%22]),h){case%20f.ContentType.FORM_URLENCODED:h=%22%22;e=!0;for(g%20in%20d.postdata)d.postdata.hasOwnProperty(g)&&(e?e=!1:h+=%22&%22,h+=escape(g)+%20%22=%22+escape(d.postdata[g]));break;default:null==h&&(d.headers[%22Content-Type%22]=f.ContentType.JSON),h=JSON.stringify(d.postdata)}else%20h=d.postdata;k||(k=new%20XMLHttpRequest);!1===d.cache&&(e=pc.time.now(),g=new%20pc.URI(b),g.query=g.query?g.query+%22&ts=%22+e:%22ts=%22+e,b=g.toString());d.query&&(g=new%20pc.URI(b),e=pc.extend(g.getQuery(),d.query),g.setQuery(e),b=g.toString());k.open(a,b,d.async);k.withCredentials=void%200!==d.withCredentials?d.withCredentials:!1;k.responseType=d.responseType||this._guessResponseType(b);%20for(var%20r%20in%20d.headers)d.headers.hasOwnProperty(r)&&k.setRequestHeader(r,d.headers[r]);k.onreadystatechange=function(){this._onReadyStateChange(a,b,d,k)}.bind(this);k.onerror=function(){this._onError(a,b,d,k);n=!0}.bind(this);try{k.send(h)}catch(u){n||d.error(k.status,k,u)}return%20k},_guessResponseType:function(a){a=new%20pc.URI(a);a=pc.path.getExtension(a.path);return%200%3C=f.binaryExtensions.indexOf(a)?f.ResponseType.ARRAY_BUFFER:f.ResponseType.TEXT},_isBinaryContentType:function(a){return%200%3C=[f.ContentType.WAV,%20f.ContentType.OGG,f.ContentType.MP3,f.ContentType.BIN,f.ContentType.DDS].indexOf(a)?!0:!1},_onReadyStateChange:function(a,b,d,e){if(4===e.readyState)switch(e.status){case%200:%22/%22!=b[0]&&this._onSuccess(a,b,d,e);break;case%20200:case%20201:case%20206:case%20304:this._onSuccess(a,b,d,e);break;default:this._onError(a,b,d,e)}},_onSuccess:function(a,b,d,e){var%20g;if(a=e.getResponseHeader(%22Content-Type%22))a=a.split(%22;%22),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||b.split(%22?%22)[0].endsWith(%22.json%22)?b=%20JSON.parse(e.responseText):this._isBinaryContentType(g)?b=e.response:e.responseType===f.ResponseType.ARRAY_BUFFER?(logWARNING(pc.string.format(%22responseType:%20{0}%20being%20served%20with%20Content-Type:%20{1}%22,f.ResponseType.ARRAY_BUFFER,g)),b=e.response):b=e.responseType===f.ResponseType.DOCUMENT||g===this.ContentType.XML?e.responseXML:e.responseText;d.callback(null,b)},_onError:function(a,b,d,e){d.callback(e.status,null)}};return{Http:f,http:new%20f}}());pc.script=function(){var%20f={app:null,create:function(a,b){void%200===b&&(b=attributes);var%20d=b(pc.script.app);d._pcScriptName=a;pc.ScriptHandler._push(d);this.fire(%22created%22,a,b)},attribute:function(){},createLoadingScreen:function(a){var%20b=pc.Application.getApplication();a(b)}};pc.events.attach(f);return%20f}();pc.extend(pc,function(){return{ContentFile:function(f){this.packs=f.packs||{};this.appProperties=f.application_properties||{};this.toc=f.toc||{}}}}());pc.extend(pc,function(){return{Pack:function(f){this.hierarchy=f.hierarchy;this.settings=f.settings}}}());pc.extend(pc,function(){var%20f=function(a,d){d=d||{};pc.log.open();pc.events.attach(this);f._applications[a.id]=this;f._currentApplication=this;this._time=0;this.timeScale=1;this._librariesLoaded=!1;this._fillMode=pc.FILLMODE_KEEP_ASPECT;this._resolutionMode=pc.RESOLUTION_FIXED;this.context=this;this.graphicsDevice=new%20pc.GraphicsDevice(a,d.graphicsDeviceOptions);this.stats=new%20pc.ApplicationStats(this.graphicsDevice);this.systems=new%20pc.ComponentSystemRegistry;this._audioManager=new%20pc.SoundManager;%20this.loader=new%20pc.ResourceLoader;this.scene=new%20pc.Scene;this.root=new%20pc.Entity(this);this.root._enabledInHierarchy=!0;this.assets=new%20pc.AssetRegistry(this.loader);this.renderer=new%20pc.ForwardRenderer(this.graphicsDevice);this.lightmapper=new%20pc.Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once(%22prerender%22,this._firstBake,this);this.keyboard=d.keyboard||null;this.mouse=d.mouse||null;this.touch=d.touch||null;this.gamepads=d.gamepads||null;this._inTools=!1;%20this._skyboxLast=0;this._scriptPrefix=d.scriptPrefix||%22%22;this.loader.addHandler(%22animation%22,new%20pc.AnimationHandler);this.loader.addHandler(%22model%22,new%20pc.ModelHandler(this.graphicsDevice));this.loader.addHandler(%22material%22,new%20pc.MaterialHandler(this.assets));this.loader.addHandler(%22texture%22,new%20pc.TextureHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler(%22text%22,new%20pc.TextHandler);this.loader.addHandler(%22json%22,new%20pc.JsonHandler);this.loader.addHandler(%22audio%22,new%20pc.AudioHandler(this._audioManager));%20this.loader.addHandler(%22script%22,new%20pc.ScriptHandler(this));this.loader.addHandler(%22scene%22,new%20pc.SceneHandler(this));this.loader.addHandler(%22cubemap%22,new%20pc.CubemapHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler(%22html%22,new%20pc.HtmlHandler);this.loader.addHandler(%22css%22,new%20pc.CssHandler);this.loader.addHandler(%22shader%22,new%20pc.ShaderHandler);this.loader.addHandler(%22hierarchy%22,new%20pc.HierarchyHandler(this));this.loader.addHandler(%22scenesettings%22,new%20pc.SceneSettingsHandler(this));%20this.loader.addHandler(%22folder%22,new%20pc.FolderHandler);new%20pc.RigidBodyComponentSystem(this);new%20pc.CollisionComponentSystem(this);new%20pc.AnimationComponentSystem(this);new%20pc.ModelComponentSystem(this);new%20pc.CameraComponentSystem(this);new%20pc.LightComponentSystem(this);new%20pc.ScriptComponentSystem(this,d.scriptPrefix);new%20pc.AudioSourceComponentSystem(this,this._audioManager);new%20pc.SoundComponentSystem(this,this._audioManager);new%20pc.AudioListenerComponentSystem(this,this._audioManager);new%20pc.ParticleSystemComponentSystem(this);%20this._visibilityChangeHandler=this.onVisibilityChange.bind(this);void%200!==document.hidden?(this._hiddenAttr=%22hidden%22,document.addEventListener(%22visibilitychange%22,this._visibilityChangeHandler,!1)):void%200!==document.mozHidden?(this._hiddenAttr=%22mozHidden%22,document.addEventListener(%22mozvisibilitychange%22,this._visibilityChangeHandler,!1)):void%200!==document.msHidden?(this._hiddenAttr=%22msHidden%22,document.addEventListener(%22msvisibilitychange%22,this._visibilityChangeHandler,!1)):void%200!==document.webkitHidden&&%20(this._hiddenAttr=%22webkitHidden%22,document.addEventListener(%22webkitvisibilitychange%22,this._visibilityChangeHandler,!1))};f._currentApplication=null;f._applications={};f.getApplication=function(a){return%20a?f._applications[a]:f._currentApplication};var%20a=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return%20this.count===this.length}};f.prototype={configure:function(a,d){var%20e=this;pc.http.get(a,function(a,b){if(a)d(a);else{var%20f=b.assets;e._parseApplicationProperties(b.application_properties,%20function(a){e._parseAssets(f);a?d(a):d(null)})}})},preload:function(b){var%20d=this;d.fire(%22preload:start%22);var%20e=this.assets.list({preload:!0}),g=new%20a(e.length),f=!1,k=function(){d.graphicsDevice&&(!f&&g.done())&&(f=!0,d.fire(%22preload:end%22),b())},n=e.length,r;if(g.length){var%20u=function(){g.inc();d.fire(%22preload:progress%22,g.count/n);g.done()&&k()},l=function(){g.inc();d.fire(%22preload:progress%22,g.count/n);g.done()&&k()};for(r=0;r%3Cg.length;r++)e[r].loaded?(g.inc(),d.fire(%22preload:progress%22,g.count/%20n),g.done()&&k()):(e[r].once(%22load%22,u),e[r].once(%22error%22,l),this.assets.load(e[r]))}else%20k()},loadSceneHierarchy:function(a,d){var%20e=this,g=this.loader.getHandler(%22hierarchy%22);g.load(a,function(f,k){this._preloadScripts(k,function(){var%20n=g.open(a,k);e.loader.clearCache(a,%22hierarchy%22);e.root.addChild(n);pc.ComponentSystem.initialize(n);pc.ComponentSystem.postInitialize(n);d&&d(f,n)})}.bind(this))},loadSceneSettings:function(a,d){this.loader.load(a,%22scenesettings%22,function(a,b){a?d&&d(a):(this.applySceneSettings(b),%20d&&d(null))}.bind(this))},loadScene:function(a,d){var%20e=this,g=this.loader.getHandler(%22scene%22);g.load(a,function(f,k){f?d&&d(f):this._preloadScripts(k,function(){var%20f=g.open(a,k);e.loader.clearCache(a,%22scene%22);e.loader.patch({resource:f,type:%22scene%22},e.assets);e.root.addChild(f.root);e.systems.rigidbody&&%22undefined%22!==typeof%20Ammo&&e.systems.rigidbody.setGravity(f._gravity.x,f._gravity.y,f._gravity.z);d&&d(null,f)})}.bind(this))},_preloadScripts:function(b,d){var%20e=this;e.systems.script.preloading=%20!0;var%20g=this._getScriptReferences(b),f=0,k=g.length,n=new%20a(k),r,u=/^http(s)?:\/\//;if(k)for(var%20l=function(a){a&&console.error(a);n.inc();n.done()&&(e.systems.script.preloading=!1,d())},f=0;f%3Ck;f++)r=g[f],!u.test(r.toLowerCase())&&e.systems.script._prefix&&(r=pc.path.join(e.systems.script._prefix,g[f])),this.loader.load(r,%22script%22,l);else%20e.systems.script.preloading=!1,d()},_parseApplicationProperties:function(a,d){this._width=a.width;this._height=a.height;a.use_device_pixel_ratio&&(this.graphicsDevice.maxPixelRatio=%20window.devicePixelRatio);this.setCanvasResolution(a.resolution_mode,this._width,this._height);this.setCanvasFillMode(a.fill_mode,this._width,this._height);this._loadLibraries(a.libraries,d)},_loadLibraries:function(a,d){var%20e=a.length,g=e,f=this;if(e)for(var%20k=function(a){g--;a?d(a):0===g&&(f.onLibrariesLoaded(),d(null))},n=0;n%3Ce;++n)this.loader.load(a[n],%22script%22,k);else%20d(null)},_parseAssets:function(a){for(var%20d%20in%20a){var%20e=a[d],g=new%20pc.Asset(e.name,e.type,e.file,e.data);g.id=parseInt(d);g.preload=%20e.preload?e.preload:!1;g.tags.add(e.tags);this.assets.add(g)}},_getScriptReferences:function(a){var%20d,e,g=[];a.settings.priority_scripts&&(g=a.settings.priority_scripts);var%20f=[],k={};for(d=0;d%3Cg.length;d++)f.push(g[d]),k[g[d]]=!0;a=a.entities;for(e%20in%20a)if(a[e].components.script){g=a[e].components.script.scripts;for(d=0;d%3Cg.length;d++)k[g[d].url]||(f.push(g[d].url),k[g[d].url]=!0)}return%20f},start:function(){this.fire(%22start%22,{timestamp:pc.now(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();%20pc.ComponentSystem.initialize(this.root);pc.ComponentSystem.postInitialize(this.root);this.tick()},update:function(a){this.graphicsDevice.updateClientRect();this.stats.frame.updateStart=pc.now();pc.ComponentSystem.fixedUpdate(1/60,this._inTools);pc.ComponentSystem.update(a,this._inTools);pc.ComponentSystem.postUpdate(a,this._inTools);this.fire(%22update%22,a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a);%20this.stats.frame.updateTime=pc.now()-this.stats.frame.updateStart},render:function(){this.stats.frame.renderStart=pc.now();this.fire(%22prerender%22,null);var%20a=this.systems.camera.cameras,d=null,e=this.renderer;this.root.syncHierarchy();for(var%20g=0,f=a.length;g%3Cf;g++)d=a[g],d.frameBegin(),e.render(this.scene,d.camera),d.frameEnd();this.stats.frame.renderTime=pc.now()-this.stats.frame.renderStart},_fillFrameStats:function(a,d,e){var%20g=this.stats.frame;g.dt=d;g.ms=e;a%3Eg._timeToCountFrames?(g.fps=g._fpsAccum,%20g._fpsAccum=0,g._timeToCountFrames=a+1E3):g._fpsAccum++;g.cameras=this.renderer._camerasRendered;g.materials=this.renderer._materialSwitches;g.shaders=this.graphicsDevice._shaderSwitchesPerFrame;g.shadowMapUpdates=this.renderer._shadowMapUpdates;a=this.graphicsDevice._primsPerFrame;g.triangles=a[pc.PRIMITIVE_TRIANGLES]/3+Math.max(a[pc.PRIMITIVE_TRISTRIP]-2,0)+Math.max(a[pc.PRIMITIVE_TRIFAN]-2,0);g.cullTime=this.renderer._cullTime;for(d=g.otherPrimitives=0;d%3Ca.length;d++)d%3Cpc.PRIMITIVE_TRIANGLES&&%20(g.otherPrimitives+=a[d]),a[d]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;g=this.stats.drawCalls;g.forward=this.renderer._forwardDrawCalls;g.depth=this.renderer._depthDrawCalls;g.shadow=this.renderer._shadowDrawCalls;g.skinned=this.renderer._skinDrawCalls;g.immediate=this.renderer._immediateRendered;g.instanced=this.renderer._instancedDrawCalls;g.removedByInstancing=%20this.renderer._removedByInstancing;g.total=this.graphicsDevice._drawCallsPerFrame;g.misc=g.total-(g.forward+g.depth+g.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0},tick:function(){if(this.graphicsDevice){f._currentApplication=this;window.requestAnimationFrame(this.tick.bind(this));%20var%20a=pc.now(),d=a-(this._time||a),e;this._time=a;e=pc.math.clamp(d/1E3,0,0.1);e*=this.timeScale;this._fillFrameStats(a,e,d);this.fire(%22frameEnd%22,{timestamp:a,target:this});this.update(e);this.render()}},setCanvasFillMode:function(a,d,e){this._fillMode=a;this.resizeCanvas(d,e)},setCanvasResolution:function(a,d,e){this._resolutionMode=a;a===pc.RESOLUTION_AUTO&&void%200===d&&(d=this.graphicsDevice.canvas.clientWidth,e=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(d,e)},isFullscreen:function(){return!!document.fullscreenElement},%20enableFullscreen:function(a,d,e){var%20a=a||this.graphicsDevice.canvas,g=function(){d();document.removeEventListener(%22fullscreenchange%22,g)},f=function(){e();document.removeEventListener(%22fullscreenerror%22,f)};d&&document.addEventListener(%22fullscreenchange%22,g,!1);e&&document.addEventListener(%22fullscreenerror%22,f,!1);a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},disableFullscreen:function(a){var%20d=function(){a();document.removeEventListener(%22fullscreenchange%22,d)};a&&document.addEventListener(%22fullscreenchange%22,%20d,!1);document.exitFullscreen()},isHidden:function(){return%20document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(a,d){var%20e=window.innerWidth,g=window.innerHeight;if(navigator.isCocoonJS)a=e,d=g,this.graphicsDevice.resizeCanvas(a,d);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var%20f=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;f%3Ee/g?(a=e,d=a/f):(d=g,a=d*f)}else%20this._fillMode===%20pc.FILLMODE_FILL_WINDOW&&(a=e,d=g);this.graphicsDevice.canvas.style.width=a+%22px%22;this.graphicsDevice.canvas.style.height=d+%22px%22;this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:a,height:d}},onLibrariesLoaded:function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded();this.systems.collision.onLibraryLoaded()},applySceneSettings:function(a){var%20d;this.systems.rigidbody&&%22undefined%22!==typeof%20Ammo&&(d=a.physics.gravity,this.systems.rigidbody.setGravity(d[0],%20d[1],d[2]));this.scene.applySettings(a);if(a.render.skybox&&this._skyboxLast!==a.render.skybox){this._skyboxLast&&(this.assets.off(%22add:%22+this._skyboxLast,this._onSkyboxAdd,this),this.assets.off(%22load:%22+this._skyboxLast,this._onSkyBoxLoad,this),this.assets.off(%22remove:%22+this._skyboxLast,this._onSkyboxRemove,this));this._skyboxLast=a.render.skybox;d=this.assets.get(a.render.skybox);this.assets.on(%22load:%22+a.render.skybox,this._onSkyBoxLoad,this);this.assets.once(%22remove:%22+a.render.skybox,this._onSkyboxRemove,%20this);if(!d)this.assets.once(%22add:%22+a.render.skybox,this._onSkyboxAdd,this);d&&(d.resource&&this.scene.setSkybox(d.resources),this._onSkyboxAdd(d))}else%20a.render.skybox?0===this.scene.skyboxMip&&a.render.skybox&&(d=this.assets.get(a.render.skybox))&&this._onSkyboxAdd(d):this._onSkyboxRemove({id:this._skyboxLast})},_onSkyboxAdd:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a)},_onSkyBoxLoad:function(a){this.scene.setSkybox(a.resources)},_onSkyboxRemove:function(a){this.assets.off(%22add:%22+%20a.id,this._onSkyboxAdd,this);this.assets.off(%22load:%22+a.id,this._onSkyBoxLoad,this);this.scene.setSkybox(null);this._skyboxLast=null},_firstBake:function(){this.lightmapper.bake()},destroy:function(){f._applications[this.graphicsDevice.canvas.id]=null;this.off(%22librariesloaded%22);document.removeEventListener(%22visibilitychange%22,this._visibilityChangeHandler);document.removeEventListener(%22mozvisibilitychange%22,this._visibilityChangeHandler);document.removeEventListener(%22msvisibilitychange%22,this._visibilityChangeHandler);%20document.removeEventListener(%22webkitvisibilitychange%22,this._visibilityChangeHandler);this.mouse&&(this.mouse.off(%22mouseup%22),this.mouse.off(%22mousedown%22),this.mouse.off(%22mousewheel%22),this.mouse.off(%22mousemove%22),this.mouse=null);this.keyboard&&(this.keyboard.off(%22keydown%22),this.keyboard.off(%22keyup%22),this.keyboard.off(%22keypress%22),this.keyboard=null);this.touch&&(this.touch.off(%22touchstart%22),this.touch.off(%22touchend%22),this.touch.off(%22touchmove%22),this.touch.off(%22touchcancel%22),this.touch=null);this.controller&&%20(this.controller=null);this.root.destroy();pc.ComponentSystem.destroy();this.loader.destroy();this.scene=this.loader=null;this.systems=[];this.renderer=this.graphicsDevice=this.context=null;this._audioManager&&(this._audioManager.destroy(),this._audioManager=null);pc.http=new%20pc.Http}};return{FILLMODE_NONE:%22NONE%22,FILLMODE_FILL_WINDOW:%22FILL_WINDOW%22,FILLMODE_KEEP_ASPECT:%22KEEP_ASPECT%22,RESOLUTION_AUTO:%22AUTO%22,RESOLUTION_FIXED:%22FIXED%22,Application:f}}());pc.ApplicationStats=function(f){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.vram=f._vram;this.shaders=f._shaderStats;Object.defineProperty(this.vram,%22totalUsed%22,{get:function(){return%20this.tex+%20this.vb+this.ib}});Object.defineProperty(this,%22scene%22,{get:function(){return%20pc.Application._currentApplication.scene._stats}});Object.defineProperty(this,%22lightmapper%22,{get:function(){return%20pc.Application._currentApplication.lightmapper._stats}});pc.events.attach(this)};pc.extend(pc,function(){var%20f=function(){};f.prototype={add:function(a,b){if(this[a])throw%20Error(pc.string.format(%22ComponentSystem%20name%20'{0}'%20already%20registered%20or%20not%20allowed%22,a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw%20Error(pc.string.format(%22No%20ComponentSystem%20named%20'{0}'%20registered%22,a));delete%20this[a]},list:function(){var%20a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,e){var%20g=b[a]||1,f=b[e]||1;return%20g%3Cf?-1:g%3Ef?1:0});return%20a.map(function(a){return%20this[a]},%20this)},getComponentSystemOrder:function(){var%20a,b=Object.keys(this);a=b.indexOf(%22collisionrect%22);b.splice(a,1);b.unshift(%22collisionrect%22);a=b.indexOf(%22collisioncircle%22);b.splice(a,1);b.unshift(%22collisioncircle%22);return%20b}};return{ComponentSystemRegistry:f}}());pc.extend(pc,function(){var%20f=function(a){this.app=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(f,{initialize:function(a){f.fire(%22initialize%22,a)},postInitialize:function(a){f.fire(%22postInitialize%22,a)},update:function(a,b){b?f.fire(%22toolsUpdate%22,a):f.fire(%22update%22,a)},fixedUpdate:function(a){f.fire(%22fixedUpdate%22,a)},postUpdate:function(a){f.fire(%22postUpdate%22,a)}});f.prototype={get%20store(){return%20this.dataStore},addComponent:function(a,b){var%20d=new%20this.ComponentType(this,a),%20e=new%20this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:e};a[this.id]=d;a.c[this.id]=d;this.initializeComponentData(d,b,[]);this.fire(%22add%22,a,d);return%20d},removeComponent:function(a){var%20b=this.dataStore[a.getGuid()];this.fire(%22beforeremove%22,a,a.c[this.id]);delete%20this.dataStore[a.getGuid()];delete%20a[this.id];delete%20a.c[this.id];this.fire(%22remove%22,a,b.data)},cloneComponent:function(a,b){var%20d=this.dataStore[a.getGuid()];return%20this.addComponent(b,d.data)},initializeComponentData:function(a,%20b,d){b=b||{};d.forEach(function(d){a[d]=void%200!==b[d]?b[d]:a.data[d]},this);if(a.enabled&&a.entity.enabled)a.onEnable()}};pc.events.attach(f);f.destroy=function(){f.off(%22initialize%22);f.off(%22postInitialize%22);f.off(%22toolsUpdate%22);f.off(%22update%22);f.off(%22fixedUpdate%22);f.off(%22postUpdate%22)};return{ComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.system.schema&&this.buildAccessors(this.system.schema);this.on(%22set%22,function(a,b,g){this.fire(%22set_%22+a,a,b,g)});this.on(%22set_enabled%22,this.onSetEnabled,this)};f.prototype={get%20data(){var%20a=this.system.store[this.entity.getGuid()];return%20a?a.data:null},buildAccessors:function(a){var%20b=this;a.forEach(function(a){Object.defineProperty(b,a,{get:function(){return%20b.data[a]},set:function(e){var%20g=b.data,%20f=g[a];g[a]=e;b.fire(%22set%22,a,f,e)},configurable:!0})})},onSetEnabled:function(a,b,d){if(b!==d&&this.entity.enabled)if(d)this.onEnable();else%20this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:f}}());pc.extend(pc,function(){return{ComponentData:function(){}}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_animations%22,this.onSetAnimations,this);this.on(%22set_assets%22,this.onSetAssets,this);this.on(%22set_loop%22,this.onSetLoop,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var%20b=b||0,d=this.data;d.prevAnim=d.currAnim;d.currAnim=a;d.model&&(d.blending=0%3Cb&&d.prevAnim,d.blending?(d.blendTime=b,d.blendTimeRemaining=b,d.fromSkel.setAnimation(d.animations[d.prevAnim]),%20d.fromSkel.addTime(d.skeleton.getCurrentTime()),d.toSkel.setAnimation(d.animations[d.currAnim])):d.skeleton.setAnimation(d.animations[d.currAnim]));d.playing=!0}}else%20console.error(pc.string.format(%22Trying%20to%20play%20animation%20'{0}'%20which%20doesn't%20exist%22,a))},getAnimation:function(a){return%20this.data.animations[a]},setModel:function(a){var%20b=this.data;if(a){var%20d=a.getGraph();b.fromSkel=new%20pc.Skeleton(d);b.toSkel=new%20pc.Skeleton(d);b.skeleton=new%20pc.Skeleton(d);b.skeleton.setLooping(b.loop);b.skeleton.setGraph(d)}b.model=%20a;b.animations&&(b.currAnim&&b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){var%20b=this,d=this.system.app.assets,e,g=a.length,f=function(a){b.animations[a.name]=a.resource;b.animations=b.animations},k=function(a){a.off(%22change%22,b.onAssetChanged,b);a.on(%22change%22,b.onAssetChanged,b);a.off(%22remove%22,b.onAssetRemoved,b);a.on(%22remove%22,b.onAssetRemoved,b);a.resource?f(a):(a.once(%22load%22,f,b),b.enabled&&b.entity.enabled&&d.load(a))};for(e=0;e%3Cg;e++){var%20n=%20d.get(a[e]);if(n)k(n);else%20d.on(%22add:%22+a[e],k)}}},onAssetChanged:function(a,b,d){%22resource%22===b&&(d?(this.animations[a.name]=d,this.data.currAnim===a.name&&this.data.playing&&(this.data.enabled&&this.entity.enabled)&&this.play(a.name,0)):delete%20this.animations[a.name])},onAssetRemoved:function(a){a.off(%22remove%22,this.onAssetRemoved,this);this.animations&&this.animations[a.name]&&(delete%20this.animations[a.name],this.data.currAnim===a.name&&this._stopCurrentAnimation())},_stopCurrentAnimation:function(){this.data.currAnim=%20null;this.data.playing=!1;this.data.skeleton&&(this.data.skeleton.setCurrentTime(0),this.data.skeleton.setAnimation(null))},onSetAnimations:function(){var%20a=this.data,b=this.entity.model;b&&(b=b.model)&&b!==a.model&&this.entity.animation.setModel(b);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled&&!this.system._inTools)for(var%20d%20in%20a.animations){this.play(d,0);break}},onSetAssets:function(a,b,d){if(b&&b.length)for(a=0;a%3Cb.length;a++)if(b[a]){var%20e=this.system.app.assets.get(b[a]);e&&(e.off(%22change%22,%20this.onAssetChanged,this),e.off(%22remove%22,this.onAssetRemoved,this),this.data.currAnim===e.name&&this._stopCurrentAnimation())}b=d.map(function(a){return%20a%20instanceof%20pc.Asset?a.id:a});this.loadAnimationAssets(b)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},onSetCurrentTime:function(a,b,d){this.data.skeleton.setCurrentTime(d);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){f._super.onEnable.call(this);var%20a=this.data.assets,%20b=this.system.app.assets;if(a)for(var%20d=0,e=a.length;d%3Ce;d++){var%20g=a[d];g%20instanceof%20pc.Asset||(g=b.get(g));g&&!g.resource&&b.load(g)}if(this.data.activate&&!this.data.currAnim&&!this.system._inTools)for(var%20h%20in%20this.data.animations){this.play(h,0);break}}});Object.defineProperties(f.prototype,{currentTime:{get:function(){return%20this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return%20this.data.animations[this.data.currAnim].getDuration()}}});%20return{AnimationComponent:f}}());pc.extend(pc,function(){var%20f=function(a){this.id=%22animation%22;this.description=%22Specifies%20the%20animation%20assets%20that%20can%20run%20on%20the%20model%20specified%20by%20the%20Entity's%20model%20Component.%22;a.systems.add(this.id,this);this.ComponentType=pc.AnimationComponent;this.DataType=pc.AnimationComponentData;this.schema=%22enabled%20assets%20speed%20loop%20activate%20animations%20skeleton%20model%20prevAnim%20currAnim%20fromSkel%20toSkel%20blending%20blendTimeRemaining%20playing%22.split(%22%20%22);this.on(%22remove%22,this.onRemove,this);this.on(%22update%22,this.onUpdate,%20this);pc.ComponentSystem.on(%22update%22,this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=[%22activate%22,%22enabled%22,%22loop%22,%22speed%22,%22assets%22];f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=%20a.animation.enabled;var%20d={},e=a.animation.animations,g;for(g%20in%20e)e.hasOwnProperty(g)&&(d[g]=e[g]);b.animation.animations=d},onRemove:function(a,b){delete%20b.animation;delete%20b.skeleton;delete%20b.fromSkel;delete%20b.toSkel},onUpdate:function(a){var%20b=this.store,d;for(d%20in%20b)if(b.hasOwnProperty(d)){var%20e=b[d],g=e.data;g.enabled&&(g.playing&&e.entity.enabled)&&(e=g.skeleton,null!==e&&null!==g.model&&(g.blending?(g.blendTimeRemaining-=a,0%3Eg.blendTimeRemaining&&(g.blendTimeRemaining=0),e.blend(g.fromSkel,%20g.toSkel,1-g.blendTimeRemaining/g.blendTime)):(e.addTime(a*g.speed),e.getCurrentTime()===e.getAnimation().getDuration()&&!g.loop&&(g.playing=!1)),g.blending&&0===g.blendTimeRemaining&&(g.blending=!1,e.setAnimation(g.toSkel.getAnimation())),e.updateGraph()))}}});return{AnimationComponentSystem:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.ComponentData);return{AnimationComponentData:f}}());pc.extend(pc,function(){var%20f=function(a){this.id=%22model%22;this.description=%22Renders%20a%203D%20model%20at%20the%20location%20of%20the%20Entity.%22;a.systems.add(this.id,this);this.ComponentType=pc.ModelComponent;this.DataType=pc.ModelComponentData;this.schema=%22enabled%20type%20asset%20materialAsset%20castShadows%20receiveShadows%20castShadowsLightmap%20lightmapped%20lightmapSizeMultiplier%20material%20model%20mapping%22.split(%22%20%22);a=a.graphicsDevice;this.box=pc.createBox(a,{halfExtents:new%20pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.createCapsule(a,%20{radius:0.5,height:2});this.sphere=pc.createSphere(a,{radius:0.5});this.cone=pc.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.createCylinder(a,{radius:0.5,height:1});this.plane=pc.createPlane(a,{halfExtents:new%20pc.Vec2(0.5,0.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new%20pc.PhongMaterial;this.on(%22beforeremove%22,this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){b.material=this.defaultMaterial;%20d=%22enabled%20material%20materialAsset%20asset%20castShadows%20receiveShadows%20castShadowsLightmap%20lightmapped%20lightmapSizeMultiplier%20type%20mapping%22.split(%22%20%22);f._super.initializeComponentData.call(this,a,b,d)},removeComponent:function(a){var%20b=a.model.data;a.model.asset=null;%22asset%22!==b.type&&b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);f._super.removeComponent.call(this,a)},cloneComponent:function(a,b){var%20d={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,%20receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,enabled:a.model.enabled,mapping:pc.extend({},a.model.mapping)},e=a.model.materialAsset;!(e%20instanceof%20pc.Asset)&&null!=e&&(e=app.assets.get(e));var%20g=a.model.material;if(!g||g===pc.ModelHandler.DEFAULT_MATERIAL||!e||g===e.resource)d.materialAsset=e;e=this.addComponent(b,d);d.materialAsset||(e.material=g);d=a.model.model.meshInstances;%20g=e.model.meshInstances;for(e=0;e%3Cd.length;e++)g[e].mask=d[e].mask},onRemove:function(a,b){b.remove()}});return{ModelComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_type%22,this.onSetType,this);this.on(%22set_asset%22,this.onSetAsset,this);this.on(%22set_castShadows%22,this.onSetCastShadows,this);this.on(%22set_receiveShadows%22,this.onSetReceiveShadows,this);this.on(%22set_castShadowsLightmap%22,this.onSetCastShadowsLightmap,this);this.on(%22set_lightmapped%22,this.onSetLightmapped,this);this.on(%22set_lightmapSizeMultiplier%22,this.onSetLightmapSizeMultiplier,this);this.on(%22set_model%22,this.onSetModel,this);this.on(%22set_material%22,%20this.onSetMaterial,this);this.on(%22set_mapping%22,this.onSetMapping,this);Object.defineProperty(this,%22materialAsset%22,{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)});this._assetOld=0;this._materialEvents=null;this._dirtyMaterialAsset=this._dirtyModelAsset=!1},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{setVisible:function(a){console.warn(%22WARNING:%20setVisible:%20Function%20is%20deprecated.%20Set%20enabled%20property%20instead.%22);this.enabled=a},_onAssetLoad:function(a){a.resource&&%20this._onModelLoaded(a.resource.clone())},_onAssetChange:function(a,b){%22data%22===b&&(this.mapping=this.data.mapping)},_onAssetRemove:function(a){this.asset===a.id&&(this.asset=null)},_setModelAsset:function(a){var%20b=this.system.app.assets,d=null!==a?b.get(a):null;this._dirtyModelAsset=!0;this._onModelAsset(d||null);if(!d&&null!==a)b.once(%22add:%22+a,this._onModelAsset,this)},_onModelAsset:function(a){var%20b=this.system.app.assets;if(this._assetOld){b.off(%22add:%22+this._assetOld,this._onModelAsset,this);var%20d=%20b.get(this._assetOld);d&&(d.off(%22load%22,this._onAssetLoad,this),d.off(%22change%22,this._onAssetChange,this),d.off(%22remove%22,this._onAssetRemove,this))}this._assetOld=a?a.id:0;a?(a.on(%22load%22,this._onAssetLoad,this),a.on(%22change%22,this._onAssetChange,this),a.on(%22remove%22,this._onAssetRemove,this),a.resource?(this._dirtyModelAsset=!1,this._onModelLoaded(a.resource.clone())):this.enabled&&this.entity.enabled&&(this._dirtyModelAsset=!1,b.load(a))):this._dirtyModelAsset=!1},remove:function(){this._onModelAsset(null)},%20_onModelLoaded:function(a){%22asset%22===this.data.type&&(this.model=a)},onSetType:function(a,b,d){a=this.data;if(d)if(this._area=b=null,%22asset%22===d)null!==this.data.asset?this._setModelAsset(this.data.asset):this.model=null;else{switch(d){case%20%22box%22:b=this.system.box;this._area={x:2,y:2,z:2,uv:2/3};break;case%20%22capsule%22:b=this.system.capsule;this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+2*(1/3/3)};break;case%20%22sphere%22:b=this.system.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case%20%22cone%22:b=%20this.system.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case%20%22cylinder%22:b=this.system.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+2*(1/3/3)};break;case%20%22plane%22:b=this.system.plane;this._area={x:0,y:1,z:0,uv:1};break;default:throw%20Error(%22Invalid%20model%20type:%20%22+d);}var%20d=new%20pc.GraphNode,e=new%20pc.Model;e.graph=d;e.meshInstances=[new%20pc.MeshInstance(d,b,a.material)];this.system._inTools&&e.generateWireframe();this.model=e;this.asset=null}},onSetAsset:function(a,b,d){a=null;%22asset%22===%20this.data.type&&(null!==d?(a=d,d%20instanceof%20pc.Asset&&(a=this.data.asset=d.id)):this.model=null);null===a&&(this.data.asset=null);this._setModelAsset(a)},onSetCastShadows:function(a,b,d){if(a=this.data.model){var%20b=this.system.app.scene,e=b.containsModel(a);e&&b.removeModel(a);for(var%20g=a.meshInstances,f=0;f%3Cg.length;f++)g[f].castShadow=d;e&&b.addModel(a)}},onSetCastShadowsLightmap:function(){},onSetLightmapped:function(a,b,d){if(this.data.model)if(a=this.data.model.meshInstances,d)for(d=0;d%3Ca.length;d++)b=%20a[d],b.mask=pc.MASK_BAKED;else%20for(d=0;d%3Ca.length;d++)b=a[d],b.deleteParameter(%22texture_lightMap%22),b._shaderDefs&=~pc.SHADERDEF_LM,b.mask=pc.MASK_DYNAMIC},onSetLightmapSizeMultiplier:function(a,b,d){this.data.lightmapSizeMultiplier=d},onSetModel:function(a,b,d){b&&(this.system.app.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete%20b._entity);if(d){for(var%20a=this.data,b=d.meshInstances,e=0;e%3Cb.length;e++)b[e].castShadow=a.castShadows,b[e].receiveShadow=a.receiveShadows;this.lightmapped=%20a.lightmapped;this.entity.addChild(d.graph);this.enabled&&this.entity.enabled&&this.system.app.scene.addModel(d);d._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(d);%22asset%22===this.data.type?this.mapping=this.data.mapping:this._unsetMaterialEvents()}else%20this._unsetMaterialEvents()},_onMaterialAssetRemove:function(a){var%20b=this.system.app.assets,d=isNaN(a)?a.id:a;a&&(isNaN(a)&&a.resource===this.material)&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL);b.off(%22add:%22+d,this._onMaterialAsset,%20this);b.off(%22load:%22+d,this._onMaterialAsset,this);b.off(%22remove:%22+d,this._onMaterialAssetRemove,this)},_onMaterialAsset:function(a){var%20b=this.system.app.assets;a.resource?(this.material=a.resource,this._dirtyMaterialAsset=!1):this.enabled&&this.entity.enabled&&(this._dirtyMaterialAsset=!1,b.load(a))},setMaterialAsset:function(a){this._dirtyMaterialAsset=!0;var%20a=%22number%22===typeof%20a||!a?a:a.id,b=this.system.app.assets;this.data.materialAsset!==a&&(this.data.materialAsset&&this._onMaterialAssetRemove(this.data.materialAsset),%20a&&(b.on(%22load:%22+a,this._onMaterialAsset,this),b.on(%22remove:%22+a,this._onMaterialAssetRemove,this)));if(void%200!==a&&null!==a){var%20d=b.get(a);d&&this._onMaterialAsset(d);b.once(%22add:%22+a,this._onMaterialAsset,this)}else%20null===a&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL,this._dirtyMaterialAsset=!1);b=this.data.materialAsset;this.data.materialAsset=a;this.fire(%22set%22,%22materialAsset%22,b,a)},getMaterialAsset:function(){return%20this.system.app.assets.get(this.data.materialAsset)},onSetMaterial:function(a,%20b,d){if(d!==b&&(this.data.material=d,this.data.model&&%22asset%22!==this.data.type)){a=this.data.model.meshInstances;for(b=0;b%3Ca.length;b++)a[b].material=d}},onSetMapping:function(a,b,d){if(%22asset%22===this.data.type&&this.data.model){this._unsetMaterialEvents();d||(d={});for(var%20a=this.data.model.meshInstances,b=(b=this.asset?this.system.app.assets.get(this.asset):null)?b.data.mapping:null,e=0,g=a.length;e%3Cg;e++)void%200!==d[e]?d[e]?this._loadAndSetMeshInstanceMaterial(d[e],a[e],e):a[e].material=pc.ModelHandler.DEFAULT_MATERIAL:%20b&&(b[e]&&(b[e].material||b[e].path)?this._loadAndSetMeshInstanceMaterial(b[e].material||b[e].path,a[e],e):a[e].material=pc.ModelHandler.DEFAULT_MATERIAL)}},_setMaterialEvent:function(a,b,d,e){b=b+%22:%22+d;this.system.app.assets.on(b,e,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][b]={id:d,handler:e}},_unsetMaterialEvents:function(){var%20a=this.system.app.assets,b=this._materialEvents;if(b){for(var%20d=0,e=b.length;d%3C%20e;d++)if(b[d]){var%20g=b[d],f;for(f%20in%20g)a.off(f,g[f].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(a){var%20b=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&(b=this.system.app.assets.getByUrl(a)):b=this.system.app.assets.get(a);return%20b},_getMaterialAssetUrl:function(a){if(!this.asset)return%20null;var%20b=this.system.app.assets.get(this.asset);if(!b)return%20null;b=b.getFileUrl();b=pc.path.getDirectory(b);return%20pc.path.join(b,a)},_loadAndSetMeshInstanceMaterial:function(a,%20b,d){var%20e=this,g=this.system.app.assets,f=this._getAssetByIdOrPath(a);if(f){var%20k=function(a){a.resource?(b.material=a.resource,e._setMaterialEvent(d,%22remove%22,a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})):(e._setMaterialEvent(d,%22load%22,a.id,function(a){b.material=a.resource;e._setMaterialEvent(d,%22remove%22,a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})}),e.enabled&&e.entity.enabled&&g.load(a))};f?k(f):(b.material=pc.ModelHandler.DEFAULT_MATERIAL,f=isNaN(parseInt(a,10)),%20e._setMaterialEvent(d,f?%22add:url%22:%22add%22,a,k))}},onSetReceiveShadows:function(a,b,d){if(void%200!==d&&(a=this.data,a.model)){a=a.model.meshInstances;for(b=0;b%3Ca.length;b++)a[b].receiveShadow=d}},onEnable:function(){f._super.onEnable.call(this);var%20a=this.data.model,b=%22asset%22===this.data.type;if(a)this.system.app.scene.containsModel(a)||this.system.app.scene.addModel(a);else%20if(b&&this._dirtyModelAsset){a=this.data.asset;if(!a)return;(a=this.system.app.assets.get(a))&&this._onModelAsset(a)}if(this._dirtyMaterialAsset&&%20(a=this.data.materialAsset))(a=this.system.app.assets.get(a))&&!a.resource&&this._onMaterialAsset(a);if(b&&(b=this.data.mapping))for(var%20d%20in%20b)b[d]&&(a=this._getAssetByIdOrPath(b[d]))&&!a.resource&&this.system.app.assets.load(a)},onDisable:function(){f._super.onDisable.call(this);var%20a=this.data.model;a&&this.system.app.scene.containsModel(a)&&this.system.app.scene.removeModel(a)}});return{ModelComponent:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.enabled=!0;this.type=%22asset%22;this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.mapping=this.materialAsset=null;this.castShadowsLightmap=!0;this.lightmapped=!1;this.lightmapSizeMultiplier=1;this.model=this.material=null},pc.ComponentData);return{ModelComponentData:f}}());pc.extend(pc,function(){var%20f=function(a){this.id=%22camera%22;this.description=%22Renders%20the%20scene%20from%20the%20location%20of%20the%20Entity.%22;a.systems.add(this.id,this);this.ComponentType=pc.CameraComponent;this.DataType=pc.CameraComponentData;this.schema=%22enabled%20clearColorBuffer%20clearColor%20clearDepthBuffer%20frustumCulling%20projection%20fov%20orthoHeight%20nearClip%20farClip%20priority%20rect%20camera%20aspectRatio%20horizontalFov%20model%20renderTarget%22.split(%22%20%22);this.cameras=[];this.on(%22beforeremove%22,this.onBeforeRemove,this);this.on(%22remove%22,%20this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){var%20d=%22postEffects%20enabled%20model%20camera%20aspectRatio%20horizontalFov%20renderTarget%20clearColor%20fov%20orthoHeight%20nearClip%20farClip%20projection%20priority%20clearColorBuffer%20clearDepthBuffer%20frustumCulling%20rect%22.split(%22%20%22),e={};d.forEach(function(a){e[a]=b[a]});if(e.clearColor&&%22array%22===pc.type(e.clearColor)){var%20g=e.clearColor;e.clearColor=new%20pc.Color(g[0],g[1],g[2],g[3])}e.rect&&%22array%22===%20pc.type(e.rect)&&(g=e.rect,e.rect=new%20pc.Vec4(g[0],g[1],g[2],g[3]));e.activate&&(console.warn(%22WARNING:%20activate:%20Property%20is%20deprecated.%20Set%20enabled%20property%20instead.%22),e.enabled=e.activate);e.camera=new%20pc.Camera;e._node=a.entity;e.postEffects=new%20pc.PostEffectQueue(this.app,a);f._super.initializeComponentData.call(this,a,e,d)},onBeforeRemove:function(a,b){this.removeCamera(b)},onRemove:function(a,b){b.camera=null},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=%20this.cameras.indexOf(a);0%3C=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return%20a.priority-b.priority})}});return{CameraComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_aspectRatio%22,this.onSetAspectRatio,this);this.on(%22set_camera%22,this.onSetCamera,this);this.on(%22set_clearColor%22,this.onSetClearColor,this);this.on(%22set_fov%22,this.onSetFov,this);this.on(%22set_orthoHeight%22,this.onSetOrthoHeight,this);this.on(%22set_nearClip%22,this.onSetNearClip,this);this.on(%22set_farClip%22,this.onSetFarClip,this);this.on(%22set_projection%22,this.onSetProjection,this);this.on(%22set_priority%22,this.onSetPriority,this);this.on(%22set_clearColorBuffer%22,%20this.updateClearFlags,this);this.on(%22set_clearDepthBuffer%22,this.updateClearFlags,this);this.on(%22set_renderTarget%22,this.onSetRenderTarget,this);this.on(%22set_rect%22,this.onSetRect,this);this.on(%22set_horizontalFov%22,this.onSetHorizontalFov,this);this.on(%22set_frustumCulling%22,this.onSetFrustumCulling,this)},f=pc.inherits(f,pc.Component);Object.defineProperty(f.prototype,%22projectionMatrix%22,{get:function(){return%20this.data.camera.getProjectionMatrix()}});Object.defineProperty(f.prototype,%22viewMatrix%22,{get:function(){return%20this.data.camera._node.getWorldTransform().clone().invert()}});%20Object.defineProperty(f.prototype,%22frustum%22,{get:function(){return%20this.data.camera.getFrustum()}});pc.extend(f.prototype,{screenToWorld:function(a,b,d,e){var%20g=this.system.app.graphicsDevice;return%20this.data.camera.screenToWorld(a,b,d,g.clientRect.width,g.clientRect.height,e)},worldToScreen:function(a,b){var%20d=this.system.app.graphicsDevice;return%20this.data.camera.worldToScreen(a,d.clientRect.width,d.clientRect.height,b)},onSetAspectRatio:function(a,b,d){this.data.camera.setAspectRatio(d)},onSetCamera:function(a,%20b,d){b&&(b._node=null);d._node=this.entity},onSetClearColor:function(a,b,d){a=this.data.camera.getClearOptions();a.color[0]=d.r;a.color[1]=d.g;a.color[2]=d.b;a.color[3]=d.a},onSetFov:function(a,b,d){this.data.camera.setFov(d)},onSetOrthoHeight:function(a,b,d){this.data.camera.setOrthoHeight(d)},onSetNearClip:function(a,b,d){this.data.camera.setNearClip(d)},onSetFarClip:function(a,b,d){this.data.camera.setFarClip(d)},onSetHorizontalFov:function(a,b,d){this.data.camera.setHorizontalFov(d)},onSetFrustumCulling:function(a,%20b,d){this.data.camera.frustumCulling=d},onSetProjection:function(a,b,d){this.data.camera.setProjection(d)},onSetPriority:function(){this.system.sortCamerasByPriority()},updateClearFlags:function(){var%20a=this.data.camera.getClearOptions(),b=0;this.clearColorBuffer&&(b|=pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&(b|=pc.CLEARFLAG_DEPTH);a.flags=b},onSetRenderTarget:function(a,b,d){this.data.camera.setRenderTarget(d)},onSetRect:function(a,b,d){this.data.camera.setRect(d.data[0],d.data[1],d.data[2],d.data[3]);%20this._resetAspectRatio()},onEnable:function(){f._super.onEnable.call(this);this.system.addCamera(this);this.postEffects.enable()},onDisable:function(){f._super.onDisable.call(this);this.postEffects.disable();this.system.removeCamera(this)},_resetAspectRatio:function(){var%20a=this.camera;if(a&&!a.getRenderTarget()){var%20b=this.system.app.graphicsDevice,d=this.rect,b=b.width*d.z/(b.height*d.w);b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameBegin:function(){this._resetAspectRatio();this.data.isRendering=%20!0},frameEnd:function(){this.data.isRendering=!1}});return{CameraComponent:f}}());pc.extend(pc,function(){CameraComponentData=function(){this.clearColor=new%20pc.Color(0.722,0.722,0.722,1);this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.PROJECTION_PERSPECTIVE;this.priority=0;this.rect=new%20pc.Vec4(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.camera=null;this.aspectRatio=16/9;this.postEffects=this.renderTarget=null;this.isRendering=!1};CameraComponentData=pc.inherits(CameraComponentData,pc.ComponentData);%20return{CameraComponentData:CameraComponentData}}());pc.extend(pc,function(){function%20f(a,b){this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;b.on(%22set_rect%22,this.onCameraRectChanged,this)}f.prototype={_createOffscreenTarget:function(a,b){var%20d=this.camera.rect,e=Math.floor(d.z*this.app.graphicsDevice.width*this.renderTargetScale),d=Math.floor(d.w*this.app.graphicsDevice.height*this.renderTargetScale),g=this.app.graphicsDevice,f=b?g.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8,%20e=new%20pc.Texture(g,{format:f,width:e,height:d});e.minFilter=pc.FILTER_NEAREST;e.magFilter=pc.FILTER_NEAREST;e.addressU=pc.ADDRESS_CLAMP_TO_EDGE;e.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return%20new%20pc.RenderTarget(this.app.graphicsDevice,e,{depth:a})},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var%20b=0===this.effects.length,d=this.effects,a={effect:a,inputTarget:this._createOffscreenTarget(b,a.hdr),outputTarget:null};b&&(this.camera.renderTarget=%20a.inputTarget);d.push(a);b=d.length;1%3Cb&&(d[b-2].outputTarget=a.inputTarget);this.enable()},removeEffect:function(a){for(var%20b=-1,d=0,e=this.effects.length;d%3Ce;d++)if(this.effects[d].effect===a){b=d;break}0%3C=b&&(0%3Cb?this.effects[b-1].outputTarget=b+1%3Cthis.effects.length?this.effects[b+1].inputTarget:null:1%3Cthis.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr)),this.camera.renderTarget=%20this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));this.enabled&&a.needsDepthBuffer&&this.camera.releaseDepthMap();0===this.effects.length&&this.disable()},requestDepthMap:function(){for(var%20a=0,b=this.effects.length;a%3Cb;a++)this.effects[a].effect.needsDepthBuffer&&this.camera.camera.requestDepthMap()},releaseDepthMap:function(){for(var%20a=0,b=this.effects.length;a%3Cb;a++)this.effects[a].effect.needsDepthBuffer&&this.camera.releaseDepthMap()},destroy:function(){for(var%20a=%200,b=this.effects.length;a%3Cb;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var%20a=this.effects,b=this.camera;this.requestDepthMap();this.app.graphicsDevice.on(%22resizecanvas%22,this._onCanvasResized,this);b.camera.setRect(0,0,1,1);this.command=new%20pc.Command(pc.LAYER_FX,pc.BLEND_NONE,function(){if(this.enabled&&b.data.isRendering){var%20d=null,e=a.length;if(e){b.renderTarget=a[0].inputTarget;this.depthTarget=%20this.camera.camera._depthTarget;for(var%20g=0;g%3Ce;g++){var%20f=a[g];this.depthTarget&&(f.effect.depthMap=this.depthTarget.colorBuffer);g===e-1&&(d=b.rect);f.effect.render(f.inputTarget,f.outputTarget,d)}}}}.bind(this));this.app.scene.drawCalls.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off(%22resizecanvas%22,this._onCanvasResized,this);this.camera.renderTarget=null;this.releaseDepthMap();var%20a=this.camera.rect;this.camera.camera.setRect(a.x,a.y,a.z,a.w);%20a=this.app.scene.drawCalls.indexOf(this.command);0%3C=a&&this.app.scene.drawCalls.splice(a,1)}},_onCanvasResized:function(){var%20a=this.camera.rect,b=this.app.graphicsDevice,a=b.width*a.z/(b.height*a.w);a!==this.camera.camera.getAspectRatio()&&this.camera.camera.setAspectRatio(a);this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(this.resizeRenderTargets.bind(this),500)},resizeRenderTargets:function(){for(var%20a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*%20this.renderTargetScale),a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale),d=this.effects,e=0,g=d.length;e%3Cg;e++){var%20f=d[e];if(f.inputTarget.width!==b||f.inputTarget.height!==a)f.inputTarget.destroy(),f.inputTarget=this._createOffscreenTarget(f.effect.needsDepthBuffer||0===e,f.hdr),0%3Ce?d[e-1].outputTarget=f.inputTarget:this.camera.renderTarget=f.inputTarget}},onCameraRectChanged:function(){this.enabled&&(this.camera.camera.setRect(0,0,1,1),this.resizeRenderTargets())}};return{PostEffectQueue:f}}());pc.extend(pc,function(){var%20f={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},a=function(a){this.id=%22light%22;this.description=%22Enables%20the%20Entity%20to%20emit%20light.%22;a.systems.add(this.id,this);this.ComponentType=pc.LightComponent;this.DataType=pc.LightComponentData;this.schema=%22enabled%20type%20color%20intensity%20castShadows%20shadowDistance%20shadowResolution%20shadowBias%20normalOffsetBias%20range%20falloffMode%20shadowType%20shadowUpdateMode%20mask%20affectDynamic%20affectLightmapped%20bake%20innerConeAngle%20outerConeAngle%20light%20model%22.split(%22%20%22);%20this.on(%22remove%22,this.onRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.extend(a.prototype,{initializeComponentData:function(b,d,e){var%20e=%22type%20light%20model%20enabled%20color%20intensity%20range%20falloffMode%20innerConeAngle%20outerConeAngle%20castShadows%20shadowDistance%20shadowResolution%20shadowUpdateMode%20shadowBias%20normalOffsetBias%20mask%20affectDynamic%20affectLightmapped%20bake%22.split(%22%20%22),g={};e.forEach(function(a){g[a]=d[a]});g.type||(g.type=b.data.type);b.data.type=g.type;g.color&&%22array%22===pc.type(g.color)&&(g.color=%20new%20pc.Color(g.color[0],g.color[1],g.color[2]));g.enable&&(console.warn(%22WARNING:%20enable:%20Property%20is%20deprecated.%20Set%20enabled%20property%20instead.%22),g.enabled=g.enable);var%20h=new%20pc.Light;h.setType(f[g.type]);h._node=b.entity;this.app.scene.addLight(h);b.data.light=h;a._super.initializeComponentData.call(this,b,g,e)},onRemove:function(a,d){this.app.scene.removeLight(d.light)},cloneComponent:function(a,d){var%20e=a.light;this.addComponent(d,{type:e.type,enabled:e.enabled,color:[e.color.r,e.color.g,e.color.b],%20intensity:e.intensity,range:e.range,innerConeAngle:e.innerConeAngle,outerConeAngle:e.outerConeAngle,castShadows:e.castShadows,shadowDistance:e.shadowDistance,shadowResolution:e.shadowResolution,falloffMode:e.falloffMode,shadowUpdateMode:e.shadowUpdateMode,shadowBias:e.shadowBias,normalOffsetBias:e.normalOffsetBias,mask:e.mask,affectDynamic:e.affectDynamic,affectLightmapped:e.affectLightmapped,bake:e.bake})},changeType:function(a,d,e){a.light.setType(f[e])}});return{LightComponentSystem:a}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_type%22,this.onSetType,this);this.on(%22set_color%22,this.onSetColor,this);this.on(%22set_intensity%22,this.onSetIntensity,this);this.on(%22set_castShadows%22,this.onSetCastShadows,this);this.on(%22set_shadowDistance%22,this.onSetShadowDistance,this);this.on(%22set_shadowResolution%22,this.onSetShadowResolution,this);this.on(%22set_shadowBias%22,this.onSetShadowBias,this);this.on(%22set_normalOffsetBias%22,this.onSetNormalOffsetBias,this);this.on(%22set_range%22,this.onSetRange,%20this);this.on(%22set_innerConeAngle%22,this.onSetInnerConeAngle,this);this.on(%22set_outerConeAngle%22,this.onSetOuterConeAngle,this);this.on(%22set_falloffMode%22,this.onSetFalloffMode,this);this.on(%22set_shadowType%22,this.onSetShadowType,this);this.on(%22set_shadowUpdateMode%22,this.onSetShadowUpdateMode,this);this.on(%22set_mask%22,this.onSetMask,this);this.on(%22set_affectDynamic%22,this.onSetAffectDynamic,this);this.on(%22set_affectLightmapped%22,this.onSetAffectLightmapped,this);this.on(%22set_bake%22,this.onSetBake,this)},%20f=pc.inherits(f,pc.Component);Object.defineProperty(f.prototype,%22enable%22,{get:function(){console.warn(%22WARNING:%20enable:%20Property%20is%20deprecated.%20Query%20enabled%20property%20instead.%22);return%20this.enabled},set:function(a){console.warn(%22WARNING:%20enable:%20Property%20is%20deprecated.%20Set%20enabled%20property%20instead.%22);this.enabled=a}});pc.extend(f.prototype,{onSetType:function(a,b,d){b!==d&&(this.system.changeType(this,b,d),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows(%22castShadows%22,%20this.castShadows,this.castShadows);this.onSetColor(%22color%22,this.color,this.color);this.onSetIntensity(%22intensity%22,this.intensity,this.intensity);this.onSetShadowDistance(%22shadowDistance%22,this.shadowDistance,this.shadowDistance);this.onSetShadowResolution(%22shadowResolution%22,this.shadowResolution,this.shadowResolution);this.onSetShadowBias(%22shadowBias%22,this.shadowBias,this.shadowBias);this.onSetNormalOffsetBias(%22normalOffsetBias%22,this.normalOffsetBias,this.normalOffsetBias);this.onSetRange(%22range%22,%20this.range,this.range);this.onSetInnerConeAngle(%22innerConeAngle%22,this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle(%22outerConeAngle%22,this.outerConeAngle,this.outerConeAngle);this.onSetFalloffMode(%22falloffMode%22,this.falloffMode,this.falloffMode);this.onSetShadowType(%22shadowType%22,this.shadowType,this.shadowType);this.onSetShadowUpdateMode(%22shadowUpdateMode%22,this.shadowUpdateMode,this.shadowUpdateMode);this.onSetMask(%22mask%22,this.light.mask,this.light.mask);this.onSetAffectDynamic(%22affectDynamic%22,%20this.affectDynamic,this.affectDynamic);this.onSetAffectLightmapped(%22affectLightmapped%22,this.affectLightmapped,this.affectLightmapped);this.onSetBake(%22bake%22,this.bake,this.bake);if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onSetCastShadows:function(a,b,d){this.light.setCastShadows(d)},onSetColor:function(a,b,d){this.light.setColor(d)},onSetIntensity:function(a,b,d){this.light.setIntensity(d)},onSetShadowDistance:function(a,b,d){%22directional%22===%20this.data.type&&this.light.setShadowDistance(d)},onSetShadowResolution:function(a,b,d){this.light.setShadowResolution(d)},onSetShadowBias:function(a,b,d){this.light.setShadowBias(-0.01*d)},onSetNormalOffsetBias:function(a,b,d){this.light.setNormalOffsetBias(d)},onSetRange:function(a,b,d){%22point%22!==this.data.type&&%22spot%22!==this.data.type||this.light.setAttenuationEnd(d)},onSetInnerConeAngle:function(a,b,d){%22spot%22===this.data.type&&this.light.setInnerConeAngle(d)},onSetOuterConeAngle:function(a,b,d){%22spot%22===%20this.data.type&&this.light.setOuterConeAngle(d)},onSetFalloffMode:function(a,b,d){%22point%22!==this.data.type&&%22spot%22!==this.data.type||this.light.setFalloffMode(d)},onSetShadowType:function(a,b,d){this.light.setShadowType(d)},onSetShadowUpdateMode:function(a,b,d){this.light.shadowUpdateMode=d},onSetMask:function(a,b,d){this.light.setMask(d)},onSetAffectDynamic:function(a,b,d){this.light.mask=d?this.light.mask|pc.MASK_DYNAMIC:this.light.mask&~pc.MASK_DYNAMIC;this.light.setMask(this.light.mask)},onSetAffectLightmapped:function(a,%20b,d){d?(this.light.mask|=pc.MASK_BAKED,this.bake&&(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP));this.light.setMask(this.light.mask)},onSetBake:function(a,b,d){d?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED));this.light.setMask(this.light.mask)},onEnable:function(){f._super.onEnable.call(this);%20this.light.setEnabled(!0);var%20a=this.data.model;if(a){var%20b=this.system.app.scene;b.containsModel(a)||b.addModel(a)}},onDisable:function(){f._super.onDisable.call(this);this.light.setEnabled(!1);var%20a=this.data.model;a&&this.system.app.scene.removeModel(a)}});return{LightComponent:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.type=%22directional%22;this.enabled=!0;this.color=new%20pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowDistance=40;this.shadowResolution=1024;this.shadowBias=0.05;this.normalOffsetBias=0;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.falloffMode=pc.LIGHTFALLOFF_LINEAR;this.shadowType=pc.SHADOW_DEPTH;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this.mask=1;this.affectDynamic=!0;this.bake=this.affectLightmapped=%20!1;this.model=this.light=null},pc.ComponentData);return{LightComponentData:f}}());pc.extend(pc,function(){var%20f=function(a,b){this.id=%22script%22;this.description=%22Allows%20the%20Entity%20to%20run%20JavaScript%20fragments%20to%20implement%20custom%20behavior.%22;a.systems.add(this.id,this);this.ComponentType=pc.ScriptComponent;this.DataType=pc.ScriptComponentData;this._prefix=b||null;this.schema=[%22enabled%22,%22scripts%22,%22instances%22,%22runInTools%22];this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on(%22beforeremove%22,%20this.onBeforeRemove,this);pc.ComponentSystem.on(%22initialize%22,this.onInitialize,this);pc.ComponentSystem.on(%22postInitialize%22,this.onPostInitialize,this);pc.ComponentSystem.on(%22update%22,this.onUpdate,this);pc.ComponentSystem.on(%22fixedUpdate%22,this.onFixedUpdate,this);pc.ComponentSystem.on(%22postUpdate%22,this.onPostUpdate,this);pc.ComponentSystem.on(%22toolsUpdate%22,this.onToolsUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=[%22runInTools%22,%22enabled%22,%20%22scripts%22];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&%22array%22===pc.type(a.attributes)){for(var%20b={},d=0;d%3Ca.attributes.length;d++)b[a.attributes[d].name]=a.attributes[d];a.attributes=b}});f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){for(var%20d=this.dataStore[a.getGuid()],e={runInTools:d.data.runInTools,scripts:[],enabled:d.data.enabled},d=d.data.scripts,g=0,f=d.length;g%3Cf;g++){var%20k=d[g].attributes;k&&delete%20d[g].attributes;e.scripts.push(pc.extend({},%20d[g]));k&&(e.scripts[g].attributes=this._cloneAttributes(k),d[g].attributes=k)}return%20this.addComponent(b,e)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var%20a=a.getChildren(),b,d=a.length;for(b=0;b%3Cd;b++)if(a[b]instanceof%20pc.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&%20a.script.enabled&&this._postInitializeScriptComponent(a.script);var%20a=a.getChildren(),b,d=a.length;for(b=0;b%3Cd;b++)if(a[b]instanceof%20pc.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var%20d=a.data.instances,e;for(e%20in%20d)if(d.hasOwnProperty(e)){var%20g=d[e].instance;g[b]&&g[b].call(g)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,%22initialize%22);a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,%20%22onEnable%22)},_disableScriptComponent:function(a){this._callInstancesMethod(a,%22onDisable%22)},_destroyScriptComponent:function(a){var%20b,d=a.data.instances,e;for(e%20in%20d)if(d.hasOwnProperty(e)){var%20g=d[e].instance;g.destroy&&g.destroy();g.update&&(b=this.instancesWithUpdate.indexOf(g),0%3C=b&&this.instancesWithUpdate.splice(b,1));g.fixedUpdate&&(b=this.instancesWithFixedUpdate.indexOf(g),0%3C=b&&this.instancesWithFixedUpdate.splice(b,1));g.postUpdate&&(b=this.instancesWithPostUpdate.indexOf(g),0%3C=b&&this.instancesWithPostUpdate.splice(b,%201));g.toolsUpdate&&(b=this.instancesWithToolsUpdate.indexOf(g),0%3C=b&&this.instancesWithToolsUpdate.splice(b,1));a.instances[e].instance===a[e]&&delete%20a[e];delete%20a.instances[e]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,%22postInitialize%22);a.data.postInitialized=!0},_updateInstances:function(a,b,d){for(var%20e,g=0,f=b.length;g%3Cf;g++)(e=b[g])&&(e.entity&&e.entity.enabled&&e.entity.script.enabled)&&e[a].call(e,d)},onUpdate:function(a){this._updateInstances(%22update%22,this.instancesWithUpdate,%20a)},onFixedUpdate:function(a){this._updateInstances(%22fixedUpdate%22,this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances(%22postUpdate%22,this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances(%22toolsUpdate%22,this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn(%22DEPRECATED:%20ScriptComponentSystem.broadcast()%20is%20deprecated%20and%20will%20be%20removed%20soon.%20Please%20use:%20http://developer.playcanvas.com/user-manual/scripting/communication/%22);var%20d=%20pc.makeArray(arguments).slice(2),e,g,f,k=this.store;for(e%20in%20k)k.hasOwnProperty(e)&&(g=k[e].data,g.instances[a]&&(f=g.instances[a].instance[b])&&f.apply(g.instances[a].instance,d))},_preRegisterInstance:function(a,b,d,e){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[d])throw%20Error(pc.string.format(%22Script%20name%20collision%20'{0}'.%20Scripts%20from%20'{1}'%20and%20'{2}'%20{{3}}%22,d,b,a.script.data._instances[d].url,a.getGuid()));a.script.data._instances[d]={url:b,name:d,%20instance:e}}},_registerInstances:function(a){var%20b,d,e;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(e%20in%20a.script.instances){b=a.script.instances[e];d=b.instance;pc.events.attach(d);d.update&&this.instancesWithUpdate.push(d);d.fixedUpdate&&this.instancesWithFixedUpdate.push(d);d.postUpdate&&this.instancesWithPostUpdate.push(d);d.toolsUpdate&&this.instancesWithToolsUpdate.push(d);a.script.scripts&&this._createAccessors(a,b);if(a.script[e])throw%20Error(pc.string.format(%22Script%20with%20name%20'{0}'%20is%20already%20attached%20to%20Script%20Component%22,%20e));a.script[e]=d}delete%20a.script.data._instances}a=a.getChildren();d=a.length;for(b=0;b%3Cd;b++)a[b]instanceof%20pc.Entity&&this._registerInstances(a[b])},_cloneAttributes:function(a){var%20b={},d;for(d%20in%20a)if(a.hasOwnProperty(d))if(%22entity%22!==a[d].type)b[d]=pc.extend({},a[d]);else{var%20e=a[d].value;delete%20a[d].value;b[d]=pc.extend({},a[d]);b[d].value=e;a[d].value=e}return%20b},_createAccessors:function(a,b){var%20d,e=a.script.scripts.length,g=b.url;for(d=0;d%3Ce;d++){var%20f=a.script.scripts[d];if(f.url===g){d=%20f.attributes;if(f.name&&d){for(var%20k%20in%20d)d.hasOwnProperty(k)&&this._createAccessor(d[k],b);a.script.data.attributes[f.name]=this._cloneAttributes(d)}break}}},_createAccessor:function(a,b){var%20d=this,a={name:a.name,value:a.value,type:a.type};d._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return%20a.value},set:function(e){var%20g=a.value;a.value=e;d._convertAttributeValue(a);b.instance.fire(%22set%22,a.name,g,a.value)},configurable:!0})},_updateAccessors:function(a,b){var%20d,%20e=a.script.scripts.length,g,f=b.url,k,n;for(d=0;d%3Ce;d++)if(k=a.script,n=k.scripts[d],n.url===f){d=n.name;n=n.attributes;if(d){if(n)for(g%20in%20n)n.hasOwnProperty(g)&&this._createAccessor(n[g],b);if(e=k.data.attributes[d])for(g%20in%20e)if(f=e[g],g%20in%20n){if(n[g].value!==f.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(f.name,f.value,n[g].value)}else%20delete%20b.instance[f.name];n?k.data.attributes[d]=this._cloneAttributes(n):delete%20k.data.attributes[d]}break}},_convertAttributeValue:function(a){if(%22rgb%22===%20a.type||%22rgba%22===a.type)%22array%22===pc.type(a.value)&&(a.value=3===a.value.length?new%20pc.Color(a.value[0],a.value[1],a.value[2]):new%20pc.Color(a.value[0],a.value[1],a.value[2],a.value[3]));else%20if(%22vec2%22===a.type)%22array%22===pc.type(a.value)&&(a.value=new%20pc.Vec2(a.value[0],a.value[1]));else%20if(%22vec3%22===a.type||%22vector%22===a.type)%22array%22===pc.type(a.value)&&(a.value=new%20pc.Vec3(a.value[0],a.value[1],a.value[2]));else%20if(%22vec4%22===a.type)%22array%22===pc.type(a.value)&&(a.value=new%20pc.Vec4(a.value[0],a.value[1],%20a.value[2],a.value[3]));else%20if(%22entity%22===a.type)null!==a.value&&%22string%22===typeof%20a.value&&(a.value=this.app.root.findByGuid(a.value));else%20if(%22curve%22===a.type||%22colorcurve%22===a.type)a.value=new%20(a.value.keys[0]instanceof%20Array?pc.CurveSet:pc.Curve)(a.value.keys),a.value.type=a.value.type}});return{ScriptComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_scripts%22,this.onSetScripts,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{send:function(a,b){console.warn(%22DEPRECATED:%20ScriptComponent.send()%20is%20deprecated%20and%20will%20be%20removed%20soon.%20Please%20use:%20http://developer.playcanvas.com/user-manual/scripting/communication/%22);var%20d=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,f;if(e&&e[a]&&(f=e[a].instance[b]))return%20f.apply(e[a].instance,d)},onEnable:function(){f._super.onEnable.call(this);%20this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){f._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,d){if((!this.system._inTools||this.runInTools)&&!this._updateScriptAttributes(b,d))this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),%20this.data.areScriptsLoaded=!1,a=d.map(function(a){return%20a.url}),this._loadFromCache(a)||this._loadScripts(a)},_updateScriptAttributes:function(a,b){var%20d=!0;if(a.length!==b.length)d=!1;else{var%20e;len=b.length;for(e=0;e%3Clen;e++)if(a[e].url!==b[e].url){d=!1;break}}if(d)for(var%20f%20in%20this.instances)this.instances.hasOwnProperty(f)&&this.system._updateAccessors(this.entity,this.instances[f]);return%20d},_loadFromCache:function(a){var%20b,d,e=[],f=this.system._prefix||%22%22,h=/^http(s)?:\/\//i;b=0;for(d=a.length;b%3C%20d;b++){var%20k=a[b];h.test(k)||(k=pc.path.join(f,k));if(k=this.system.app.loader.getFromCache(k,%22script%22))e.push(k);else%20return!1}b=0;for(d=e.length;b%3Cd;b++)f=e[b],!0!==f&&(f&&this.entity.script&&!this.entity.script.instances[f._pcScriptName])&&(h=new%20f(this.entity),this.system._preRegisterInstance(this.entity,a[b],f._pcScriptName,h));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0},_loadScripts:function(a){var%20b=%20a.length,d=this.system._prefix||%22%22;a.forEach(function(a){var%20f=null,h=null;a.toLowerCase().startsWith(%22http://%22)||a.toLowerCase().startsWith(%22https://%22)?f=h=a:(h=a,f=pc.path.join(d,a));this.system.app.loader.load(f,%22script%22,function(a,d){b--;if(a)console.error(a);else%20if(d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]){var%20e=new%20d(this.entity);this.system._preRegisterInstance(this.entity,h,d._pcScriptName,e)}0===b&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),%20this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});return{ScriptComponent:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.ComponentData);return{ScriptComponentData:f}}());pc.extend(pc,{DISTANCE_LINEAR:%22linear%22,DISTANCE_INVERSE:%22inverse%22,DISTANCE_EXPONENTIAL:%22exponential%22});pc.extend(pc,function(){var%20f=function(a,b,d){d=d||{};this._component=a;this._assets=a.system.app.assets;this._manager=a.system.manager;this._name=b||%22Untitled%22;this._volume=void%200!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void%200!==d.pitch?Math.max(0.01,Number(d.pitch)||0):1;this._loop=!!(void%200!==d.loop&&d.loop);this._duration=0%3Cd.duration?d.duration:null;this._startTime=Math.max(0,Number(d.startTime)||0);this._overlap=!!d.overlap;this._autoPlay=!!d.autoPlay;this._lastNode=%20this._firstNode=null;this._asset=d.asset;this._asset%20instanceof%20pc.Asset&&(this._asset=this._asset.id);this.instances=[];pc.events.attach(this)};f.prototype={play:function(){!this.overlap&&(this.isPlaying||this.isPaused)&&this.stop();var%20a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var%20b=function(b,e){a.sound=e;a._playWhenLoaded&&a.play()};this.off(%22load%22,b);this.once(%22load%22,b);this.load()}this.fire(%22play%22,this,a);return%20a},pause:function(){for(var%20a=!1,b=this.instances,%20d=0,e=b.length;d%3Ce;d++)b[d].pause()&&(a=!0);a&&this.fire(%22pause%22,this);return%20a},resume:function(){for(var%20a=!1,b=this.instances,d=0,e=b.length;d%3Ce;d++)b[d].resume()&&(a=!0);a&&this.fire(%22resume%22,this);return%20a},stop:function(){for(var%20a=!1,b=this.instances,d=0,e=b.length;d%3Ce;d++)b[d].stop()&&(a=!0);b.length=0;a&&this.fire(%22stop%22,this);return%20a},load:function(){if(this._hasAsset()){var%20a=this._assets.get(this._asset);a?(a.off(%22remove%22,this._onAssetRemoved,this),a.on(%22remove%22,this._onAssetRemoved,%20this),a.resource?this.fire(%22load%22,this,a.resource):(a.off(%22load%22,this._onAssetLoad,this),a.once(%22load%22,this._onAssetLoad,this),this._assets.load(a))):(this._assets.off(%22add:%22+this._asset,this._onAssetAdd,this),this._assets.once(%22add:%22+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,b){if(a){if(b||(b=a),this._firstNode=a,this._lastNode=b,!this._overlap)for(var%20d=this.instances,e=0,f=d.length;e%3Cf;e++)d[e].setExternalNodes(a,b)}else%20logError(%22The%20firstNode%20must%20have%20a%20valid%20AudioNode%22)},%20clearExternalNodes:function(){this._lastNode=this._firstNode=null;if(!this._overlap)for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)a[b].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return%20null!=this._asset},_createInstance:function(){var%20a=null,a=this._component,b=null;if(this._hasAsset()){var%20d=this._assets.get(this._asset);d&&(b=d.resource)}d={volume:this._volume*a.volume,pitch:this._pitch*a.pitch,loop:this._loop,startTime:this._startTime,%20duration:this._duration};a.positional?(d.position=a.entity.getPosition(),d.maxDistance=a.maxDistance,d.refDistance=a.refDistance,d.rollOffFactor=a.rollOffFactor,d.distanceModel=a.distanceModel,a=new%20pc.SoundInstance3d(this._manager,b,d)):a=new%20pc.SoundInstance(this._manager,b,d);a.once(%22end%22,this._onInstanceEnd,this);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);return%20a},_onInstanceEnd:function(a){a=this.instances.indexOf(a);-1!==a&&this.instances.splice(a,1)},_onAssetAdd:function(){this.load()},%20_onAssetLoad:function(){this.load()},_onAssetRemoved:function(a){a.off(%22remove%22,this._onAssetRemoved,this);this._assets.off(%22add:%22+a.id,this._onAssetAdd,this);this.stop()},updatePosition:function(a){for(var%20b=this.instances,d=0,e=b.length;d%3Ce;d++)b[d].position=a}};Object.defineProperty(f.prototype,%22name%22,{get:function(){return%20this._name},set:function(a){this._name=a}});Object.defineProperty(f.prototype,%22volume%22,{get:function(){return%20this._volume},set:function(a){this._volume=pc.math.clamp(Number(a)||%200,0,1);if(!this._overlap)for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)a[b].volume=this._volume*this._component.volume}});Object.defineProperty(f.prototype,%22pitch%22,{get:function(){return%20this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,0.01);if(!this._overlap)for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)a[b].pitch=this.pitch*this._component.pitch}});Object.defineProperty(f.prototype,%22loop%22,{get:function(){return%20this._loop},set:function(a){this._loop=!!a;for(var%20a=this.instances,%20b=0,d=a.length;b%3Cd;b++)a[b].loop=this._loop}});Object.defineProperty(f.prototype,%22autoPlay%22,{get:function(){return%20this._autoPlay},set:function(a){this._autoPlay=!!a}});Object.defineProperty(f.prototype,%22overlap%22,{get:function(){return%20this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(f.prototype,%22startTime%22,{get:function(){return%20this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap)for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)a[b].startTime=%20this._startTime}});Object.defineProperty(f.prototype,%22duration%22,{get:function(){var%20a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return%20null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap)for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)a[b].duration=this._duration}});Object.defineProperty(f.prototype,%22asset%22,{get:function(){return%20this._asset},set:function(a){var%20b=this._asset;b&&%20(this._assets.off(%22add:%22+b,this._onAssetAdd,this),(b=this._assets.get(b))&&b.off(%22remove%22,this._onAssetRemoved,this));this._asset=a;this._asset%20instanceof%20pc.Asset&&(this._asset=this._asset.id);this._hasAsset()&&(this._component.enabled&&this._component.entity.enabled)&&this.load()}});Object.defineProperty(f.prototype,%22isLoaded%22,{get:function(){if(this._hasAsset()){var%20a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});Object.defineProperty(f.prototype,%22isPlaying%22,{get:function(){for(var%20a=%20this.instances,b=0,d=a.length;b%3Cd;b++)if(a[b].isPlaying)return!0;return!1}});Object.defineProperty(f.prototype,%22isPaused%22,{get:function(){var%20a=this.instances,b=a.length;if(0===b)return!1;for(var%20d=0;d%3Cb;d++)if(!a[d].isPaused)return!1;return!0}});Object.defineProperty(f.prototype,%22isStopped%22,{get:function(){for(var%20a=this.instances,b=0,d=a.length;b%3Cd;b++)if(!a[b].isStopped)return!1;return!0}});return{SoundSlot:f}}());pc.extend(pc,function(){var%20f=function(a,b){this.id=%22sound%22;this.description=%22Allows%20an%20Entity%20to%20play%20sounds%22;a.systems.add(this.id,this);this.ComponentType=pc.SoundComponent;this.DataType=pc.SoundComponentData;this.schema=%22enabled%20volume%20pitch%20positional%20refDistance%20maxDistance%20rollOffFactor%20distanceModel%20slots%22.split(%22%20%22);this.manager=b;pc.ComponentSystem.on(%22update%22,this.onUpdate,this);this.on(%22beforeremove%22,this.onBeforeRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,%20{initializeComponentData:function(a,b,d){d=%22volume%20pitch%20positional%20refDistance%20maxDistance%20rollOffFactor%20distanceModel%20slots%20enabled%22.split(%22%20%22);f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){var%20d=a.sound.data,e={},f;for(f%20in%20d)d.hasOwnProperty(f)&&(e[f]=d[f]);e.slots={};for(f%20in%20d.slots){var%20h=d.slots[f];e.slots[f]=h%20instanceof%20pc.SoundSlot?{name:h.name,volume:h.volume,pitch:h.pitch,loop:h.loop,duration:h.duration,startTime:h.startTime,overlap:h.overlap,autoPlay:h.autoPlay,%20asset:h.asset}:h}e.playingBeforeDisable={};return%20this.addComponent(b,e)},onUpdate:function(){var%20a=this.store,b;for(b%20in%20a)if(a.hasOwnProperty(b)){var%20d=a[b],e=d.entity,d=d.data;if(d.enabled&&e.enabled&&d.positional){var%20e=e.getPosition(),d=d.slots,f;for(f%20in%20d)d[f].updatePosition(e)}}},onBeforeRemove:function(a,b){var%20d=b.slots,e;for(e%20in%20d)d[e].overlap||d[e].stop()}});Object.defineProperty(f.prototype,%22volume%22,{get:function(){return%20this.manager.volume},set:function(a){this.manager.volume=a}});%20Object.defineProperty(f.prototype,%22context%22,{get:function(){return!pc.SoundManager.hasAudioContext()?(console.warn(%22WARNING:%20Audio%20context%20is%20not%20supported%20on%20this%20browser%22),null):this.manager.context}});return{SoundComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_slots%22,this.onSetSlots,this);this.on(%22set_volume%22,this.onSetVolume,this);this.on(%22set_pitch%22,this.onSetPitch,this);this.on(%22set_refDistance%22,this.onSetRefDistance,this);this.on(%22set_maxDistance%22,this.onSetMaxDistance,this);this.on(%22set_rollOffFactor%22,this.onSetRollOffFactor,this);this.on(%22set_distanceModel%22,this.onSetDistanceModel,this);this.on(%22set_positional%22,this.onSetPositional,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{onSetSlots:function(a,%20b,d){if(b)for(var%20e%20in%20b)b[e].stop();a={};for(e%20in%20d)d[e]instanceof%20pc.SoundSlot?a[d[e].name]=d[e]:d[e].name&&(a[d[e].name]=new%20pc.SoundSlot(this,d[e].name,d[e]));this.data.slots=a;if(this.enabled&&this.entity.enabled)this.onEnable()},onSetVolume:function(a,b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20f=b.instances,h=0,k=f.length;h%3Ck;h++)f[h].volume=b.volume*d},onSetPitch:function(a,b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20f=b.instances,h=0,k=f.length;h%3C%20k;h++)f[h].pitch=b.pitch*d},onSetRefDistance:function(a,b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20b=b.instances,f=0,h=b.length;f%3Ch;f++)b[f].refDistance=d},onSetMaxDistance:function(a,b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20b=b.instances,f=0,h=b.length;f%3Ch;f++)b[f].maxDistance=d},onSetRollOffFactor:function(a,b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20b=b.instances,f=0,h=b.length;f%3Ch;f++)b[f].rollOffFactor=d},onSetDistanceModel:function(a,%20b,d){var%20a=this.data.slots,e;for(e%20in%20a)if(b=a[e],!b.overlap)for(var%20b=b.instances,f=0,h=b.length;f%3Ch;f++)b[f].distanceModel=d},onSetPositional:function(){var%20a=this.data.slots,b;for(b%20in%20a){var%20d=a[b];if(!d.overlap)for(var%20e=d.instances,f=0,h=e.length;f%3Ch;f++){var%20k=e[f].isPlaying||e[f].isSuspended,n=e[f].currentTime;k&&e[f].stop();e[f]=d._createInstance();k&&(e[f].play(),e[f].currentTime=n)}}},onEnable:function(){f._super.onEnable.call(this);if(!this.system._inTools){var%20a=this.data.slots,b=this.data.playingBeforeDisable,%20d;for(d%20in%20a){var%20e=a[d];e.autoPlay&&e.isStopped?e.play():b[d]?e.resume():e.isLoaded||e.load()}}},onDisable:function(){f._super.onDisable.call(this);var%20a=this.data.slots,b={},d;for(d%20in%20a)!a[d].overlap&&a[d].isPlaying&&(a[d].pause(),b[d]=!0);this.data.playingBeforeDisable=b},addSlot:function(a,b){var%20d=this.data.slots;if(d[a])return%20logWARNING(%22A%20sound%20slot%20with%20name%20%22+a+%22%20already%20exists%20on%20Entity%20%22+this.entity.getPath()),null;var%20e=new%20pc.SoundSlot(this,a,b);d[a]=e;e.autoPlay&&(this.enabled&&this.entity.enabled)&&%20e.play();return%20e},removeSlot:function(a){var%20b=this.data.slots;b[a]&&(b[a].stop(),delete%20b[a])},slot:function(a){return%20this.data.slots[a]},play:function(a){if(!this.enabled||!this.entity.enabled)return%20null;var%20b=this.slots[a];if(!b)return%20logWARNING(%22Trying%20to%20play%20sound%20slot%20with%20name%20%22+a+%22%20which%20does%20not%20exist%22),null;a=b.play();this.fire(%22play%22,this,b,a);return%20a},pause:function(a){var%20b;b=this.data.slots;if(a)(b=b[a])?(b.pause(),this.fire(%22pause%22,this,b)):logWARNING(%22Trying%20to%20pause%20sound%20slot%20with%20name%20%22+%20a+%22%20which%20does%20not%20exist%22);else{for(var%20d%20in%20b)b[d].pause();this.fire(%22pause%22,this)}},resume:function(a){var%20b;b=this.data.slots;if(a)(b=b[a])?b.isPaused&&b.resume()&&this.fire(%22resume%22,this,b):logWARNING(%22Trying%20to%20resume%20sound%20slot%20with%20name%20%22+a+%22%20which%20does%20not%20exist%22);else{for(var%20d%20in%20b)b[d].resume();this.fire(%22resume%22,this)}},stop:function(a){var%20b;b=this.data.slots;if(a)(b=b[a])?b.stop()&&this.fire(%22stop%22,this,b):logWARNING(%22Trying%20to%20stop%20sound%20slot%20with%20name%20%22+a+%22%20which%20does%20not%20exist%22);%20else{for(var%20d%20in%20b)b[d].stop();this.fire(%22stop%22,this)}}});return{SoundComponent:f}}());pc.SoundComponentData=function(){this.enabled=!0;this.pitch=this.volume=1;this.positional=!0;this.refDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_LINEAR;this.slots={};this.playingBeforeDisable={}};pc.extend(pc,function(){var%20f=function(a,b){this.id=%22audiosource%22;this.description=%22Specifies%20audio%20assets%20that%20can%20be%20played%20at%20the%20position%20of%20the%20Entity.%22;a.systems.add(this.id,this);this.ComponentType=pc.AudioSourceComponent;this.DataType=pc.AudioSourceComponentData;this.schema=%22enabled%20assets%20volume%20pitch%20loop%20activate%203d%20minDistance%20maxDistance%20rollOffFactor%20distanceModel%20sources%20currentSource%20channel%22.split(%22%20%22);this.manager=b;this.initialized=!1;pc.ComponentSystem.on(%22initialize%22,this.onInitialize,%20this);pc.ComponentSystem.on(%22update%22,this.onUpdate,this);this.on(%22remove%22,this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=%22activate%20volume%20pitch%20loop%203d%20minDistance%20maxDistance%20rollOffFactor%20distanceModel%20enabled%20assets%22.split(%22%20%22);f._super.initializeComponentData.call(this,a,b,d);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);%20var%20a=a.getChildren(),b,d=a.length;for(b=0;b%3Cd;b++)if(a[b]instanceof%20pc.Entity)this.onInitialize(a[b]);this.initialized=!0},onUpdate:function(){var%20a=this.store,b;for(b%20in%20a)if(a.hasOwnProperty(b)){var%20d=a[b],e=d.entity,d=d.data;d.enabled&&(e.enabled&&d.channel%20instanceof%20pc.Channel3d)&&(e=e.getPosition(),d.channel.setPosition(e))}},onRemove:function(a,b){b.channel&&(b.channel.stop(),b.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_assets%22,this.onSetAssets,this);this.on(%22set_loop%22,this.onSetLoop,this);this.on(%22set_volume%22,this.onSetVolume,this);this.on(%22set_pitch%22,this.onSetPitch,this);this.on(%22set_minDistance%22,this.onSetMinDistance,this);this.on(%22set_maxDistance%22,this.onSetMaxDistance,this);this.on(%22set_rollOffFactor%22,this.onSetRollOffFactor,this);this.on(%22set_distanceModel%22,this.onSetDistanceModel,this);this.on(%22set_3d%22,this.onSet3d,this)},f=pc.inherits(f,pc.Component);%20pc.extend(f.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var%20b,d=this.data;d.sources[a]&&(d[%223d%22]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(d.sources[a],b,d)):b=this.system.manager.playSound(d.sources[a],d),d.currentSource=a,d.channel=b)}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=%20null)},onSetAssets:function(a,b,d){var%20a=[],e,f=d.length;if(b&&b.length)for(e=0;e%3Cb.length;e++)if(b[e]){var%20h=this.system.app.assets.get(b[e]);h&&(h.off(%22change%22,this.onAssetChanged,this),h.off(%22remove%22,this.onAssetRemoved,this),this.currentSource===h.name&&this.stop())}if(f)for(e=0;e%3Cf;e++)0%3Eb.indexOf(d[e])&&(d[e]instanceof%20pc.Asset?a.push(d[e].id):a.push(d[e]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,d){%22resource%22===b&&this.data.sources&&(this.data.sources[a.name]=%20d,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?(this.play(a.name),this.pause()):this.play(a.name)))},onAssetRemoved:function(a){a.off(%22remove%22,this.onAssetRemoved,this);this.data.sources[a.name]&&(delete%20this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(a,b,d){b!=d&&this.channel&&this.channel.setLoop(d)},onSetVolume:function(a,b,d){b!=d&&this.channel&&this.channel.setVolume(d)},onSetPitch:function(a,%20b,d){b!=d&&this.channel&&this.channel.setPitch(d)},onSetMaxDistance:function(a,b,d){b!=d&&this.channel%20instanceof%20pc.Channel3d&&this.channel.setMaxDistance(d)},onSetMinDistance:function(a,b,d){b!=d&&this.channel%20instanceof%20pc.Channel3d&&this.channel.setMinDistance(d)},onSetRollOffFactor:function(a,b,d){b!=d&&this.channel%20instanceof%20pc.Channel3d&&this.channel.setRollOffFactor(d)},onSetDistanceModel:function(a,b,d){b!==d&&this.channel%20instanceof%20pc.Channel3d&&this.channel.setDistanceModel(d)},onSet3d:function(a,%20b,d){b!==d&&(this.system.initialized&&this.currentSource)&&(b=a=!1,this.channel&&(a=this.channel.paused,b=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=b))},onEnable:function(){f._super.onEnable.call(this);var%20a=this.data.assets;if(a)for(var%20b=this.system.app.assets,d=0,e=a.length;d%3Ce;d++){var%20g=a[d];g%20instanceof%20pc.Asset||(g=b.get(g));g&&!g.resource&&b.load(g)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):%20this.unpause())},onDisable:function(){f._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var%20b=this,d=a.map(function(a){return%20this.system.app.assets.get(a)},this),e={},f=null,h=d.length,k=function(){h--},n=function(){this.data.sources=e;this.data.currentSource=f;if(this.enabled&&this.activate&&f)this.onEnable()}.bind(this);d.forEach(function(d,u){d?(f=f||d.name,d.off(%22change%22,this.onAssetChanged,this),d.on(%22change%22,this.onAssetChanged,this),d.off(%22remove%22,this.onAssetRemoved,%20this),d.on(%22remove%22,this.onAssetRemoved,this),d.off(%22error%22,k,this),d.on(%22error%22,k,this),d.ready(function(a){e[a.name]=a.resource;h--;0===h&&n()}),!d.resource&&(b.enabled&&b.entity.enabled)&&this.system.app.assets.load(d)):(h--,0===h&&n(),this.system.app.assets.on(%22add:%22+a[u],function(a){a.ready(function(a){b.data.sources[a.name]=a.resource});a.resource||b.system.app.assets.load(a)}))},this)}});return{AudioSourceComponent:f}}());pc.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this[%223d%22]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_INVERSE;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc,function(){var%20f=function(a,b){this.id=%22audiolistener%22;this.description=%22Specifies%20the%20location%20of%20the%20listener%20for%203D%20audio%20playback.%22;a.systems.add(this.id,this);this.ComponentType=pc.AudioListenerComponent;this.DataType=pc.AudioListenerComponentData;this.schema=[%22enabled%22];this.manager=b;this.current=null;pc.ComponentSystem.on(%22update%22,this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=[%22enabled%22];f._super.initializeComponentData.call(this,%20a,b,d)},onUpdate:function(){if(this.current){var%20a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var%20a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){f._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){f._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});%20return{AudioListenerComponent:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.enabled=!0},pc.ComponentData);return{AudioListenerComponentData:f}}());pc.extend(pc,{BODYTYPE_STATIC:%22static%22,BODYTYPE_DYNAMIC:%22dynamic%22,BODYTYPE_KINEMATIC:%22kinematic%22,BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,%20BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});pc.extend(pc,function(){new%20pc.Mat4;new%20pc.Mat4;new%20pc.Vec3;new%20pc.Vec3;new%20pc.Vec3;var%20f,a,b={},d={},e=function(a,b,d){this.entity=a;this.point=b;this.normal=d},g=function(a,b,d){0===arguments.length?(this.b=this.a=null,this.localPointA=new%20pc.Vec3,this.localPointB=new%20pc.Vec3,this.pointA=new%20pc.Vec3,this.pointB=new%20pc.Vec3,this.normal=new%20pc.Vec3):(this.a=a,this.b=b,this.localPointA=d.localPoint,this.localPointB=d.localPointOther,this.pointA=d.point,this.pointB=d.pointOther,this.normal=d.normal)},%20h=function(a,b,d,e,f){0===arguments.length?(this.localPoint=new%20pc.Vec3,this.localPointOther=new%20pc.Vec3,this.point=new%20pc.Vec3,this.pointOther=new%20pc.Vec3,this.normal=new%20pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=d,this.pointOther=e,this.normal=f)},k=function(a,b){this.other=a;this.contacts=b},n=function(a){this.id=%22rigidbody%22;this.description=%22Adds%20the%20entity%20to%20the%20scene's%20physical%20simulation.%22;a.systems.add(this.id,this);this._stats=a.stats.frame;this.ComponentType=pc.RigidBodyComponent;%20this.DataType=pc.RigidBodyComponentData;this.contactPointPool=new%20pc.AllocatePool(h,1);this.contactResultPool=new%20pc.AllocatePool(k,1);this.singleContactResultPool=new%20pc.AllocatePool(g,1);this.schema=%22enabled%20type%20mass%20linearDamping%20angularDamping%20linearFactor%20angularFactor%20friction%20restitution%20group%20mask%20body%22.split(%22%20%22);this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on(%22remove%22,this.onRemove,this)},n=pc.inherits(n,pc.ComponentSystem);pc.extend(n.prototype,{onLibraryLoaded:function(){if(%22undefined%22!==%20typeof%20Ammo){var%20b=new%20Ammo.btDefaultCollisionConfiguration,d=new%20Ammo.btCollisionDispatcher(b),e=new%20Ammo.btDbvtBroadphase,g=new%20Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new%20Ammo.btDiscreteDynamicsWorld(d,e,g,b);this._ammoGravity=new%20Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);f=new%20Ammo.btVector3;a=new%20Ammo.btVector3;pc.ComponentSystem.on(%22update%22,this.onUpdate,this)}else%20pc.ComponentSystem.off(%22update%22,this.onUpdate,this)},initializeComponentData:function(a,%20b,d){var%20d=%22enabled%20mass%20linearDamping%20angularDamping%20linearFactor%20angularFactor%20friction%20restitution%20type%20group%20mask%22.split(%22%20%22),e={};d.forEach(function(a){e[a]=b[a]});b.bodyType&&(e.type=b.bodyType,console.warn(%22WARNING:%20rigidbody.bodyType:%20Property%20is%20deprecated.%20Use%20type%20instead.%22));e.linearFactor&&%22array%22===pc.type(e.linearFactor)&&(e.linearFactor=new%20pc.Vec3(e.linearFactor[0],e.linearFactor[1],e.linearFactor[2]));e.angularFactor&&%22array%22===pc.type(e.angularFactor)&&(e.angularFactor=new%20pc.Vec3(e.angularFactor[0],%20e.angularFactor[1],e.angularFactor[2]));n._super.initializeComponentData.call(this,a,e,d)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,%20type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a,b,d){void%200!==b&&void%200!==d?this.dynamicsWorld.addRigidBody(a,b,d):this.dynamicsWorld.addRigidBody(a);return%20a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return%20a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var%20a,%20b,d;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,d=arguments[0].z):(a=arguments[0],b=arguments[1],d=arguments[2]);this._ammoGravity.setValue(a,b,d);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,d,g){f.setValue(b.x,b.y,b.z);a.setValue(d.x,d.y,d.z);b=new%20Ammo.ClosestRayResultCallback(f,a);this.dynamicsWorld.rayTest(f,a,b);if(b.hasHit()){var%20d=b.get_m_collisionObject(),d=Ammo.castObject(d,Ammo.btRigidBody),h=b.get_m_hitPointWorld(),k=b.get_m_hitNormalWorld();d&&%20g(new%20e(d.entity,new%20pc.Vec3(h.x(),h.y(),h.z()),new%20pc.Vec3(k.x(),k.y(),k.z())))}Ammo.destroy(b)},_storeCollision:function(a,e){var%20f=!1,g=a.getGuid();b[g]=b[g]||{others:[],entity:a};0%3Eb[g].others.indexOf(e)&&(b[g].others.push(e),f=!0);d[g]=d[g]||{others:[],entity:a};d[g].others.push(e);return%20f},_createContactPointFromAmmo:function(a){var%20b=this.contactPointPool.allocate();b.localPoint.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPointOther.set(a.get_m_localPointB().x(),%20a.get_m_localPointB().y(),a.get_m_localPointB().z());b.point.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.pointOther.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return%20b},_createReverseContactPointFromAmmo:function(a){var%20b=this.contactPointPool.allocate();b.localPointOther.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),%20a.get_m_localPointA().z());b.localPoint.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.pointOther.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.point.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return%20b},_createSingleContactResult:function(a,b,d){var%20e=this.singleContactResultPool.allocate();%20e.a=a;e.b=b;e.localPointA=d.localPoint;e.localPointB=d.localPointOther;e.pointA=d.point;e.pointB=d.pointOther;e.normal=d.normal;return%20e},_createContactResult:function(a,b){var%20d=this.contactResultPool.allocate();d.other=a;d.contacts=b;return%20d},_cleanOldCollisions:function(){for(var%20a%20in%20b)if(b.hasOwnProperty(a)){for(var%20e=b[a].entity,f=e.collision,g=b[a].others,h=g.length;h--;){var%20k=g[h];if(!d[a]||0%3Ed[a].others.indexOf(k))g.splice(h,1),f&&k.collision&&(e.rigidbody&&k.rigidbody?f.fire(%22collisionend%22,%20k):e.trigger&&f.fire(%22triggerleave%22,k))}0===g.length&&delete%20b[a]}},onUpdate:function(a){this._stats.physicsStart=pc.now();frameContacts=0;this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var%20b=this.store,e;for(e%20in%20b)if(b.hasOwnProperty(e)){var%20f=b[e].entity,g=b[e].data;g.body&&(g.body.isActive()&&g.enabled&&f.enabled)&&(g.type===pc.BODYTYPE_DYNAMIC?f.rigidbody.syncBodyToEntity():g.type===pc.BODYTYPE_KINEMATIC&&f.rigidbody._updateKinematic(a))}var%20a=this.dynamicsWorld.getDispatcher(),%20b=a.getNumManifolds(),h;d={};for(e=0;e%3Cb;e++){var%20k=a.getManifoldByIndexInternal(e),n=k.getBody0(),x=k.getBody1(),f=Ammo.castObject(n,Ammo.btRigidBody),g=Ammo.castObject(x,Ammo.btRigidBody),f=f.entity,g=g.entity;if(f&&g){h=n.getCollisionFlags();var%20A=x.getCollisionFlags(),C=k.getNumContacts(),B=[],x=[],z;if(0%3CC)if(h&pc.BODYFLAG_NORESPONSE_OBJECT||A&pc.BODYFLAG_NORESPONSE_OBJECT)z=f.collision?f.collision.hasEvent(%22triggerenter%22)||f.collision.hasEvent(%22triggerleave%22):!1,n=g.collision?g.collision.hasEvent(%22triggerenter%22)||%20g.collision.hasEvent(%22triggerleave%22):!1,z&&(k=this._storeCollision(f,g))&&f.collision&&!(A&pc.BODYFLAG_NORESPONSE_OBJECT)&&f.collision.fire(%22triggerenter%22,g),n&&(k=this._storeCollision(g,f))&&g.collision&&!(h&pc.BODYFLAG_NORESPONSE_OBJECT)&&g.collision.fire(%22triggerenter%22,f);else%20if(z=f.collision?f.collision.hasEvent(%22collisionstart%22)||f.collision.hasEvent(%22collisionend%22)||f.collision.hasEvent(%22contact%22):!1,n=g.collision?g.collision.hasEvent(%22collisionstart%22)||g.collision.hasEvent(%22collisionend%22)||%20g.collision.hasEvent(%22contact%22):!1,(A=this.hasEvent(%22contact%22))||z||n){for(h=0;h%3CC;h++){var%20E=k.getContactPoint(h),G=this._createContactPointFromAmmo(E),R=null;if(z||n)R=this._createReverseContactPointFromAmmo(E),B.push(G),x.push(R);A&&(E=this._createSingleContactResult(f,g,G),this.fire(%22contact%22,E))}z&&(C=this._createContactResult(g,B),f.collision&&f.collision.fire(%22contact%22,C),(k=this._storeCollision(f,g))&&f.collision&&f.collision.fire(%22collisionstart%22,C));n&&(x=this._createContactResult(f,x),%20g.collision&&g.collision.fire(%22contact%22,x),(k=this._storeCollision(g,f))&&g.collision&&g.collision.fire(%22collisionstart%22,x))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll();this._stats.physicsTime=pc.now()-this._stats.physicsStart}});return{RIGIDBODY_TYPE_STATIC:%22static%22,RIGIDBODY_TYPE_DYNAMIC:%22dynamic%22,RIGIDBODY_TYPE_KINEMATIC:%22kinematic%22,RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,%20RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:n}}());pc.extend(pc,function(){var%20f,a,b,d,e,g=function(){%22undefined%22!==typeof%20Ammo&&!f&&(f=new%20Ammo.btTransform,a=new%20Ammo.btVector3,b=new%20Ammo.btVector3,d=new%20Ammo.btQuaternion,e=new%20Ammo.btVector3(0,0,0));this.on(%22set_mass%22,this.onSetMass,this);this.on(%22set_linearDamping%22,this.onSetLinearDamping,this);this.on(%22set_angularDamping%22,this.onSetAngularDamping,this);this.on(%22set_linearFactor%22,this.onSetLinearFactor,this);this.on(%22set_angularFactor%22,this.onSetAngularFactor,this);this.on(%22set_friction%22,this.onSetFriction,%20this);this.on(%22set_restitution%22,this.onSetRestitution,this);this.on(%22set_type%22,this.onSetType,this);this.on(%22set_group%22,this.onSetGroupOrMask,this);this.on(%22set_mask%22,this.onSetGroupOrMask,this);this.on(%22set_body%22,this.onSetBody,this);this._displacement=new%20pc.Vec3(0,0,0);this._linearVelocity=new%20pc.Vec3(0,0,0);this._angularVelocity=new%20pc.Vec3(0,0,0)},g=pc.inherits(g,pc.Component);Object.defineProperty(g.prototype,%22bodyType%22,{get:function(){console.warn(%22WARNING:%20bodyType:%20Function%20is%20deprecated.%20Query%20type%20property%20instead.%22);%20return%20this.type},set:function(a){console.warn(%22WARNING:%20bodyType:%20Function%20is%20deprecated.%20Set%20type%20property%20instead.%22);this.type=a}});Object.defineProperty(g.prototype,%22linearVelocity%22,{get:function(){if(this.isKinematic())return%20this._linearVelocity;if(this.body){var%20a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z());return%20this._linearVelocity}},set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var%20d=this.body;d&&(a.setValue(b.x,b.y,%20b.z),d.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,%22angularVelocity%22,{get:function(){if(this.isKinematic())return%20this._angularVelocity;if(this.body){var%20a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return%20this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);else{var%20d=this.body;d&&(a.setValue(b.x,b.y,b.z),d.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var%20b=this.entity,%20e;b.collision&&(e=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete%20b.trigger));if(e){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var%20f=this.isStaticOrKinematic(),g=f?0:this.mass,u=new%20Ammo.btVector3(0,0,0);f||e.calculateLocalInertia(g,u);var%20f=b.getPosition(),l=b.getRotation();d.setValue(l.x,l.y,l.z,l.w);l=new%20Ammo.btTransform;l.setIdentity();l.getOrigin().setValue(f.x,f.y,f.z);l.setRotation(d);f=new%20Ammo.btDefaultMotionState(l);e=new%20Ammo.btRigidBodyConstructionInfo(g,%20f,e,u);e=new%20Ammo.btRigidBody(e);e.setRestitution(this.restitution);e.setFriction(this.friction);e.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);e.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);e.setAngularFactor(a);e.entity=b;this.isKinematic()&&(e.setCollisionFlags(e.getCollisionFlags()|pc.BODYFLAG_KINEMATIC_OBJECT),e.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));b.rigidbody.body=e;this.enabled&&this.entity.enabled&&this.enableSimulation()}},%20isActive:function(){return%20this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var%20a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var%20a=%20this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var%20d,f,g,r,u,l;switch(arguments.length){case%201:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;break;case%202:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;r=arguments[1].x;u=arguments[1].y;l=arguments[1].z;break;case%203:d=arguments[0];f=arguments[1];g=arguments[2];break;case%206:d=arguments[0],f=arguments[1],g=arguments[2],%20r=arguments[3],u=arguments[4],l=arguments[5]}var%20m=this.body;m&&(m.activate(),a.setValue(d,f,g),void%200!==r?(b.setValue(r,u,l),m.applyForce(a,b)):m.applyForce(a,e))},applyTorque:function(){var%20b,d,e;switch(arguments.length){case%201:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case%203:b=arguments[0];d=arguments[1];e=arguments[2];break;default:console.error(%22ERROR:%20applyTorque:%20function%20takes%201%20or%203%20arguments%22);return}var%20f=this.body;f&&(f.activate(),a.setValue(b,d,e),f.applyTorque(a))},applyImpulse:function(){var%20d,%20f,g,r,u,l;switch(arguments.length){case%201:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;break;case%202:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;r=arguments[1].x;u=arguments[1].y;l=arguments[1].z;break;case%203:d=arguments[0];f=arguments[1];g=arguments[2];break;case%206:d=arguments[0],f=arguments[1],g=arguments[2],r=arguments[0],u=arguments[1],l=arguments[2]}var%20m=this.body;m&&(m.activate(),a.setValue(d,f,g),void%200!==r?(b.setValue(r,u,l),m.applyImpulse(a,b)):m.applyImpulse(a,e))},applyTorqueImpulse:function(){var%20b,%20d,e;switch(arguments.length){case%201:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case%203:b=arguments[0];d=arguments[1];e=arguments[2];break;default:console.error(%22ERROR:%20applyTorqueImpulse:%20function%20takes%201%20or%203%20arguments%22);return}var%20f=this.body;f&&(f.activate(),a.setValue(b,d,e),f.applyTorqueImpulse(a))},isStatic:function(){return%20this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return%20this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},isKinematic:function(){return%20this.type===%20pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var%20a=this.body;if(a){var%20b=this.entity.getPosition(),e=this.entity.getRotation(),f=a.getWorldTransform();f.getOrigin().setValue(b.x,b.y,b.z);d.setValue(e.x,e.y,e.z,e.w);f.setRotation(d);this.isKinematic()&&(b=this.body.getMotionState())&&b.setWorldTransform(f);a.activate()}},syncBodyToEntity:function(){var%20a=this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(f);var%20a=f.getOrigin(),b=f.getRotation();this.entity.setPosition(a.x(),%20a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3%3Earguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof%20pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);%20this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var%20a=this.entity.getPosition(),b=this.entity.getRotation();f.getOrigin().setValue(a.x,a.y,a.z);d.setValue(b.x,b.y,b.z,b.w);f.setRotation(d);this.body.getMotionState().setWorldTransform(f)}},onEnable:function(){g._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},%20onDisable:function(){g._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,d){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var%20e=new%20Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(d,e);a.setMassProps(d,e);a.updateInertiaTensor();b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,d){(a=this.data.body)&&a.setDamping(d,this.data.angularDamping)},onSetAngularDamping:function(a,b,d){(a=this.data.body)&&a.setDamping(this.data.linearDamping,%20d)},onSetLinearFactor:function(b,d,e){if(b=this.data.body)a.setValue(e.x,e.y,e.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,d,e){if(b=this.data.body)a.setValue(e.x,e.y,e.z),b.setAngularFactor(a)},onSetFriction:function(a,b,d){(a=this.data.body)&&a.setFriction(d)},onSetRestitution:function(a,b,d){(a=this.data.body)&&a.setRestitution(d)},onSetType:function(a,b,d){d!==b&&(this.disableSimulation(),d===pc.BODYTYPE_DYNAMIC?(this.data.group=pc.BODYGROUP_DYNAMIC,this.data.mask=pc.BODYMASK_ALL):%20d===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,d){d!==b&&(this.enabled&&this.entity.enabled)&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(){this.body&&this.data.simulationEnabled&&this.body.activate()}});return{RigidBodyComponent:g}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new%20pc.Vec3(1,1,1);this.angularFactor=new%20pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1},pc.ComponentData);return{RigidBodyComponentData:f}}());pc.extend(pc,function(){var%20f,a,b=function(b,e,g){this.entity=e.entity;this.component=e;this.app=b;%22undefined%22!==typeof%20Ammo&&(f=new%20Ammo.btVector3,a=new%20Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var%20e=this.entity;if((b=b.shape)&&%22undefined%22!==typeof%20Ammo){e.trigger&&e.trigger.destroy();var%20g=new%20Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var%20h=e.getPosition(),k=e.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new%20Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(h.x,%20h.y,h.z);k.setRotation(a);h=new%20Ammo.btDefaultMotionState(k);b=new%20Ammo.btRigidBodyConstructionInfo(1,h,b,g);this.body=b=new%20Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);f.setValue(0,0,0);b.setLinearFactor(f);b.setAngularFactor(f);b.setCollisionFlags(b.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);b.entity=e;this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){this.body&&this.app.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var%20b=%20this.body;if(b){var%20e=this.entity.getPosition(),f=this.entity.getRotation(),h=b.getWorldTransform();h.getOrigin().setValue(e.x,e.y,e.z);a.setValue(f.x,f.y,f.z,f.w);h.setRotation(a);b.activate()}},enable:function(){var%20a=this.body;a&&(this.app.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER),a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG),a.activate(),this.syncEntityToBody())},disable:function(){var%20a=this.body;a&&(this.app.systems.rigidbody.removeBody(a),%20a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION))}};return{Trigger:b}}());pc.extend(pc,function(){var%20f=function(a){this.id=%22collision%22;this.description=%22Specifies%20a%20collision%20volume.%22;a.systems.add(this.id,this);this.ComponentType=pc.CollisionComponent;this.DataType=pc.CollisionComponentData;this.schema=%22enabled%20type%20halfExtents%20radius%20axis%20height%20asset%20shape%20model%22.split(%22%20%22);this.implementations={};this.on(%22remove%22,this.onRemove,this);pc.ComponentSystem.on(%22update%22,this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);f.prototype=pc.extend(f.prototype,{onLibraryLoaded:function(){%22undefined%22===%20typeof%20Ammo&&pc.ComponentSystem.off(%22update%22,this.onUpdate,this)},initializeComponentData:function(a,b,d){var%20e={},d=%22type%20halfExtents%20radius%20axis%20height%20shape%20model%20asset%20enabled%22.split(%22%20%22);d.forEach(function(a){e[a]=b[a]});e.type||(e.type=a.data.type);a.data.type=e.type;e.halfExtents&&%22array%22===pc.type(e.halfExtents)&&(e.halfExtents=new%20pc.Vec3(e.halfExtents[0],e.halfExtents[1],e.halfExtents[2]));var%20g=this._createImplementation(e.type);g.beforeInitialize(a,e);f._super.initializeComponentData.call(this.system,%20a,e,d);g.afterInitialize(a,e)},_createImplementation:function(a){if(void%200===this.implementations[a]){var%20b;switch(a){case%20%22box%22:b=new%20CollisionBoxSystemImpl(this);break;case%20%22sphere%22:b=new%20CollisionSphereSystemImpl(this);break;case%20%22capsule%22:b=new%20CollisionCapsuleSystemImpl(this);break;case%20%22cylinder%22:b=new%20CollisionCylinderSystemImpl(this);break;case%20%22mesh%22:b=new%20CollisionMeshSystemImpl(this);break;default:throw%22Invalid%20collision%20system%20type:%20%22+a;}this.implementations[a]=b}return%20this.implementations[a]},%20_getImplementation:function(a){return%20this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return%20this._getImplementation(a).clone(a,b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var%20a,b,d,e=this.store;for(a%20in%20e)b=e[a].entity,d=e[a].data,d.enabled&&b.enabled&&!b.rigidbody&&b.trigger&&b.trigger.syncEntityToBody()},onTransformChanged:function(a,b,d,e){this.implementations[a.data.type].updateTransform(a,b,d,e)},changeType:function(a,b,%20d){this.implementations[b].remove(a.entity,a.data);this._createImplementation(d).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new%20pc.Model;b.model.graph=new%20pc.GraphNode},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,%20b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var%20b=a.entity,d=a.data;%22undefined%22!==typeof%20Ammo&&(d.shape=this.createPhysicalShape(a.entity,d),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody()):b.trigger?b.trigger.initialize(d):b.trigger=new%20pc.Trigger(this.system.app,a,d))},createPhysicalShape:function(){},updateTransform:function(a){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,b){var%20d=this.system.app;%20a.rigidbody&&a.rigidbody.body&&d.systems.rigidbody.removeBody(a.rigidbody.body);a.trigger&&(a.trigger.destroy(),delete%20a.trigger);d.scene.containsModel(b.model)&&(d.root.removeChild(b.model.graph),d.scene.removeModel(b.model))},clone:function(a,b){var%20d=this.system.dataStore[a.getGuid()];return%20this.system.addComponent(b,{enabled:d.data.enabled,type:d.data.type,halfExtents:[d.data.halfExtents.x,d.data.halfExtents.y,d.data.halfExtents.z],radius:d.data.radius,axis:d.data.axis,height:d.data.height,asset:d.data.asset,%20model:d.data.model})}};CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createPhysicalShape:function(a,b){if(%22undefined%22!==typeof%20Ammo){var%20d=b.halfExtents,d=new%20Ammo.btVector3(d.x,d.y,d.z);return%20new%20Ammo.btBoxShape(d)}}});CollisionSphereSystemImpl=function(){};CollisionSphereSystemImpl=pc.inherits(CollisionSphereSystemImpl,CollisionSystemImpl);CollisionSphereSystemImpl.prototype=%20pc.extend(CollisionSphereSystemImpl.prototype,{createPhysicalShape:function(a,b){if(%22undefined%22!==typeof%20Ammo)return%20new%20Ammo.btSphereShape(b.radius)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createPhysicalShape:function(a,b){var%20d=null,e=void%200!==b.axis?b.axis:1,f=b.radius||0.5,h=Math.max((b.height||2)-2*f,0);if(%22undefined%22!==%20typeof%20Ammo)switch(e){case%200:d=new%20Ammo.btCapsuleShapeX(f,h);break;case%201:d=new%20Ammo.btCapsuleShape(f,h);break;case%202:d=new%20Ammo.btCapsuleShapeZ(f,h)}return%20d}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=pc.extend(CollisionCylinderSystemImpl.prototype,{createPhysicalShape:function(a,b){var%20d=null,d=null,e=void%200!==b.axis?b.axis:1,f=void%200!==b.radius?b.radius:0.5,h=void%200!==%20b.height?b.height:1;if(%22undefined%22!==typeof%20Ammo)switch(e){case%200:d=new%20Ammo.btVector3(0.5*h,f,f);d=new%20Ammo.btCylinderShapeX(d);break;case%201:d=new%20Ammo.btVector3(f,0.5*h,f);d=new%20Ammo.btCylinderShape(d);break;case%202:d=new%20Ammo.btVector3(f,f,0.5*h),d=new%20Ammo.btCylinderShapeZ(d)}return%20d}});CollisionMeshSystemImpl=function(){};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,CollisionSystemImpl);CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},%20createPhysicalShape:function(a,b){if(%22undefined%22!==typeof%20Ammo&&b.model){var%20d=b.model,e=new%20Ammo.btCompoundShape,f,h;for(f=0;f%3Cd.meshInstances.length;f++){var%20k=d.meshInstances[f],n=k.mesh,r=n.indexBuffer[pc.RENDERSTYLE_SOLID],u=n.vertexBuffer,l=u.getFormat(),m=l.size/4,w;for(h=0;h%3Cl.elements.length;h++){var%20s=l.elements[h];s.name===pc.SEMANTIC_POSITION&&(w=new%20Float32Array(u.lock(),s.offset))}var%20r=new%20Uint16Array(r.lock()),u=n.primitive[0].count/3,l=new%20Ammo.btVector3,s=new%20Ammo.btVector3,D=new%20Ammo.btVector3,%20y,x,A=n.primitive[0].base,C=new%20Ammo.btTriangleMesh;for(h=0;h%3Cu;h++)n=r[A+3*h]*m,y=r[A+3*h+1]*m,x=r[A+3*h+2]*m,l.setValue(w[n],w[n+1],w[n+2]),s.setValue(w[y],w[y+1],w[y+2]),D.setValue(w[x],w[x+1],w[x+2]),C.addTriangle(l,s,D,!0);h=new%20Ammo.btBvhTriangleMeshShape(C,!0);m=k.node.getWorldTransform().getScale();h.setLocalScaling(new%20Ammo.btVector3(m.x,m.y,m.z));m=k.node.getPosition();k=k.node.getRotation();r=new%20Ammo.btTransform;r.setIdentity();r.getOrigin().setValue(m.x,m.y,m.z);m=new%20Ammo.btQuaternion;%20m.setValue(k.x,k.y,k.z,k.w);r.setRotation(m);e.addChildShape(r,h)}d=a.getWorldTransform().getScale();f=new%20Ammo.btVector3;f.setValue(d.x,d.y,d.z);e.setLocalScaling(f);return%20e}},recreatePhysicalShapes:function(a){var%20b=a.data;null!==b.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):(b.model=null,this.doRecreatePhysicalShape(a))},loadModelAsset:function(a){var%20b=this,d=a.data.asset,e=a.data,f=this.system.app.assets,h=f.get(d);if(h)h.ready(function(d){e.model=d.resource;b.doRecreatePhysicalShape(a)}),%20f.load(h);else%20f.once(%22add:%22+d,function(d){d.ready(function(d){e.model=d.resource;b.doRecreatePhysicalShape(a)});f.load(d)})},doRecreatePhysicalShape:function(a){var%20b=a.entity,d=a.data;d.model?(d.shape&&Ammo.destroy(d.shape),d.shape=this.createPhysicalShape(b,d),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(d):b.trigger=new%20pc.Trigger(this.system.app,a,d)):this.remove(b,d)},updateTransform:function(a,b,d,e){if(a.shape){var%20f=a.entity.getWorldTransform().getScale(),h=a.shape.getLocalScaling();%20(f.x!==h.x()||f.y!==h.y()||f.z!==h.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,a,b,d,e)}});return{CollisionComponentSystem:f}}());pc.extend(pc,function(){var%20f=function(){this.on(%22set_type%22,this.onSetType,this);this.on(%22set_halfExtents%22,this.onSetHalfExtents,this);this.on(%22set_radius%22,this.onSetRadius,this);this.on(%22set_height%22,this.onSetHeight,this);this.on(%22set_axis%22,this.onSetAxis,this);this.on(%22set_asset%22,this.onSetAsset,this);this.on(%22set_model%22,this.onSetModel,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{onSetType:function(a,b,d){b!==d&&this.system.changeType(this,b,d)},onSetHalfExtents:function(){this.data.initialized&&%20%22box%22===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&(%22sphere%22===this.data.type||%22capsule%22===this.data.type||%22cylinder%22===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&(%22capsule%22===this.data.type||%22cylinder%22===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&(%22capsule%22===this.data.type||%22cylinder%22===this.data.type)&&this.system.recreatePhysicalShapes(this)},%20onSetAsset:function(a,b,d){a=this.system.app.assets;b&&(b=a.get(b))&&b.off(%22remove%22,this.onAssetRemoved,this);if(d&&(d%20instanceof%20pc.Asset&&(this.data.asset=d.id),b=a.get(this.data.asset)))b.off(%22remove%22,this.onAssetRemoved,this),b.on(%22remove%22,this.onAssetRemoved,this);this.data.initialized&&%22mesh%22===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetModel:function(){this.data.initialized&&%22mesh%22===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(a){a.off(%22remove%22,%20this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)},onEnable:function(){f._super.onEnable.call(this);if(%22mesh%22===this.data.type&&this.data.asset&&this.data.initialized){var%20a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){f._super.onDisable.call(this);%20this.entity.trigger?this.entity.trigger.disable():this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()}});return{CollisionComponent:f}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.enabled=!0;this.type=%22box%22;this.halfExtents=new%20pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.ComponentData);return{CollisionComponentData:f}}());pc.extend(pc,function(){var%20f=function(a){this.id=%22particlesystem%22;this.description=%22Updates%20and%20renders%20particle%20system%20in%20the%20scene.%22;a.systems.add(this.id,this);this.ComponentType=pc.ParticleSystemComponent;this.DataType=pc.ParticleSystemComponentData;this.schema=%22enabled%20autoPlay%20numParticles%20lifetime%20rate%20rate2%20startAngle%20startAngle2%20loop%20preWarm%20lighting%20halfLambert%20intensity%20depthWrite%20noFog%20depthSoftening%20sort%20blendType%20stretch%20alignToMotion%20emitterShape%20emitterExtents%20emitterRadius%20initialVelocity%20wrap%20wrapBounds%20colorMapAsset%20normalMapAsset%20mesh%20localVelocityGraph%20localVelocityGraph2%20velocityGraph%20velocityGraph2%20rotationSpeedGraph%20rotationSpeedGraph2%20scaleGraph%20scaleGraph2%20colorGraph%20colorGraph2%20alphaGraph%20alphaGraph2%20colorMap%20normalMap%20animTilesX%20animTilesY%20animNumFrames%20animSpeed%20animLoop%22.split(%22%20%22);%20this.propertyTypes={emitterExtents:%22vec3%22,wrapBounds:%22vec3%22,localVelocityGraph:%22curveset%22,localVelocityGraph2:%22curveset%22,velocityGraph:%22curveset%22,velocityGraph2:%22curveset%22,colorGraph:%22curveset%22,colorGraph2:%22curveset%22,alphaGraph:%22curve%22,alphaGraph2:%22curve%22,rotationSpeedGraph:%22curve%22,rotationSpeedGraph2:%22curve%22,scaleGraph:%22curve%22,scaleGraph2:%22curve%22};this.on(%22remove%22,this.onRemove,this);pc.ComponentSystem.on(%22update%22,this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,%20b,d){var%20e={},d=[],g=this.propertyTypes,h,k;for(k%20in%20b)b.hasOwnProperty(k)&&(d.push(k),e[k]=b[k]),%22vec3%22===g[k]?%22array%22===pc.type(e[k])&&(e[k]=new%20pc.Vec3(e[k][0],e[k][1],e[k][2])):%22curve%22===g[k]?e[k]instanceof%20pc.Curve||(h=e[k].type,e[k]=new%20pc.Curve(e[k].keys),e[k].type=h):%22curveset%22===g[k]&&!(e[k]instanceof%20pc.CurveSet)&&(h=e[k].type,e[k]=new%20pc.CurveSet(e[k].keys),e[k].type=h);f._super.initializeComponentData.call(this,a,e,d)},cloneComponent:function(a,b){for(var%20d=a.particlesystem.data,e=this.schema,%20f={},h=0,k=e.length;h%3Ck;h++){var%20n=e[h],r=d[n];r%20instanceof%20pc.Vec3||r%20instanceof%20pc.Curve||r%20instanceof%20pc.CurveSet?(r=r.clone(),f[n]=r):null!==r&&void%200!==r&&(f[n]=r)}return%20this.addComponent(b,f)},onUpdate:function(a){var%20b=this.store,d,e,f;for(f%20in%20b)if(b.hasOwnProperty(f)){d=b[f];var%20h=d.entity;d=d.data;if(d.enabled&&h.enabled&&(h=d.model.emitter,!d.paused&&(h.simTime+=a,d=0,h.simTime%3Eh.fixedTimeStep&&(d=Math.floor(h.simTime/h.fixedTimeStep),h.simTime-=d*h.fixedTimeStep),d))){d=Math.min(d,h.maxSubSteps);%20for(e=0;e%3Cd;e++)h.addTime(h.fixedTimeStep)}}},onRemove:function(a,b){b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{ParticleSystemComponentSystem:f}}());pc.extend(pc,function(){var%20f=%22emitterExtents%20emitterRadius%20loop%20initialVelocity%20animSpeed%20normalMap%22.split(%22%20%22),a=%22numParticles%20lifetime%20rate%20rate2%20startAngle%20startAngle2%20lighting%20halfLambert%20intensity%20wrap%20wrapBounds%20depthWrite%20noFog%20sort%20stretch%20alignToMotion%20preWarm%20emitterShape%20animTilesX%20animTilesY%20animFrames%20animLoop%20colorMap%22.split(%22%20%22),b=%22scaleGraph%20scaleGraph2%20colorGraph%20colorGraph2%20alphaGraph%20alphaGraph2%20velocityGraph%20velocityGraph2%20localVelocityGraph%20localVelocityGraph2%20rotationSpeedGraph%20rotationSpeedGraph2%22.split(%22%20%22),%20d=[%22colorMapAsset%22,%22normalMapAsset%22,%22mesh%22],e=function(){this.on(%22set_colorMapAsset%22,this.onSetColorMapAsset,this);this.on(%22set_normalMapAsset%22,this.onSetNormalMapAsset,this);this.on(%22set_mesh%22,this.onSetMesh,this);this.on(%22set_loop%22,this.onSetLoop,this);this.on(%22set_blendType%22,this.onSetBlendType,this);this.on(%22set_depthSoftening%22,this.onSetDepthSoftening,this);f.forEach(function(a){this.on(%22set_%22+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on(%22set_%22+a,this.onSetComplexProperty,%20this)}.bind(this));b.forEach(function(a){this.on(%22set_%22+a,this.onSetGraphProperty,this)}.bind(this))},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onSetColorMapAsset:function(a,b,d){var%20e=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off(%22remove%22,this.onColorMapRemoved,this);if(d)if(d%20instanceof%20pc.Asset&&(d=this.data.colorMapAsset=d.id),a=f.get(d))a.on(%22remove%22,this.onColorMapRemoved,this),a.ready(function(a){e.colorMap=a.resource}),e.enabled&&e.entity.enabled&&f.load(a);else%20f.once(%22add:%22+%20d,function(a){a.on(%22remove%22,this.onColorMapRemoved,this);a.ready(function(a){e.colorMap=a.resource});e.enabled&&e.entity.enabled&&f.load(a)});else%20this.colorMap=null},onColorMapRemoved:function(a){a.off(%22remove%22,this.onColorMapRemoved,this);this.colorMapAsset=null},onSetNormalMapAsset:function(a,b,d){var%20e=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off(%22remove%22,this.onNormalMapRemoved,this);if(d)if(d%20instanceof%20pc.Asset&&(d=this.data.normalMapAsset=d.id),a=f.get(d))a.on(%22remove%22,this.onNormalMapRemoved,%20this),a.ready(function(a){e.normalMap=a.resource}),e.enabled&&e.entity.enabled&&f.load(a);else%20f.once(%22add:%22+d,function(a){a.on(%22remove%22,this.onNormalMapRemoved,this);a.ready(function(a){e.normalMap=a.resource});e.enabled&&e.entity.enabled&&f.load(a)});else%20this.normalMap=null},onNormalMapRemoved:function(a){a.off(%22remove%22,this.onNormalMapRemoved,this);this.normalMapAsset=null},onSetMesh:function(a,b,d){var%20e=this,f=this.system.app.assets;b&&%22number%22===typeof%20b&&(a=f.get(b))&&a.off(%22remove%22,this.onMeshRemoved,%20this);if(d)if(d%20instanceof%20pc.Asset&&(d=this.data.mesh=d.id),%22number%22===typeof%20d)if(a=f.get(d))a.on(%22remove%22,this.onMeshRemoved,this),a.ready(function(a){e._onMeshChanged(a.resource)}),e.enabled&&e.entity.enabled&&f.load(a);else%20f.once(%22add:%22+d,function(a){a.on(%22remove%22,this.onMeshRemoved,this);a.ready(function(a){e._onMeshChanged(a.resource)});e.enabled&&e.entity.enabled&&f.load(a)});else%20this._onMeshChanged(d);else%20this._onMeshChanged(null)},_onMeshChanged:function(a){a&&!(a%20instanceof%20pc.Mesh)&&%20(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onMeshRemoved:function(a){a.off(%22remove%22,this.onMeshRemoved,this);this.mesh=null},onSetLoop:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.resetTime())},onSetBlendType:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.material.blendType=d,this.emitter.resetMaterial(),this.rebuild())},onSetDepthSoftening:function(a,b,d){if(this.emitter&&%20b!==d){if(d){if(this.emitter[a]=d,this.enabled)this.emitter.onEnableDepth()}else{if(this.enabled)this.emitter.onDisableDepth();this.emitter[a]=d}this.reset();this.emitter.resetMaterial();this.rebuild()}},onSetSimpleProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,%20this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var%20a=0,b=d.length;a%3Cb;a++){var%20f=this.data[d[a]];if(f){if(!(f%20instanceof%20pc.Asset))if(0%3C=parseInt(f,10))f=this.system.app.assets.get(f);else%20continue;f&&!f.resource&&this.system.app.assets.load(f)}}a=!1;!this.emitter&&!this.system._inTools&&(b=this.data.mesh,b%20instanceof%20pc.Mesh||(b=null),a=!0,this.emitter=new%20pc.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:this.data.numParticles,emitterExtents:this.data.emitterExtents,%20emitterRadius:this.data.emitterRadius,emitterShape:this.data.emitterShape,initialVelocity:this.data.initialVelocity,wrap:this.data.wrap,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,animTilesX:this.data.animTilesX,animTilesY:this.data.animTilesY,animNumFrames:this.data.animNumFrames,animSpeed:this.data.animSpeed,animLoop:this.data.animLoop,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,scaleGraph:this.data.scaleGraph,scaleGraph2:this.data.scaleGraph2,%20colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,loop:this.data.loop,preWarm:this.data.preWarm,%20sort:this.data.sort,stretch:this.data.stretch,alignToMotion:this.data.alignToMotion,lighting:this.data.lighting,halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,scene:this.system.app.scene,mesh:b,depthWrite:this.data.depthWrite,noFog:this.data.noFog,node:this.entity,blendType:this.data.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new%20pc.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=%20[this.emitter.meshInstance],this.data.model=this.psys,this.emitter.psys=this.psys,this.data.autoPlay||this.pause());if(this.data.model&&(!this.system.app.scene.containsModel(this.data.model)&&this.emitter.colorMap)&&(this.system.app.scene.addModel(this.data.model),!a))this.emitter.onEnableDepth();e._super.onEnable.call(this)},onDisable:function(){e._super.onDisable.call(this);this.data.model&&this.system.app.scene.containsModel(this.data.model)&&(this.system.app.scene.removeModel(this.data.model),%20this.emitter.onDisableDepth())},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return%20this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()%3C=this.emitter.endTime},rebuild:function(){var%20a=%20this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a}});return{ParticleSystemComponent:e}}());pc.extend(pc,function(){var%20f;f=pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new%20pc.Vec3;this.emitterRadius=0;this.emitterShape=pc.EMITTERSHAPE_BOX;this.initialVelocity=0;this.wrapBounds=new%20pc.Vec3;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.sort=0;this.mode=pc.PARTICLEMODE_GPU;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=%201;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=null;this.noFog=this.depthWrite=!1;this.animSpeed=this.animNumFrames=this.animTilesY=this.animTilesX=1;this.animLoop=!0;this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=%20!1;this.autoPlay=!0},pc.ComponentData);return{ParticleSystemComponentData:f}}());pc.extend(pc,function(){var%20f=function(a){this._guid=pc.guid.create();this._batchHandle=null;this.c={};this._app=a;a||(this._app=pc.Application.getApplication())||console.error(%22Couldn't%20find%20current%20application%22);pc.events.attach(this)},f=pc.inherits(f,pc.GraphNode);f.prototype.addComponent=function(a,b){var%20d=this._app.systems[a];if(d)if(this.c[a])logERROR(pc.string.format(%22Entity%20already%20has%20{0}%20Component%22,a));else%20return%20d.addComponent(this,b);else%20return%20logERROR(pc.string.format(%22System:%20'{0}'%20doesn't%20exist%22,%20a)),null};f.prototype.removeComponent=function(a){var%20b=this._app.systems[a];b?this.c[a]?b.removeComponent(this):logERROR(pc.string.format(%22Entity%20doesn't%20have%20{0}%20Component%22,a)):logERROR(pc.string.format(%22System:%20'{0}'%20doesn't%20exist%22,a))};f.prototype.getGuid=function(){return%20this._guid};f.prototype.setGuid=function(a){this._guid=a};f.prototype._onHierarchyStateChanged=function(a){pc.Entity._super._onHierarchyStateChanged.call(this,a);var%20b,d=this.c,e;for(e%20in%20d)if(d.hasOwnProperty(e)&&(b=d[e],b.enabled))if(a)b.onEnable();%20else%20b.onDisable()};f.prototype.setRequest=function(a){this._request=a};f.prototype.getRequest=function(){return%20this._request};f.prototype.addChild=function(a){if(a%20instanceof%20pc.Entity&&this.getRoot().findOne(%22getGuid%22,a.getGuid()))throw%20Error(%22GUID%20already%20exists%20in%20graph%22);pc.GraphNode.prototype.addChild.call(this,a)};f.prototype.findByGuid=function(a){if(this._guid===a)return%20this;for(var%20b=0;b%3Cthis._children.length;b++)if(this._children[b].findByGuid){var%20d=this._children[b].findByGuid(a);if(null!==%20d)return%20d}return%20null};f.prototype.destroy=function(){var%20a=this.getParent(),b;for(b%20in%20this.c)this.c[b].enabled=!1;for(b%20in%20this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b%20instanceof%20pc.Entity&&b.destroy(),b=a.shift()};f.prototype.clone=function(){var%20a,b=new%20pc.Entity(this._app);pc.Entity._super._cloneInternal.call(this,b);for(a%20in%20this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a%3Cthis.getChildren().length;a++){var%20d=this.getChildren()[a];%20d%20instanceof%20pc.Entity&&b.addChild(d.clone())}return%20b};f.deserialize=function(a){var%20b=pc.json.parse(a.template),d=pc.json.parse(a.parent),e=pc.json.parse(a.children),f=pc.json.parse(a.transform),h=pc.json.parse(a.components),k=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:k,template:b,parent:d,children:e,transform:f,components:h}};f.serialize=function(a){var%20b={_id:a._id,resource_id:a.resource_id,name:a.name,enabled:a.enabled,%20labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return%20b};return{Entity:f}}());pc.extend(pc,function(){var%20f=function(){this._handlers={};this._requests={};this._cache={}};f.prototype={addHandler:function(a,b){this._handlers[a]=b},removeHandler:function(a){delete%20this._handlers[a]},getHandler:function(a){return%20this._handlers[a]},load:function(a,b,d){var%20e=this._handlers[b];if(e){var%20f=a+b;void%200!==this._cache[f]?d(null,this._cache[f]):this._requests[f]?this._requests[f].push(d):(this._requests[f]=[d],e.load(a,function(b,d){if(this._requests[f]){var%20n,r=this._requests[f].length;%20if(b)for(n=0;n%3Cr;n++)this._requests[f][n](b);else{var%20u=e.open(a,d);this._cache[f]=u;for(n=0;n%3Cr;n++)this._requests[f][n](null,u)}delete%20this._requests[f]}}.bind(this)))}else%20d(%22No%20handler%20for%20asset%20type:%20%22+b)},open:function(a,b){var%20d=this._handlers[a];return!d?(console.warn(%22No%20resource%20handler%20found%20for:%20%22+a),b):d.open(null,b)},patch:function(a,b){var%20d=this._handlers[a.type];d?d.patch&&d.patch(a,b):console.warn(%22No%20resource%20handler%20found%20for:%20%22+a.type)},clearCache:function(a,b){delete%20this._cache[a+%20b]},getFromCache:function(a,b){if(this._cache[a+b])return%20this._cache[a+b]},destroy:function(){this._handlers={};this._requests={};this._cache={}}};return{ResourceLoader:f}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20animation%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)}.bind(this))},open:function(a,b){return%20this[%22_parseAnimationV%22+b.animation.version](b)},_parseAnimationV3:function(a){var%20a=a.animation,b=new%20pc.Animation;b.setName(a.name);b.setDuration(a.duration);for(var%20d=0;d%3Ca.nodes.length;d++){var%20e=new%20pc.Node,f=a.nodes[d];e._name=f.name;for(var%20h=0;h%3Cf.keys.length;h++){var%20k=%20f.keys[h],n=k.time,r=k.pos,u=k.rot,k=k.scale,r=new%20pc.Vec3(r[0],r[1],r[2]),u=(new%20pc.Quat).setFromEulerAngles(u[0],u[1],u[2]),k=new%20pc.Vec3(k[0],k[1],k[2]),n=new%20pc.Key(n,r,u,k);e._keys.push(n)}b.addNode(e)}return%20b},_parseAnimationV4:function(a){var%20a=a.animation,b=new%20pc.Animation;b.setName(a.name);b.setDuration(a.duration);for(var%20d=0;d%3Ca.nodes.length;d++){var%20e=new%20pc.Node,f=a.nodes[d];e._name=f.name;for(var%20h=f.defaults.p,k=f.defaults.r,n=f.defaults.s,r=0;r%3Cf.keys.length;r++){var%20u=f.keys[r],%20l=u.t,m=h?h:u.p,w=k?k:u.r,u=n?n:u.s,m=new%20pc.Vec3(m[0],m[1],m[2]),w=(new%20pc.Quat).setFromEulerAngles(w[0],w[1],w[2]),u=new%20pc.Vec3(u[0],u[1],u[2]),l=new%20pc.Key(l,m,w,u);e._keys.push(l)}b.addNode(e)}return%20b}};return{AnimationHandler:f}}());pc.extend(pc,function(){var%20f=function(){var%20a=window.navigator.userAgent,d=a.indexOf(%22MSIE%20%22);return%200%3Cd?parseInt(a.substring(d+5,a.indexOf(%22.%22,d)),10):0%3Ca.indexOf(%22Trident/%22)?(d=a.indexOf(%22rv:%22),parseInt(a.substring(d+3,a.indexOf(%22.%22,d)),10)):!1}(),a=function(a){this.manager=a;try{this._audio=new%20Audio}catch(d){}};a.prototype={_isSupported:function(a){var%20d={%22.ogg%22:%22audio/ogg%22,%22.mp3%22:%22audio/mpeg%22,%22.wav%22:%22audio/x-wav%22},a=pc.path.getExtension(a);return%20d[a]?%22%22!==this._audio.canPlayType(d[a]):!1},%20load:function(a,d){var%20e=function(a){d(null,new%20pc.Sound(a))},f=function(e){e=e||%22Error%20loading%20audio%20url:%20%22+a;console.warn(e);d(e)};this._createSound?this._isSupported(a)?this._createSound(a,e,f):f(pc.string.format(%22Audio%20format%20for%20{0}%20not%20supported%22,a)):f(null)},open:function(a,d){return%20d}};pc.SoundManager.hasAudioContext()?a.prototype._createSound=function(a,d,e){var%20f=this.manager;f.context?pc.http.get(a,function(a,b){a&&e();f.context.decodeAudioData(b,d,e)}):e(%22Audio%20manager%20has%20no%20audio%20context%22)}:%20pc.SoundManager.hasAudio()&&(a.prototype._createSound=function(a,d,e){var%20g=null;try{g=new%20Audio}catch(h){e(%22No%20support%20for%20Audio%20element%22);return}f&&document.body.appendChild(g);var%20k=function(){g.removeEventListener(%22canplaythrough%22,k);f&&document.body.removeChild(g);d(g)};g.onerror=function(){g.onerror=null;f&&document.body.removeChild(g);e()};g.addEventListener(%22canplaythrough%22,k);g.src=a});return{AudioHandler:a}}());pc.extend(pc,function(){var%20f=function(a,b,d){this._device=a;this._assets=b;this._loader=d};f.prototype={load:function(){},open:function(){},patch:function(a,b){var%20d=this,e=!1;a.resources[0]||(a.resources[0]=new%20pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,cubemap:!0,autoMipmap:!0,fixCubemapSeams:!!a._dds}),e=!0);a.file?a.file&&!a._dds&&b._loader.load(a.file.url+%22?t=%22+a.file.hash,%22texture%22,function(e,f){e?(b.fire(%22error%22,e,a),b.fire(%22error:%22+a.id,e,a),a.fire(%22error%22,e,a)):(b._loader.patch({resource:f,%20type:%22texture%22,data:a.data},b),a._dds=f,d.patch(a,b))}):delete%20a._dds;if((!a.file||!a._dds)&&a.resources[1])a.resources=[a.resources[0]],e=!0;else%20if(a._dds&&!a.resources[1]){a.resources=[a.resources[0]];a._dds.fixCubemapSeams=!0;a._dds.autoMipmap=this._device.useTexCubeLod?!1:!0;a._dds.minFilter=this._device.useTexCubeLod?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;a._dds.magFilter=pc.FILTER_LINEAR;a._dds.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a._dds.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.resources.push(a._dds);%20for(e=1;6%3Ee;e++){var%20f=new%20pc.gfx.Texture(this._device,{cubemap:!0,fixCubemapSeams:!0,autoMipmap:!0,format:a._dds.format,rgbm:a._dds.rgbm,width:Math.pow(2,7-e),height:Math.pow(2,7-e)});f.addressU=pc.ADDRESS_CLAMP_TO_EDGE;f.addressV=pc.ADDRESS_CLAMP_TO_EDGE;f._levels[0]=a._dds._levels[e];f.upload();a.resources.push(f)}e=!0}f=a.resource;f.name!==a.name&&(f.name=a.name);a.data.hasOwnProperty(%22rgbm%22)&&f.rgbm!==!!a.data.rgbm&&(f.rgbm=!!a.data.rgbm);f.fixCubemapSeams=!!a._dds;a.data.hasOwnProperty(%22minFilter%22)&&%20f.minFilter!==a.data.minFilter&&(f.minFilter=a.data.minFilter);a.data.hasOwnProperty(%22magFilter%22)&&f.magFilter!==a.data.magFilter&&(f.magFilter=a.data.magFilter);a.data.hasOwnProperty(%22anisotropy%22)&&f.anisotropy!==a.data.anisotropy&&(f.anisotropy=a.data.anisotropy);f.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(f.addressU=pc.ADDRESS_CLAMP_TO_EDGE);f.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(f.addressV=pc.ADDRESS_CLAMP_TO_EDGE);this._patchTextureFaces(a,b);e&&(b.fire(%22load%22,a),b.fire(%22load:%22+a.id,a),a.fire(%22load%22,%20a))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(a,b){if(a.loadFaces||!a.file){var%20d=a.resource,e=[],f=0,h=!1,k=this;a._levelsEvents||(a._levelsEvents=[null,null,null,null,null,null]);a.data.textures.forEach(function(n,r){var%20u=function(l){f++;e[r]=l&&l.resource.getSource()||null;var%20n=a._levelsEvents[r];if(n!==l){n&&n.off(%22load%22,k._patchTexture,a);if(l)l.on(%22load%22,k._patchTexture,a);a._levelsEvents[r]=l||null}e[r]!==%20d._levels[0][r]&&(h=!0);6===f&&h&&(d.setSource(e),b.fire(%22load%22,a),b.fire(%22load:%22+a.id,a),a.fire(%22load%22,a))},l=b.get(a.data.textures[r]);if(l)l.ready(u),b.load(l);else%20if(n)b.once(%22load:%22+n,u);else%20u(null)})}}};return{CubemapHandler:f}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20JSON%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)})},open:function(a,b){return%20b},patch:function(){}};return{JsonHandler:f}}());pc.extend(pc,function(){var%20f={ambient:%22vec3%22,ambientTnumber:%22boolean%22,aoMap:%22texture%22,aoMapVertexColor:%22boolean%22,aoMapChannel:%22string%22,aoMapUv:%22number%22,aoMapTiling:%22vec2%22,aoMapOffset:%22vec2%22,occludeSpecular:%22boolean%22,diffuse:%22vec3%22,diffuseMap:%22texture%22,diffuseMapVertexColor:%22boolean%22,diffuseMapChannel:%22string%22,diffuseMapUv:%22number%22,diffuseMapTiling:%22vec2%22,diffuseMapOffset:%22vec2%22,diffuseMapTnumber:%22boolean%22,specular:%22vec3%22,specularMapVertexColor:%22boolean%22,specularMapChannel:%22string%22,specularMapUv:%22number%22,%20specularMap:%22texture%22,specularMapTiling:%22vec2%22,specularMapOffset:%22vec2%22,specularMapTnumber:%22boolean%22,specularAntialias:%22boolean%22,useMetalness:%22boolean%22,metalnessMap:%22texture%22,metalnessMapVertexColor:%22boolean%22,metalnessMapChannel:%22string%22,metalnessMapUv:%22number%22,metalnessMapTiling:%22vec2%22,metalnessMapOffset:%22vec2%22,metalnessMapTnumber:%22boolean%22,metalness:%22number%22,conserveEnergy:%22boolean%22,shininess:%22number%22,glossMap:%22texture%22,glossMapVertexColor:%22boolean%22,glossMapChannel:%22string%22,glossMapUv:%22number%22,%20glossMapTiling:%22vec2%22,glossMapOffset:%22vec2%22,fresnelModel:%22number%22,fresnelFactor:%22float%22,emissive:%22vec3%22,emissiveMap:%22texture%22,emissiveMapVertexColor:%22boolean%22,emissiveMapChannel:%22string%22,emissiveMapUv:%22number%22,emissiveMapTiling:%22vec2%22,emissiveMapOffset:%22vec2%22,emissiveMapTint:%22boolean%22,emissiveIntensity:%22number%22,normalMap:%22texture%22,normalMapTiling:%22vec2%22,normalMapOffset:%22vec2%22,normalMapUv:%22number%22,bumpMapFactor:%22number%22,heightMap:%22texture%22,heightMapChannel:%22string%22,heightMapUv:%22number%22,heightMapTiling:%22vec2%22,%20heightMapOffset:%22vec2%22,heightMapFactor:%22number%22,alphaTest:%22number%22,opacity:%22number%22,opacityMap:%22texture%22,opacityMapVertexColor:%22boolean%22,opacityMapChannel:%22string%22,opacityMapUv:%22number%22,opacityMapTiling:%22vec2%22,opacityMapOffset:%22vec2%22,reflectivity:%22number%22,refraction:%22number%22,refractionIndex:%22number%22,sphereMap:%22texture%22,cubeMap:%22cubemap%22,cubeMapProjection:%22boolean%22,lightMap:%22texture%22,lightMapVertexColor:%22boolean%22,lightMapChannel:%22string%22,lightMapUv:%22number%22,lightMapTiling:%22vec2%22,lightMapOffset:%22vec2%22,%20depthTest:%22boolean%22,depthWrite:%22boolean%22,cull:%22number%22,blendType:%22number%22,shadowSampleType:%22number%22,shadingModel:%22number%22},a=function(a){for(var%20b=%22cubeMap%20prefilteredCubeMap128%20prefilteredCubeMap64%20prefilteredCubeMap32%20prefilteredCubeMap16%20prefilteredCubeMap8%20prefilteredCubeMap4%22.split(%22%20%22),f=0;f%3Cb.length;f++)this[b[f]]!==a.resources[f]&&(this[b[f]]=a.resources[f]);this.update()},b=function(a){this._assets=a};b.prototype={load:function(a,b){pc.http.get(a,function(f,h){f?b&&b(pc.string.format(%22Error%20loading%20material:%20{0}%20[{1}]%22,%20a,f)):b&&b(null,h)})},open:function(a,b){var%20f=new%20pc.PhongMaterial;b.parameters||this._createParameters(b);f.init(b);f._data=b;return%20f},_createParameters:function(a){var%20b=[];a.shadingModel||(a.shadingModel=%22blinn%22===a.shader?pc.SPECULAR_BLINN:pc.SPECULAR_PHONG);var%20g=a.shader;delete%20a.shader;for(var%20h%20in%20a)a.hasOwnProperty(h)&&b.push({name:h,type:f[h],data:a[h]});a.shader=g;a.parameters=b},patch:function(a,b){void%200===a.data.shader&&(a.data=a.resource._data,delete%20a.resource._data);this._updatePhongMaterial(a,%20a.data,b);a.off(%22change%22,this._onAssetChange,this);a.on(%22change%22,this._onAssetChange,this)},_onAssetChange:function(a,b,f){%22data%22===b&&this._updatePhongMaterial(a,f,this._assets)},_updatePhongMaterial:function(b,e,f){var%20h=b.resource,k;b.file&&(k=pc.path.getDirectory(b.getFileUrl()));e.name=b.name;e.parameters||this._createParameters(e);var%20n=%22path%22===e.mapping_format;e.parameters.forEach(function(r,u){var%20l;if(%22texture%22===r.type){h._assetHandlers||(h._assetHandlers={});var%20m=h._assetHandlers[r.name];%20if(r.data&&!(r.data%20instanceof%20pc.Texture))if(n?b=f.getByUrl(pc.path.join(k,r.data)):(l=r.data,b=f.get(r.data)),m&&(f.off(%22load:%22+m.id,m.bind),f.off(%22add:%22+m.id,m.add),f.off(%22remove:%22+m.id,m.remove),m.url&&(f.off(%22add:url:%22+m.url,m.add),f.off(%22remove:url:%22+m.url,m.remove)),h._assetHandlers[r.name]=null),m=h._assetHandlers[r.name]={id:l,url:n?pc.path.join(k,r.data):%22%22,bind:function(a){e.parameters[u].data=a.resource;h[e.parameters[u].name]=a.resource;h.update()},add:function(a){f.load(a)},remove:function(a){h[e.parameters[u].name]===%20a.resource&&(e.parameters[u].data=null,h[e.parameters[u].name]=null,h.update())}},l?(f.on(%22load:%22+l,m.bind),f.on(%22remove:%22+l,m.remove)):n&&(f.on(%22load:url:%22+pc.path.join(k,r.data),m.bind),f.on(%22remove:url:%22+pc.path.join(k,r.data),m.remove)),b)b.resource&&m.bind(b),f.load(b);else%20if(l)f.once(%22add:%22+l,m.add);else{if(n)f.once(%22add:url:%22+m.url,m.add)}else%20m&&!r.data&&(f.off(%22load:%22+m.id,m.bind),f.off(%22add:%22+m.id,m.add),f.off(%22remove:%22+m.id,m.remove),m.url&&(f.off(%22add:url:%22+m.url,m.add),f.off(%22remove:url:%22+%20m.url,m.remove)),h._assetHandlers[r.name]=null)}else%20if(%22cubemap%22===r.type&&r.data&&!(r.data%20instanceof%20pc.Texture)){n?b=f.getByUrl(pc.path.join(k,r.data)):(l=r.data,b=f.get(r.data));var%20m=function(a){e.shadingModel===pc.SPECULAR_PHONG&&(a.loadFaces=!0);a.ready(w);f.load(a)},w=function(b){r.data=b.resource;1%3Cb.resources.length&&(e.parameters.push({name:%22prefilteredCubeMap128%22,data:b.resources[1]}),e.parameters.push({name:%22prefilteredCubeMap64%22,data:b.resources[2]}),e.parameters.push({name:%22prefilteredCubeMap32%22,%20data:b.resources[3]}),e.parameters.push({name:%22prefilteredCubeMap16%22,data:b.resources[4]}),e.parameters.push({name:%22prefilteredCubeMap8%22,data:b.resources[5]}),e.parameters.push({name:%22prefilteredCubeMap4%22,data:b.resources[6]}));h.init(e);b.off(%22load%22,a,h);b.on(%22load%22,a,h)};if(b)m(b);else%20if(l)f.once(%22add:%22+l,m);else%20if(n)f.once(%22add:url:%22+pc.path.join(k,r.data),function(b){b.ready(function(b){e.parameters[u].data=b.resource;h.init(e);b.off(%22load%22,a,h);b.on(%22load%22,a,h)});f.load(b)})}});h.init(e)}};%20return{MaterialHandler:b,getMaterialParamType:function(a){return%20f[a]}}}());pc.extend(pc,function(){var%20f=function(a){this._device=a};f.DEFAULT_MATERIAL=new%20pc.PhongMaterial;f.DEFAULT_MATERIAL.shadingModel=pc.SPECULAR_BLINN;f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b&&b(pc.string.format(%22Error%20loading%20model:%20{0}%20[{1}]%22,a,d)):b&&b(null,e)})},open:function(a,b){if(b.model){if(1%3E=b.model.version)logERROR(pc.string.format(%22Asset:%20{0},%20is%20an%20old%20model%20format.%20Upload%20source%20assets%20to%20re-import.%22,a));else%20if(2%3C=b.model.version)return(new%20pc.JsonModelParser(this._device)).parse(b);%20return%20null}},patch:function(a,b){if(a.resource){var%20d=a.data;a.resource.meshInstances.forEach(function(e,f){if(d.mapping){var%20h=function(a){a.resource?e.material=a.resource:(a.once(%22load%22,h),b.load(a));a.once(%22remove%22,function(a){e.material===a.resource&&(e.material=pc.ModelHandler.DEFAULT_MATERIAL)})};if(d.mapping[f]){var%20k=d.mapping[f].material,n=d.mapping[f].path;if(void%200!==k)if(k)if(n=b.get(k))h(n);else%20b.once(%22add:%22+k,h);else%20e.material=pc.ModelHandler.DEFAULT_MATERIAL;else%20if(void%200!==n&&%20n)if(k=a.getFileUrl(),k=pc.path.getDirectory(k),k=pc.path.join(k,d.mapping[f].path),n=b.getByUrl(k))h(n);else%20b.once(%22add:url:%22+k,h)}else%20e.material=pc.ModelHandler.DEFAULT_MATERIAL}})}}};return{ModelHandler:f}}());pc.extend(pc,function(){var%20f=function(a){this._app=a;this._scripts={}};f._types=[];f._push=function(a){0%3Cf._types.length?console.assert(%22Script%20Ordering%20Error.%20Contact%20support@playcanvas.com%22):f._types.push(a)};f.prototype={load:function(a,b){pc.script.app=this._app;this._loadScript(a,function(a,e){if(a)b(a);else{var%20g=null;f._types.length&&(g=f._types.pop());g?this._scripts[e]=g:g=null;b(null,g)}}.bind(this))},open:function(a,b){return%20b},patch:function(){},_loadScript:function(a,b){var%20d=document.getElementsByTagName(%22head%22)[0],%20e=document.createElement(%22script%22);e.async=!1;e.addEventListener(%22error%22,function(a){b(pc.string.format(%22Script:%20{0}%20failed%20to%20load%22,a.target.src))});var%20f=!1;e.onload=e.onreadystatechange=function(){if(!f&&(!this.readyState||%22loaded%22==this.readyState||%22complete%22==this.readyState))f=!0,b(null,a)};e.src=a;d.appendChild(e)}};return{ScriptHandler:f}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20text%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)})},open:function(a,b){return%20b},patch:function(){}};return{TextHandler:f}}());pc.extend(pc,function(){var%20f={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b,f){this._device=a;this._assets=b;this._loader=f;this.crossOrigin=void%200};b.prototype={load:function(a,b){var%20f=%200%3C=a.indexOf(%22?%22)?a.split(%22?%22)[0]:a,f=pc.path.getExtension(f).toLowerCase();if(%22.dds%22===f||%22.crn%22===f)pc.http.get(a,{cache:!0,responseType:%22arraybuffer%22},function(a,d){a?b(a):b(null,d)});else%20if(%22.jpg%22===f||%22.jpeg%22===f||%22.gif%22===f||%22.png%22===f){var%20h=new%20Image;void%200!==this.crossOrigin&&(h.crossOrigin=this.crossOrigin);h.onload=function(){b(null,h)};h.onerror=function(){b(pc.string.format(%22Error%20loading%20Texture%20from:%20'{0}'%22,a))};h.src=a}},open:function(a,b){if(a){var%20f,h=pc.path.getExtension(a).toLowerCase(),%20k=null;if(b%20instanceof%20Image||b%20instanceof%20HTMLImageElement){var%20n=b,k=%22.jpg%22===h||%22.jpeg%22===h?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8;f=new%20pc.Texture(this._device,{width:n.width,height:n.height,format:k});f.setSource(n)}else%20if(b%20instanceof%20ArrayBuffer){if(%22.crn%22===h){var%20h=b.byteLength,r=new%20Uint8Array(b),n=Module._malloc(h),u=Module.HEAPU8,l,m=n/4,w=h%4,s=new%20Uint32Array(r.buffer,0,(h-w)/4),D=new%20Uint32Array(u.buffer);for(l=0;l%3Cs.length;l++)D[m+l]=s[l];for(l=h-w;l%3Ch;l++)u[n+l]=r[l];%20r=Module._crn_decompress_get_data(n,h);h=Module._crn_decompress_get_size(n,h);b=Module.HEAPU8.buffer.slice(r,r+h)}f=new%20Uint32Array(b,0,32);var%20h=f[4],n=f[3],r=Math.max(f[7],1),y=f[21],x=f[22],u=65024===f[28],D=s=w=m=l=!1;if(4===f[20])if(827611204===y)k=pc.PIXELFORMAT_DXT1,l=!0;else%20if(894720068===y)k=pc.PIXELFORMAT_DXT5,l=!0;else%20if(116===y)k=pc.PIXELFORMAT_RGBA32F,m=!0;else%20if(826496069===y)k=pc.PIXELFORMAT_ETC1,w=l=!0;else%20if(825438800===y||825504336===y)k=825438800===y?pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:%20pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1,s=l=!0;else{if(825439312===y||825504848===y)k=825439312===y?pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1,D=l=!0}else%2032===x&&(k=pc.PIXELFORMAT_R8_G8_B8_A8);f=Math.round(Math.log2(Math.max(h,n))+1);if(!k||r!==f&&l)return%20k?console.error(%22DDS%20has%20%22+r+%22%20mips,%20but%20engine%20requires%20%22+f+%22%20for%20DXT%20format.%20.%20Empty%20texture%20will%20be%20created%20instead.%22):console.error(%22This%20DDS%20pixel%20format%20is%20currently%20unsupported.%20Empty%20texture%20will%20be%20created%20instead.%22),f=%20new%20pc.Texture(this._device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8});f=new%20pc.Texture(this._device,{width:h,height:n,format:k,cubemap:u});u&&(f.addressU=pc.ADDRESS_CLAMP_TO_EDGE,f.addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(var%20k=128,x=u?6:1,A,y=827611204===y?8:16,C,B=0;B%3Cx;B++)for(var%20z=h,E=n,G=0;G%3Cr;G++)l?w?A=8*Math.floor((z+3)/4)*Math.floor((E+3)/4):s?A=Math.max(z,16)*Math.max(E,8)/4:D?A=Math.max(z,8)*Math.max(E,8)/2:(A=Math.floor((z+4-1)/4),C=Math.floor((E+4-1)/4),numBlocks=A*C,A=numBlocks*%20y):A=4*z*E,C=m?new%20Float32Array(b,k,A):new%20Uint8Array(b,k,A),u?(f._levels[G]||(f._levels[G]=[]),f._levels[G][B]=C):f._levels[G]=C,k+=m?4*A:A,z=Math.max(0.5*z,1),E=Math.max(0.5*E,1);f.upload()}return%20f}},patch:function(b){var%20e=b.resource;e&&(e.name!==b.name&&(e.name=b.name),b.data.hasOwnProperty(%22minfilter%22)&&e.minFilter!==a[b.data.minfilter]&&(e.minFilter=a[b.data.minfilter]),b.data.hasOwnProperty(%22magfilter%22)&&e.magFilter!==a[b.data.magfilter]&&(e.magFilter=a[b.data.magfilter]),b.data.hasOwnProperty(%22addressu%22)&&%20e.addressU!==f[b.data.addressu]&&(e.addressU=f[b.data.addressu]),b.data.hasOwnProperty(%22addressv%22)&&e.addressV!==f[b.data.addressv]&&(e.addressV=f[b.data.addressv]),b.data.hasOwnProperty(%22anisotropy%22)&&e.anisotropy!==b.data.anisotropy&&(e.anisotropy=b.data.anisotropy),b.data.hasOwnProperty(%22rgbm%22)&&e.rgbm!==!!b.data.rgbm&&(e.rgbm=!!b.data.rgbm))}};return{TextureHandler:b}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20html%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)})},open:function(a,b){return%20b},patch:function(){}};return{HtmlHandler:f}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20css%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)})},open:function(a,b){return%20b},patch:function(){}};return{CssHandler:f,createStyle:function(a){var%20b=document.createElement(%22style%22);b.type=%22text/css%22;b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));return%20b}}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format(%22Error%20loading%20shader%20resource:%20{0}%20[{1}]%22,a,d)):b(null,e)})},open:function(a,b){return%20b},patch:function(){}};return{ShaderHandler:f}}());pc.extend(pc,function(){var%20f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(%22Error%20requesting%20scene:%20%22+a):b(null,e)})},open:function(a,b){this._app.systems.script.preloading=!0;var%20d=(new%20pc.SceneParser(this._app)).parse(b),e=this._app.scene;e.root=d;this._app.applySceneSettings(b.settings);this._app.systems.script.preloading=!1;return%20e},patch:function(){}};return{SceneHandler:f}}());pc.extend(pc,function(){var%20f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(%22Error%20requesting%20scene:%20%22+a):b(null,e)})},open:function(a,b){this._app.systems.script.preloading=!0;var%20d=(new%20pc.SceneParser(this._app)).parse(b);this._app.systems.script.preloading=!1;return%20d}};return{HierarchyHandler:f}}());pc.extend(pc,function(){var%20f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(%22Error%20requesting%20scene:%20%22+a):b(null,e)})},open:function(a,b){return%20b.settings}};return{SceneSettingsHandler:f}}());pc.extend(pc,function(){var%20f=function(){};f.prototype={load:function(a,b){b(null,null)},open:function(a,b){return%20b}};return{FolderHandler:f}}());pc.extend(pc,function(){var%20f={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},a={int8:pc.ELEMENTTYPE_INT8,uint8:pc.ELEMENTTYPE_UINT8,int16:pc.ELEMENTTYPE_INT16,uint16:pc.ELEMENTTYPE_UINT16,int32:pc.ELEMENTTYPE_INT32,uint32:pc.ELEMENTTYPE_UINT32,float32:pc.ELEMENTTYPE_FLOAT32},b=function(a){this._device=a};b.prototype={parse:function(a){var%20b=%20this._parseNodes(a),f=this._parseSkins(a,b),h=this._parseVertexBuffers(a),k=this._parseIndexBuffers(a,h),h=this._parseMeshes(a,f.skins,h,k.buffer,k.data),a=this._parseMeshInstances(a,b,h,f.skins,f.instances),h=new%20pc.Model;h.graph=b[0];h.meshInstances=a;h.skinInstances=f.instances;h.getGraph().syncHierarchy();return%20h},_parseNodes:function(a){var%20a=a.model,b=[],f;for(f=0;f%3Ca.nodes.length;f++){var%20h=a.nodes[f],k=new%20pc.GraphNode;k.setName(h.name);k.setLocalPosition(h.position[0],h.position[1],h.position[2]);%20k.setLocalEulerAngles(h.rotation[0],h.rotation[1],h.rotation[2]);k.setLocalScale(h.scale[0],h.scale[1],h.scale[2]);b.push(k)}for(f=1;f%3Ca.parents.length;f++)b[a.parents[f]].addChild(b[f]);return%20b},_parseSkins:function(a,b){var%20f=a.model,h=[],k=[],n,r;!this._device.supportsBoneTextures&&0%3Cf.skins.length&&(n=this._device.getBoneLimit(),pc.partitionSkin(f,null,n));for(n=0;n%3Cf.skins.length;n++){var%20u=f.skins[n],l=[];for(r=0;r%3Cu.inverseBindMatrices.length;r++){var%20m=u.inverseBindMatrices[r];l[r]=new%20pc.Mat4(m[0],%20m[1],m[2],m[3],m[4],m[5],m[6],m[7],m[8],m[9],m[10],m[11],m[12],m[13],m[14],m[15])}u=new%20pc.Skin(this._device,l,u.boneNames);h.push(u);l=new%20pc.SkinInstance(u,b[0]);m=[];for(r=0;r%3Cu.boneNames.length;r++){var%20w=b[0].findByName(u.boneNames[r]);m.push(w)}l.bones=m;k.push(l)}return{skins:h,instances:k}},_parseVertexBuffers:function(b){var%20b=b.model,e=[],f,h,k={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,%20color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,texCoord1:pc.SEMANTIC_TEXCOORD1,texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7},n,r;for(n=0;n%3Cb.vertices.length;n++){var%20u=b.vertices[n];if(u.position&&u.normal&&u.texCoord0){f=[];for(r=0;r%3Cb.meshes.length;r++)b.meshes[r].vertices===n&&(f=f.concat(b.meshes[r].indices));f=pc.calculateTangents(u.position.data,%20u.normal.data,u.texCoord0.data,f);u.tangent={type:%22float32%22,components:4,data:f}}r=[];for(h%20in%20u){f=u[h];var%20l=f.type;this._device.supportsUnsignedByte||(%22uint8%22===l&&(l=%22float32%22),%22int8%22===l&&(l=%22float32%22));r.push({semantic:k[h],components:f.components,type:a[l],normalize:k[h]===pc.SEMANTIC_COLOR})}f=new%20pc.VertexFormat(this._device,r);var%20l=u.position.data.length/u.position.components,m=new%20pc.VertexBuffer(this._device,f,l),w=new%20pc.VertexIterator(m);for(r=0;r%3Cl;r++){for(h%20in%20u)switch(f=u[h],f.components){case%201:w.element[k[h]].set(f.data[r]);%20break;case%202:w.element[k[h]].set(f.data[2*r],f.data[2*r+1]);break;case%203:w.element[k[h]].set(f.data[3*r],f.data[3*r+1],f.data[3*r+2]);break;case%204:w.element[k[h]].set(f.data[4*r],f.data[4*r+1],f.data[4*r+2],f.data[4*r+3])}w.next()}w.end();e.push(m)}return%20e},_parseIndexBuffers:function(a,b){var%20f=a.model,h=null,k=null,n,r=0;for(n=0;n%3Cf.meshes.length;n++){var%20u=f.meshes[n];void%200!==u.indices&&(r+=u.indices.length)}for(n=f=0;n%3Cb.length;n++)f=Math.max(f,b[n].numVertices);0%3Cr&&(65535%3Cf&&this._device.extUintElement?%20(h=new%20pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT32,r),k=new%20Uint32Array(h.lock())):(h=new%20pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,r),k=new%20Uint16Array(h.lock())));return{buffer:h,data:k}},_parseMeshes:function(a,b,g,h,k){var%20a=a.model,n=[],r=0,u;for(u=0;u%3Ca.meshes.length;u++){var%20l=a.meshes[u],m=l.aabb,w=m.min,m=m.max,w=new%20pc.BoundingBox(new%20pc.Vec3(0.5*(m[0]+w[0]),0.5*(m[1]+w[1]),0.5*(m[2]+w[2])),new%20pc.Vec3(0.5*(m[0]-w[0]),0.5*(m[1]-w[1]),0.5*(m[2]-w[2]))),m=void%200!==l.indices,%20s=new%20pc.Mesh;s.vertexBuffer=g[l.vertices];s.indexBuffer[0]=m?h:null;s.primitive[0].type=f[l.type];s.primitive[0].base=m?l.base+r:l.base;s.primitive[0].count=l.count;s.primitive[0].indexed=m;s.skin=void%200!==l.skin?b[l.skin]:null;s.aabb=w;m&&(k.set(l.indices,r),r+=l.indices.length);n.push(s)}null!==h&&h.unlock();return%20n},_parseMeshInstances:function(a,b,f,h,k){var%20a=a.model,n=[],r;for(r=0;r%3Ca.meshInstances.length;r++){var%20u=a.meshInstances[r],l=f[u.mesh],u=new%20pc.MeshInstance(b[u.node],l,pc.ModelHandler.DEFAULT_MATERIAL);%20if(l.skin){l=h.indexOf(l.skin);if(-1===l)throw%20Error(%22Mesh's%20skin%20does%20not%20appear%20in%20skin%20array.%22);u.skinInstance=k[l]}n.push(u)}return%20n}};return{JsonModelParser:b}}());pc.extend(pc,function(){var%20f=function(a){this._app=a};f.prototype={parse:function(a){var%20b={},d,e,f=null;for(d%20in%20a.entities)b[d]=this._createEntity(a.entities[d]),null===a.entities[d].parent&&(f=b[d]);for(d%20in%20a.entities){var%20h=a.entities[d].children.length;for(e=0;e%3Ch;e++){var%20k=a.entities[d].children[e];b[k]&&b[d].addChild(b[k])}}this._openComponentData(f,a.entities);return%20f},_createEntity:function(a){var%20b=new%20pc.Entity,d=a.position,e=a.rotation,f=a.scale;b.setName(a.name);b.setGuid(a.resource_id);%20b.setLocalPosition(d[0],d[1],d[2]);b.setLocalEulerAngles(e[0],e[1],e[2]);b.setLocalScale(f[0],f[1],f[2]);b._enabled=void%200!==a.enabled?a.enabled:!0;b._enabledInHierarchy=b._enabled;b.template=a.template;a.labels&&a.labels.forEach(function(a){b.addLabel(a)});return%20b},_openComponentData:function(a,b){var%20d=this._app.systems.list(),e,f=d.length,h=b[a.getGuid()];for(e=0;e%3Cf;e++){var%20k=h.components[d[e].id];k&&this._app.systems[d[e].id].addComponent(a,k)}d=h.children.length;f=a.getChildren();for(e=0;e%3C%20d;e++)f[e]=this._openComponentData(f[e],b);return%20a}};return{SceneParser:f}}());pc.extend(pc,function(){var%20f=-1,a=function(a,d,e,g){this._id=++f;this.name=a;this.type=d;this.tags=new%20pc.Tags(this);this.preload=!1;this._file=e?{filename:e.filename,size:e.size,hash:e.hash,url:e.url}:null;this._data=g||{};this._resources=[];this.loading=this.loaded=!1;pc.events.attach(this)};a.prototype={getFileUrl:function(){return!this.file?null:this.file.url},ready:function(a,d){d=d||this;if(this.resource)a.call(d,this);else%20this.once(%22load%22,function(e){a.call(d,e)})},unload:function(){this.resource=%20null;this.loaded=!1}};Object.defineProperty(a.prototype,%22id%22,{get:function(){return%20this._id},set:function(a){this._id=a;a%3Ef&&(f=a)}});Object.defineProperty(a.prototype,%22file%22,{get:function(){return%20this._file},set:function(a){var%20d=this._file;this._file=a;if(!a||!d||a&&d&&a.hash!==d.hash)this.fire(%22change%22,this,%22file%22,a,d),this.loaded&&(%22cubemap%22===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))}});Object.defineProperty(a.prototype,%22data%22,{get:function(){return%20this._data},%20set:function(a){var%20d=this._data;this._data=a;a!==d&&(this.fire(%22change%22,this,%22data%22,a,d),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(a.prototype,%22resource%22,{get:function(){return%20this._resources[0]},set:function(a){var%20d=this._resources[0];this._resources[0]=a;this.fire(%22change%22,this,%22resource%22,a,d)}});Object.defineProperty(a.prototype,%22resources%22,{get:function(){return%20this._resources},set:function(a){var%20d=this._resources;this._resources=a;this.fire(%22change%22,%20this,%22resources%22,a,d)}});return{Asset:a,ASSET_ANIMATION:%22animation%22,ASSET_AUDIO:%22audio%22,ASSET_IMAGE:%22image%22,ASSET_JSON:%22json%22,ASSET_MODEL:%22model%22,ASSET_MATERIAL:%22material%22,ASSET_TEXT:%22text%22,ASSET_TEXTURE:%22texture%22,ASSET_CUBEMAP:%22cubemap%22,ASSET_SHADER:%22shader%22,ASSET_CSS:%22css%22,ASSET_HTML:%22html%22}}());pc.extend(pc,function(){var%20f=function(a){this._loader=a;this._assets=[];this._cache={};this._names={};this._tags=new%20pc.TagsCache(%22_id%22);this._urls={};this.prefix=null;pc.extend(this,pc.events)};f.prototype={list:function(a){a=a||{};return%20this._assets.filter(function(b){var%20d=!0;void%200!==a.preload&&(d=b.preload===a.preload);return%20d})},add:function(a){var%20b=this._assets.push(a)-1,d;this._cache[a.id]=b;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(b);a.file&&(d=a.getFileUrl(),%20this._urls[d]=b);a.registry=this;this._tags.addItem(a);a.tags.on(%22add%22,this._onTagAdd,this);a.tags.on(%22remove%22,this._onTagRemove,this);this.fire(%22add%22,a);this.fire(%22add:%22+a.id,a);d&&this.fire(%22add:url:%22+d,a)},remove:function(a){delete%20this._cache[a.id];delete%20this._names[a.name];var%20b=a.getFileUrl();b&&delete%20this._urls[b];this._tags.removeItem(a);a.tags.off(%22add%22,this._onTagAdd,this);a.tags.off(%22remove%22,this._onTagRemove,this);a.fire(%22remove%22,a);this.fire(%22remove%22,a);this.fire(%22remove:%22+a.id,a);%20b&&this.fire(%22remove:url:%22+b,a)},get:function(a){return%20this._assets[this._cache[a]]},getByUrl:function(a){return%20this._assets[this._urls[a]]},_compatibleLoad:function(a){var%20b=this;console.warn(%22DEPRECATED:%20Loading%20arrays%20of%20assets%20is%20deprecated.%20Call%20assets.load%20with%20single%20assets.%22);return%20new%20pc.promise.Promise(function(d){var%20e=a.length;a.forEach(function(f){f.ready(function(){e--;if(0===e){var%20b=a.map(function(a){return%20a.resource});d(b)}});b.load(f)})})},load:function(a){if(a%20instanceof%20Array)return%20this._compatibleLoad(a);%20if(!a.loading){var%20b=this;if(a.loaded)%22cubemap%22===a.type&&b._loader.patch(a,this);else{var%20d=!!a.file,e=function(){var%20d=b._loader.open(a.type,a.data);d%20instanceof%20Array?a.resources=d:a.resource=d;a.loaded=!0;b._loader.patch(a,b);b.fire(%22load%22,a);b.fire(%22load:%22+a.id,a);a.file&&a.file.url&&b.fire(%22load:url:%22+a.file.url,a);a.fire(%22load%22,a)};a.file&&%22cubemap%22===a.type&&(d=!1,this._loader.load(a.file.url+%22?t=%22+a.file.hash,%22texture%22,function(d,f){d?(b.fire(%22error%22,d,a),b.fire(%22error:%22+a.id,d,a),a.fire(%22error%22,%20d,a)):(b._loader.patch({resource:f,type:%22texture%22,data:a.data},b),a._dds=f,e())}));if(a.file){if(d){this.fire(%22load:start%22,a);this.fire(%22load:%22+a.id+%22:start%22,a);d=a.file.url;b.prefix&&(d.startsWith(%22/%22)&&(d=d.slice(1)),d=pc.path.join(b.prefix,d));var%20f=-1!==d.indexOf(%22&%22)?%22&%22:%22?%22,d=d+(f+%22t=%22+a.file.hash);a.loading=!0;b._loader.load(d,a.type,function(d,e){a.loaded=!0;a.loading=!1;d?(b.fire(%22error%22,d,a),b.fire(%22error:%22+a.id,d,a),a.fire(%22error%22,d,a)):(e%20instanceof%20Array?a.resources=e:a.resource=e,b._loader.patch(a,%20b),b.fire(%22load%22,a),b.fire(%22load:%22+a.id,a),a.file&&a.file.url&&b.fire(%22load:url:%22+a.file.url,a),a.fire(%22load%22,a))})}}else%20e()}}},loadFromUrl:function(a,b,d){var%20e=pc.path.getBasename(a),f={url:a},h={},a=this.getByUrl(a);a||(a=new%20pc.Asset(e,b,f,h),this.add(a));%22model%22===b?this._loadModel(a,d):(a.once(%22load%22,function(a){d(null,a)}),a.once(%22error%22,function(a){d(a)}),this.load(a))},_loadModel:function(a,b){var%20d=this,e=a.getFileUrl(),f=pc.path.getDirectory(e),e=pc.path.getBasename(e);e.replace(%22.json%22,%20%22%22);var%20e=pc.path.join(f,e.replace(%22.json%22,%22.mapping.json%22)),h=function(a){a.once(%22load%22,function(a){b(null,a)});a.once(%22error%22,function(a){b(a)});d.load(a)};this._loader.load(e,%22json%22,function(b,e){b?(a.data={mapping:[]},h(a)):d._loadMaterials(f,e,function(){a.data=e;h(a)})})},_loadMaterials:function(a,b,d){var%20e=this,f,h=b.mapping.length,k=[];0===h&&d(null,k);var%20n=function(a,b){k.push(b);h--;0===h&&e._loadTextures(k,function(){d(null,k)})};for(f=0;f%3Cb.mapping.length;f++){var%20r=b.mapping[f].path;%20r?e.loadFromUrl(pc.path.join(a,r),%22material%22,n):h--}},_loadTextures:function(a,b){var%20d,e,f={},h=[],k=[],n=0;for(d=0;d%3Ca.length;d++)if(a[d].data.parameters){var%20r=a[d].data.parameters;for(e=0;e%3Cr.length;e++)if(%22texture%22===r[e].type){var%20u=pc.path.getDirectory(a[d].getFileUrl()),u=pc.path.join(u,r[e].data);f[u]||(f[u]=!0,h.push(u),n++)}}else%20console.warn(%22Update%20material%20asset%20loader%20to%20support%20new%20material%20format%22);if(n){e=function(a,d){k.push(d);n--;0===n&&b(null,k)};for(d=0;d%3Ch.length;d++)this.loadFromUrl(h[d],%20%22texture%22,e)}else%20b(null,k)},findAll:function(a,b){var%20d=this,e=this._names[a];return%20e?(e=e.map(function(a){return%20d._assets[a]}),b?e.filter(function(a){return%20a.type===b}):e):[]},_onTagAdd:function(a,b){this._tags.add(a,b)},_onTagRemove:function(a,b){this._tags.remove(a,b)},findByTag:function(){return%20this._tags.find(arguments)},filter:function(a){for(var%20b=[],d=0,e=this._assets.length;d%3Ce;d++)a(this._assets[d])&&b.push(this._assets[d]);return%20b},find:function(a,b){var%20d=this.findAll(a,b);return%20d?%20d[0]:null},getAssetById:function(a){console.warn(%22DEPRECATED:%20getAssetById()%20use%20get()%20instead%22);return%20this.get(a)}};return{AssetRegistry:f}}());!function(f){var%20a,b,d={},e={};a=function(a,b,e){d[a]={deps:b,callback:e}};b=function(a){function%20f(b){if(%22.%22!==b.charAt(0))return%20b;for(var%20b=b.split(%22/%22),d=a.split(%22/%22).slice(0,-1),e=0,h=b.length;h%3Ee;e++){var%20k=b[e];%22..%22===k?d.pop():%22.%22!==k&&d.push(k)}return%20d.join(%22/%22)}if(e[a])return%20e[a];if(e[a]={},!d[a])throw%20Error(%22Could%20not%20find%20module%20%22+a);for(var%20k,n=d[a],r=n.deps,n=n.callback,u=[],l=0,m=r.length;m%3El;l++)u.push(%22exports%22===r[l]?k={}:b(f(r[l])));r=n.apply(this,u);return%20e[a]=k||r};b.entries=%20d;!0;a(%22rsvp/all-settled%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=b.isArray,u=b.isNonThenable;d[%22default%22]=function(a,b){return%20new%20e(function(b){function%20d(a){return%20function(b){h(a,{state:%22fulfilled%22,value:b})}}function%20g(a){return%20function(b){h(a,{state:%22rejected%22,reason:b})}}function%20h(a,d){C[a]=d;0===--m&&b(C)}if(!f(a))throw%20new%20TypeError(%22You%20must%20pass%20an%20array%20to%20allSettled.%22);var%20k,m=a.length;if(0===m)return%20void%20b([]);for(var%20C=Array(m),B=0;B%3Ca.length;B++)k=%20a[B],u(k)?h(B,{state:%22fulfilled%22,value:k}):e.resolve(k).then(d(B),g(B))},b)}});a(%22rsvp/all%22,[%22./promise%22,%22exports%22],function(a,b){var%20d=a[%22default%22];b[%22default%22]=function(a,b){return%20d.all(a,b)}});a(%22rsvp/asap%22,[%22exports%22],function(a){function%20b(){for(var%20a=0;a%3Ce.length;a++){var%20d=e[a];(0,d[0])(d[1])}e.length=0}a[%22default%22]=function(a,b){1===e.push([a,b])&&d()};var%20d,a=%22undefined%22!=typeof%20window?window:{},a=a.MutationObserver||a.WebKitMutationObserver,e=[];if(%22undefined%22!=typeof%20process&&%22[object%20process]%22===%20{}.toString.call(process))a=function(){process.nextTick(b)};else%20if(a)var%20f=0,a=new%20a(b),u=document.createTextNode(%22%22),a=(a.observe(u,{characterData:!0}),function(){u.data=f=++f%2});else%20a=function(){setTimeout(b,1)};d=a});a(%22rsvp/config%22,[%22./events%22,%22exports%22],function(a,b){var%20d={instrument:!1};a[%22default%22].mixin(d);b.config=d;b.configure=function(a,b){return%22onerror%22===a?void%20d.on(%22error%22,b):2!==arguments.length?d[a]:void(d[a]=b)}});a(%22rsvp/defer%22,[%22./promise%22,%22exports%22],function(a,b){var%20d=a[%22default%22];%20b[%22default%22]=function(a){var%20b={};return%20b.promise=new%20d(function(a,d){b.resolve=a;b.reject=d},a),b}});a(%22rsvp/events%22,[%22exports%22],function(a){function%20b(a,d){for(var%20e=0,f=a.length;f%3Ee;e++)if(a[e]===d)return%20e;return-1}function%20d(a){var%20b=a._promiseCallbacks;return%20b||(b=a._promiseCallbacks={}),b}a[%22default%22]={mixin:function(a){return%20a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void%200,a},on:function(a,e){var%20f,g=d(this);(f=g[a])||(f=g[a]=[]);-1===b(f,e)&&f.push(e)},off:function(a,%20e){var%20f,g,m=d(this);return%20e?(f=m[a],g=b(f,e),void(-1!==g&&f.splice(g,1))):void(m[a]=[])},trigger:function(a,b){var%20e;if(e=d(this)[a])for(var%20f=0;f%3Ce.length;f++)(0,e[f])(b)}}});a(%22rsvp/filter%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=b.isFunction;d[%22default%22]=function(a,b,d){return%20e.all(a,d).then(function(a){if(!f(b))throw%20new%20TypeError(%22You%20must%20pass%20a%20function%20as%20filter's%20second%20argument.%22);for(var%20g=a.length,h=Array(g),k=0;g%3Ek;k++)h[k]=b(a[k]);return%20e.all(h,d).then(function(b){for(var%20d=%20Array(g),e=0,f=0;g%3Ef;f++)!0===b[f]&&(d[e]=a[f],e++);return%20d.length=e,d})})}});a(%22rsvp/hash-settled%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=b.isNonThenable,u=b.keysOf;d[%22default%22]=function(a){return%20new%20e(function(b){function%20d(a){return%20function(b){h(a,{state:%22fulfilled%22,value:b})}}function%20g(a){return%20function(b){h(a,{state:%22rejected%22,reason:b})}}function%20h(a,d){A[a]=d;0===--B&&b(A)}var%20k,x,A={},C=u(a),B=C.length;if(0===B)return%20void%20b(A);for(var%20z=0;z%3CC.length;z++)x=%20C[z],k=a[x],f(k)?h(x,{state:%22fulfilled%22,value:k}):e.resolve(k).then(d(x),g(x))})}});a(%22rsvp/hash%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=b.isNonThenable,u=b.keysOf;d[%22default%22]=function(a){return%20new%20e(function(b,d){function%20g(a){return%20function(d){A[a]=d;0===--B&&b(A)}}function%20h(a){B=0;d(a)}var%20k,x,A={},C=u(a),B=C.length;if(0===B)return%20void%20b(A);for(var%20z=0;z%3CC.length;z++)x=C[z],k=a[x],f(k)?(A[x]=k,0===--B&&b(A)):e.resolve(k).then(g(x),h)})}});a(%22rsvp/instrument%22,%20[%22./config%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a.config,f=b.now;d[%22default%22]=function(a,b,d){try{e.trigger(a,{guid:b._guidKey+b._id,eventName:a,detail:b._detail,childGuid:d&&b._guidKey+d._id,label:b._label,timeStamp:f(),stack:Error(b._label).stack})}catch(g){setTimeout(function(){throw%20g;},0)}}});a(%22rsvp/map%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=(b.isArray,b.isFunction);d[%22default%22]=function(a,b,d){return%20e.all(a,d).then(function(a){if(!f(b))throw%20new%20TypeError(%22You%20must%20pass%20a%20function%20as%20map's%20second%20argument.%22);%20for(var%20g=a.length,h=Array(g),k=0;g%3Ek;k++)h[k]=b(a[k]);return%20e.all(h,d)})}});a(%22rsvp/node%22,[%22./promise%22,%22./utils%22,%22exports%22],function(a,b,d){var%20e=a[%22default%22],f=b.isArray;d[%22default%22]=function(a,b){function%20d(){for(var%20f=arguments.length,k=Array(f),r=0;f%3Er;r++)k[r]=arguments[r];var%20m;return%20g||h||!b?m=this:(console.warn('Deprecation:%20RSVP.denodeify()%20doesn\'t%20allow%20setting%20the%20%22this%22%20binding%20anymore.%20Use%20yourFunction.bind(yourThis)%20instead.'),m=b),e.all(k).then(function(d){return%20new%20e(function(e,%20f){d.push(function(){for(var%20a=arguments.length,d=Array(a),k=0;a%3Ek;k++)d[k]=arguments[k];a=d[0];k=d[1];if(a)f(a);else%20if(g)e(d.slice(1));else%20if(h){for(var%20a={},r=d.slice(1),k=0;k%3Cb.length;k++)d=b[k],a[d]=r[k];e(a)}else%20e(k)});a.apply(m,d)})})}var%20g=!0===b,h=f(b);return%20d.__proto__=a,d}});a(%22rsvp/promise%22,%22./config%20./events%20./instrument%20./utils%20./promise/cast%20./promise/all%20./promise/race%20./promise/resolve%20./promise/reject%20exports%22.split(%22%20%22),function(a,b,d,e,f,u,l,m,w,s){function%20D(){}function%20y(a,%20b){if(!M(a))throw%20new%20TypeError(%22You%20must%20pass%20a%20resolver%20function%20as%20the%20first%20argument%20to%20the%20promise%20constructor%22);if(!(this%20instanceof%20y))throw%20new%20TypeError(%22Failed%20to%20construct%20'Promise':%20Please%20use%20the%20'new'%20operator,%20this%20object%20constructor%20cannot%20be%20called%20as%20a%20function.%22);this._id=J++;this._label=b;this._subscribers=[];I.instrument&&P(%22created%22,this);if(D!==a){var%20d=this,e=function(a){B(d,a)},f=function(a){E(d,a)};try{a(e,f)}catch(g){f(g)}}}function%20x(a,b){var%20d,e,f=a._subscribers,g=a._detail;%20I.instrument&&P(b===ba?%22fulfilled%22:%22rejected%22,a);for(var%20h=0;h%3Cf.length;h+=3)d=f[h],e=f[h+b],A(b,d,e,g);a._subscribers=null}function%20A(a,b,d,e){var%20f,g,h,k,l=M(d);if(l)try{f=d(e),h=!0}catch(r){k=!0,g=r}else%20f=e,h=!0;C(b,f)||(l&&h?B(b,f):k?E(b,g):a===ba?B(b,f):a===F&&E(b,f))}function%20C(a,b){var%20d,e=null;try{if(a===b)throw%20new%20TypeError(%22A%20promises%20callback%20cannot%20return%20that%20same%20promise.%22);if(Q(b)&&(e=b.then,M(e)))return%20e.call(b,function(e){return%20d?!0:(d=!0,void(b!==e?B(a,e):z(a,e)))},function(b){return%20d?%20!0:(d=!0,void%20E(a,b))},%22Settle:%20%22+(a._label||%22%20unknown%20promise%22)),!0}catch(f){return%20d?!0:(E(a,f),!0)}return!1}function%20B(a,b){a===b?z(a,b):C(a,b)||z(a,b)}function%20z(a,b){a._state===N&&(a._state=U,a._detail=b,I.async(G,a))}function%20E(a,b){a._state===N&&(a._state=U,a._detail=b,I.async(R,a))}function%20G(a){x(a,a._state=ba)}function%20R(a){a._onerror&&a._onerror(a._detail);x(a,a._state=F)}var%20I=a.config,P=(b[%22default%22],d[%22default%22]),Q=e.objectOrFunction,M=e.isFunction,a=e.now,f=f[%22default%22],u=u[%22default%22],%20l=l[%22default%22],m=m[%22default%22],w=w[%22default%22],a=%22rsvp_%22+a()+%22-%22,J=0;s[%22default%22]=y;y.cast=f;y.all=u;y.race=l;y.resolve=m;y.reject=w;var%20N=void%200,U=0,ba=1,F=2;y.prototype={constructor:y,_id:void%200,_guidKey:a,_label:void%200,_state:void%200,_detail:void%200,_subscribers:void%200,_onerror:function(a){I.trigger(%22error%22,a)},then:function(a,b,d){var%20e=this;this._onerror=null;var%20f=new%20this.constructor(D,d);if(this._state){var%20g=arguments;I.async(function(){A(e._state,f,g[e._state-1],e._detail)})}else{var%20h=this._subscribers,%20k=h.length;h[k]=f;h[k+ba]=a;h[k+F]=b}return%20I.instrument&&P(%22chained%22,e,f),f},%22catch%22:function(a,b){return%20this.then(null,a,b)},%22finally%22:function(a,b){var%20d=this.constructor;return%20this.then(function(b){return%20d.resolve(a()).then(function(){return%20b})},function(b){return%20d.resolve(a()).then(function(){throw%20b;})},b)}}});a(%22rsvp/promise/all%22,[%22../utils%22,%22exports%22],function(a,b){var%20d=a.isArray,e=a.isNonThenable;b[%22default%22]=function(a,b){var%20f=this;return%20new%20f(function(b,g){function%20h(a){return%20function(d){A[a]=%20d;0===--x&&b(A)}}function%20u(a){x=0;g(a)}if(!d(a))throw%20new%20TypeError(%22You%20must%20pass%20an%20array%20to%20all.%22);var%20y,x=a.length,A=Array(x);if(0===x)return%20void%20b(A);for(var%20C=0;C%3Ca.length;C++)y=a[C],e(y)?(A[C]=y,0===--x&&b(A)):f.resolve(y).then(h(C),u)},b)}});a(%22rsvp/promise/cast%22,[%22exports%22],function(a){a[%22default%22]=function(a,b){return%20a&&%22object%22==typeof%20a&&a.constructor===this?a:new%20this(function(b){b(a)},b)}});a(%22rsvp/promise/race%22,[%22../utils%22,%22exports%22],function(a,b){var%20d=a.isArray,e=(a.isFunction,%20a.isNonThenable);b[%22default%22]=function(a,b){var%20f,g=this;return%20new%20g(function(b,h){function%20u(a){x&&(x=!1,b(a))}function%20y(a){x&&(x=!1,h(a))}if(!d(a))throw%20new%20TypeError(%22You%20must%20pass%20an%20array%20to%20race.%22);for(var%20x=!0,A=0;A%3Ca.length;A++){if(f=a[A],e(f))return%20x=!1,void%20b(f);g.resolve(f).then(u,y)}},b)}});a(%22rsvp/promise/reject%22,[%22exports%22],function(a){a[%22default%22]=function(a,b){return%20new%20this(function(b,d){d(a)},b)}});a(%22rsvp/promise/resolve%22,[%22exports%22],function(a){a[%22default%22]=function(a,b){return%20a&&%20%22object%22==typeof%20a&&a.constructor===this?a:new%20this(function(b){b(a)},b)}});a(%22rsvp/race%22,[%22./promise%22,%22exports%22],function(a,b){var%20d=a[%22default%22];b[%22default%22]=function(a,b){return%20d.race(a,b)}});a(%22rsvp/reject%22,[%22./promise%22,%22exports%22],function(a,b){var%20d=a[%22default%22];b[%22default%22]=function(a,b){return%20d.reject(a,b)}});a(%22rsvp/resolve%22,[%22./promise%22,%22exports%22],function(a,b){var%20d=a[%22default%22];b[%22default%22]=function(a,b){return%20d.resolve(a,b)}});a(%22rsvp/rethrow%22,[%22exports%22],function(a){a[%22default%22]=function(a){throw%20setTimeout(function(){throw%20a;%20}),a;}});a(%22rsvp/utils%22,[%22exports%22],function(a){function%20b(a){return%22function%22==typeof%20a||%22object%22==typeof%20a&&null!==a}a.objectOrFunction=b;a.isFunction=function(a){return%22function%22==typeof%20a};a.isNonThenable=function(a){return!b(a)};a.isArray=Array.isArray?Array.isArray:function(a){return%22[object%20Array]%22===Object.prototype.toString.call(a)};a.now=Date.now||function(){return(new%20Date).getTime()};a.keysOf=Object.keys||function(a){var%20b=[],d;for(d%20in%20a)b.push(d);return%20b}});a(%22rsvp%22,%22./rsvp/promise%20./rsvp/events%20./rsvp/node%20./rsvp/all%20./rsvp/all-settled%20./rsvp/race%20./rsvp/hash%20./rsvp/hash-settled%20./rsvp/rethrow%20./rsvp/defer%20./rsvp/config%20./rsvp/map%20./rsvp/resolve%20./rsvp/reject%20./rsvp/filter%20./rsvp/asap%20exports%22.split(%22%20%22),%20function(a,b,d,e,f,u,l,m,w,s,D,y,x,A,C,B,z){function%20E(){G.on.apply(G,arguments)}var%20a=a[%22default%22],b=b[%22default%22],d=d[%22default%22],e=e[%22default%22],f=f[%22default%22],u=u[%22default%22],l=l[%22default%22],m=m[%22default%22],w=w[%22default%22],s=s[%22default%22],G=D.config,D=D.configure,y=y[%22default%22],x=x[%22default%22],A=A[%22default%22],C=C[%22default%22];if(G.async=B[%22default%22],%22undefined%22!=typeof%20window&&%22object%22==typeof%20window.__PROMISE_INSTRUMENTATION__){B=window.__PROMISE_INSTRUMENTATION__;D(%22instrument%22,!0);for(var%20R%20in%20B)B.hasOwnProperty(R)&&%20E(R,B[R])}z.Promise=a;z.EventTarget=b;z.all=e;z.allSettled=f;z.race=u;z.hash=l;z.hashSettled=m;z.rethrow=w;z.defer=s;z.denodeify=d;z.configure=D;z.on=E;z.off=function(){G.off.apply(G,arguments)};z.resolve=x;z.reject=A;z.async=function(a,b){G.async(a,b)};z.map=y;z.filter=C});f.RSVP=b(%22rsvp%22)}(window);pc.promise={Promise:window.RSVP.Promise,all:window.RSVP.all};pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton};pc.asset={ASSET_ANIMATION:%22animation%22,ASSET_AUDIO:%22audio%22,ASSET_IMAGE:%22image%22,ASSET_JSON:%22json%22,ASSET_MODEL:%22model%22,ASSET_MATERIAL:%22material%22,ASSET_TEXT:%22text%22,ASSET_TEXTURE:%22texture%22,ASSET_CUBEMAP:%22cubemap%22};pc.audio={AudioManager:pc.SoundManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound};%20pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,ContentFile:pc.ContentFile,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},Pack:pc.Pack,ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}};%20pc.extend(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,precalculatedTangents:pc.precalculatedTangents,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,%20VertexIterator:pc.VertexIterator});pc.extend(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent});pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue};%20pc.extend(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,%20Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.PhongMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance});pc.shape={Aabb:pc.BoundingBox,Sphere:pc.BoundingSphere,Plane:pc.Plane};pc.time={now:pc.now,Timer:pc.Timer};pc.extend(pc.Application.prototype,function(){var%20f=null,a=[],b=null,d=null,e=null,g=function(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.meshInstance=this.material=null};g.prototype={init:function(a,b){this.mesh||(this.mesh=new%20pc.Mesh,this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new%20pc.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=%20pc.BLEND_NORMAL,this.material.update());for(;this.linesUsed+b%3Ethis.numLinesAllocated;)this.vb=null,this.numLinesAllocated*=2;this.vb||(this.vb=new%20pc.VertexBuffer(a,f,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new%20DataView(this.vb.lock()),this.meshInstance||(this.meshInstance=new%20pc.MeshInstance({worldTransform:pc.Mat4.IDENTITY},this.mesh,this.material)))},addLines:function(a,b){for(var%20d=!!b.length,e=2*this.linesUsed*f.size,g,l=0;l%3Ca.length;l++)this.vbRam.setFloat32(e,%20a[l].x,!0),e+=4,this.vbRam.setFloat32(e,a[l].y,!0),e+=4,this.vbRam.setFloat32(e,a[l].z,!0),e+=4,g=d?b[l]:b,this.vbRam.setUint8(e,255*g.r),e+=1,this.vbRam.setUint8(e,255*g.g),e+=1,this.vbRam.setUint8(e,255*g.b),e+=1,this.vbRam.setUint8(e,255*g.a),e+=1;this.linesUsed+=a.length/2},finalize:function(a){0%3Cthis.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,a.push(this.meshInstance),this.linesUsed=0)}};return{renderMeshInstance:function(a){this.scene.immediateDrawCalls.push(a)},%20renderMesh:function(a,b,d){a=new%20pc.MeshInstance({worldTransform:d},a,b);this.scene.immediateDrawCalls.push(a)},renderLine:function(a,b,d,e,f){var%20g=d,m=pc.LINEBATCH_WORLD;e&&(%22number%22===typeof%20e?m=e:(g=e,f&&(m=f)));this._addLines(m,[a,b],[d,g])},renderLines:function(a,b,d){void%200===d&&(d=pc.LINEBATCH_WORLD);b.length&&a.length!==b.length?pc.log.error(%22renderLines:%20position/color%20arrays%20have%20different%20lengths%22):0!==a.length%2?pc.log.error(%22renderLines:%20array%20length%20is%20not%20divisible%20by%202%22):this._addLines(d,%20a,b)},renderQuad:function(a,d,e){if(!b){var%20f=new%20pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);quadVb=new%20pc.VertexBuffer(this.graphicsDevice,f,4);f=new%20pc.VertexIterator(quadVb);f.element[pc.SEMANTIC_POSITION].set(-0.5,-0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(0.5,-0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(-0.5,0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(0.5,0.5,0);f.end();b=new%20pc.Mesh;b.vertexBuffer=%20quadVb;b.primitive[0].type=pc.PRIMITIVE_TRISTRIP;b.primitive[0].base=0;b.primitive[0].count=4;b.primitive[0].indexed=!1}a=new%20pc.MeshInstance({worldTransform:a},b,d);e&&(a.layer=e);this.scene.immediateDrawCalls.push(a)},renderWireCube:function(a,b,f){void%200===f&&(f=pc.LINEBATCH_WORLD);var%20g;d||(d=[new%20pc.Vec3(-0.5,-0.5,-0.5),new%20pc.Vec3(-0.5,0.5,-0.5),new%20pc.Vec3(0.5,0.5,-0.5),new%20pc.Vec3(0.5,-0.5,-0.5),new%20pc.Vec3(-0.5,-0.5,0.5),new%20pc.Vec3(-0.5,0.5,0.5),new%20pc.Vec3(0.5,0.5,0.5),new%20pc.Vec3(0.5,%20-0.5,0.5)],e=[new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3,new%20pc.Vec3]);for(g=0;8%3Eg;g++)a.transformPoint(d[g],e[g]);this.renderLines([e[0],e[1],e[1],e[2],e[2],e[3],e[3],e[0],e[4],e[5],e[5],e[6],e[6],e[7],e[7],e[4],e[0],e[4],e[1],e[5],e[2],e[6],e[3],e[7]],b,f)},_addLines:function(b,d,e){f||(f=new%20pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.ELEMENTTYPE_UINT8,%20normalize:!0}]),this.on(%22prerender%22,this._preRenderImmediate,this));a[b]?a[b].init(this.graphicsDevice,d.length/2):(a[b]=new%20g,a[b].init(this.graphicsDevice,d.length/2),b===pc.LINEBATCH_OVERLAY?(a[b].material.depthTest=!1,a[b].meshInstance.layer=pc.LAYER_GIZMO):b===pc.LINEBATCH_GIZMO&&(a[b].meshInstance.layer=pc.LAYER_GIZMO));a[b].addLines(d,e)},_preRenderImmediate:function(){for(var%20b=0;3%3Eb;b++)a[b]&&a[b].finalize(this.scene.immediateDrawCalls)}}}());pc.extend(pc,function(){function%20f(a,b,d,e){if(a.enabled){var%20g;if(a.model&&(a.model.model&&a.model.enabled)&&(e&&e.push(a),a.model.data.lightmapped&&b)){var%20h=!0,k=a.model.model.meshInstances;for(g=0;g%3Ck.length;g++)if(!k[g].mesh.vertexBuffer.format.hasUv1){h=!1;break}if(h){var%20n,r=[];for(g=0;g%3Ck.length;g++){n=!1;for(h=0;h%3Ck.length;h++)g!==h&&k[g].mesh===k[h].mesh&&(n=!0);n?(b.push(a),d.push([k[g]])):r.push(k[g])}0%3Cr.length&&(b.push(a),d.push(r))}}a=a.getChildren();for(g=0;g%3Ca.length;g++)f(a[g],b,%20d,e)}}var%20a=[],b=[],d,e=new%20pc.Vec3,g=new%20pc.BoundingBox,h=new%20pc.BoundingBox,k={},n,r=function(a,b,d,e,f){this.device=a;this.root=b;this.scene=d;this.renderer=e;this.assets=f;this._stats={renderPasses:0,lightmapCount:0,lightmapMem:0,renderTime:0,shadersLinked:0}};r.prototype={calculateLightmapSize:function(a){var%20b=this.scene.lightmapSizeMultiplier||16,d=1,f=1,g=1,h=1;if(a.model.asset){var%20k=this.assets.get(a.model.asset).data;k.area&&(d=k.area.x,f=k.area.y,g=k.area.z,h=k.area.uv)}else%20a.model._area&&%20(k=a.model,k._area&&(d=k._area.x,f=k._area.y,g=k._area.z,h=k._area.uv));k=a.model.lightmapSizeMultiplier||1;d*=k;f*=k;g*=k;e.copy(a.getLocalScale());for(a=a.getParent();a;)e.mul(a.getLocalScale()),a=a.getParent();d=d*e.y*e.z+f*e.x*e.z+g*e.x*e.y;d=Math.sqrt(d/h);return%20Math.min(pc.math.nextPowerOfTwo(d*b),this.scene.lightmapMaxResolution||2048)},bake:function(r){var%20l=pc.now();this.device.fire(%22lightmapper:start%22,{timestamp:l,target:this});var%20m,w,s,D=this.device,y=this.scene,x=this._stats;x.renderPasses=%200;var%20A=D._shaderStats.linked,C=[],B=[];if(r){for(m=0;m%3Ca.length;m++)for(m=w;w%3Cr.length;w++)b[m]===r[w]&&a[m].destroy();a=[];b=[];var%20z=[];for(m=0;m%3Cr.length;m++)f(r[m],z,B);r=z;f(this.root,null,null,C)}else{for(m=0;m%3Ca.length;m++)a[m].destroy();a=[];b=[];r=[];f(this.root,r,B,C)}x.lightmapCount=r.length;var%20E=[],z=[],G={},R,I;for(m=0;m%3Cr.length;m++)R=this.calculateLightmapSize(r[m],B[m]),E.push(R),I=new%20pc.Texture(D,{width:R,height:R,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1,rgbm:!0}),I.addressU=%20pc.ADDRESS_CLAMP_TO_EDGE,I.addressV=pc.ADDRESS_CLAMP_TO_EDGE,I._minFilter=pc.FILTER_LINEAR,I._magFilter=pc.FILTER_LINEAR,z.push(I),x.lightmapMem+=16*R*R,G[R]||(I=new%20pc.Texture(D,{width:R,height:R,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1,rgbm:!0}),I.addressU=pc.ADDRESS_CLAMP_TO_EDGE,I.addressV=pc.ADDRESS_CLAMP_TO_EDGE,I._minFilter=pc.FILTER_LINEAR,I._magFilter=pc.FILTER_LINEAR,I=new%20pc.RenderTarget(D,I,{depth:!1}),G[R]=I);E=[];R=[];I=[];var%20P=[],Q=y._lights,M;for(m=0;m%3CQ.length;m++)Q[m]._enabled&&%20(M=Q[m].mask,0!==(M&4)&&(R.push(M),I.push(Q[m].shadowUpdateMode),Q[m].setMask(4294967295),Q[m].shadowUpdateMode=Q[m].getType()===pc.LIGHTTYPE_DIRECTIONAL?pc.SHADOWUPDATE_REALTIME:pc.SHADOWUPDATE_THISFRAME,E.push(Q[m]))),P.push(Q[m]._enabled),Q[m].setEnabled(!1);m=pc.shaderChunks;var%20J=m.transformUv1VS,N=m.bakeLmEndPS;M=m.createShaderFromCode(D,m.fullscreenQuadVS,m.dilatePS,%22lmDilate%22);var%20U=D.scope.resolve(%22source%22),ba=D.scope.resolve(%22pixelOffset%22),F,O=y.drawCalls;for(m=0;m%3CO.length;m++)O[m].node&&%20O[m].node.getWorldTransform();var%20O=y.fog,da=y.ambientLight.r,H=y.ambientLight.g,T=y.ambientLight.b,ea=y.drawCalls;y.fog=pc.FOG_NONE;y.ambientLight.r=0;y.ambientLight.g=0;y.ambientLight.b=0;d||(d=new%20pc.Camera,d._node=new%20pc.GraphNode,d.setClearOptions({color:[0,0,0,0],depth:1,flags:pc.CLEARFLAG_COLOR}),d.frustumCulling=!1);var%20K,L;for(K=0;K%3CC.length;K++){L=C[K].model.model.meshInstances;for(m=0;m%3CL.length;m++)L[m]._shaderDefs&=~pc.SHADERDEF_LM}var%20ha=[];for(K=0;K%3CC.length;K++)ha[K]=C[K].model.castShadows,%20C[K].model.castShadows=C[K].model.data.castShadowsLightmap;var%20X=[],Z=[],ca=[];y.updateShadersFunc(D);for(K=0;K%3Cr.length;K++){L=B[K];for(m=0;m%3CL.length;m++)F=L[m].material,X.push(F)}n||(n=new%20pc.PhongMaterial,n.chunks.transformVS=J,n.chunks.endPS=N,n.ambient=new%20pc.Color(0,0,0),n.ambientTint=!0,n.chunks.outputAlphaPS=%22\n%22,n.chunks.outputAlphaOpaquePS=%22\n%22,n.chunks.outputAlphaPremulPS=%22\n%22,n.cull=pc.CULLFACE_NONE,n.forceUv1=!0,n.update(),n.updateShader(D,y));for(K=0;K%3Cr.length;K++){L=B[K];J=z[K];if(0%3C%20L.length){g.copy(L[0].aabb);for(m=0;m%3CL.length;m++)L[m].node.getWorldTransform(),g.add(L[m].aabb)}m=new%20pc.BoundingBox;m.copy(g);Z.push(m);for(m=0;m%3CL.length;m++)F=L[m],F._shaderDefs&=~pc.SHADERDEF_LM,F.mask=4,F.deleteParameter(%22texture_lightMap%22),F.material=n;N=new%20pc.RenderTarget(D,J,{depth:!1});ca.push(N)}for(w=0;w%3CE.length;w++)E[w].setEnabled(!1);for(m=0;m%3CE.length;m++){E[m].setEnabled(!0);E[m]._cacheShadowMap=!0;E[m].getType()!==pc.LIGHTTYPE_DIRECTIONAL&&(E[m]._node.getWorldTransform(),E[m].getBoundingSphere(k),%20h.center=k.center,h.halfExtents.x=k.radius,h.halfExtents.y=k.radius,h.halfExtents.z=k.radius);E[m].getType()===pc.LIGHTTYPE_SPOT&&(K=E[m],s=this.renderer.getShadowCamera(D,K),s._node.setPosition(K._node.getPosition()),s._node.setRotation(K._node.getRotation()),s._node.rotateLocal(-90,0,0),s.setProjection(pc.PROJECTION_PERSPECTIVE),s.setNearClip(K.getAttenuationEnd()/1E3),s.setFarClip(K.getAttenuationEnd()),s.setAspectRatio(1),s.setFov(2*K.getOuterConeAngle()),this.renderer.updateCameraFrustum(s));%20for(K=0;K%3Cr.length;K++){L=B[K];J=z[K];g=Z[K];N=ca[K];F=G[J.width];texTmp=F.colorBuffer;y.drawCalls=[];for(w=0;w%3CL.length;w++)y.drawCalls.push(L[w]);y.updateShaders=!0;if(E[m].getType()===pc.LIGHTTYPE_DIRECTIONAL)e.copy(g.center),e.y+=g.halfExtents.y,d._node.setPosition(e),d._node.setEulerAngles(-90,0,0),w=Math.max(g.halfExtents.x,g.halfExtents.z),d.setProjection(pc.PROJECTION_ORTHOGRAPHIC),d.setNearClip(0),d.setFarClip(2*g.halfExtents.y),d.setAspectRatio(1),d.setOrthoHeight(w);else%20if(!h.intersects(g))continue;%20if(E[m].getType()===pc.LIGHTTYPE_SPOT){var%20S=!1;for(w=0;w%3CL.length;w++)if(this.renderer._isVisible(s,L[w])){S=!0;break}if(!S)continue}d.setRenderTarget(F);this.renderer.render(y,d);x.renderPasses++;z[K]=texTmp;ca[K]=F;G[J.width]=N;for(w=0;w%3CL.length;w++)F=L[w],F.setParameter(%22texture_lightMap%22,texTmp),F._shaderDefs|=pc.SHADERDEF_LM}E[m].setEnabled(!1);E[m]._cacheShadowMap=!1}for(K=s=0;K%3Cr.length;K++){L=B[K];J=z[K];N=ca[K];F=G[J.width];texTmp=F.colorBuffer;m=new%20pc.Vec2(1/J.width,1/J.height);ba.setValue(m.data);%20for(m=0;4%3Em;m++)U.setValue(J),pc.drawQuadWithShader(D,F,M),U.setValue(texTmp),pc.drawQuadWithShader(D,N,M);for(m=0;m%3CL.length;m++)F=L[m],F.mask=2,L[m].material=X[s],L[m].setParameter(%22texture_lightMap%22,J),s++;a.push(J);b.push(r[K]);N.destroy()}for(var%20fa%20in%20G)G.hasOwnProperty(fa)&&(G[fa].colorBuffer.destroy(),G[fa].destroy());for(K=0;K%3CC.length;K++)C[K].model.castShadows=ha[K];for(m=0;m%3CE.length;m++)E[m].setMask(R[m]),E[m].shadowUpdateMode=I[m];for(m=0;m%3CQ.length;m++)Q[m].setEnabled(P[m]);y.drawCalls=%20ea;y.fog=O;y.ambientLight.r=da;y.ambientLight.g=H;y.ambientLight.b=T;y._updateLightStats();this.device.fire(%22lightmapper:end%22,{timestamp:pc.now(),target:this});x.renderTime=pc.now()-l;x.shadersLinked=D._shaderStats.linked-A}};return{Lightmapper:r,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4}}());
